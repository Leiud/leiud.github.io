<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>ElasticSearch | 进阶 | 漂泊者的理想三旬</title><meta name="keywords" content="ElasticSearch"><meta name="author" content="Feng Deng"><meta name="copyright" content="Feng Deng"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="核心概念索引（Index）一个索引就是一个拥有几分相似特征的文档的集合。比如说，可以有一个客户数据的索引，一个产品目录的索引，还有一个订单数据的索引。 一个索引由一个名字来标识（必须全部是小写字母），并且当要对这个索引中的文档进行索引、搜索、更新和删除时，都要使用到这个名字。 在一个集群中，可以定义任意多的索引。 能搜索的数据必须索引，这样的好处是可以提高查询速度，比如：新华字典前面的目录就是索引">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch | 进阶">
<meta property="og:url" content="http://atideas.github.io/2021/10/17/ElasticSearch/04.%E8%BF%9B%E9%98%B6/index.html">
<meta property="og:site_name" content="漂泊者的理想三旬">
<meta property="og:description" content="核心概念索引（Index）一个索引就是一个拥有几分相似特征的文档的集合。比如说，可以有一个客户数据的索引，一个产品目录的索引，还有一个订单数据的索引。 一个索引由一个名字来标识（必须全部是小写字母），并且当要对这个索引中的文档进行索引、搜索、更新和删除时，都要使用到这个名字。 在一个集群中，可以定义任意多的索引。 能搜索的数据必须索引，这样的好处是可以提高查询速度，比如：新华字典前面的目录就是索引">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img.paulzzh.com/touhou/random">
<meta property="article:published_time" content="2021-10-17T11:06:38.000Z">
<meta property="article:modified_time" content="2022-03-10T01:46:00.372Z">
<meta property="article:author" content="Feng Deng">
<meta property="article:tag" content="ElasticSearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.paulzzh.com/touhou/random"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/atideas/assets/static/favicon.ico"><link rel="canonical" href="http://atideas.github.io/2021/10/17/ElasticSearch/04.%E8%BF%9B%E9%98%B6/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-36LL6FC11S"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-36LL6FC11S');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ElasticSearch | 进阶',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-10 09:46:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/all.css"><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="漂泊者的理想三旬" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/atideas/assets/static/avatar.jpg" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/atideas/assets/static/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">175</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">26</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/artitalk/"><i class="fa-fw fas fa-comments"></i><span> 说说</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://img.paulzzh.com/touhou/random')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">漂泊者的理想三旬</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/artitalk/"><i class="fa-fw fas fa-comments"></i><span> 说说</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ElasticSearch | 进阶</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-10-17T11:06:38.000Z" title="发表于 2021-10-17 19:06:38">2021-10-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-03-10T01:46:00.372Z" title="更新于 2022-03-10 09:46:00">2022-03-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">14.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>47分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ElasticSearch | 进阶"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2021/10/17/ElasticSearch/04.%E8%BF%9B%E9%98%B6/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2021/10/17/ElasticSearch/04.%E8%BF%9B%E9%98%B6/" itemprop="commentCount"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h1><h2 id="索引（Index）"><a href="#索引（Index）" class="headerlink" title="索引（Index）"></a>索引（Index）</h2><p>一个索引就是一个拥有几分相似特征的文档的集合。比如说，可以有一个客户数据的索引，一个产品目录的索引，还有一个订单数据的索引。</p>
<p>一个索引由一个名字来标识（必须全部是小写字母），并且当要对这个索引中的文档进行索引、搜索、更新和删除时，都要使用到这个名字。</p>
<p>在一个集群中，可以定义任意多的索引。</p>
<p>能搜索的数据必须索引，这样的好处是可以提高查询速度，比如：新华字典前面的目录就是索引的意思，目录可以提高查询速度。</p>
<p><strong><code>Elasticsearch</code>索引的精髓：一切设计都是为了提高搜索的性能</strong>。</p>
<h2 id="类型（Type）"><a href="#类型（Type）" class="headerlink" title="类型（Type）"></a>类型（Type）</h2><p>在一个索引中可以定义一种或多种类型。</p>
<p>一个类型是索引的一个逻辑上的分类/分区，其语义完全由自己来定。通常会为具有一组共同字段的文档定义一个类型。</p>
<p>不同的版本，类型发生了不同的变化。</p>
<table>
<thead>
<tr>
<th>版本</th>
<th>Type</th>
</tr>
</thead>
<tbody><tr>
<td>5.x</td>
<td>支持多种<code>type</code></td>
</tr>
<tr>
<td>6.x</td>
<td>只能有一种<code>type</code></td>
</tr>
<tr>
<td>7.x</td>
<td>默认不再支持自定义索引类型（默认类型为<code>_doc</code>）</td>
</tr>
</tbody></table>
<h2 id="文档（Document）"><a href="#文档（Document）" class="headerlink" title="文档（Document）"></a>文档（Document）</h2><p>一个文档是一个可被索引的基础信息单元，也就是一条数据。</p>
<p>比如：可以拥有某一个客户的文档，某一个产品的一个文档，当然，也可以拥有某个订单的一个文档。文档以<code>JSON</code>（<code>Javascript Object Notation</code>）格式来表示，而<code>JSON</code>是一个到处存在的互联网数据交互格式。</p>
<p>在一个<code>index/type</code>里面可以存储任意多的文档。</p>
<h2 id="字段（Field）"><a href="#字段（Field）" class="headerlink" title="字段（Field）"></a>字段（Field）</h2><p>相当于是数据表的字段，对文档数据根据不同属性进行的分类标识。</p>
<h2 id="映射（Mapping）"><a href="#映射（Mapping）" class="headerlink" title="映射（Mapping）"></a>映射（Mapping）</h2><p><code>mapping</code>是处理数据的方式和规则方面做一些限制，如：某个字段的数据类型、默认值、分析器、是否被索引等等。</p>
<p>这些都是映射里面可以设置的，其它就是处理<code>ES</code>里面数据的一些使用规则设置也叫做映射，按着最优规则处理数据对性能提高很大，因此才需要建立映射，并且需要思考如何建立映射才能对性能更好。</p>
<h2 id="分片（Shards）"><a href="#分片（Shards）" class="headerlink" title="分片（Shards）"></a>分片（Shards）</h2><p>一个索引可以存储超出单个节点硬件限制的大量数据。</p>
<p>比如，一个具有 $10$ 亿文档数据的索引占据 $1TB$的磁盘空间，而任一节点都可能没有这样大的磁盘空间，或者单个节点处理搜索请求，响应太慢。</p>
<p>为了解决这个问题，<code>Elasticsearch</code>提供了将索引划分成多份的能力，每一份就称之为分片。当创建一个索引的时候，可以指定想要的分片的数量。每个分片本身也是一个功能完善并且独立的“索引”，这个“索引”可以被放置到集群中的任何节点上。</p>
<p>分片很重要，主要有两方面的原因：</p>
<ol>
<li>允许你水平分割 / 扩展你的内容容量</li>
<li>允许你在分片之上进行分布式的、并行的操作，进而提高性能/吞吐量</li>
</ol>
<p>至于一个分片怎样分布，它的文档怎样聚合和搜索请求，是完全由<code>Elasticsearch</code>管理的，对于作为用户的人来说，这些都是透明的，无需过分关心。</p>
<p><strong>被混淆的概念是，一个<code>Lucene</code>索引——在<code>Elasticsearch</code>称作分片。一个<code>Elasticsearch</code>索引是分片的集合。 当<code>Elasticsearch</code>在索引中搜索的时候， 它发送查询到每一个属于索引的分片（<code>Lucene</code>索引），然后合并每个分片的结果到一个全局的结果集</strong>。</p>
<h2 id="副本（Replicas）"><a href="#副本（Replicas）" class="headerlink" title="副本（Replicas）"></a>副本（Replicas）</h2><p>在一个网络 / 云的环境里，失败随时都可能发生，在某个分片/节点不知怎么的就处于离线状态，或者由于任何原因消失了，这种情况下，有一个故障转移机制是非常有用并且是强烈推荐的。为此目的，<code>Elasticsearch</code>允许创建分片的一份或多份拷贝，这些拷贝叫做复制分片(副本)。</p>
<p>复制分片之所以重要，有两个主要原因：</p>
<ul>
<li>在分片/节点失败的情况下，提供了高可用性。因为这个原因，注意到复制分片从不与原/主要（<code>original/primary</code>）分片置于同一节点上是非常重要的。</li>
<li>Ø  扩展你的搜索量/吞吐量，因为搜索可以在所有的副本上并行运行。</li>
</ul>
<p>总之，每个索引可以被分成多个分片。</p>
<p>一个索引也可以被复制 $0$ 次（意思是没有复制）或多次。一旦复制了，每个索引就有了主分片（作为复制源的原来的分片）和复制分片（主分片的拷贝）之别。分片和复制的数量可以在索引创建的时候指定。在索引创建之后，可以在任何时候动态地改变复制的数量，但是事后不能改变分片的数量。</p>
<p>默认情况下，<code>Elasticsearch</code>中的每个索引被分片 $1$ 个主分片和 $1$ 个复制，这意味着，如果集群中至少有两个节点，索引将会有 $1$ 个主分片和另外 $1$ 个复制分片（$1$ 个完全拷贝），这样的话</p>
<p>每个索引总共就有 $2$ 个分片，我们需要根据索引需要确定分片个数。</p>
<h2 id="分配（Allocation）"><a href="#分配（Allocation）" class="headerlink" title="分配（Allocation）"></a>分配（Allocation）</h2><p>将分片分配给某个节点的过程，包括分配主分片或者副本。如果是副本，还包含从主分片复制数据的过程。这个过程是由<code>master</code>节点完成的。</p>
<h1 id="系统架构"><a href="#系统架构" class="headerlink" title="系统架构"></a>系统架构</h1><div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826347-287f5615.png"></p>
</div>

<p>一个运行中的<code>Elasticsearch</code>实例称为一个节点，而集群是由一个或者多个拥有相同<code>cluster.name</code>配置的节点组成， 它们共同承担数据和负载的压力。</p>
<p>当有节点加入集群中或者从集群中移除节点时，集群将会重新平均分布所有的数据。</p>
<p>当一个节点被选举成为主节点时， 它将负责管理集群范围内的所有变更，例如增加、删除索引，或者增加、删除节点等。  </p>
<p>而主节点并不需要涉及到文档级别的变更和搜索等操作，所以当集群只拥有一个主节点的情况下，即使流量的增加它也不会成为瓶颈。</p>
<p>任何节点都可以成为主节点。示例集群就只有一个节点，所以它同时也成为了主节点。</p>
<p>作为用户，可以将请求发送到集群中的任何节点，包括主节点。 </p>
<p>每个节点都知道任意文档所处的位置，并且能够将请求直接转发到存储所需文档的节点。无论将请求发送到哪个节点，它都能负责从各个包含所需文档的节点收集回数据，并将最终结果返回給客户端。</p>
<p><code>Elasticsearch</code>对这一切的管理都是透明的。</p>
<h1 id="分布式集群"><a href="#分布式集群" class="headerlink" title="分布式集群"></a>分布式集群</h1><h2 id="单节点集群"><a href="#单节点集群" class="headerlink" title="单节点集群"></a>单节点集群</h2><p>在包含一个空节点的集群内创建名为<code>users</code>的索引，为了演示目的，将分配 $3$ 个主分片和一份副本（每个主分片拥有一个副本分片）。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;number_of_shards&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;number_of_replicas&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826389-2a96694e.png"></p>
</div>

<p>集群现在是拥有一个索引的单节点集群。所有 $3$ 个主分片都被分配在<code>node-1</code>。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826412-8ccdb9a8.png"></p>
</div>

<p>通过<code>Elasticsearch Head</code>插件查看集群情况：</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826438-8beccf33.png"></p>
</div>

<ul>
<li>集群健康值<code>yellow (3 of 6)</code> : 表示当前集群的全部主分片都正常运行，但是副本分片没有全部处在正常状态</li>
<li><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826460-494733a4.png">：$3$ 个主分片正常</li>
<li><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826493-b4fdc852.png">：$3$ 个副本分片都是<code>Unassigned</code>—— 它们都没有被分配到任何节点。 在同一个节点上既保存原始数据又保存副本是没有意义的，因为一旦失去了那个节点，也将丢失该节点上的所有副本数据。</li>
</ul>
<p>当前集群是正常运行的，但是在硬件故障时有丢失数据的风险。</p>
<h2 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h2><p>当集群中只有一个节点在运行时，意味着会有一个单点故障问题——没有冗余。 </p>
<p>幸运的是，只需再启动一个节点即可防止数据丢失。</p>
<p>当在同一台机器上启动了第二个节点时，只要它和第一个节点有同样的<code>cluster.name</code>配置，它就会自动发现集群并加入到其中。但是在不同机器上启动节点的时候，为了加入到同一集群，需要配置一个可连接到的单播主机列表。之所以配置为使用单播发现，以防止节点无意中加入集群。只有在同一台机器上运行的节点才会自动组成集群。</p>
<p>如果启动了第二个节点，我们的集群将会拥有两个节点的集群</p>
<p>所有主分片和副本分片都已被分配：</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826535-2e5a15b4.png"></p>
</div>

<p>通过<code>Elasticsearch Head</code>插件查看集群情况：</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826560-af7dc74f.png"></p>
</div>

<ul>
<li>**集群健康值 : green (6 of 6)**：表示所有 $6$ 个分片（包括 $3$ 个主分片和 $3$ 个副本分片）都在正常运行</li>
<li><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826582-dd8c76ca.png">：$3$ 个主分片正常</li>
<li><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826603-c7be1ae7.png">：当第二个节点加入到集群后，$3$ 个副本分片将会分配到这个节点上——每个主分片对应一个副本分片。这意味着当集群内任何一个节点出现问题时，数据都完好无损。所有新近被索引的文档都将会保存在主分片上，然后被并行的复制到对应的副本分片上。这就保证了既可以从主分片又可以从副本分片上获得文档。</li>
</ul>
<h2 id="水平扩容"><a href="#水平扩容" class="headerlink" title="水平扩容"></a>水平扩容</h2><p>怎样为正在增长中的应用程序按需扩容呢？</p>
<p>当启动了第三个节点，集群将会拥有三个节点的集群 : 为了分散负载而对.分片进行重新分配。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826631-7f6586cf.png"></p>
</div>

<p>通过<code>Elasticsearch Head</code>插件查看集群情况：</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826657-06c01416.png"></p>
</div>

<p><code>集群健康值 : green (6 of 6)</code>：表示所有 $6$ 个分片（包括 $3$ 个主分片和 $3$ 个副本分片）都在正常运行</p>
<p><code>node-1</code>和<code>node-2</code>上各有一个分片被迁移到了新的<code>node-3</code>节点，现在每个节点上都拥有 $2$ 个分片， 而不是之前的 $3$ 个。 这表示每个节点的硬件资源（<code>CPU</code>，<code>RAM</code>，<code>I/O</code>）将被更少的分片所共享，每个分片的性能将会得到提升。</p>
<p>分片是一个功能完整的搜索引擎，它拥有使用一个节点上的所有资源的能力。这个拥有 $6$ 个分片（$3$ 个主分片和 $3$ 个副本分片）的索引可以最大扩容到 $6$ 个节点，每个节点上存在一个分片，并且每个分片拥有所在节点的全部资源。</p>
<p><strong>但是如果想要扩容超过 $6$ 个节点怎么办呢</strong>？</p>
<p>主分片的数目在索引创建时就已经确定了下来。实际上，这个数目定义了这个索引能够存储的最大数据量（实际大小取决于数据、硬件和使用场景）。</p>
<p>但是，读操作——搜索和返回数据——可以同时被主分片或副本分片所处理，所以当拥有越多的副本分片时，也将拥有越高的吞吐量。</p>
<p>在运行中的集群上是可以动态调整副本分片数目的，可以按需伸缩集群。</p>
<p>先把副本数从默认的 $1$ 增加到 $2$。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826724-09ad5d75.png"></p>
</div>

<p><code>users</code>索引现在拥有 $9$ 个分片：$3$ 个主分片和 $6$ 个副本分片。这意味着可以将集群扩容到 $9$ 个节点，每个节点上一个分片。相比原来 $3$ 个节点时，集群搜索性能可以提升 $3$ 倍。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826746-20c62458.png"></p>
</div>

<p>通过<code>Elasticsearch Head</code>插件查看集群情况：</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826774-2f4cad19.png"></p>
</div>

<p>当然，如果只是在相同节点数目的集群上增加更多的副本分片并不能提高性能，因为每个分片从节点上获得的资源会变少。 你需要增加更多的硬件资源来提升吞吐量。</p>
<p>但是更多的副本分片数提高了数据冗余量：按照上面的节点配置，我们可以在失去 $2$ 个节点的情况下不丢失任何数据。</p>
<h2 id="应对故障"><a href="#应对故障" class="headerlink" title="应对故障"></a>应对故障</h2><p>关闭第一个节点，这时集群的状态为：关闭了一个节点后的集群。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826814-d635f690.png"></p>
</div>

<p>关闭的节点是一个主节点。而集群必须拥有一个主节点来保证正常工作，所以发生的第一件事情就是选举一个新的主节点：<code>node-2</code>。在关闭<code>node-1</code>的同时也失去了主分片 $1$ 和 $2$，并且在缺失主分片的时候索引也不能正常工作。  </p>
<p>如果此时来检查集群的状况，看到的状态将会为<code>red</code>：不是所有主分片都在正常工作。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826841-7b553107.png"></p>
</div>

<p>幸运的是，在其它节点上存在着这两个主分片的完整副本， 所以新的主节点立即将这些分片在<code>node-2</code>和<code>node-3</code>上对应的副本分片提升为主分片，此时集群的状态将会为<code>yellow</code>。这个提升主分片的过程是瞬间发生的，如同按下一个开关一般。</p>
<p><strong>为什么集群状态是<code>yellow</code>而不是<code>green</code>呢</strong>？</p>
<p>虽然拥有所有的三个主分片，但是同时设置了每个主分片需要对应 $2$ 份副本分片，而此时只存在一份副本分片，所以集群不能为<code>green</code>的状态。</p>
<p>不过不必过于担心：如果同样关闭了<code>node-2</code>，程序依然可以保持在不丢任何数据的情况下运行，因为<code>node-3</code>为每一个分片都保留着一份副本。</p>
<p>如果重新启动<code>node-1</code>，集群可以将缺失的副本分片再次进行分配，那么集群的状态也将恢复成之前的状态。 如果<code>node-1</code>依然拥有着之前的分片，它将尝试去重用它们，同时仅从主分片复制发生了修改的数据文件。和之前的集群相比，只是<code>master</code>节点切换了。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639827636-176cf0cc.png"></p>
</div>

<h1 id="路由计算"><a href="#路由计算" class="headerlink" title="路由计算"></a>路由计算</h1><div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639827744-99398bec.png"></p>
</div>

<p>当索引一个文档的时候，文档会被存储到一个主分片中。</p>
<p><code>Elasticsearch</code>如何知道一个文档应该存放到哪个分片中呢？当创建文档时，它如何决定这个文档应当被存储在分片 $1$ 还是分片 $2$ 中呢？</p>
<p>首先这肯定不会是随机的，否则将来要获取文档时就不知道从何处寻找了。实际上，这个过程是根据下面这个公式决定的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shard = hash(routing) % number_of_primary_shard</span><br></pre></td></tr></table></figure>

<p><code>routing</code>是一个可变值，默认是文档的<code>_id</code>，也可以设置成一个自定义的值。<code>routing</code>通过</p>
<p><code>hash</code>函数生成一个数字，然后这个数字再除以<code>number_of_primary_shards</code>（主分片的数量）后得到余数。这个分布在 $0$ 到<code>number_of_primary_shards-1</code>之间的余数，就是所寻求的文档所在分片的位置。</p>
<p>这就解释了为什么要在创建索引的时候就确定好主分片的数量并且永远不会改变这个数量：因为如果数量变化了，那么所有之前路由的值都会无效，文档也再也找不到了。</p>
<p>所有的文档<code>API</code>（<code>get</code>、<code>index</code>、<code>delete</code>、<code>bulk</code>、<code>update</code>以及<code>mget</code>）都接受一个叫做<code>routing</code>的路由参数 ，通过这个参数可以自定义文档到分片的映射。一个自定义的路由参数可以用来确保所有相关的文档——例如所有属于同一个用户的文档——都被存储到同一个分片中。</p>
<h1 id="分片控制"><a href="#分片控制" class="headerlink" title="分片控制"></a>分片控制</h1><div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639827809-f22aabe8.png"></p>
</div>

<p>假设有一个集群由三个节点组成。 它包含一个叫<code>emps</code>的索引，有两个主分片，每个主分片有两个副本分片。相同分片的副本不会放在同一节点。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;setting&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;number_of_shards&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;number_of_replicas&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639827837-f1c4fbd2.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639827850-7f74643c.png"></p>
</div>

<p>通过<code>Elasticsearch Head</code>插件查看集群情况，集群是一个有三个节点和一个索引的集群。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639827876-5c3c9c7d.png"></p>
</div>

<p>可以发送请求到集群中的任一节点。  </p>
<p>每个节点都有能力处理任意请求。 每个节点都知道集群中任一文档位置，所以可以直接将请求转发到需要的节点上。</p>
<p>在下面的例子中，将所有的请求发送到<code>node-1</code>，将其称为<strong>协调节点</strong>（<code>coordinating node</code>）。</p>
<p><strong>当发送请求的时候，为了扩展负载，更好的做法是轮询集群中所有的节点。</strong></p>
<h3 id="写流程"><a href="#写流程" class="headerlink" title="写流程"></a>写流程</h3><div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639827945-e402a7a1.png"></p>
</div>

<p>新建、索引和删除请求都是写操作，必须在主分片上面完成之后才能被复制到相关的副本分片。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828012-079984de.png"></p>
</div>

<p><strong>新建，索引和删除文档所需要的步骤顺序</strong>：</p>
<ol>
<li>客户端向<code>node-1</code>发送新建、索引或者删除请求。</li>
<li>节点使用文档的<code>_id</code>确定文档属于分片 $0$。请求会被转发到<code>node-3</code>，因为分片 $0$ 的主分片目前被分配在<code>node-3</code>上。</li>
<li><code>node-3</code>在主分片上面执行请求。如果成功了，它将请求并行转发到<code>node-1</code>和<code>node-2</code>的副本分片上。一旦所有的副本分片都报告成功，<code>node-3</code>将向协调节点报告成功，协调节点向客户端报告成功。</li>
</ol>
<p>在客户端收到成功响应时，文档变更已经在主分片和所有副本分片执行完成，变更是安全的。有一些可选的请求参数允许您影响这个过程，可能以数据安全为代价提升性能。</p>
<p>这些选项很少使用，因为<code>Elasticsearch</code>已经很快，但是为了完整起见，请参考下面表格：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>consistency</td>
<td><code>consistency</code>，即一致性。<br />在默认设置下，即使仅仅是在试图执行一个写操作之前，主分片都会要求必须要有规定数量（<code>quorum</code>）（或者换种说法，也即必须要有大多数）的分片副本处于活跃可用状态，才会去执行写操作（其中分片副本可以是主分片或者副本分片）。这是为了避免在发生网络分区故障（<code>networkpartition</code>）的时候进行写操作，进而导致数据不一致。<br />规定数量即：<br /><code>int((primary+number_of_replicas)/2)+1&lt;br /&gt;</code><br />consistency参数的值可以设为：<code>one</code>（只要主分片状态<code>ok</code>就允许执行写操作）,<code>all</code>（必须要主分片和所有副本分片的状态没问题才允许执行写操作）,<br />或<code>quorum</code>。默认值为<code>quorum</code>, 即大多数的分片副本状态没问题就允许执行写操作。<br />注意，规定数量的计算公式中<code>number_of_replicas</code>指的是在索引设置中的设定副本分片数，而不是指当前处理活动状态的副本分片数。如果索引设置中指定了当前索引拥有三个副本分片，那规定数量的计算结果即：<br /><code>int((primary+3 replicas)/2 )+1=3</code><br />如果此时只启动两个节点，那么处于活跃状态的分片副本数量就达不到规定数量，也因此将无法索引和删除任何文档。<br /></td>
</tr>
<tr>
<td>timeout</td>
<td>如果没有足够的副本分片会发生什么？<br /><code>Elasticsearch</code>会等待，希望更多的分片出现。<br />默认情况下，它最多等待 $1$ 分钟。如果需要，可以使用<code>timeout</code>参数使它更早终止： 100ms：100毫秒，30s是 30秒。<br /></td>
</tr>
</tbody></table>
<p>新索引默认有 $1$ 个副本分片，这意味着为满足规定数量应该需要两个活动的分片副本。但是，这些默认的设置会阻止在单一节点上做任何事情。</p>
<p>为了避免这个问题，要求只有当<code>number_of_replicas</code>大于 $1$ 的时候，规定数量才会执行。</p>
<h3 id="读流程"><a href="#读流程" class="headerlink" title="读流程"></a>读流程</h3><div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828089-0da8743e.png"></p>
</div>

<p>可以从主分片或者从其它任意副本分片检索文档：</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828114-0e9e77e7.png"></p>
</div>

<p><strong>从主分片或者副本分片检索文档的步骤顺序</strong>：</p>
<ol>
<li>客户端向<code>node-1</code>发送获取请求。</li>
<li>节点使用文档的<code>_id</code>来确定文档属于分片 $0$。分片 $0$ 的副本分片存在于所有的三个节点上。 在这种情况下，它将请求转发到<code>node-2</code>。</li>
<li><code>node-2</code>将文档返回给<code>node-1</code>，然后将文档返回给客户端。</li>
</ol>
<p>在处理读取请求时，协调结点在每次请求的时候都会通过轮询所有的副本分片来达到负载均衡。</p>
<p>在文档被检索时，已经被索引的文档可能已经存在于主分片上但是还没有复制到副本分片。</p>
<p>在这种情况下，副本分片可能会报告文档不存在，但是主分片可能成功返回文档。  </p>
<p>一旦索引请求成功返回给用户，文档在主分片和副本分片都是可用的。</p>
<h3 id="更新流程"><a href="#更新流程" class="headerlink" title="更新流程"></a>更新流程</h3><p>部分更新一个文档结合了先前说明的读取和写入流程：</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828145-fb5d4bc4.png"></p>
</div>

<p><strong>部分更新一个文档的步骤如下</strong>：</p>
<ol>
<li>客户端向<code>node-1</code>发送更新请求。</li>
<li>它将请求转发到主分片所在的<code>node-3</code>。</li>
<li><code>node-3</code>从主分片检索文档，修改<code>_source</code>字段中的<code>JSON</code>，并且尝试重新索引主分片的文档。如果文档已经被另一个进程修改，它会重试步骤 $3$，超过<code>retry_on_conflict</code>次后放弃。</li>
<li>如果<code>node-3</code>成功地更新文档，它将新版本的文档并行转发到<code>node-1</code>和<code>node-2</code>上的副本分片，重新建立索引。一旦所有副本分片都返回成功，<code>node-3</code>向协调节点也返回成功，协调节点向客户端返回成功。</li>
</ol>
<p>当主分片把更改转发到副本分片时，它不会转发更新请求。相反，它转发完整文档的新版本。请记住，这些更改将会异步转发到副本分片，并且不能保证它们以发送它们相同的顺序到达。  </p>
<p>如果<code>Elasticsearch</code>仅转发更改请求，则可能以错误的顺序应用更改，导致得到损坏的文档。</p>
<h3 id="多文档操作流程"><a href="#多文档操作流程" class="headerlink" title="多文档操作流程"></a>多文档操作流程</h3><p><code>mget</code>和<code>bulkAPI</code>的模式类似于单文档模式。区别在于协调节点知道每个文档存在于哪个分片中。它将整个多文档请求分解成每个分片的多文档请求，并且将这些请求并行转发到每个参与节点。</p>
<p>协调节点一旦收到来自每个节点的应答，就将每个节点的响应收集整理成单个响应，返回给客户端。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828183-18eaa11b.png"></p>
</div>

<p><strong>用单个<code>mget</code>请求取回多个文档所需的步骤顺序</strong>：</p>
<ol>
<li>客户端向<code>node-1</code>发送<code>mget</code>请求。</li>
<li><code>node-1</code>为每个分片构建多文档获取请求，然后并行转发这些请求到托管在每个所需的主分片或者副本分片的节点上。一旦收到所有答复，<code>node-1</code>构建响应并将其返回给客户端。</li>
</ol>
<p>可以对<code>docs</code>数组中每个文档设置<code>routing</code>参数。</p>
<p><code>bulk API</code>：允许在单个批量请求中执行多个创建、索引、删除和更新请求。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828209-3a6671fa.png"></p>
</div>

<p><strong><code>bulk API</code>按如下步骤顺序执行</strong>：</p>
<ol>
<li>客户端向<code>node-1</code>发送<code>bulk</code>请求。</li>
<li><code>node-1</code>为每个节点创建一个批量请求，并将这些请求并行转发到每个包含主分片的节点主机。</li>
<li>主分片一个接一个按顺序执行每个操作。当每个操作成功时，主分片并行转发新文档（或删除）到副本分片，然后执行下一个操作。 一旦所有的副本分片报告所有操作成功，该节点将向协调节点报告成功，协调节点将这些响应收集整理并返回给客户端。</li>
</ol>
<h1 id="分片原理"><a href="#分片原理" class="headerlink" title="分片原理"></a>分片原理</h1><p>分片是<code>Elasticsearch</code>最小的工作单元。但是究竟什么是一个分片，它是如何工作的？</p>
<p>传统的数据库每个字段存储单个值，但这对全文检索并不够。文本字段中的每个单词需要被搜索，对数据库意味着需要单个字段有索引多值的能力。最好的支持是一个字段多个值需求的数据结构是倒排索引。</p>
<h2 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h2><p><code>Elasticsearch</code>使用一种称为<strong>倒排索引</strong>的结构，它适用于快速的全文搜索。</p>
<p>见其名，知其意，有倒排索引，肯定会对应有正向索引。正向索引（<code>forward index</code>），反向索引（<code>inverted index</code>）更熟悉的名字是倒排索引。</p>
<p>所谓的正向索引，就是搜索引擎会将待搜索的文件都对应一个文件<code>ID</code>，搜索时将这个<code>ID</code>和搜索关键字进行对应，形成<code>K-V</code>对，然后对关键字进行统计计数。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828246-dd8dff5b.png"></p>
</div>

<p>但是互联网上收录在搜索引擎中的文档的数目是个天文数字，这样的索引结构根本无法满足实时返回排名结果的要求。</p>
<p>所以，搜索引擎会将正向索引重新构建为倒排索引，即把文件<code>ID</code>对应到关键词的映射转换为关键词到文件<code>ID</code>的映射，每个关键词都对应着一系列的文件，这些文件中都出现这个关键词。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828269-6224b4a9.png"></p>
</div>

<p>一个倒排索引由文档中所有不重复词的列表构成，对于其中每个词，有一个包含它的文档列表。例如，假设我们有两个文档，每个文档的<code>content</code>域包含如下内容：</p>
<ul>
<li><code>The quick brown fox jumped over the lazy dog</code></li>
<li><code>Quick brown foxes leap over lazy dogs in summer</code></li>
</ul>
<p>为了创建倒排索引，首先将每个文档的<code>content</code>域拆分成单独的词（称它为词条或<code>tokens</code>）。</p>
<ul>
<li>词条：索引中最小存储和查询单元</li>
<li>词典：字典，词条的集合，<code>B+ Tree</code>，<code>HashMap</code></li>
</ul>
<p>创建一个包含所有不重复词条的排序列表，然后列出每个词条出现在哪个文档，结果如下所示：</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828302-32e228c7.png"></p>
</div>

<p>现在，如果我们想搜索<code>quick brown</code>，只需要查找包含每个词条的文档：</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828323-25a39983.png"></p>
</div>

<p>两个文档都匹配，但是第一个文档比第二个匹配度更高。如果使用仅计算匹配词条数量的简单相似性算法，那么可以说，对于查询的相关性来讲，第一个文档比第二个文档更佳。</p>
<p>但是，目前的倒排索引有一些问题：</p>
<ul>
<li><code>Quick</code>和<code>quick</code>以独立的词条出现，然而用户可能认为它们是相同的词</li>
<li><code>fox</code>和<code>foxes</code>非常相似，就像<code>dog</code>和<code>dogs</code>；它们有相同的词根</li>
<li><code>jumped</code>和<code>leap</code>尽管没有相同的词根，但它们的意思很相近，是同义词</li>
</ul>
<p>使用前面的索引搜索<code>+Quick +fox</code>不会得到任何匹配文档（记住，<code>+</code>前缀表明这个词必须存在）。只有同时出现<code>Quick</code>和<code>fox</code>的文档才满足这个查询条件，但是第一个文档包含<code>quick fox</code>，第二个文档包含<code>Quick foxes</code>。</p>
<p>用户可以合理的期望两个文档与查询匹配。我们可以做的更好。</p>
<p>如果将词条规范为标准模式，那么可以找到与用户搜索的词条不完全一致，但具有足够相关性的文档。例如：</p>
<ul>
<li><code>Quick</code>可以小写化为<code>quick</code><br /></li>
<li><code>foxes</code>可以词干提取——变为词根的格式——为<code>fox</code>。类似的，<code>dogs</code>可以为提取为<code>dog</code>。<br /></li>
<li><code>jumped</code>和<code>leap</code>是同义词，可以索引为相同的单词<code>jump</code>。</li>
</ul>
<p>现在索引看上去像这样：</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828361-94add718.png"></p>
</div>

<p>这还远远不够。搜索<code>+Quick +fox</code>仍然会失败，因为在索引中已经没有<code>Quick</code>了。但是，如果对搜索的字符串使用与<code>content</code>域相同的标准化规则，会变成查询<code>+quick +fox</code>，这样两个文档都会匹配！分词和标准化的过程称为<strong>分析</strong>。</p>
<p>这非常重要。你只能搜索在索引中出现的词条，所以索引文本和查询字符串必须标准化为相同的格式。</p>
<h2 id="文档搜索"><a href="#文档搜索" class="headerlink" title="文档搜索"></a>文档搜索</h2><p>早期的全文检索会为整个文档集合建立一个很大的倒排索引并将其写入到磁盘。 一旦新的索引就绪，旧的就会被其替换，这样最近的变化便可以被检索到。</p>
<p>倒排索引被写入磁盘后是不可改变的：它永远不会修改。</p>
<p>不变性有重要的价值：</p>
<ul>
<li>不需要锁。如果你从来不更新索引，你就不需要担心多进程同时修改数据的问题。</li>
<li>一旦索引被读入内核的文件系统缓存，便会留在哪里，由于其不变性。只要文件系统缓存中还有足够的空间，那么大部分读请求会直接请求内存，而不会命中磁盘。这提供了很大的性能提升。</li>
<li>其它缓存（像filter缓存），在索引的生命周期内始终有效。它们不需要在每次数据改变时被重建，因为数据不会变化。</li>
<li>写入单个大的倒排索引允许数据被压缩，减少磁盘<code>I/O</code>和需要被缓存到内存的索引的使用量。</li>
</ul>
<p>当然，一个不变的索引也有不好的地方。主要事实是它是不可变的! 不能修改它。</p>
<p>如果需要让一个新的文档可被搜索，需要重建整个索引。这要么对一个索引所能包含的数据量造成了很大的限制，要么对索引可被更新的频率造成了很大的限制。</p>
<h3 id="动态更新索引"><a href="#动态更新索引" class="headerlink" title="动态更新索引"></a>动态更新索引</h3><p>如何在保留不变性的前提下实现倒排索引的更新？</p>
<p>答案是: 用更多的索引。通过增加新的补充索引来反映新近的修改，而不是直接重写整个倒排索引。每一个倒排索引都会被轮流查询到，从最早的开始查询完后再对结果进行合并。</p>
<p><code>Elasticsearch</code>基于<code>Lucene</code>，这个<code>java</code>库引入了<strong>按段搜索</strong>的概念。每一 段本身都是一个倒排索引，但索引在<code>Lucene</code>中除表示所有段的集合外，还增加了提交点的概念——一个列出了所有已知段的文件。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828408-8c18cc47.png"></p>
</div>

<p><strong>按段搜索</strong>会以如下流程执行：</p>
<ol>
<li>新文档被收集到内存索引缓存<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828426-82827a27.png"></li>
<li>不时地，缓存被提交<ol>
<li>一个新的段——一个追加的倒排索引—被写入磁盘</li>
<li>一个新的包含新段名字的 提交点 被写入磁盘</li>
<li>磁盘进行同步——所有在文件系统缓存中等待的写入都刷新到磁盘，以确保它们被写入物理文件</li>
</ol>
</li>
<li>新的段被开启，让它包含的文档可见以被搜索</li>
<li>内存缓存被清空，等待接收新的文档<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828445-218cda2e.png"></li>
</ol>
<p>当一个查询被触发，所有已知的段按顺序被查询。词项统计会对所有段的结果进行聚合，以保证每个词和每个文档的关联都被准确计算。这种方式可以用相对较低的成本将新文档添加到索引。</p>
<p>段是不可改变的，所以既不能从把文档从旧的段中移除，也不能修改旧的段来进行反映文档的更新。 取而代之的是，每个提交点会包含一个<code>.del</code>文件，文件中会列出这些被删除文档的段信息。</p>
<p>当一个文档被 “删除” 时，它实际上只是在<code>.del</code>文件中被标记删除。一个被标记删除的文档仍然可以被查询匹配到， 但它会在最终结果被返回前从结果集中移除。</p>
<p>文档更新也是类似的操作方式：当一个文档被更新时，旧版本文档被标记删除，文档的新版本被索引到一个新的段中。可能两个版本的文档都会被一个查询匹配到，但被删除的那个旧版本文档在结果集返回前就已经被移除。</p>
<h3 id="近实时搜索"><a href="#近实时搜索" class="headerlink" title="近实时搜索"></a>近实时搜索</h3><p>随着按段（<code>per-segment</code>）搜索的发展，一个新的文档从索引到可被搜索的延迟显著降低了。新文档在几分钟之内即可被检索，但这样还是不够快。磁盘在这里成为了瓶颈。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828488-91244843.png"></p>
</div>

<p>提交（<code>Commiting</code>）一个新的段到磁盘需要一个<code>fsync</code>来确保段被物理性地写入磁盘，这样在断电的时候就不会丢失数据。但是<code>fsync</code>操作代价很大; 如果每次索引一个文档都去执行一次的话会造成很大的性能问题。</p>
<p>需要的是一个更轻量的方式来使一个文档可被搜索，这意味着<code>fsync</code>要从整个过程中被移除。</p>
<p>在<code>Elasticsearch</code>和磁盘之间是文件系统缓存。像之前描述的一样， 在内存索引缓冲区中的文档会被写入到一个新的段中。</p>
<p>但是这里新段会被先写入到文件系统缓存—这一步代价会比较低，稍后再被刷新到磁盘—这一步代价比较高。不过只要文件已经在缓存中，就可以像其它文件一样被打开和读取了。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828524-e805fe38.png"></p>
</div>

<p><code>Lucene</code>允许新段被写入和打开—使其包含的文档在未进行一次完整提交时便对搜索可见。这种方式比进行一次提交代价要小得多，并且在不影响性能的前提下可以被频繁地执行。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828547-c71664f8.png"></p>
</div>

<p>在<code>Elasticsearch</code>中，写入和打开一个新段的轻量的过程叫做<code>refresh</code>。 默认情况下每个分片会每秒自动刷新一次。</p>
<p>这就是为什么说<code>Elasticsearch</code>是近实时搜索: 文档的变化并不是立即对搜索可见，但会在一秒之内变为可见。</p>
<p>这些行为可能会对新用户造成困惑：他们索引了一个文档然后尝试搜索它，但却没有搜到。这个问题的解决办法是用<code>refreshAPI</code>执行一次手动刷新：<code>/users/_refresh</code>。</p>
<p><strong>尽管刷新是比提交轻量很多的操作，它还是会有性能开销。当写测试的时候，手动刷新很有用，但是不要在生产环境下每次索引一个文档都去手动刷新。相反，应用需要意识到<code>Elasticsearch</code>的近实时的性质，并接受它的不足</strong>。</p>
<p>并不是所有的情况都需要每秒刷新。可能正在使用<code>Elasticsearch</code>索引大量的日志文件，可能想优化索引速度而不是近实时搜索， 可以通过设置<code>refresh_interval</code>， 降低每个索引的刷新频率：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">        <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30s&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>refresh_interval</code>可以在既存索引上进行动态更新。在生产环境中，当正在建立一个大的新索引时，可以先关闭自动刷新，待开始使用该索引时，再把它们调回来。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 关闭自动刷新</span><br><span class="line"># PUT /users/_settings</span><br><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="number">-1</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># 每一秒刷新</span><br><span class="line">#PUT /users/_settings</span><br><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1s&quot;</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="持久化变更"><a href="#持久化变更" class="headerlink" title="持久化变更"></a>持久化变更</h3><p>如果没有用<code>fsync</code>把数据从文件系统缓存刷（<code>flush</code>）到硬盘，我们不能保证数据在断电甚至是程序正常退出之后依然存在。为了保证<code>Elasticsearch</code>的可靠性，需要确保数据变化被持久化到磁盘。</p>
<p>在动态更新索引说一次完整的提交会将段刷到磁盘，并写入一个包含所有段列表的提交点。<code>Elasticsearch</code>在启动或重新打开一个索引的过程中使用这个提交点来判断哪些段隶属于当前分片。</p>
<p>即使通过每秒刷新（<code>refresh</code>）实现了近实时搜索，仍然需要经常进行完整提交来确保能从失败中恢复。但在两次提交之间发生变化的文档怎么办？也不希望丢失掉这些数据。</p>
<p><code>Elasticsearch</code>增加了一个<code>translog</code>，或者叫事务日志，在每一次对<code>Elasticsearch</code>进行操作时均进行了日志记录。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828593-7d2a25ad.png"></p>
</div>

<p>整个流程如下：</p>
<ol>
<li><p>一个文档被索引之后，就会被添加到内存缓冲区，并且追加到了<code>translog</code><br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828617-55a74f47.png"></p>
</li>
<li><p>刷新（<code>refresh</code>）使分片每秒被刷新（<code>refresh</code>）一次</p>
<ul>
<li>这些在内存缓冲区的文档被写入到一个新的段中，且没有进行 fsync操作</li>
<li>这个段被打开，使其可被搜索</li>
<li>内存缓冲区被清空</li>
</ul>
<p> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828637-eb1827bb.png"></p>
</li>
<li><p>这个进程继续工作，更多的文档被添加到内存缓冲区和追加到事务日志<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828654-59f0262a.png"></p>
</li>
<li><p>每隔一段时间——例如<code>translog</code>变得越来越大—索引被刷新（<code>flush</code>）；一个新的<code>translog</code>被创建，并且一个全量提交被执行。</p>
<ul>
<li>所有在内存缓冲区的文档都被写入一个新的段</li>
<li>缓冲区被清空</li>
<li>一个提交点被写入硬盘</li>
<li>文件系统缓存通过<code>fsync</code>被刷新（<code>flush</code>）</li>
<li>老的<code>translog</code>被删除</li>
</ul>
</li>
</ol>
<p><code>translog</code>提供所有还没有被刷到磁盘的操作的一个持久化纪录。</p>
<p>当<code>Elasticsearch</code>启动的时候， 它会从磁盘中使用最后一个提交点去恢复已知的段，并且会重放 <code>translog</code>中所有在最后一次提交后发生的变更操作。</p>
<p><code>translog</code>也被用来提供实时<code>CRUD</code>。当你试着通过<code>ID</code>查询、更新、删除一个文档，它会在尝试从相应的段中检索之前， 首先检查<code>translog</code>任何最近的变更。这意味着它总是能够实时地获取到文档的最新版本。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828684-91022a3d.png"></p>
</div>

<p>执行一个提交并且截断<code>translog</code>的行为在<code>Elasticsearch</code>被称作一次<code>flush</code>。</p>
<p>分片每 $30$ 分钟被自动刷新（<code>flush</code>），或者在<code>translog</code>太大的时候也会刷新。</p>
<p>很少需要自己手动执行<code>flush</code>操作；通常情况下，自动刷新就足够了。这就是说，在重启节点或关闭索引之前执行<code>flush有</code>益于自己的索引。当<code>Elasticsearch</code>尝试恢复或重新打开一个索引， 它需要重放<code>translog</code>中所有的操作，所以如果日志越短，恢复越快。</p>
<p><code>translog</code>的目的是保证操作不会丢失，在文件被<code>fsync</code>到磁盘前，被写入的文件在重启之后就会丢失。</p>
<p>默认<code>translog</code>是每 $5$ 秒被<code>fsync</code>刷新到硬盘， 或者在每次写请求完成之后执行（<code>index</code>，<code>delete</code>，<code>update</code>，<code>bulk</code>）。这个过程在主分片和复制分片都会发生。</p>
<p>最终，基本上，这意味着在整个请求被<code>fsync</code>到主分片和复制分片的<code>translog</code>之前，客户端不会得到一个<code>200OK</code>响应。</p>
<p>在每次请求后都执行一个<code>fsync</code>会带来一些性能损失，尽管实践表明这种损失相对较小（特别是 <code>bulk</code>导入，它在一次请求中平摊了大量文档的开销）。</p>
<p>但是对于一些大容量的偶尔丢失几秒数据问题也并不严重的集群，使用异步的<code>fsync</code>还是比较有益的。比如，写入的数据被缓存到内存中，再每 $5$ 秒执行一次<code>fsync</code>。</p>
<p>如果决定使用异步<code>translog</code>的话，需要保证在发生<code>crash</code>时，丢失掉<code>sync_interval</code>时间段的数据也无所谓。请在决定前知晓这个特性。</p>
<p>如果不确定这个行为的后果，最好是使用默认的参数（<code>&quot;index.translog.durability&quot;: &quot;request&quot;</code>）来避免数据丢失。</p>
<h3 id="段合并"><a href="#段合并" class="headerlink" title="段合并"></a>段合并</h3><p>由于自动刷新流程每秒会创建一个新的段，这样会导致短时间内的段数量暴增。而段数目太多会带来较大的麻烦。 每一个段都会消耗文件句柄、内存和<code>cpu</code>运行周期。更重要的是，每个搜索请求都必须轮流检查每个段；所以段越多，搜索也就越慢。</p>
<p><code>Elasticsearch</code>通过在后台进行段合并来解决这个问题。小的段被合并到大的段，然后这些大的段再被合并到更大的段。</p>
<p>段合并的时候会将那些旧的已删除文档从文件系统中清除。被删除的文档（或被更新文档的旧版本）不会被拷贝到新的大段中。</p>
<p>启动段合并不需要做任何事。进行索引和搜索时会自动进行。</p>
<ol>
<li><p>当索引的时候，刷新（<code>refresh</code>）操作会创建新的段并将段打开以供搜索使用</p>
</li>
<li><p>合并进程选择一小部分大小相似的段，并且在后台将它们合并到更大的段中。这并不会中断索引和搜索</p>
</li>
<li><p>一旦合并结束，老的段被删除</p>
<ul>
<li>新的段被刷新（<code>flush</code>）到了磁盘。写入一个包含新段且排除旧的和较小的段的新提交点。</li>
<li>新的段被打开用来搜索。</li>
<li>老的段被删除。</li>
</ul>
<p> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828727-5f635329.png"></p>
</li>
</ol>
<p>合并大的段需要消耗大量的<code>I/O</code>和<code>CPU</code>资源，如果任其发展会影响搜索性能。<code>Elasticsearch</code>在默认情况下会对合并流程进行资源限制，所以搜索仍然 有足够的资源很好地执行。</p>
<h1 id="文档分析"><a href="#文档分析" class="headerlink" title="文档分析"></a>文档分析</h1><p>分析包含下面的过程：</p>
<ul>
<li>将一块文本分成适合于倒排索引的独立的词条</li>
<li>将这些词条统一化为标准格式以提高它们的“可搜索性”，或者<code>recall</code></li>
</ul>
<p>分析器执行上面的工作。</p>
<p>分析器实际上是将三个功能封装到了一个包里：</p>
<ul>
<li>字符过滤器<br>首先，字符串按顺序通过每个 字符过滤器 。<br>它们的任务是在分词前整理字符串。一个字符过滤器可以用来去掉<code>HTML</code>，或者将<code>&amp;</code>转化成 <code>and</code>。</li>
<li>分词器<br>其次，字符串被分词器分为单个的词条。<br>一个简单的分词器遇到空格和标点的时候，可能会将文本拆分成词条。</li>
<li><code>Token</code>过滤器<br>最后，词条按顺序通过每个<code>token</code>过滤器。<br>这个过程可能会改变词条（例如小写化<code>Quick</code>），删除词条（例如<code>a</code>，<code>and</code>，<code>the</code>等无用词），或者增加词条（例如<code>jump</code>和<code>leap</code>这种同义词）。</li>
</ul>
<h3 id="内置分析器"><a href="#内置分析器" class="headerlink" title="内置分析器"></a>内置分析器</h3><p><code>Elasticsearch</code>还附带了可以直接使用的预包装的分析器。</p>
<p>接下来会列出最重要的分析器。为了证明它们的差异，先来看看每个分析器会从下面的字符串得到哪些词条：</p>
<blockquote>
<p>Set the shape to semi-transparent by calling set_trans(5)</p>
</blockquote>
<ul>
<li><p>标准分析器<br>标准分析器是<code>Elasticsearch</code>默认使用的分析器。它是分析各种语言文本最常用的选择。它根据<br><code>Unicode</code>联盟定义的单词边界划分文本；删除绝大部分标点；最后，将词条小写。它会产生：</p>
<blockquote>
<p>set, the, shape, to, semi, transparent, by, calling, set_trans, 5</p>
</blockquote>
</li>
<li><p>简单分析器<br>简单分析器在任何不是字母的地方分隔文本，将词条小写。它会产生：</p>
<blockquote>
<p>set, the, shape, to, semi, transparent, by, calling, set, trans</p>
</blockquote>
</li>
<li><p>空格分析器<br>空格分析器在空格的地方划分文本。它会产生：</p>
<blockquote>
<p>Set, the, shape, to, semi-transparent, by, calling, set_trans(5)</p>
</blockquote>
</li>
<li><p>语言分析器<br>特定语言分析器可用于很多语言。它们可以考虑指定语言的特点。<br>例如， 英语分析器附带了一组英语无用词（常用单词，如<code>and</code>或<code>the</code>，它们对相关性没有多少影响），它们会被删除。 由于理解英语语法的规则，这个分词器可以提取英语单词的词干。<br>英语分词器会产生下面的词条：</p>
<blockquote>
<p>set, shape, semi, transpar, call, set_tran, 5</p>
</blockquote>
<p>注意看，<code>transparent</code>、<code>calling</code>和<code>set_trans</code>已经变为词根格式。</p>
</li>
</ul>
<h3 id="分析器使用场景"><a href="#分析器使用场景" class="headerlink" title="分析器使用场景"></a>分析器使用场景</h3><p>当索引 一个文档，它的全文域被分析成词条以用来创建倒排索引。但是，当在全文域搜索的时候，需要将查询字符串通过相同的分析过程，以保证我们搜索的词条格式与索引中的词条格式一致。</p>
<p>全文查询，理解每个域是如何定义的，因此它们可以做正确的事：</p>
<ul>
<li>当查询一个<strong>全文域</strong>时，会对查询字符串应用相同的分析器，以产生正确的搜索词条列表。</li>
<li>当查询一个<strong>精确值域</strong>时，不会分析查询字符串，而是搜索指定的精确值。</li>
</ul>
<h3 id="测试分析器"><a href="#测试分析器" class="headerlink" title="测试分析器"></a>测试分析器</h3><p>有些时候很难理解分词的过程和实际被存储到索引中的词条，特别是刚接触<code>Elasticsearch</code>。</p>
<p>为了理解发生了什么，可以使用<code>analyzeAPI</code>来看文本是如何被分析的。</p>
<p>在消息体里，指定分析器和要分析的文本：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># GET http<span class="punctuation">:</span><span class="comment">//localhost:9200/_analyze</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Text to analyze&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>结果中每个元素代表一个单独的词条：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;tokens&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span>	<span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;to&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span>	<span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span>	<span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;analyze&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span>	<span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>token</code>是实际存储到索引中的词条。<code>position</code>指明词条在原始文本中出现的位置。<code>start_offset</code>和<code>end_offset</code>指明字符在原始字符串中的位置。</p>
<h3 id="指定分析器"><a href="#指定分析器" class="headerlink" title="指定分析器"></a>指定分析器</h3><p>当<code>Elasticsearch</code>在文档中检测到一个新的字符串域，它会自动设置其为一个全文字符串域，使用 标准分析器对它进行分析。</p>
<p>但并不希望总是这样。有时想使用一个不同的分析器，适用于数据使用的语言。有时想要一个字符串域就是一个字符串域——不使用分析，直接索引传入的精确值，例如用户<code>ID</code>或者一个内部的状态域或标签。要做到这一点，必须手动指定这些域的映射。</p>
<h3 id="IK-分词器"><a href="#IK-分词器" class="headerlink" title="IK 分词器"></a>IK 分词器</h3><p>首先通过<code>Postman</code>发送<code>GET</code>请求查询分词效果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># GET http<span class="punctuation">:</span><span class="comment">//localhost:9200/_analyze</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;测试单词&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828810-abdbeef5.png"></p>
</div>

<p><code>ES</code>的默认分词器无法识别中文中测试、单词这样的词汇，而是简单的将每个字拆完分为一个词：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;tokens&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;测&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;试&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;单&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;词&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这样的结果显然不符合使用要求，所以需要下载<code>ES</code>对应版本的中文分词器。</p>
<p>这里采用<code>IK</code>中文分词器，<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">下载地址</a>为：<code>https://github.com/medcl/elasticsearch-analysis-ik/</code>。</p>
<p>将解压后的后的文件夹放入<code>ES</code>根目录下的<code>plugins</code>目录下，重启<code>ES</code>即可使用。</p>
<p>这次加入新的查询参数·<code>&quot;analyzer&quot;:&quot;ik_max_word&quot;</code>。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># GET http<span class="punctuation">:</span><span class="comment">//localhost:9200/_analyze</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;测试单词&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span><span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>ik_max_word</code>：会将文本做最细粒度的拆分</li>
<li><code>ik_smart</code>：会将文本做最粗粒度的拆分</li>
</ul>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828846-16e27ee9.png"></p>
</div>

<p>　使用中文分词后的结果为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;tokens&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;测试&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;单词&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>ES</code>中也可以进行扩展词汇，首先查询：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># GET http<span class="punctuation">:</span><span class="comment">//localhost:9200/_analyze</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;弗雷尔卓德&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span><span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828874-a0e0219d.png"></p>
</div>

<p>仅仅可以得到每个字的分词结果，需要做的就是使分词器识别到弗雷尔卓德也是一个词语：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;tokens&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;弗&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;雷&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;尔&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;卓&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;德&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>首先进入<code>ES</code>根目录中的<code>plugins</code>文件夹下的 ik文件夹，进入<code>config</code>目录，创建<code>custom.dic</code>文件，写入弗雷尔卓德。同时打开<code>IKAnalyzer.cfg.xml</code>文件，将新建的<code>custom.dic</code>配置其中，重启<code>ES</code>服务器。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">properties</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_dict&quot;</span>&gt;</span>custom.dic<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	 <span class="comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_stopwords&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &lt;entry key=&quot;remote_ext_dict&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828904-8d0957f2.png"></p>
</div>

<h3 id="自定义分析器"><a href="#自定义分析器" class="headerlink" title="自定义分析器"></a>自定义分析器</h3><p>虽然<code>Elasticsearch</code>带有一些现成的分析器，然而在分析器上<code>Elasticsearch</code>真正的强大之处在于，可以通过在一个适合特定数据的设置之中组合字符过滤器、分词器、词汇单元过滤器来创建自定义的分析器。在分析与分析器说过，一个分析器就是在一个包里面组合了三种函数的一个包装器， 三种函数按照顺序被执行。</p>
<ul>
<li>字符过滤器<br>字符过滤器用来整理一个尚未被分词的字符串。例如，如果文本是<code>HTML</code>格式的，它会包含像 <code>&lt;p&gt;</code>或者<code>&lt;div&gt;</code>这样的<code>HTML</code>标签，这些标签是不想索引的。<br>可以使用<code>html</code>清除字符过滤器来移除掉所有的<code>HTML</code>标签，并且像把<code>&amp;Aacute;</code>转换为相对应的<code>Unicode</code>字符<code>Á</code>这样，转换<code>HTML</code>实体。一个分析器可能有 $0$ 个或者多个字符过滤器。</li>
<li>分词器<br>一个分析器必须有一个唯一的分词器。<br>分词器把字符串分解成单个词条或者词汇单元。<br>标准分析器里使用的标准分词器把一个字符串根据单词边界分解成单个词条，并且移除掉大部分的标点符号，然而还有其他不同行为的分词器存在。<br>例如，关键词分词器完整地输出接收到的同样的字符串，并不做任何分词。<br>空格分词器只根据空格分割文本。正则分词器根据匹配正则表达式来分割文本 。</li>
<li>词单元过滤器<br>经过分词，作为结果的词单元流会按照指定的顺序通过指定的词单元过滤器。<br>词单元过滤器可以修改、添加或者移除词单元。已经提到过<code>lowercase</code>和<code>stop</code>词过滤器，但是在<code>Elasticsearch</code>里面还有很多可供选择的词单元过滤器。词干过滤器把单词遏制为词干。 <code>ascii_folding</code>过滤器移除变音符，把一个像<code>très</code>这样的词转换为<code>tres</code>。<br><code>ngram</code>和<code>edge_ngram</code>词单元过滤器可以产生适合用于部分匹配或者自动补全的词单元。</li>
</ul>
<p>接下来，看看如何创建自定义的分析器：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># PUT http<span class="punctuation">:</span><span class="comment">//localhost:9200/my_index</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;analysis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">            <span class="attr">&quot;char_filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;&amp;_to_and&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mapping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;&amp;=&gt; and &quot;</span><span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;my_stopwords&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stop&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;stopwords&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;the&quot;</span><span class="punctuation">,</span> <span class="string">&quot;a&quot;</span> <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                <span class="attr">&quot;my_analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;custom&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;char_filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;html_strip&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&amp;_to_and&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">                    <span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;lowercase&quot;</span><span class="punctuation">,</span> <span class="string">&quot;my_stopwords&quot;</span> <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828936-6c9c2912.png"></p>
</div>

<p>索引被创建以后，使用<code>analyzeAPI</code>来测试这个新的分析器：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># GET http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9200/my_index/_analyze</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;The quick &amp; brown fox&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_analyzer&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828957-92753551.png"></p>
</div>

<p>下面的缩略结果展示出分析器正在正确地运行：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;tokens&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;quick&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;and&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;brown&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">17</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fox&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="文档处理"><a href="#文档处理" class="headerlink" title="文档处理"></a>文档处理</h1><h2 id="文档冲突"><a href="#文档冲突" class="headerlink" title="文档冲突"></a>文档冲突</h2><p>当使用<code>indexAPI</code>更新文档 ，可以一次性读取原始文档，做修改，然后重新索引整个文档。</p>
<p>最近的索引请求将获胜：无论最后哪一个文档被索引，都将被唯一存储在<code>Elasticsearch</code>中。如果其他人同时更改这个文档，他们的更改将丢失。</p>
<p>很多时候这是没有问题的。也许主数据存储是一个关系型数据库，只是将数据复制到<code>Elasticsearch</code>中并使其可被搜索。也许两个人同时更改相同的文档的几率很小。或者对于业务来说偶尔丢失更改并不是很严重的问题。</p>
<p>但有时丢失了一个变更就是非常严重的 。试想使用<code>Elasticsearch</code>存储网上商城商品库存的数量，<br>每次卖一个商品的时候，在<code>Elasticsearch</code>中将库存数量减少。有一天，管理层决定做一次促销。突然地，一秒要卖好几个商品。 假设有两个<code>web</code>程序并行运行，每一个都同时处理所有商品的销售：</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828992-3e399600.png"></p>
</div>

<p><code>web_1</code>对<code>stock_count</code>所做的更改已经丢失，因为<code>web_2</code>不知道它的<code>stock_count</code>的拷贝已经过期。 结果会认为有超过商品的实际数量的库存，因为卖给顾客的库存商品并不存在，将让用户非常失望。</p>
<p>变更越频繁，读数据和更新数据的间隙越长，也就越可能丢失变更。</p>
<p>在数据库领域中，有两种方法通常被用来确保并发更新时变更不会丢失：</p>
<ul>
<li>悲观并发控制<br>这种方法被关系型数据库广泛使用，它假定有变更冲突可能发生，因此阻塞访问资源以防止冲突。一个典型的例子是读取一行数据之前先将其锁住，确保只有放置锁的线程能够对这行数据进行修改。</li>
<li>乐观并发控制<br><code>Elasticsearch</code>中使用的这种方法假定冲突是不可能发生的，并且不会阻塞正在尝试的操作。 然而，如果源数据在读写当中被修改，更新将会失败。应用程序接下来将决定该如何解决冲突。 例如，可以重试更新、使用新的数据、或者将相关情况报告给用户。</li>
</ul>
<h2 id="乐观并发控制"><a href="#乐观并发控制" class="headerlink" title="乐观并发控制"></a>乐观并发控制</h2><p><code>Elasticsearch</code>是分布式的。当文档创建、更新或删除时，新版本的文档必须复制到集群中的其他节点。<code>Elasticsearch</code>也是异步和并发的，这意味着这些复制请求被并行发送，并且到达目的地时也许顺序是乱的。<code>Elasticsearch</code>需要一种方法确保文档的旧版本不会覆盖新的版本。</p>
<p>之前讨论<code>index</code>，<code>GET</code>和<code>delete</code>请求时，指出每个文档都有一个<code>_version</code>（版本）号，当文档被修改时版本号递增。<code>Elasticsearch</code>使用这个<code>version</code>号来确保变更以正确顺序得到执行。如果旧版本的文档在新版本之后到达，它可以被简单的忽略。</p>
<p>可以利用<code>version</code>号来确保应用中相互冲突的变更不会导致数据丢失。通过指定想要修改文档的 <code>version</code>号来达到这个目的。如果该版本不是当前版本号，请求将会失败。</p>
<p>老的版本<code>ES</code>使用<code>version</code>，但是新版本不支持了，会报下面的错误，提示用<code>if_seq_no</code>和<code>if_primary_term</code>。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639829029-9c9717aa.png"></p>
</div>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;root_cause&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;action_request_validation_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Validation Failed: 1: internal versioning can not be used for optimistic concurrency control. Please use `if_seq_no` and `if_primary_term` instead;&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;action_request_validation_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Validation Failed: 1: internal versioning can not be used for optimistic concurrency control. Please use `if_seq_no` and `if_primary_term` instead;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">400</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639829051-47eab3fb.png"></p>
</div>

<h2 id="外部系统版本控制"><a href="#外部系统版本控制" class="headerlink" title="外部系统版本控制"></a>外部系统版本控制</h2><p>一个常见的设置是使用其它数据库作为主要的数据存储，使用<code>Elasticsearch</code>做数据检索，这意味着主数据库的所有更改发生时都需要被复制到<code>Elasticsearch</code>，如果多个进程负责这一数据同步，可能遇到类似于之前描述的并发问题。</p>
<p>如果主数据库已经有了版本号或一个能作为版本号的字段值比如<code>timestamp</code> — 那么就可以在<code>Elasticsearch</code>中通过增加<code>version_type=external</code>到查询字符串的方式重用这些相同的版本号，<br>版本号必须是大于零的整数，且小于 $9.2E+18$——一个<code>Java</code>中<code>long</code>类型的正值。</p>
<p>外部版本号的处理方式和之前讨论的内部版本号的处理方式有些不同，<code>Elasticsearch</code>不是检查当前<code>_version</code>和请求中指定的版本号是否相同，而是检查当前<code>_version</code>是否小于指定的版本号。如果请求成功，外部的版本号作为文档的新<code>_version</code>进行存储。</p>
<div align="center">

<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639829077-f93c5123.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639829088-5b9bd7e3.png"></p>
</div>

<p>外部版本号不仅在索引和删除请求是可以指定，而且在创建新文档时也可以指定。</p>
<h1 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h1><p><code>Kibana</code>是一个免费且开放的用户界面，能够对<code>Elasticsearch</code>数据进行可视化，并在<code>ElasticStack中</code>进行导航。</p>
<p>可以进行各种操作，从跟踪查询负载，到理解请求如何流经整个应用，都能轻松完成。</p>
<p><a target="_blank" rel="noopener" href="https://artifacts.elastic.co/downloads/kibana/kibana-7.8.0-windows-x86_64.zip">下载地址</a>：<code>https://artifacts.elastic.co/downloads/kibana/kibana-7.8.0-windows-x86_64.zip</code>。</p>
<ol>
<li>解压缩下载的<code>zip</code>文件</li>
<li>修改<code>config/kibana.yml</code>文件 <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认端口server.port: 5601 # ES 服务器的地址</span></span><br><span class="line"><span class="attr">elasticsearch.hosts</span>: <span class="string">[&quot;http://localhost:9200&quot;] </span></span><br><span class="line"><span class="comment"># 索引名</span></span><br><span class="line"><span class="attr">kibana.index</span>: <span class="string">&quot;.kibana&quot;</span></span><br><span class="line"><span class="comment"># 支持中文</span></span><br><span class="line"><span class="attr">i18n.locale</span>: <span class="string">&quot;zh-CN&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><code>Windows</code>环境下执行<code>bin/kibana.bat</code>文件</li>
<li>通过浏览器访问：<code>http://localhost:5601</code></li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Feng Deng</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://atideas.github.io/2021/10/17/ElasticSearch/04.%E8%BF%9B%E9%98%B6/">http://atideas.github.io/2021/10/17/ElasticSearch/04.%E8%BF%9B%E9%98%B6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://atideas.github.io" target="_blank">漂泊者的理想三旬</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ElasticSearch/">ElasticSearch</a></div><div class="post_share"><div class="social-share" data-image="https://img.paulzzh.com/touhou/random" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/atideas/assets/static/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/atideas/assets/static/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/atideas/assets/static/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/atideas/assets/static/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/10/15/ElasticSearch/03.%E7%8E%AF%E5%A2%83/"><img class="prev-cover" src="https://www.dmoe.cc/random.php" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/atideas/assets/static/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">ElasticSearch | 环境</div></div></a></div><div class="next-post pull-right"><a href="/2021/10/21/ElasticSearch/05.%E9%9B%86%E6%88%90/"><img class="next-cover" src="https://www.dmoe.cc/random.php" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/atideas/assets/static/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">ElasticSearch | 集成</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/10/11/ElasticSearch/01.%E6%A6%82%E8%BF%B0/" title="ElasticSearch | 概述"><img class="cover" src="https://img.paulzzh.com/touhou/random" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-11</div><div class="title">ElasticSearch | 概述</div></div></a></div><div><a href="/2021/10/12/ElasticSearch/02.%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/" title="ElasticSearch | 基本操作"><img class="cover" src="https://img.paulzzh.com/touhou/random" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-12</div><div class="title">ElasticSearch | 基本操作</div></div></a></div><div><a href="/2021/10/15/ElasticSearch/03.%E7%8E%AF%E5%A2%83/" title="ElasticSearch | 环境"><img class="cover" src="https://www.dmoe.cc/random.php" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-15</div><div class="title">ElasticSearch | 环境</div></div></a></div><div><a href="/2021/10/21/ElasticSearch/05.%E9%9B%86%E6%88%90/" title="ElasticSearch | 集成"><img class="cover" src="https://www.dmoe.cc/random.php" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-21</div><div class="title">ElasticSearch | 集成</div></div></a></div><div><a href="/2021/10/21/ElasticSearch/06.%E4%BC%98%E5%8C%96%E4%B8%8E%E9%9D%A2%E8%AF%95%E9%A2%98/" title="ElasticSearch | 优化与面试题"><img class="cover" src="https://img.paulzzh.com/touhou/random" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-21</div><div class="title">ElasticSearch | 优化与面试题</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/atideas/assets/static/avatar.jpg" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/atideas/assets/static/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Feng Deng</div><div class="author-info__description">一身转战三千里，一剑曾当百万师</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">175</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">26</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/atideas"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/atideas" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:3153896464@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎访问我的博客！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%EF%BC%88Index%EF%BC%89"><span class="toc-number">1.1.</span> <span class="toc-text">索引（Index）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%EF%BC%88Type%EF%BC%89"><span class="toc-number">1.2.</span> <span class="toc-text">类型（Type）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%EF%BC%88Document%EF%BC%89"><span class="toc-number">1.3.</span> <span class="toc-text">文档（Document）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%EF%BC%88Field%EF%BC%89"><span class="toc-number">1.4.</span> <span class="toc-text">字段（Field）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%98%A0%E5%B0%84%EF%BC%88Mapping%EF%BC%89"><span class="toc-number">1.5.</span> <span class="toc-text">映射（Mapping）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E7%89%87%EF%BC%88Shards%EF%BC%89"><span class="toc-number">1.6.</span> <span class="toc-text">分片（Shards）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%EF%BC%88Replicas%EF%BC%89"><span class="toc-number">1.7.</span> <span class="toc-text">副本（Replicas）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E9%85%8D%EF%BC%88Allocation%EF%BC%89"><span class="toc-number">1.8.</span> <span class="toc-text">分配（Allocation）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">系统架构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4"><span class="toc-number">3.</span> <span class="toc-text">分布式集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4"><span class="toc-number">3.1.</span> <span class="toc-text">单节点集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-number">3.2.</span> <span class="toc-text">故障转移</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%AE%B9"><span class="toc-number">3.3.</span> <span class="toc-text">水平扩容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E5%AF%B9%E6%95%85%E9%9A%9C"><span class="toc-number">3.4.</span> <span class="toc-text">应对故障</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E8%AE%A1%E7%AE%97"><span class="toc-number">4.</span> <span class="toc-text">路由计算</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E7%89%87%E6%8E%A7%E5%88%B6"><span class="toc-number">5.</span> <span class="toc-text">分片控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E6%B5%81%E7%A8%8B"><span class="toc-number">5.0.1.</span> <span class="toc-text">写流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">5.0.2.</span> <span class="toc-text">读流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B"><span class="toc-number">5.0.3.</span> <span class="toc-text">更新流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">5.0.4.</span> <span class="toc-text">多文档操作流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E7%89%87%E5%8E%9F%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">分片原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-number">6.1.</span> <span class="toc-text">倒排索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E6%90%9C%E7%B4%A2"><span class="toc-number">6.2.</span> <span class="toc-text">文档搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%9B%B4%E6%96%B0%E7%B4%A2%E5%BC%95"><span class="toc-number">6.2.1.</span> <span class="toc-text">动态更新索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%91%E5%AE%9E%E6%97%B6%E6%90%9C%E7%B4%A2"><span class="toc-number">6.2.2.</span> <span class="toc-text">近实时搜索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E5%8F%98%E6%9B%B4"><span class="toc-number">6.2.3.</span> <span class="toc-text">持久化变更</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AE%B5%E5%90%88%E5%B9%B6"><span class="toc-number">6.2.4.</span> <span class="toc-text">段合并</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E5%88%86%E6%9E%90"><span class="toc-number">7.</span> <span class="toc-text">文档分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-number">7.0.1.</span> <span class="toc-text">内置分析器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E5%99%A8%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">7.0.2.</span> <span class="toc-text">分析器使用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-number">7.0.3.</span> <span class="toc-text">测试分析器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-number">7.0.4.</span> <span class="toc-text">指定分析器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IK-%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">7.0.5.</span> <span class="toc-text">IK 分词器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-number">7.0.6.</span> <span class="toc-text">自定义分析器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86"><span class="toc-number">8.</span> <span class="toc-text">文档处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E5%86%B2%E7%AA%81"><span class="toc-number">8.1.</span> <span class="toc-text">文档冲突</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%90%E8%A7%82%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="toc-number">8.2.</span> <span class="toc-text">乐观并发控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E7%B3%BB%E7%BB%9F%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6"><span class="toc-number">8.3.</span> <span class="toc-text">外部系统版本控制</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kibana"><span class="toc-number">9.</span> <span class="toc-text">Kibana</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/03/27/%E6%8A%80%E6%9C%AF/03.Hexo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/" title="Hexo | Hexo搭建博客"><img src="https://api.yimian.xyz/img?type=moe&amp;size=1920x1080" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/atideas/assets/static/404.jpg'" alt="Hexo | Hexo搭建博客"/></a><div class="content"><a class="title" href="/2022/03/27/%E6%8A%80%E6%9C%AF/03.Hexo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/" title="Hexo | Hexo搭建博客">Hexo | Hexo搭建博客</a><time datetime="2022-03-27T01:08:15.000Z" title="发表于 2022-03-27 09:08:15">2022-03-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/01/10/SpringCloud/08.%E7%86%94%E6%96%AD%E4%B8%8E%E9%99%90%E6%B5%81/" title="SpringCloud | 熔断与限流"><img src="https://img.paulzzh.com/touhou/random" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/atideas/assets/static/404.jpg'" alt="SpringCloud | 熔断与限流"/></a><div class="content"><a class="title" href="/2022/01/10/SpringCloud/08.%E7%86%94%E6%96%AD%E4%B8%8E%E9%99%90%E6%B5%81/" title="SpringCloud | 熔断与限流">SpringCloud | 熔断与限流</a><time datetime="2022-01-10T13:17:54.000Z" title="发表于 2022-01-10 21:17:54">2022-01-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/01/05/SpringCloud/07.%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/" title="SpringCloud | 服务注册和配置中心"><img src="https://api.ixiaowai.cn/api/api.php" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/atideas/assets/static/404.jpg'" alt="SpringCloud | 服务注册和配置中心"/></a><div class="content"><a class="title" href="/2022/01/05/SpringCloud/07.%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/" title="SpringCloud | 服务注册和配置中心">SpringCloud | 服务注册和配置中心</a><time datetime="2022-01-05T14:19:38.000Z" title="发表于 2022-01-05 22:19:38">2022-01-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/12/30/SpringCloud/06.%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE/" title="SpringCloud | 服务配置"><img src="https://api.ixiaowai.cn/api/api.php" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/atideas/assets/static/404.jpg'" alt="SpringCloud | 服务配置"/></a><div class="content"><a class="title" href="/2021/12/30/SpringCloud/06.%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE/" title="SpringCloud | 服务配置">SpringCloud | 服务配置</a><time datetime="2021-12-30T13:16:50.000Z" title="发表于 2021-12-30 21:16:50">2021-12-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/12/27/SpringCloud/05.%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3/" title="SpringCloud | 服务网关"><img src="https://img.paulzzh.com/touhou/random" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/atideas/assets/static/404.jpg'" alt="SpringCloud | 服务网关"/></a><div class="content"><a class="title" href="/2021/12/27/SpringCloud/05.%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3/" title="SpringCloud | 服务网关">SpringCloud | 服务网关</a><time datetime="2021-12-27T12:34:37.000Z" title="发表于 2021-12-27 20:34:37">2021-12-27</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2022 By Feng Deng</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">愿漂泊的人都有酒喝,孤独的人都会唱歌</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '1UHXekkb2FIztWkcxykWIrb5-9Nh9j0Va',
      appKey: 'paFEd6U94HDMBJ5ejtxfxBwM',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: {"tv_doge":"6ea59c827c414b4a2955fe79e0f6fd3dcd515e24.png","tv_亲亲":"a8111ad55953ef5e3be3327ef94eb4a39d535d06.png","tv_偷笑":"bb690d4107620f1c15cff29509db529a73aee261.png","tv_再见":"180129b8ea851044ce71caf55cc8ce44bd4a4fc8.png","tv_冷漠":"b9cbc755c2b3ee43be07ca13de84e5b699a3f101.png","tv_发怒":"34ba3cd204d5b05fec70ce08fa9fa0dd612409ff.png","tv_发财":"34db290afd2963723c6eb3c4560667db7253a21a.png","tv_可爱":"9e55fd9b500ac4b96613539f1ce2f9499e314ed9.png","tv_吐血":"09dd16a7aa59b77baa1155d47484409624470c77.png","tv_呆":"fe1179ebaa191569b0d31cecafe7a2cd1c951c9d.png","tv_呕吐":"9f996894a39e282ccf5e66856af49483f81870f3.png","tv_困":"241ee304e44c0af029adceb294399391e4737ef2.png","tv_坏笑":"1f0b87f731a671079842116e0991c91c2c88645a.png","tv_大佬":"093c1e2c490161aca397afc45573c877cdead616.png","tv_大哭":"23269aeb35f99daee28dda129676f6e9ea87934f.png","tv_委屈":"d04dba7b5465779e9755d2ab6f0a897b9b33bb77.png","tv_害羞":"a37683fb5642fa3ddfc7f4e5525fd13e42a2bdb1.png","tv_尴尬":"7cfa62dafc59798a3d3fb262d421eeeff166cfa4.png","tv_微笑":"70dc5c7b56f93eb61bddba11e28fb1d18fddcd4c.png","tv_思考":"90cf159733e558137ed20aa04d09964436f618a1.png","tv_惊吓":"0d15c7e2ee58e935adc6a7193ee042388adc22af.png"},
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>