<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Markdown链接小卡片</title>
      <link href="/2021/12/05/%E6%8A%80%E6%9C%AF/02.Markdown%E9%93%BE%E6%8E%A5%E5%B0%8F%E5%8D%A1%E7%89%87/"/>
      <url>/2021/12/05/%E6%8A%80%E6%9C%AF/02.Markdown%E9%93%BE%E6%8E%A5%E5%B0%8F%E5%8D%A1%E7%89%87/</url>
      
        <content type="html"><![CDATA[<p>提醒：需要会写基本的<code>Markdown</code>语法（当然，如果只想学会链接小卡片的话会写图片和链接的语法就可以了）。</p><h1 id="什么是链接小卡片"><a href="#什么是链接小卡片" class="headerlink" title="什么是链接小卡片"></a>什么是链接小卡片</h1><p>实际上叫<code>badge</code>，翻译过来是徽标的意思。因为我每次用这个都是用作链接，而它长得有点像小卡片，所以贴心地起名叫“链接小卡片”。</p><h1 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h1><p>链接小卡片本质上是借助 <a href="https://img.shields.io/"><img src="https://img.shields.io/badge/Shields.io-%E5%85%AB%E6%9C%88?color=222&logo=shieldsdotio"></a> 这个网站来实现的图片。所以会用到 Markdown 图片语法，如果想做成链接，还需用到 Markdown 链接语法。</p><p>所有参数值未加特殊说明均不可省略！</p><p>由于是通过其他网站实现显示图片，所以要想正常显示，必须确保有网。</p><h2 id="单内容链接小卡片"><a href="#单内容链接小卡片" class="headerlink" title="单内容链接小卡片"></a>单内容链接小卡片</h2><p>我把只有一个内容项的称为<strong>单内容链接小卡片</strong>。</p><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/内容-防伪值?color=颜色值</span>)</span><br></pre></td></tr></table></figure><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/未央-八月?color=ff69b4</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/%E6%9C%AA%E5%A4%AE-%E5%85%AB%E6%9C%88?color=ff69b4"></p><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul><li>使用时替换语法代码部分中的汉字内容即可</li><li>颜色值可省略（从 ? 开始省略）</li><li>颜色值均指背景颜色，字体颜色会自动调整，无法自定义字体颜色</li><li>颜色值若使用 16 进制，不要加 # 号</li><li>默认的颜色是：<img src="https://img.shields.io/badge/%E7%BB%BF%E7%9A%84-%E6%9C%AA%E5%A4%AE"></li><li>防伪值只是我是这么叫的，因为它不会显示</li><li>只要出现防伪值，防伪值均不可省略，下同</li></ul><h2 id="双内容链接小卡片"><a href="#双内容链接小卡片" class="headerlink" title="双内容链接小卡片"></a>双内容链接小卡片</h2><p>我把有两个内容项的称为<strong>双内容链接小卡片</strong>。</p><h3 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/前内容-后内容-后内容颜色值</span>)</span><br></pre></td></tr></table></figure><h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/Atideas-未央-fff</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/Atideas-%E6%9C%AA%E5%A4%AE-fff"></p><h3 id="注意事项-1"><a href="#注意事项-1" class="headerlink" title="注意事项"></a>注意事项</h3><ul><li>所有内容均不可省略，包括颜色值</li><li>这里的颜色值只能修改<strong>后内容</strong>的颜色值</li></ul><h2 id="图标链接小卡片"><a href="#图标链接小卡片" class="headerlink" title="图标链接小卡片"></a>图标链接小卡片</h2><p>我把带有小图标的称为<strong>图标链接小卡片</strong>。</p><p>图标链接小卡片又分为<strong>内置图标链接小卡片</strong>和<strong>自定义图标链接小卡片</strong>。</p><h3 id="内置图标链接小卡片"><a href="#内置图标链接小卡片" class="headerlink" title="内置图标链接小卡片"></a>内置图标链接小卡片</h3><p>内置图标可以直接使用。所有内置图标可以在这里找到（点击传送）：<a href="https://simpleicons.org/"><img src="https://img.shields.io/badge/Simple%20Icons-%E5%85%AB%E6%9C%88?color=222&logo=simpleicons"></a></p><h4 id="语法-2"><a href="#语法-2" class="headerlink" title="语法"></a>语法</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 单内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/内容-防伪值?color=颜色&amp;logo=内置图标名</span>)</span><br><span class="line"></span><br><span class="line"><span class="bullet">2.</span> 双内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/前内容-后内容-后内容颜色值?logo=内置图标名</span>)</span><br></pre></td></tr></table></figure><h4 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 单内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/QQ-八月?color=4ab7f5&amp;logo=tencentqq</span>)</span><br><span class="line"></span><br><span class="line"><span class="bullet">2.</span> 双内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/macOS-10.13+-367aff?logo=apple</span>)</span><br></pre></td></tr></table></figure><p>效果：</p><ol><li><p>单内容：<img src="https://img.shields.io/badge/QQ-%E5%85%AB%E6%9C%88?color=4ab7f5&logo=tencentqq"></p></li><li><p>双内容：<img src="https://img.shields.io/badge/macOS-10.13+-367aff?logo=apple"></p></li></ol><h4 id="修改内置图标颜色"><a href="#修改内置图标颜色" class="headerlink" title="修改内置图标颜色"></a>修改内置图标颜色</h4><ul><li>部分内置图标默认是白色的，比如上面的示例</li><li>部分内置图标默认自带颜色，比如：<img src="https://img.shields.io/badge/WeChat-%E5%85%AB%E6%9C%88?color=fff&logo=wechat"> 和 <img src="https://img.shields.io/badge/%E6%94%AF%E4%BB%98%E5%AE%9D-%E5%85%AB%E6%9C%88?color=fff&logo=alipay"> </li><li>哪些默认带颜色，哪些默认不带，需要自己试</li><li>内置图标的颜色可以修改</li></ul><h5 id="语法-3"><a href="#语法-3" class="headerlink" title="语法"></a>语法</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 单内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/内容-防伪值?color=颜色&amp;logo=内置图标名&amp;logoColor=内置图标颜色值</span>)</span><br><span class="line"></span><br><span class="line"><span class="bullet">2.</span> 双内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/前内容-后内容-后内容颜色值?logo=内置图标名&amp;logoColor=内置图标颜色值</span>)</span><br></pre></td></tr></table></figure><h5 id="示例-3"><a href="#示例-3" class="headerlink" title="示例"></a>示例</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 单内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/QQ-八月?color=fff&amp;logo=tencentqq&amp;logoColor=4ab7f5</span>)</span><br><span class="line"></span><br><span class="line"><span class="bullet">2.</span> 双内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/macOS-10.13+-367aff?logo=apple&amp;logoColor=f9d694</span>)</span><br></pre></td></tr></table></figure><p>效果：</p><ol><li><p>单内容：<img src="https://img.shields.io/badge/QQ-%E5%85%AB%E6%9C%88?color=4ab7f5&logo=tencentqq"></p></li><li><p>双内容：<img src="https://img.shields.io/badge/macOS-10.13+-367aff?logo=apple"></p></li></ol><h4 id="自定义图标链接小卡片"><a href="#自定义图标链接小卡片" class="headerlink" title="自定义图标链接小卡片"></a>自定义图标链接小卡片</h4><p>自定义图标需将图片转换成<code>Base64</code>编码（这样的工具很多），同时需要原图片的长和宽均 ≥ 14px。</p><h5 id="语法-4"><a href="#语法-4" class="headerlink" title="语法"></a>语法</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 单内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/内容-防伪值?color=颜色&amp;logo=内置图标名&amp;logoColor=内置图标颜色值</span>)</span><br><span class="line"></span><br><span class="line"><span class="bullet">2.</span> 双内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/前内容-后内容-后内容颜色值?logo=内置图标名&amp;logoColor=内置图标颜色值</span>)</span><br></pre></td></tr></table></figure><h5 id="示例-4"><a href="#示例-4" class="headerlink" title="示例"></a>示例</h5><p>我把自己的头像转换成了<code>Base64</code>编码作为示例，不过编码太长了，放进来严重影响性能，所以就省略不放了。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 单内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/未央-八月?color=fff&amp;logo=data:image/png;base64,AAA...A==</span>)</span><br><span class="line"></span><br><span class="line">;2. 双内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/Atideas-未央-八月?color=fff&amp;logo=data:image/png;base64,AAA...A==</span>)</span><br></pre></td></tr></table></figure><p>效果：</p><ol><li><p>单内容：<img src="https://img.shields.io/badge/%E6%9C%AA%E5%A4%AE-%E5%85%AB%E6%9C%88?color=fff&logo=data:image/jpg;base64,9j"></p></li><li><p>双内容：<img src="https://img.shields.io/badge/Atideas-%E6%9C%AA%E5%A4%AE-%E5%85%AB%E6%9C%88?color=fff&logo=data:image/jpg;base64,9j"></p></li></ol><h2 id="双内容自定义颜色"><a href="#双内容自定义颜色" class="headerlink" title="双内容自定义颜色"></a>双内容自定义颜色</h2><p>前面提及双内容链接小卡片的语法和示例中可修改的颜色值都只能修改后内容的颜色。本小节将演示如何分别控制双内容的颜色。</p><h3 id="语法-5"><a href="#语法-5" class="headerlink" title="语法"></a>语法</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/后内容-防伪值?label=前内容&amp;colorA=前内容颜色值&amp;colorB=后内容颜色值</span>)</span><br></pre></td></tr></table></figure><h3 id="示例-5"><a href="#示例-5" class="headerlink" title="示例"></a>示例</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/macOS-八月?label=AppStore&amp;colorA=fff&amp;colorB=367aff&amp;logo=appstore</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/macOS-%E5%85%AB%E6%9C%88?label=AppStore&colorA=fff&colorB=367aff&logo=appstore"></p><h3 id="注意事项-2"><a href="#注意事项-2" class="headerlink" title="注意事项"></a>注意事项</h3><ul><li>注意图片语法链接中的“前内容”跑到后面去了，“后内容”跑到前面去了，不要搞反了</li><li>如果要加上图标，比如上面的示例，直接在图片语法链接末尾加上<code>&amp;logo=图标名</code>即可，注意<code>&amp;</code>不要忘了</li><li>如果还要修改图标颜色，再继续在链接末尾继续加上<code>&amp;logoColor=图标颜色值</code>即可</li></ul><h2 id="增加超链接"><a href="#增加超链接" class="headerlink" title="增加超链接"></a>增加超链接</h2><p>链接小卡片是可以点的，这是因为在<code>Markdown</code>图片语法外层又套娃了一层超链接语法。</p><h3 id="语法-6"><a href="#语法-6" class="headerlink" title="语法"></a>语法</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">链接小卡片图片显示</span>](<span class="link">超链接地址</span>)</span><br></pre></td></tr></table></figure><h3 id="示例-6"><a href="#示例-6" class="headerlink" title="示例"></a>示例</h3><p>就是把<code>§ 2.1 ~ § 2.4</code>学到的放在超链接语法的 [] 里就行。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">![</span>](<span class="link">https://img.shields.io/badge/未央-八月?color=fff&amp;logo=data:image/png;base64,AAA...A==</span>)](<span class="link">https://atideas.github.io/</span>)</span><br></pre></td></tr></table></figure><p>效果：<a href="https://atideas.github.io/"><img src="https://img.shields.io/badge/%E6%9C%AA%E5%A4%AE-%E5%85%AB%E6%9C%88?color=fff&logo=data:image/png;base64,AAA...A=="></a></p><h3 id="注意事项-3"><a href="#注意事项-3" class="headerlink" title="注意事项"></a>注意事项</h3><ul><li>注意图片语法链接中的“前内容”跑到后面去了，“后内容”跑到前面去了，不要搞反了</li><li>如果要加上图标，比如上面的示例，直接在图片语法链接末尾加上<code>&amp;logo=图标名</code>即可，注意<code>&amp;</code>不要忘了</li><li>如果还要修改图标颜色，再继续在链接末尾继续加上<code>&amp;logoColor=图标颜色值</code>即可</li></ul><p>其他的可以自行尝试。</p><h2 id="样式"><a href="#样式" class="headerlink" title="样式"></a>样式</h2><p>有五种样式可供选择。</p><h3 id="立体胶质圆角矩形"><a href="#立体胶质圆角矩形" class="headerlink" title="立体胶质圆角矩形"></a>立体胶质圆角矩形</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/style=plastic-八月?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git&amp;style=plastic</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/style=plastic-%E5%85%AB%E6%9C%88?label=Git&colorA=fff&colorB=f14d28&logo=git&style=plastic"></p><h3 id="扁平圆角矩形（默认）"><a href="#扁平圆角矩形（默认）" class="headerlink" title="扁平圆角矩形（默认）"></a>扁平圆角矩形（默认）</h3><p>如果什么都不加，默认就相当于<code>&amp;style=flat</code>。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/style=flat-八月?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git&amp;style=flat</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/style=flat-%E5%85%AB%E6%9C%88?label=Git&colorA=fff&colorB=f14d28&logo=git&style=flat"></p><h3 id="扁平直角矩形"><a href="#扁平直角矩形" class="headerlink" title="扁平直角矩形"></a>扁平直角矩形</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/style=flat--square-八月?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git&amp;style=flat-square</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/style=flat--square-%E5%85%AB%E6%9C%88?label=Git&colorA=fff&colorB=f14d28&logo=git&style=flat-square"></p><h3 id="大扁平圆角矩形-字母全大写"><a href="#大扁平圆角矩形-字母全大写" class="headerlink" title="大扁平圆角矩形 - 字母全大写"></a>大扁平圆角矩形 - 字母全大写</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/style=for--the--badge-八月?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git&amp;style=for-the-badge</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/style=for--the--badge-%E5%85%AB%E6%9C%88?label=Git&colorA=fff&colorB=f14d28&logo=git&style=for-the-badge"></p><h3 id="GitHub-交流样式"><a href="#GitHub-交流样式" class="headerlink" title="GitHub 交流样式"></a>GitHub 交流样式</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/style=social-八月?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git&amp;style=social</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/style=social-%E5%85%AB%E6%9C%88?label=Git&colorA=fff&colorB=f14d28&logo=git&style=social"></p><h2 id="动态内容"><a href="#动态内容" class="headerlink" title="动态内容"></a>动态内容</h2><p>动态内容即显示的内容为可变的，主要用于<code>GitHub</code>等网站的某些数据显示。</p><p>这里的动态内容只介绍与<code>GitHub</code>相关的一部分，想了解更多可以去官网查询。</p><p>以<code>Linux</code>之父林纳斯·托瓦斯的<code>Linux</code>源代码仓库<code>torvalds/linux</code>为示例。</p><h3 id="Watch"><a href="#Watch" class="headerlink" title="Watch"></a>Watch</h3><p>语法：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/github/watchers/用户名/仓库名?style=social&amp;label=Watch</span>)</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/github/watchers/torvalds/linux?style=social&amp;label=Watch</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/github/watchers/torvalds/linux?style=social&label=Watch"></p><h3 id="Star"><a href="#Star" class="headerlink" title="Star"></a>Star</h3><p>语法：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/github/stars/用户名/仓库名?style=social</span>)</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/github/stars/torvalds/linux?style=social&amp;label=star</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/github/stars/torvalds/linux?style=social&label=star"></p><h3 id="Fork"><a href="#Fork" class="headerlink" title="Fork"></a>Fork</h3><p>语法：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/github/forks/用户名/仓库名?style=social&amp;label=Fork</span>)</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/github/forks/torvalds/linux?style=social&amp;label=Fork</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/github/forks/torvalds/linux?style=social&label=Fork"></p><p>其他的可以自行尝试。</p><h1 id="特殊符号问题"><a href="#特殊符号问题" class="headerlink" title="特殊符号问题"></a>特殊符号问题</h1><p>有时候需要空格或者其他的特殊符号，直接打在链接里可能会导致结果不符合预期。</p><p>解决方法其实很简单，就是把特殊符号转换成<code>url</code>编码即可。</p><h2 id="空格示例"><a href="#空格示例" class="headerlink" title="空格示例"></a>空格示例</h2><p>之前<code>App Store</code>那个示例中是没有空格的，现在添加空格（空格的<code>url</code>编码是<code>%20</code>）：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/macOS-八月?label=App%20Store&amp;colorA=fff&amp;colorB=367aff&amp;logo=appstore</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/macOS-%E5%85%AB%E6%9C%88?label=App%20Store&colorA=fff&colorB=367aff&logo=appstore"></p><h2 id="短横-符号示例"><a href="#短横-符号示例" class="headerlink" title="短横 - 符号示例"></a>短横 - 符号示例</h2><p>短横符号<code>-</code>比较特殊，它没有<code>url</code>编码，或者说它的<code>url</code>编码就是它本身。 要想在小卡片中显示它也很简单，写两遍就行。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/----everything--is--local-八月?label=git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/----everything--is--local-%E5%85%AB%E6%9C%88?label=git&colorA=fff&colorB=f14d28&logo=git"></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Markdown </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>面向对象设计的SOLID原则</title>
      <link href="/2021/12/04/%E6%8A%80%E6%9C%AF/01.%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E7%9A%84SOLID%E5%8E%9F%E5%88%99/"/>
      <url>/2021/12/04/%E6%8A%80%E6%9C%AF/01.%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E7%9A%84SOLID%E5%8E%9F%E5%88%99/</url>
      
        <content type="html"><![CDATA[<p><code>S.O.L.I.D</code>是面向对象设计和编程（<code>OOD&amp;OOP</code>）中几个重要编码原则（Programming Priciple）的首字母缩写。</p><table><thead><tr><th align="center"><strong>SRP</strong></th><th align="center"><a href="http://www.objectmentor.com/resources/articles/srp.pdf">The Single Responsibility Principle</a><br/></th><th align="center">单一责任原则</th></tr></thead><tbody><tr><td align="center"><strong>OCP</strong></td><td align="center"><a href="http://www.objectmentor.com/resources/articles/ocp.pdf">The Open Closed Principle</a><br/></td><td align="center">开放封闭原则</td></tr><tr><td align="center"><strong>LSP</strong></td><td align="center"><a href="http://www.objectmentor.com/resources/articles/lsp.pdf">The Liskov Substitution Principle</a></td><td align="center">里氏替换原则</td></tr><tr><td align="center"><strong>DIP</strong></td><td align="center"><a href="http://www.objectmentor.com/resources/articles/dip.pdf">The Dependency Inversion Principle</a></td><td align="center">依赖倒置原则</td></tr><tr><td align="center"><strong>ISP</strong></td><td align="center"><a href="http://www.objectmentor.com/resources/articles/isp.pdf">The Interface Segregation Principle</a></td><td align="center">接口分离原则</td></tr></tbody></table><p><a href="http://stevesmithblog.com/">Steve Smith</a>在5月份的微软TechED 2009上有个<a href="http://stevesmithblog.com/blog/teched-2009-session-aftermath/">SOLIDify Your ASP.NET MVC</a>的讲座, <a href="http://www.lostechies.com/members/derick.bailey/default.aspx">derick.bailey</a>的<a href="http://www.lostechies.com/blogs/derickbailey/archive/2009/02/11/solid-development-principles-in-motivational-pictures.aspx">SOLID Development Principles – In Motivational Pictures</a>很好的解释了SOLID原则。</p><h1 id="单一责任原则"><a href="#单一责任原则" class="headerlink" title="单一责任原则"></a>单一责任原则</h1><p>当需要修改某个类的时候原因有且只有一个（<code>THERE SHOULD NEVER BE MORE THAN ONE REASON FOR A CLASS TO CHANGE</code>）。换句话说就是让一个类只做一种类型责任，当这个类需要承当其他类型的责任的时候，就需要分解这个类。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets//blog/1638580256/1639479537-3625ee4b.png" title="The Single Responsibility Principle"></p></div><h1 id="开放封闭原则"><a href="#开放封闭原则" class="headerlink" title="开放封闭原则"></a>开放封闭原则</h1><p>软件实体应该是可扩展，而不可修改的。也就是说，对扩展是开放的，而对修改是封闭的。这个原则是诸多面向对象编程原则中最抽象、最难理解的一个。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets//blog/1638580256/1639479579-620695e9.png" title="Open Closed Principle"></p></div><h1 id="里氏替换原则"><a href="#里氏替换原则" class="headerlink" title="里氏替换原则"></a>里氏替换原则</h1><p>当一个子类的实例应该能够替换任何其超类的实例时，它们之间才具有<code>is-A</code>关系。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets//blog/1638580256/1639479664-eec4a030.png" title="Liskov Subtitution Principle"></p></div><h1 id="依赖倒置原则"><a href="#依赖倒置原则" class="headerlink" title="依赖倒置原则"></a>依赖倒置原则</h1><ol><li>高层模块不应该依赖于低层模块，二者都应该依赖于抽象</li><li>抽象不应该依赖于细节，细节应该依赖于抽象</li></ol><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets//blog/1638580256/1639479695-20bdd418.png" title="Dependency Inversion Principle"></p></div><h1 id="接口分离原则"><a href="#接口分离原则" class="headerlink" title="接口分离原则"></a>接口分离原则</h1><p>不能强迫用户去依赖那些他们不使用的接口。换句话说，使用多个专门的接口比使用单一的总接口总要好。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets//blog/1638580256/1639479768-7deecc37.png" title="Interface Segregation Principle"></p></div><p>这几条原则是非常基础而且重要的面向对象设计原则。正是由于这些原则的基础性，理解、融汇贯通这些原则需要不少的经验和知识的积累。上述的图片很好的注释了这几条原则。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 面向对象 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>正则表达式介绍</title>
      <link href="/2021/12/03/%E6%8A%80%E6%9C%AF/%E6%AD%A3%E5%88%99/01.%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%BB%8B%E7%BB%8D/"/>
      <url>/2021/12/03/%E6%8A%80%E6%9C%AF/%E6%AD%A3%E5%88%99/01.%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%BB%8B%E7%BB%8D/</url>
      
        <content type="html"><![CDATA[<h1 id="什么是正则表达式？"><a href="#什么是正则表达式？" class="headerlink" title="什么是正则表达式？"></a>什么是正则表达式？</h1><blockquote><p>正则表达式是一组由字母和符号组成的特殊文本, 它可以用来从文本中找出满足你想要的格式的句子。</p></blockquote><p>一个正则表达式是在一个主体字符串中从左到右匹配字符串时的一种样式。例如<code>Regular expression</code>是一个完整的句子，但我们常使用缩写的术语<code>regex</code>或<code>regexp</code>。</p><p>正则表达式可以用来替换文本中的字符串、验证形式、提取字符串等等。</p><p>想象你正在写一个应用，然后你想设定一个用户命名的规则，让用户名包含字符、数字、下划线和连字符以及限制字符的个数，好让名字看起来没那么丑。</p><p>我们使用以下正则表达式来验证一个用户名:</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets//blog/1638522453/1639473212-1926fd4f.png"></p></div><p>以上的正则表达式可以接受 <code>john_doe</code>, <code>jo-hn_doe</code>, <code>john12_as</code>，但不匹配<code>Jo</code>，因为它包含了大写的字母而且太短了。</p><h1 id="基本匹配"><a href="#基本匹配" class="headerlink" title="基本匹配"></a>基本匹配</h1><p>正则表达式其实就是在执行搜索时的格式，它由一些字母和数字组合而成。</p><p>例如: 一个正则表达式 <code>the</code>，它表示一个规则：由字母<code>t</code>开始,接着是<code>h</code>,再接着是<code>e</code>.</p><blockquote><p>“the” =&gt; The fat cat sat on <strong>the</strong> mat.</p></blockquote><p>正则表达式<code>123</code>匹配字符串<code>123</code>。它逐个字符的与输入的正则表达式做比较。</p><p>正则表达式是大小写敏感的，所以<code>The</code>不会匹配<code>the</code></p><blockquote><p>“The” =&gt; <strong>The</strong> fat cat sat on the mat.</p></blockquote><h1 id="元字符"><a href="#元字符" class="headerlink" title="元字符"></a>元字符</h1><p>正则表达式主要依赖于元字符。</p><p>元字符不代表他们本身的字面意思，他们都有特殊的含义。</p><p>一些元字符写在方括号中的时候有一些特殊的意思.。</p><p>以下是一些元字符的介绍:</p><table><thead><tr><th align="center">元字符</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">.</td><td align="center">句号匹配任意单个字符除了换行符</td></tr><tr><td align="center">[ ]</td><td align="center">字符种类. 匹配方括号内的任意字符</td></tr><tr><td align="center">[^ ]</td><td align="center">否定的字符种类. 匹配除了方括号里的任意字符</td></tr><tr><td align="center">*</td><td align="center">匹配&gt;=0个重复的在*号之前的字符</td></tr><tr><td align="center">+</td><td align="center">匹配&gt;1个重复的+号前的字符</td></tr><tr><td align="center">?</td><td align="center">标记?之前的字符为可选</td></tr><tr><td align="center">{n,m}</td><td align="center">匹配num个中括号之前的字符 (n &lt;= num &lt;= m)</td></tr><tr><td align="center">(xyz)</td><td align="center">字符集, 匹配与 xyz 完全相等的字符串</td></tr><tr><td align="center">&#124;</td><td align="center">或运算符,匹配符号前或后的字符</td></tr><tr><td align="center">&#92;</td><td align="center">转义字符,用于匹配一些保留的字符 <code>[ ] ( ) &#123; &#125; . * + ? ^ $ \</td></tr><tr><td align="center">^</td><td align="center">从开始行开始匹配</td></tr><tr><td align="center">$</td><td align="center">从末端开始匹配</td></tr></tbody></table><h2 id="点运算符"><a href="#点运算符" class="headerlink" title="点运算符 ."></a>点运算符 <code>.</code></h2><p><code>.</code>是元字符中最简单的例子。</p><p><code>.</code>匹配任意单个字符，但不匹配换行符。</p><p>例如，表达式<code>.ar</code>匹配一个任意字符后面跟着是<code>a</code>和<code>r</code>的字符串。</p><blockquote><p>“.ar” =&gt; The <strong>car par</strong>ked in the <strong>gar</strong>age</p></blockquote><h2 id="字符集"><a href="#字符集" class="headerlink" title="字符集"></a>字符集</h2><p>字符集也叫做字符类。</p><p>方括号用来指定一个字符集，在方括号中使用连字符来指定字符集的范围；在方括号中的字符集不关心顺序。</p><p>例如，表达式<code>[Tt]he</code> 匹配 <code>the</code> 和 <code>The</code>。</p><blockquote><p>“[Tt]he” =&gt; <strong>The</strong> car parked in <strong>the</strong> garage.</p></blockquote><p>方括号的句号就表示句号。</p><p>表达式 <code>ar[.]</code> 匹配 <code>ar.</code>字符串。</p><blockquote><p>“ar[.]” =&gt; A garage is a good place to park a c<strong>ar</strong></p></blockquote><h3 id="否定字符集"><a href="#否定字符集" class="headerlink" title="否定字符集"></a>否定字符集</h3><p>一般来说 <code>^</code> 表示一个字符串的开头，但它用在一个方括号的开头的时候表示这个字符集是否定的。</p><p>例如, 表达式<code>[^c]ar</code> 匹配一个后面跟着<code>ar</code>的除了<code>c</code>的任意字。</p><blockquote><p>“[^c]ar” =&gt; The car <strong>par</strong>ked in the <strong>gar</strong>age.</p></blockquote><h2 id="重复次数"><a href="#重复次数" class="headerlink" title="重复次数"></a>重复次数</h2><p>后面跟着元字符<code>+</code>、<code>*</code>、<code>?</code> 的，用来指定匹配子模式的次数。这些元字符在不同的情况下有着不同的意思。</p><h3 id="号"><a href="#号" class="headerlink" title="* 号"></a><code>*</code> 号</h3><p><code>*</code>号匹配在<code>*</code>之前的字符出现<code>大于等于0</code>次。</p><p>例如，表达式<code>a*</code>匹配以<code>0</code>或更多个<code>a</code>开头的字符，因为有<code>0</code>个这个条件，其实也就匹配了所有的字符。表达式<code>[a-z]*</code>匹配一个行中所有以小写字母开头的字符串。</p><blockquote><p>“[a-z]<em>“ =&gt; T*<em>he car parked in the garage</em></em>.</p></blockquote><p><code>*</code>字符和<code>.</code>字符搭配可以匹配所有的字符<code>.*</code>。</p><p><code>*</code>和表示匹配空格的符号<code>\s</code>连起来用, 如表达式<code>\s*cat\s*</code>匹配<code>0</code>或更多个空格开头和<code>0</code>或更多个空格结尾的<code>cat</code>字符串。</p><blockquote><p>“\s*cat\s*“ =&gt; The fat <strong>cat</strong> sat on the con<strong>cat</strong>enation</p></blockquote><h3 id="号-1"><a href="#号-1" class="headerlink" title="+ 号"></a><code>+</code> 号</h3><p><code>+</code>号匹配<code>+</code>号之前的字符出现<code>&gt;=1</code>次个字符。</p><p>例如，表达式<code>c.+t</code> 匹配以首字母<code>c</code>开头以<code>t</code>结尾,中间跟着任意个字符的字符串。</p><blockquote><p>“c.+t” =&gt; The fat <strong>cat sat  on the mat</strong>.</p></blockquote><h3 id="号-2"><a href="#号-2" class="headerlink" title="? 号"></a><code>?</code> 号</h3><p>在正则表达式中元字符 <code>?</code> 标记在符号前面的字符为可选, 即出现<code>0</code>或<code>1</code>次。</p><p>例如，表达式<code>[T]?he</code>匹配字符串<code>he</code>和<code>The</code>。</p><blockquote><p>“[T]he” =&gt; <strong>The</strong> car is parked in the garage.</p><p>“[T]?he” =&gt; <strong>The</strong> car is parked in t<strong>he</strong> garage.</p></blockquote><h2 id="号-3"><a href="#号-3" class="headerlink" title="{} 号"></a><code>&#123;&#125;</code> 号</h2><p>在正则表达式中 <code>&#123;&#125;</code> 是一个量词，常用来一个或一组字符可以重复出现的次数。</p><p>例如，表达式 <code>[0-9]&#123;2,3&#125;</code> 匹配<code>2~3</code>位<code>0~9</code>的数字.</p><blockquote><p>“[0-9]{2,3}” =&gt; The number was 9.<strong>999</strong>7 but we rounded it off to <strong>10</strong>.0.</p></blockquote><p>我们可以省略第二个参数。</p><p>例如，<code>[0-9]&#123;2,&#125;</code>匹配至少两位<code>0~9</code>的数字。</p><blockquote><p>“[0-9]{2,}” =&gt; The number was 9.<strong>9997</strong> but we rounded it off to <strong>10</strong>.0.</p></blockquote><p>如果逗号也省略掉则表示重复固定的次数。<br>例如, <code>[0-9]&#123;3&#125;</code> 匹配<code>3</code>位数字。</p><blockquote><p>“[0-9]{3}” =&gt; The number was 9.<strong>999</strong>7 but we rounded it off to 10.0.</p></blockquote><h2 id="特征标群"><a href="#特征标群" class="headerlink" title="(...) 特征标群"></a><code>(...)</code> 特征标群</h2><p>特征标群是一组写在 <code>(...)</code> 中的子模式。</p><p>例如之前说的<code>&#123;&#125;</code>是用来表示前面一个字符出现指定次数，但如果在<code>&#123;&#125;</code>前加入特征标群则表示整个标群内的字符重复<code>N</code>次。</p><p>例如, 表达式<code>(ab)*</code>匹配连续出现<code>0</code>或更多个<code>ab</code>。</p><p>我们还可以在<code>()</code>中用或字符<code>|</code>表示或。</p><p>例如，<code>(c|g|p)ar</code>匹配<code>car</code>或<code>gar</code>或<code>par</code>。</p><blockquote><p>“(c|g|p)ar” =&gt; The <strong>car</strong> is <strong>par</strong>ked in the <strong>gar</strong>age.</p></blockquote><h2 id="或运算符"><a href="#或运算符" class="headerlink" title="| 或运算符"></a><code>|</code> 或运算符</h2><p>或运算符就表示或，用作判断条件。</p><p>例如<code>(T|t)he|car</code>匹配<code>(T|t)he</code> 或 <code>car</code>。</p><blockquote><p>“(T|t)he|car” =&gt; <strong>The car</strong> is parked in <strong>the</strong> garage.</p></blockquote><h2 id="转码特殊字符"><a href="#转码特殊字符" class="headerlink" title="转码特殊字符"></a>转码特殊字符</h2><p>反斜线<code>\</code>在表达式中用于转码紧跟其后的字符。用于指定<code>&#123; &#125; [ ] / \ + * . $ ^ | ?</code>这些特殊字符，如果想要匹配这些特殊字符则要在其前面加上反斜线<code>\</code>。</p><p>例如<code>.</code>是用来匹配除换行符外的所有字符的，如果想要匹配句子中的<code>.</code>则要写成<code>\.</code>。</p><blockquote><p>“(f|c|m)at.?” =&gt; The <strong>fat cat</strong> sat on the <strong>mat</strong>.</p></blockquote><h2 id="锚点"><a href="#锚点" class="headerlink" title="锚点"></a>锚点</h2><p>在正则表达式中, 想要匹配指定开头或结尾的字符串就要使用到锚点. <code>^</code> 指定开头, <code>$</code> 指定结尾.</p><h3 id="号-4"><a href="#号-4" class="headerlink" title="^ 号"></a><code>^</code> 号</h3><p><code>^</code>用来检查匹配的字符串是否在所匹配字符串的开头。</p><p>例如，在<code>abc</code>中使用表达式<code>^a</code>会得到结果<code>a</code>，但如果使用<code>^b</code>将匹配不到任何结果，因为在字符串<code>abc</code>中并不是以<code>b</code>开头。</p><p>例如，<code>^(T|t)he</code>匹配以<code>The</code>或<code>the</code>开头的字符串。</p><blockquote><p>“(T|t)he” =&gt; The car is parked in <strong>the</strong> garage.</p><p>“^(T|t)he” =&gt; <strong>The</strong> car is parked in the garage.</p></blockquote><h3 id="号-5"><a href="#号-5" class="headerlink" title="$ 号"></a><code>$</code> 号</h3><p>同理于<code>^</code>号，<code>$</code>号用来匹配字符是否是最后一个。</p><p>例如，<code>(at\.)$</code>匹配以<code>at.</code>结尾的字符串。</p><blockquote><p>“(at.)” =&gt; The fat c<strong>at.</strong> s<strong>at.</strong> on the mat.</p><p>“(at.)$” =&gt; The fat cat. sat. on the m<strong>at.</strong></p></blockquote><h2 id="简写字符集"><a href="#简写字符集" class="headerlink" title="简写字符集"></a>简写字符集</h2><p>正则表达式提供一些常用的字符集简写. 如下:</p><table><thead><tr><th align="center">简写</th><th>描述</th></tr></thead><tbody><tr><td align="center">.</td><td>除换行符外的所有字符</td></tr><tr><td align="center">\w</td><td>匹配所有字母数字, 等同于 <code>[a-zA-Z0-9_]</code></td></tr><tr><td align="center">\W</td><td>匹配所有非字母数字, 即符号, 等同于: <code>[^\w]</code></td></tr><tr><td align="center">\d</td><td>匹配数字: <code>[0-9]</code></td></tr><tr><td align="center">\D</td><td>匹配非数字: <code>[^\d]</code></td></tr><tr><td align="center">\s</td><td>匹配所有空格字符, 等同于: <code>[\t\n\f\r\p&#123;Z&#125;]</code></td></tr><tr><td align="center">\S</td><td>匹配所有非空格字符: <code>[^\s]</code></td></tr></tbody></table><h2 id="前后关联约束（前后预查）"><a href="#前后关联约束（前后预查）" class="headerlink" title="前后关联约束（前后预查）"></a>前后关联约束（前后预查）</h2><p>前置约束和后置约束都属于<strong>非捕获簇</strong>（用于匹配不在匹配列表中的格式）。</p><p>前置约束用于判断所匹配的格式是否在另一个确定的格式之后。</p><p>例如，我们想要获得所有跟在<code>$</code>符号后的数字，我们可以使用正向向后约束<code>(?&lt;=\$)[0-9\.]*</code>。这个表达式匹配<code>$</code>开头，之后跟着<code>0,1,2,3,4,5,6,7,8,9,.</code>这些字符可以出现大于等于<code>0</code>次。</p><p>前后关联约束如下：</p><table><thead><tr><th align="center">符号</th><th>描述</th></tr></thead><tbody><tr><td align="center">?=</td><td>前置约束-存在</td></tr><tr><td align="center">?!</td><td>前置约束-排除</td></tr><tr><td align="center">?&lt;=</td><td>后置约束-存在</td></tr><tr><td align="center">?&lt;!</td><td>后置约束-排除</td></tr></tbody></table><h3 id="前置约束（存在）"><a href="#前置约束（存在）" class="headerlink" title="?=... 前置约束（存在）"></a><code>?=...</code> 前置约束（存在）</h3><p><code>?=...</code>前置约束（存在），表示第一部分表达式必须跟在<code>?=...</code>定义的表达式之后。</p><p>返回结果只瞒住第一部分表达式。</p><p>定义一个前置约束（存在）要使用<code>()</code>，在括号内部使用一个问号和等号：<code>(?=...)</code>.</p><p>前置约束的内容写在括号中的等号后面。</p><p>例如，表达式<code>[T|t]he(?=\sfat)</code>匹配<code>The</code>和<code>the</code>，在括号中我们又定义了前置约束（存在）<code>(?=\sfat)</code>，即<code>The</code>和<code>the</code>后面紧跟着<code>(空格)fat</code>。</p><blockquote><p>“[T|t]he(?=\sfat)” =&gt; <strong>The</strong> fat cat sat on the mat.</p></blockquote><h3 id="前置约束-排除"><a href="#前置约束-排除" class="headerlink" title="?!... 前置约束-排除"></a><code>?!...</code> 前置约束-排除</h3><p>前置约束-排除<code>?!</code>用于筛选所有匹配结果，筛选条件为其后不跟随着定义的格式。</p><p><code>前置约束-排除</code>的定义和<code>前置约束(存在)</code>一样, 区别就是<code>=</code>替换成<code>!</code>也就是<code>(?!...)</code>。</p><p>表达式<code>[T|t]he(?!\sfat)</code>匹配<code>The</code>和<code>the</code>，且其后不跟着 <code>(空格)fat</code>。</p><blockquote><p>“[T|t]he(?!\sfat)” =&gt; The fat cat sat on <strong>the</strong> mat.</p></blockquote><h3 id="lt-后置约束-存在"><a href="#lt-后置约束-存在" class="headerlink" title="?&lt;= ... 后置约束-存在"></a><code>?&lt;= ...</code> 后置约束-存在</h3><p>后置约束-存在记作<code>(?&lt;=...)</code>，用于筛选所有匹配结果，筛选条件为 其前跟随着定义的格式。</p><p>例如，表达式<code>(?&lt;=[T|t]he\s)(fat|mat)</code>匹配<code>fat</code>和<code>mat</code>，且其前跟着<code>The</code>或<code>the</code>。</p><blockquote><p>“(?&lt;=[T|t]he\s)(fat|mat)” =&gt; The <strong>fat</strong> cat sat on the <strong>mat</strong>.</p></blockquote><h3 id="lt-后置约束-排除"><a href="#lt-后置约束-排除" class="headerlink" title="?&lt;!... 后置约束-排除"></a><code>?&lt;!...</code> 后置约束-排除</h3><p>后置约束-排除记作<code>(?&lt;!...)</code>，用于筛选所有匹配结果，筛选条件为其前不跟着定义的格式。</p><p>例如，表达式<code>(?&lt;!(T|t)he\s)(cat)</code>匹配<code>cat</code>，且其前不跟着<code>The</code>或<code>the</code>。</p><blockquote><p>“(?&lt;![T|t]he\s)(cat)” =&gt; The cat sat on <strong>cat</strong>.</p></blockquote><h2 id="标志"><a href="#标志" class="headerlink" title="标志"></a>标志</h2><p>标志也叫修饰语，因为它可以用来修改表达式的搜索结果。这些标志可以任意的组合使用，它也是整个正则表达式的一部分。</p><table><thead><tr><th align="center">标志</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">i</td><td align="center">忽略大小写</td></tr><tr><td align="center">g</td><td align="center">全局搜索</td></tr><tr><td align="center">m</td><td align="center">多行的: 锚点元字符 <code>^</code> <code>$</code> 工作范围在每行的起始</td></tr></tbody></table><h3 id="忽略大小写（Case-Insensitive）"><a href="#忽略大小写（Case-Insensitive）" class="headerlink" title="忽略大小写（Case Insensitive）"></a>忽略大小写（Case Insensitive）</h3><p>修饰语<code>i</code>用于忽略大小写。</p><p>例如，表达式<code>/The/gi</code>表示在全局搜索<code>The</code>，在后面的<code>i</code>将其条件修改为忽略大小写，则变成搜索<code>the</code>和 <code>The</code>，<code>g</code>表示全局搜索。</p><blockquote><p>“The” =&gt; <strong>The</strong> fat cat sat on the mat.</p><p>“/The/gi” =&gt; <strong>The</strong> fat cat sat on <strong>the</strong> mat.</p></blockquote><h3 id="全局搜索（Global-search）"><a href="#全局搜索（Global-search）" class="headerlink" title="全局搜索（Global search）"></a>全局搜索（Global search）</h3><p>修饰符<code>g</code>常用于执行一个全局搜索匹配，即（不仅仅返回第一个匹配的，而是返回全部）。</p><p>例如，表达式<code>/.(at)/g</code>表示搜索任意字符（除了换行）+<code>at</code>，并返回全部结果。</p><blockquote><p>“/.(at)/“ =&gt; The <strong>fat</strong> cat sat on the mat.</p><p>“/.(at)/g” =&gt; The <strong>fat cat sat</strong> ont the <strong>mat</strong>.</p></blockquote><h3 id="多行修饰符（Multiline）"><a href="#多行修饰符（Multiline）" class="headerlink" title="多行修饰符（Multiline）"></a>多行修饰符（Multiline）</h3><p>多行修饰符<code>m</code>常用于执行一个多行匹配.</p><p>像之前介绍的<code>(^,$)</code>用于检查格式是否是在待检测字符串的开头或结尾，但我们如果想要它在每行的开头和结尾生效，我们需要用到多行修饰符<code>m</code>。</p><p>例如，表达式<code>/at(.)?$/gm</code>表示在待检测字符串每行的末尾搜索<code>at</code>后跟一个或多个<code>.</code>的字符串，并返回全部结果。</p><p>　　</p><blockquote><p>“/.at(.)?$/“ =&gt; The fat cat sat on the <strong>mat.</strong></p></blockquote><blockquote><p>“/.at(.)?$/gm” =&gt; The fat cat <strong>sat</strong> on the <strong>mat.</strong></p></blockquote><h2 id="额外补充"><a href="#额外补充" class="headerlink" title="额外补充"></a>额外补充</h2><ul><li>正整数：<code>^\d+$</code></li><li>负整数：<code>^-\d+$</code></li><li>手机国家号：<code>^+?[\d\s]&#123;3,&#125;$</code></li><li>手机号：<code>^+?[\d\s]+(?[\d\s]&#123;10,&#125;$</code></li><li>整数：<code>^-?\d+$</code></li><li>用户名：<code>^[\w\d_.]&#123;4,16&#125;$</code></li><li>数字和英文字母：<code>^[a-zA-Z0-9]*$</code></li><li>数字和应为字母和空格：<code>^[a-zA-Z0-9 ]*$</code></li><li>密码：<code>^(?=^.&#123;6,&#125;$)((?=.*[A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z]))^.*$</code></li><li>邮箱：<code>^([a-zA-Z0-9._%-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]&#123;2,4&#125;)*$</code></li><li>IP4 地址：<code>^((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.)&#123;3&#125;(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))*$</code></li><li>纯小写字母：<code>^([a-z])*$</code></li><li>纯大写字母：<code>^([A-Z])*$</code></li><li>URL：<code>^(((http|https|ftp):\/\/)?([[a-zA-Z0-9]\-\.])+(\.)([[a-zA-Z0-9]])&#123;2,4&#125;([[a-zA-Z0-9]\/+=%&amp;_\.~?\-]*))*$</code></li><li>VISA 信用卡号：<code>^(4[0-9]&#123;12&#125;(?:[0-9]&#123;3&#125;)?)*$</code></li><li>日期 (MM/DD/YYYY)：<code>^(0?[1-9]|1[012])[- /.](0?[1-9]|[12][0-9]|3[01])[- /.](19|20)?[0-9]&#123;2&#125;$</code></li><li>日期 (YYYY/MM/DD)：<code>^(19|20)?[0-9]&#123;2&#125;[- /.](0?[1-9]|1[012])[- /.](0?[1-9]|[12][0-9]|3[01])$</code></li><li>MasterCard 信用卡号：<code>^(5[1-5][0-9]&#123;14&#125;)*$</code></li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 正则 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IDEA注释模板</title>
      <link href="/2021/12/02/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/01.IDEA%E6%B3%A8%E9%87%8A%E6%A8%A1%E6%9D%BF/"/>
      <url>/2021/12/02/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/01.IDEA%E6%B3%A8%E9%87%8A%E6%A8%A1%E6%9D%BF/</url>
      
        <content type="html"><![CDATA[<h1 id="类注释"><a href="#类注释" class="headerlink" title="类注释"></a>类注释</h1><p>打开<code>IDEA</code>的<code>Settings</code>，点击<code>Editor--&gt;File and Code Templates</code>，点击右边<code>File</code>选项卡下面的<code>Class</code>，在其中添加下面的内容：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">if</span> ($&#123;PACKAGE_NAME&#125; &amp;&amp; $&#123;PACKAGE_NAME&#125; != <span class="string">&quot;&quot;</span>)<span class="keyword">package</span> $&#123;PACKAGE_NAME&#125;;#end</span><br><span class="line">#parse(<span class="string">&quot;File Header.java&quot;</span>)</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> echo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> $&#123;YEAR&#125;年 $&#123;MONTH&#125;月 $&#123;DAY&#125;日 $&#123;TIME&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">$</span>&#123;NAME&#125; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><center><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets//blog/1638440757/1639447118-cca895f6.png"></p></center><p>在我提供的示例模板中，说明了作者和时间，<code>IDEA</code>支持的所有的模板参数在下方的<code>description</code>中被列出来。</p><p>保存后，当你创建一个新的类的时候就会自动添加类注释。如果你想对接口也生效，同时配置上图中的<code>Interface</code>项即可。</p><h1 id="方法注释"><a href="#方法注释" class="headerlink" title="方法注释"></a>方法注释</h1><p>不同于目前网络上互相复制粘贴的方法注释教程，本文将实现以下功能：</p><ul><li><p>根据形参数目自动生成<code>@param</code>注解</p></li><li><p>根据方法是否有返回值智能生成<code>@return</code>注解</p></li></ul><p>相较于类模板，为方法添加注释模板就较为复杂，首先在 <code>Settings</code>中点击<code>Editor--&gt;Live Templates</code>。</p><p>点击最右边的<code>+</code>，首先选择<code>2. Template Group...</code>来创建一个模板分组：</p><center><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets//blog/1638440757/1639447293-826a9a69.png"></p></center><p>在弹出的对话框中填写分组名，我这里叫做<code>userDefine</code>：</p><center><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets//blog/1638440757/1639447268-7e879ed1.png"></p></center><p>然后选中刚刚创建的模板分组<code>userDefine</code>，然后点击<code>+</code>，选择<code>1. Live Template</code>：</p><center><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets//blog/1638440757/1639447312-09f1391e.png"></p></center><p>此时就会创建了一个空的模板，我们修改该模板的<code>Abbreviation、Description</code>和<code>Template text</code>。需要注意的是，<code>Abbreviation</code>必须为<code>*</code>，最后检查下<code>Expand with</code>的值是否为<code>Enter</code>键。</p><center><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets//blog/1638440757/1639447330-b80388cc.png"></p></center><p>上图中· <code>Template text</code>内容如下，需要注意首行没有 <code>/</code>，且<code>*</code>是顶格的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">*</span><br><span class="line"> *</span><br><span class="line"> * <span class="meta">@author</span> echo</span><br><span class="line"> * <span class="meta">@date</span> $date$ $time$$param$ $<span class="keyword">return</span>$</span><br><span class="line"> */</span><br></pre></td></tr></table></figure><p>注意到右下角的<code>No applicable contexts yet</code>了吗，这说明此时这个模板还没有指定应用的语言。</p><p>点击<code>Define</code>，在弹框中勾选<code>Java</code>，表示将该模板应用于所有的<code>Java</code>类型文件。</p><center><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets//blog/1638440757/1639447344-023bef64.png"></p></center><h2 id="设置applicable-contexts"><a href="#设置applicable-contexts" class="headerlink" title="设置applicable contexts"></a>设置<code>applicable contexts</code></h2><p>还记得我们配置<code>Template text</code>时里面包含了类似于<code>$date$</code>这样的参数，此时<code>IDEA</code>还不认识这些参数是啥玩意，下面我们对这些参数进行方法映射，让<code>IDEA</code>能够明白这些参数的含义。</p><p>点击<code>Edit variables</code>按钮：</p><center><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets//blog/1638440757/1639447361-36bb9d1a.png"></p></center><p>为每一个参数设置相对应的<code>Expression</code>：</p><center><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets//blog/1638440757/1639447378-41b78fa9.png"></p></center><h2 id="设置Expression"><a href="#设置Expression" class="headerlink" title="设置Expression"></a>设置<code>Expression</code></h2><p>需要注意的是，<code>date</code>和<code>time</code>的<code>Expression</code>使用的是<code>IDEA</code>内置的函数，直接使用下拉框选择就可以了，而<code>param</code>这个参数<code>IDEA</code>默认的实现很差，因此我们需要手动实现，代码如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groovyScript(&quot;def result = &#x27;&#x27;;def params = \&quot;$&#123;_1&#125;\&quot;.replaceAll(&#x27;[\\\\[|\\\\]|\\\\s]&#x27;, &#x27;&#x27;).split(&#x27;,&#x27;).toList(); for(i = 0; i &lt; params.size(); i++) &#123;if(params[i] != &#x27;&#x27;)result+=&#x27;* @param &#x27; + params[i] + ((i &lt; params.size() - 1) ? &#x27;\\r\\n &#x27; : &#x27;&#x27;)&#125;; return result == &#x27;&#x27; ? null : &#x27;\\r\\n &#x27; + result&quot;, methodParameters())</span><br></pre></td></tr></table></figure><p>另外<code>return</code>这个参数也要实现了下，代码如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groovyScript(&quot;return \&quot;$&#123;_1&#125;\&quot; == &#x27;void&#x27; ? null : &#x27;\\r\\n * @return &#x27; + \&quot;$&#123;_1&#125;\&quot;&quot;, methodReturnType())</span><br></pre></td></tr></table></figure><blockquote><p>注：你还注意到我并没有勾选<code>Skip if defined</code>属性，它的意思是如果在生成注释时候如果这一项被定义了，那么鼠标光标就会直接跳过它。我并不需要这个功能，因此有被勾选该属性。</p></blockquote><p>点击<code>OK</code>保存设置，大功告成！</p><h1 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h1><ol><li><p>为什么模板的<code>Abbreviation</code>一定要叫<code>*</code>？<code>Expand with</code>要保证是<code>Enter</code>键？</p><blockquote><p>答：因为<code>IDEA</code>模板的生成逻辑是<code>模板名 + 生成键</code>，当生成键是<code>Enter</code>时，我们输入<code>* + Enter</code>就能够触发模板。<br> 这也同时说明了为什么注释模板首行是一个<code>*</code>了，因为当我们先输入<code>/*</code>，然后输入<code>* + Enter</code>，触发模板，首行正好拼成了<code>/**</code>，符合<code>Javadoc</code>的规范。</p></blockquote></li><li><p>注释模板中为什么有一行空的<code>*</code>？</p><blockquote><p>答：因为我习惯在这一行写方法说明，所以就预留了一行空的写，你也可以把它删掉。</p></blockquote></li><li><p>注释模板中<code>$time$$param$</code> `这两个明明不相干的东西为什么紧贴在一起？</p><blockquote><p>答：首先网上提供的大部分<code>param</code>生成函数在无参情况下仍然会生成一行空的<code>@param</code>，因此我对<code>param</code>函数的代码进行修改，使得在无参情况下不生成<code>@param</code>，但是这就要求<code>$param$</code>要和别人处在同一行中，不然没法处理退格。</p></blockquote></li><li><p>为什么<code>return</code>参数不使用<code>methodReturnType()</code>， 而要自己实现？</p><blockquote><p>答：<code>methodReturnType()</code>在无返回值的情况下会返回<code>void</code>，这并没有什么意义，因此我对<code>methodReturnType()</code>返回值进行了处理，仅在有返回值时才生成。</p></blockquote></li><li><p>为什么<code>$return$</code> `不是单独一行？</p><blockquote><p>答：因为当<code>methodReturnType()</code>返回<code>null</code>时，无法处理退格问题，原因同第三点。</p></blockquote></li></ol>]]></content>
      
      
      <categories>
          
          <category> 开发工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> IDEA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2021/12/01/%E9%9A%8F%E7%AC%94/01.Hello%20World/"/>
      <url>/2021/12/01/%E9%9A%8F%E7%AC%94/01.Hello%20World/</url>
      
        <content type="html"><![CDATA[<blockquote><h1 id="你好"><a href="#你好" class="headerlink" title="你好"></a>你好</h1></blockquote><p>欢迎来到我的博客，今天，2021年12月1日，是我的博客的出生日。</p><p>这篇文章是用来测试的，因为博客刚跟建立，所以可能会有一些小问题，还请多多包涵。如果遇到问题，可以在评论区给我留言。</p><p>如果您也有博客，欢迎前往<a href="/link/">友链</a>，在评论区中留言与我互换友链信息。</p><center><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets//blog/static/helloworld.jpg"></p></center><blockquote><h1 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World!"></a>Hello World!</h1></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> main&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello, World&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>发布确认高级、其他知识点与集群</title>
      <link href="/2021/11/27/RabbitMQ/04.%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4%E9%AB%98%E7%BA%A7%E3%80%81%E5%85%B6%E4%BB%96%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%8E%E9%9B%86%E7%BE%A4/"/>
      <url>/2021/11/27/RabbitMQ/04.%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4%E9%AB%98%E7%BA%A7%E3%80%81%E5%85%B6%E4%BB%96%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%8E%E9%9B%86%E7%BE%A4/</url>
      
        <content type="html"><![CDATA[<h1 id="发布确认高级"><a href="#发布确认高级" class="headerlink" title="发布确认高级"></a>发布确认高级</h1><p>在生产环境中由于一些不明原因，会导致<code>RabbitMQ</code>重启，在<code>RabbitMQ</code>重启期间生产者消息投递失败，导致消息丢失，需要手动处理和恢复。那么，如何才能进行<code>RabbitMQ</code>的消息可靠投递呢？特别是在这样比较极端的情况，<code>RabbitMQ</code>集群不可用的时候，无法投递的消息该如何处理呢？</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">应 用 [xxx] 在 [08-1516:36:04] 发 生 [ 错 误 日 志 异 常 ] ， alertId=[xxx] 。 由</span><br><span class="line">[org.springframework.amqp.rabbit.listener.BlockingQueueConsumer:start:620] 触 发 。</span><br><span class="line">应用 xxx 可能原因如下</span><br><span class="line">服 务 名 为 ：</span><br><span class="line">异 常 为 ： org.springframework.amqp.rabbit.listener.BlockingQueueConsumer:start:620,</span><br><span class="line">产 生 原 因 如 下 :1.org.springframework.amqp.rabbit.listener.QueuesNotAvailableException:</span><br><span class="line">Cannot prepare queue <span class="keyword">for</span> listener. Either the queue doesn<span class="string">&#x27;t exist or the broker will not</span></span><br><span class="line"><span class="string">allow us to use it.||Consumer received fatal=false exception on startup:</span></span><br></pre></td></tr></table></figure><h2 id="发布确认-SpringBoot-版本"><a href="#发布确认-SpringBoot-版本" class="headerlink" title="发布确认 SpringBoot 版本"></a>发布确认 SpringBoot 版本</h2><h3 id="确认机制方案"><a href="#确认机制方案" class="headerlink" title="确认机制方案"></a>确认机制方案</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639814295-a5f937a7.png"></p></div><h3 id="代码架构图"><a href="#代码架构图" class="headerlink" title="代码架构图"></a>代码架构图</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639814326-4ab69b2f.png"></p></div><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ul><li><p>配置文件<br>在配置文件当中需要添加：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.rabbitmq.publisher-confirm-type</span>=<span class="string">correlated</span></span><br></pre></td></tr></table></figure><ul><li><code>NONE</code>：禁用发布确认模式，是默认值</li><li><code>CORRELATED</code>：发布消息成功到交换器后会触发回调方法</li><li><code>SIMPLE</code>：经测试有两种效果<ul><li>效果和<code>CORRELATED</code>值一样会触发回调方法</li><li>在发布消息成功后使用<code>rabbitTemplate</code>调用<code>waitForConfirms</code>或<code>waitForConfirmsOrDie</code>方法等待<code>broker</code>节点返回发送结果，根据返回结果来判定下一步的逻辑，要注意的点是<code>waitForConfirmsOrDie</code>方法如果返回<code>false</code>则会关闭<code>channel</code>，则接下来无法发送消息到<code>broker</code></li></ul></li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.rabbitmq.host</span>=<span class="string">192.168.30.129</span></span><br><span class="line"><span class="attr">spring.rabbitmq.port</span>=<span class="string">5672</span></span><br><span class="line"><span class="attr">spring.rabbitmq.username</span>=<span class="string">admin</span></span><br><span class="line"><span class="attr">spring.rabbitmq.password</span>=<span class="string">admin</span></span><br><span class="line"><span class="attr">spring.rabbitmq.publisher-confirm-type</span>=<span class="string">correlated</span></span><br></pre></td></tr></table></figure></li><li><p>配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfirmConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIRM_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIRM_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明业务 Exchange</span></span><br><span class="line"><span class="comment">     * 确认交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;confirmExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">confirmExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(CONFIRM_EXCHANGE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明确认队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;confirmQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">confirmQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(CONFIRM_QUEUE_NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明确认队列绑定关系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queue</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">queueBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;confirmQueue&quot;)</span> Queue queue,</span></span><br><span class="line"><span class="params">                                <span class="meta">@Qualifier(&quot;confirmExchange&quot;)</span> DirectExchange exchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>消息生产者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/confirm&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIRM_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyCallBack myCallBack;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 先依赖注入 rabbitTemplate，之后再设置它的回调对象</span></span><br><span class="line"><span class="comment">     * 在初始化是设置回调对象，这样当消息发送到交换机时才能触发发布确认</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        rabbitTemplate.setConfirmCallback(myCallBack);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;sendMessage/&#123;message&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(<span class="meta">@PathVariable</span> String message)</span>&#123;</span><br><span class="line">        <span class="comment">// 指定消息 id 为 1</span></span><br><span class="line">        CorrelationData correlationData1=<span class="keyword">new</span> <span class="title class_">CorrelationData</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        String routingKey=<span class="string">&quot;key1&quot;</span>;</span><br><span class="line">        rabbitTemplate.convertAndSend(CONFIRM_EXCHANGE_NAME,routingKey,message+routingKey,correlationData1);</span><br><span class="line"></span><br><span class="line">        CorrelationData correlationData2=<span class="keyword">new</span> <span class="title class_">CorrelationData</span>(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        routingKey=<span class="string">&quot;key2&quot;</span>;</span><br><span class="line">        rabbitTemplate.convertAndSend(CONFIRM_EXCHANGE_NAME,routingKey,message+routingKey,correlationData2);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;发送消息内容:&#123;&#125;&quot;</span>,message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>回调接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 回调接口实现类</span></span><br><span class="line"><span class="comment"> * 发布确认回调：当发布消息成功到交换器后会触发回调方法，给生产者发确认信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCallBack</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交换机不管是否收到消息的一个回调方法</span></span><br><span class="line"><span class="comment">     * CorrelationData</span></span><br><span class="line"><span class="comment">     * 消息相关数据</span></span><br><span class="line"><span class="comment">     * ack</span></span><br><span class="line"><span class="comment">     * 交换机是否收到消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> &#123;</span><br><span class="line"></span><br><span class="line">        String id=correlationData!=<span class="literal">null</span>?correlationData.getId():<span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(ack)&#123;</span><br><span class="line">            log.info(<span class="string">&quot;交换机已经收到 id 为:&#123;&#125;的消息&quot;</span>,id);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            log.info(<span class="string">&quot;交换机还未收到 id 为:&#123;&#125;消息,由于原因:&#123;&#125;&quot;</span>,id,cause);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>消息消费者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfirmConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIRM_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.queue&quot;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@RabbitListener(queues =CONFIRM_QUEUE_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveMsg</span><span class="params">(Message message)</span> &#123; </span><br><span class="line">        String msg=<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody());</span><br><span class="line">        log.info(<span class="string">&quot;接受到队列 confirm.queue 消息:&#123;&#125;&quot;</span>,msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="结果分析"><a href="#结果分析" class="headerlink" title="结果分析"></a>结果分析</h3><p>访问：<a href="http://127.0.0.1:8080/confirm/sendMessage/111">127.0.0.1:8080/confirm/sendMessage/111</a></p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639814382-5cc2eef6.png"></p></div><p>可以看到，发送了两条消息，第一条消息的<code>RoutingKey</code>为<code>key1</code>，第二条消息的<code>RoutingKey</code>为<code>key2</code>，两条消息都成功被交换机接收，也收到了交换机的确认回调，但消费者只收到了一条消息，第二条消息因为交换机没有和队列绑定，也没有其它队列能接收这个消息，所以第二条消息被直接丢弃了。</p><h2 id="回退消息"><a href="#回退消息" class="headerlink" title="回退消息"></a>回退消息</h2><h3 id="Mandatory-参数"><a href="#Mandatory-参数" class="headerlink" title="Mandatory 参数"></a>Mandatory 参数</h3><p><strong>在仅开启了生产者确认机制的情况下，交换机接收到消息后，会直接给消息生产者发送确认消息，如果发现该消息不可路由，那么消息会被直接丢弃，此时生产者是不知道消息被丢弃这个事件的。</strong></p><p>那么如何处理无法被路由的消息？最起码通知生产者一声，让它自己处理啊。通过设置<code>mandatory</code>参数可以在当消息传递过程中不可达目的地时将消息返回给生产者。</p><ul><li>消息生产者<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/confirm&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageProducer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyCallBack myCallBack;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 先将 rabbitTemplate 注入，之后就设置回调函数等</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        rabbitTemplate.setConfirmCallback(myCallBack);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置 Mandatory 参数</span></span><br><span class="line"><span class="comment">         * true：</span></span><br><span class="line"><span class="comment">         * 交换机无法将消息进行路由时，会将该消息返回给生产者</span></span><br><span class="line"><span class="comment">         * false：</span></span><br><span class="line"><span class="comment">         * 如果发现消息无法进行路由，则直接丢弃</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        rabbitTemplate.setMandatory(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 设置回退消息交给谁处理</span></span><br><span class="line">        rabbitTemplate.setReturnCallback(myCallBack);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;sendMessage&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String message)</span>&#123;</span><br><span class="line">        <span class="comment">// 让消息绑定一个 id 值</span></span><br><span class="line">        <span class="type">CorrelationData</span> <span class="variable">correlationData1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>(UUID.randomUUID().toString());</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;confirm.exchange&quot;</span>,<span class="string">&quot;key1&quot;</span>,message+<span class="string">&quot;key1&quot;</span>,correlationData1);</span><br><span class="line">        log.info(<span class="string">&quot;发送消息 id 为:&#123;&#125;内容为&#123;&#125;&quot;</span>,correlationData1.getId(),message+<span class="string">&quot;key1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">CorrelationData</span> <span class="variable">correlationData2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>(UUID.randomUUID().toString());</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;confirm.exchange&quot;</span>,<span class="string">&quot;key2&quot;</span>,message+<span class="string">&quot;key2&quot;</span>,correlationData2);</span><br><span class="line">        log.info(<span class="string">&quot;发送消息 id 为:&#123;&#125;内容为&#123;&#125;&quot;</span>,correlationData2.getId(),message+<span class="string">&quot;key2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>回调接口<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 回调接口实现类</span></span><br><span class="line"><span class="comment"> * 发布确认回调：当发布消息成功到交换器后会触发回调方法，给生产者发确认信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCallBack</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback, RabbitTemplate.ReturnCallback&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交换机不管是否收到消息的一个回调方法</span></span><br><span class="line"><span class="comment">     * CorrelationData</span></span><br><span class="line"><span class="comment">     * 消息相关数据</span></span><br><span class="line"><span class="comment">     * ack</span></span><br><span class="line"><span class="comment">     * 交换机是否收到消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> &#123;</span><br><span class="line"></span><br><span class="line">        String id=correlationData!=<span class="literal">null</span>?correlationData.getId():<span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(ack)&#123;</span><br><span class="line">            log.info(<span class="string">&quot;交换机已经收到 id 为:&#123;&#125;的消息&quot;</span>,id);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            log.info(<span class="string">&quot;交换机还未收到 id 为:&#123;&#125;消息,由于原因:&#123;&#125;&quot;</span>,id,cause);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当消息无法路由的时候的回调方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> replyCode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> replyText</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> routingKey</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(Message message, <span class="type">int</span> replyCode,</span></span><br><span class="line"><span class="params">                                String replyText, String exchange, String routingKey)</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot; 消 息 &#123;&#125;, 被 交 换 机 &#123;&#125; 退 回 ， 退 回 原 因 :&#123;&#125;, 路 由 key:&#123;&#125;&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()),exchange,replyText,routingKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="结果分析-1"><a href="#结果分析-1" class="headerlink" title="结果分析"></a>结果分析</h3><p>访问：<a href="http://127.0.0.1:8080/confirm/sendMessage">127.0.0.1:8080/confirm/sendMessage</a></p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639814428-e16f2e34.png"></p></div><h2 id="备份交换机"><a href="#备份交换机" class="headerlink" title="备份交换机"></a>备份交换机</h2><p>有了<code>mandatory</code>参数和回退消息，获得了对无法投递消息的感知能力，有机会在生产者的消息无法被投递时发现并处理。但有时候并不知道该如何处理这些无法路由的消息，最多打个日志，然后触发报警，再来手动处理。</p><p>而通过日志来处理这些无法路由的消息是很不优雅的做法，特别是当生产者所在的服务有多台机器的时候，手动复制日志会更加麻烦而且容易出错。而且设置<code>mandatory</code>参数会增加生产者的复杂性，需要添加处理这些被退回的消息的逻辑。如果既不想丢失消息，又不想增加生产者的复杂性，该怎么做呢？</p><p>前面在设置死信队列的文章中，提到过可以为队列设置死信交换机来存储那些处理失败的消息，可是这些不可路由消息根本没有机会进入到队列，因此无法使用死信队列来保存消息。  </p><p>在<code>RabbitMQ</code>中，有一种备份交换机的机制存在，可以很好的应对这个问题。</p><p>什么是备份交换机呢？</p><p>备份交换机可以理解为<code>RabbitMQ</code>中交换机的“备胎”，当为某一个交换机声明一个对应的备份交换机时，就是为它创建一个备胎，当交换机接收到一条不可路由消息时，将会把这条消息转发到备份交换机中，由备份交换机来进行转发和处理，通常备份交换机的类型为<code>Fanout</code>，这样就能把所有消息都投递到与其绑定的队列中，然后在备份交换机下绑定一个队列，这样所有那些原交换机无法被路由的消息，就会都进入这个队列了。当然，还可以建立一个报警队列，用独立的消费者来进行监测和报警。</p><h3 id="代码架构图-1"><a href="#代码架构图-1" class="headerlink" title="代码架构图"></a>代码架构图</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639814479-f6b3551c.png"></p></div><h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><ul><li>配置类<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfirmConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIRM_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIRM_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BACKUP_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;backup.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BACKUP_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;backup.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WARNING_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;warning.queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明确认队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;confirmQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">confirmQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(CONFIRM_QUEUE_NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明确认队列绑定关系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queue</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">queueBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;confirmQueue&quot;)</span> Queue queue,</span></span><br><span class="line"><span class="params">                                <span class="meta">@Qualifier(&quot;confirmExchange&quot;)</span> DirectExchange exchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明备份 Exchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;backupExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">backupExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(BACKUP_EXCHANGE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明确认 Exchange 交换机的备份交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;confirmExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">confirmExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ExchangeBuilder</span> <span class="variable">exchangeBuilder</span> <span class="operator">=</span> ExchangeBuilder</span><br><span class="line">                .directExchange(CONFIRM_EXCHANGE_NAME)</span><br><span class="line">                .durable(<span class="literal">true</span>)</span><br><span class="line">                <span class="comment">// 设置该交换机的备份交换机</span></span><br><span class="line">                .withArgument(<span class="string">&quot;alternate-exchange&quot;</span>, BACKUP_EXCHANGE_NAME);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> (DirectExchange)exchangeBuilder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明警告队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;warningQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">warningQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(WARNING_QUEUE_NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明报警队列绑定关系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queue</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> backupExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">warningBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;warningQueue&quot;)</span> Queue queue,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@Qualifier(&quot;backupExchange&quot;)</span> FanoutExchange</span></span><br><span class="line"><span class="params">                                          backupExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(backupExchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明备份队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;backQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">backQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BACKUP_QUEUE_NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明备份队列绑定关系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queue</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> backupExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">backupBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;backQueue&quot;)</span> Queue queue,</span></span><br><span class="line"><span class="params">                                 <span class="meta">@Qualifier(&quot;backupExchange&quot;)</span> FanoutExchange backupExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(backupExchange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>报警消费者<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WarningConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WARNING_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;warning.queue&quot;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@RabbitListener(queues = WARNING_QUEUE_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveWarningMsg</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody());</span><br><span class="line">        log.error(<span class="string">&quot;报警发现不可路由消息：&#123;&#125;&quot;</span>, msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="测试注意事项"><a href="#测试注意事项" class="headerlink" title="测试注意事项"></a>测试注意事项</h3><p>重新启动项目的时候需要把原来的<code>confirm.exchange</code>删除，因为修改了其绑定属性，不然报以下错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inequivalent arg <span class="string">&#x27;alternate-exchange&#x27;</span> <span class="keyword">for</span> exchange <span class="string">&#x27;confirm.exchange&#x27;</span> <span class="keyword">in</span> vhost <span class="string">&#x27;/&#x27;</span>: received the value <span class="string">&#x27;backup.exchange&#x27;</span> of <span class="built_in">type</span> <span class="string">&#x27;longstr&#x27;</span> but current is none, class-id=40, method-id=10)</span><br></pre></td></tr></table></figure><h3 id="结果分析-2"><a href="#结果分析-2" class="headerlink" title="结果分析"></a>结果分析</h3><p>访问：<a href="http://127.0.0.1:8080/confirm/sendMessage/111">127.0.0.1:8080/confirm/sendMessage/111</a></p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639814522-08db6c8e.png"></p></div><p><code>mandatory</code>参数与备份交换机可以一起使用的时候，如果两者同时开启，消息究竟何去何从？谁优先级高，经过上面结果显示答案是备份交换机优先级高。</p><h1 id="RabbitMQ-其他知识点"><a href="#RabbitMQ-其他知识点" class="headerlink" title="RabbitMQ 其他知识点"></a>RabbitMQ 其他知识点</h1><h2 id="幂等性"><a href="#幂等性" class="headerlink" title="幂等性"></a>幂等性</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用。</p><p>举个最简单的例子，那就是支付，用户购买商品后支付，支付扣款成功，但是返回结果的时候网络异常，此时钱已经扣了，用户再次点击按钮，此时会进行第二次扣款，返回结果成功，用户查询余额发现多扣钱了，流水记录也变成了两条。</p><p>在以前的单应用系统中，只需要把数据操作放入事务中即可，发生错误立即回滚，但是再响应客户端的时候也有可能出现网络中断或者异常等等。</p><h3 id="消息重复消费"><a href="#消息重复消费" class="headerlink" title="消息重复消费"></a>消息重复消费</h3><p>消费者在消费<code>MQ</code>中的消息时，<code>MQ</code>已把消息发送给消费者，消费者在给<code>MQ</code>返回<code>ack</code>时网络中断，故<code>MQ</code>未收到确认信息，该条消息会重新发给其他的消费者，或者在网络重连后再次发送给该消费者，但实际上该消费者已成功消费了该条消息，造成消费者消费了重复的消息。</p><h3 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h3><p><code>MQ</code>消费者的幂等性的解决一般使用全局<code>ID</code>或者写个唯一标识，比如时间戳或者<code>UUID</code>或者订单消费者消费<code>MQ</code>中的消息，也可利用<code>MQ</code>的该<code>ID</code>来判断，或者可按自己的规则生成一个全局唯一<code>ID</code>，每次消费消息时用该<code>ID</code>先判断该消息是否已消费过。</p><h3 id="消费端的幂等性保障"><a href="#消费端的幂等性保障" class="headerlink" title="消费端的幂等性保障"></a>消费端的幂等性保障</h3><p>在海量订单生成的业务高峰期，生产端有可能就会重复发生了消息，这时候消费端就要实现幂等性，这就意味着我们的消息永远不会被消费多次，即使收到了一样的消息。业界主流的幂等性有两种操作：</p><ol><li>唯一<code>ID</code>+指纹码机制，利用数据库主键去重<ul><li>指纹码：一些规则或者时间戳加别的服务给到的唯一信息码，它并不一定是系统生成的，基本都是由业务规则拼接而来，但是一定要保证唯一性，然后就利用查询语句进行判断这个<code>ID</code>是否存在数据库中<ul><li>优势就是实现简单就一个拼接，然后查询判断是否重复</li><li>劣势就是在高并发时，如果是单个数据库就会有写入性能瓶颈，当然也可以采用分库分表提升性能，但也不是最推荐的方式。</li></ul></li></ul></li><li>利用<code>Redis</code>的原子性去实现<ul><li>利用<code>Redis</code>执行<code>setnx</code>命令，天然具有幂等性。从而实现不重复消费</li></ul></li></ol><h2 id="优先级队列"><a href="#优先级队列" class="headerlink" title="优先级队列"></a>优先级队列</h2><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p>在系统中有一个订单催付的场景，客户在天猫下的订单，淘宝会及时将订单推送给系统，如果在用户设定的时间内未付款那么就会给用户推送一条短信提醒，但是，<code>tmall</code>商家肯定是要分大客户和小客户的，比如像苹果，小米这样大商家一年起码能创造很大的利润，所以理应当然，他们的订单必须得到优先处理。</p><p>而曾经的后端系统是使用<code>Redis</code>来存放的定时轮询，大家都知道<code>Redis</code>只能用<code>List</code>做一个简简单单的消息队列，并不能实现一个优先级的场景，所以订单量大了后采用<code>RabbitMQ</code>进行改造和优化,如果发现是大客户的订单给一个相对比较高的优先级，否则就是默认优先级。</p><h3 id="如何添加"><a href="#如何添加" class="headerlink" title="如何添加"></a>如何添加</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639814614-66a007e3.png"></p></div><ol><li>控制台页面添加<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639814634-92424719.png"></li><li>队列中代码添加优先级 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">params.put(<span class="string">&quot;x-max-priority&quot;</span>, <span class="number">10</span>);</span><br><span class="line">channel.queueDeclare(<span class="string">&quot;hello&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, params);</span><br></pre></td></tr></table></figure></li><li>消息中代码添加优先级 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AMQP.<span class="type">BasicProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AMQP</span>.BasicProperties().builder().priority(<span class="number">5</span>).build();</span><br></pre></td></tr></table></figure></li><li>注意事项<br> 要让队列实现优先级需要做的事情有如下事情：<ol><li>队列需要设置为优先级队列</li><li>消息需要设置消息的优先级</li><li>消费者需要等待消息已经发送到队列中才去消费，因为这样才有机会对消息进行排序</li></ol></li></ol><h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><ul><li>消息生产者<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME=<span class="string">&quot;hello&quot;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();) &#123;</span><br><span class="line">            <span class="comment">// 给消息赋予一个 priority 属性</span></span><br><span class="line">            AMQP.<span class="type">BasicProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AMQP</span>.BasicProperties().builder().priority(<span class="number">5</span>).build();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;<span class="number">11</span>; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;info&quot;</span>+i;</span><br><span class="line">                <span class="keyword">if</span>(i==<span class="number">5</span>)&#123;</span><br><span class="line">                    channel.basicPublish(<span class="string">&quot;&quot;</span>, QUEUE_NAME, properties, message.getBytes());</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    channel.basicPublish(<span class="string">&quot;&quot;</span>, QUEUE_NAME, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;发送消息完成:&quot;</span> + message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>消息消费者<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME=<span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        <span class="comment">// 设置队列的最大优先级，最大可以设置到 255，官网推荐 1-10，如果设置太高比较吃内存和 CPU</span></span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">&quot;x-max-priority&quot;</span>, <span class="number">10</span>);</span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, params);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;消费者启动等待消费..............&quot;</span>);</span><br><span class="line"></span><br><span class="line">        DeliverCallback deliverCallback=(consumerTag, delivery) -&gt;&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">receivedMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody());</span><br><span class="line">            System.out.println(<span class="string">&quot;接收到消息:&quot;</span>+receivedMessage);</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(QUEUE_NAME,<span class="literal">true</span>,deliverCallback,(consumerTag) -&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;消费者无法消费消息时调用，如队列被删除&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="惰性队列"><a href="#惰性队列" class="headerlink" title="惰性队列"></a>惰性队列</h2><h3 id="使用场景-1"><a href="#使用场景-1" class="headerlink" title="使用场景"></a>使用场景</h3><p><code>RabbitMQ</code>从 $3.6.0$ 版本开始引入了惰性队列的概念。</p><p>惰性队列会尽可能的将消息存入磁盘中，而在消费者消费到相应的消息时才会被加载到内存中，它的一个重要的设计目标是能够支持更长的队列，即支持更多的消息存储。当消费者由于各种各样的原因（比如消费者下线、宕机亦或者是由于维护而关闭等）而致使长时间内不能消费消息造成堆积时，惰性队列就很有必要了。</p><p>默认情况下，当生产者将消息发送到<code>RabbitMQ</code>的时候，队列中的消息会尽可能的存储在内存之，这样可以更加快速的将消息发送给消费者。即使是持久化的消息，在被写入磁盘的同时也会在内存中驻留一份备份。当<code>RabbitMQ</code>需要释放内存的时候，会将内存中的消息换页至磁盘中，这个操作会耗费较长的时间，也会阻塞队列的操作，进而无法接收新的消息。</p><p>虽然<code>RabbitMQ</code>的开发者们一直在升级相关的算法，但是效果始终不太理想，尤其是在消息量特别大的时候。</p><h3 id="两种模式"><a href="#两种模式" class="headerlink" title="两种模式"></a>两种模式</h3><p>队列具备两种模式：<code>default</code>和<code>lazy</code>。默认的为<code>default</code>模式，在 $3.6.0$ 之前的版本无需做任何变更。</p><p><code>lazy</code>模式即为惰性队列的模式，可以通过调用<code>channel.queueDeclare</code>方法的时候在参数中设置，也可以通过<code>Policy</code>的方式设置，如果一个队列同时使用这两种方式设置的话，那么<code>Policy</code>的方式具备更高的优先级。如果要通过声明的方式改变已有队列的模式的话，那么只能先删除队列，然后再重新声明一个新的。</p><p>在队列声明的时候可以通过<code>x-queue-mode</code>参数来设置队列的模式，取值为<code>default</code>和<code>lazy</code>。下面示例中演示了一个惰性队列的声明细节：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">args.put(<span class="string">&quot;x-queue-mode&quot;</span>, <span class="string">&quot;lazy&quot;</span>);</span><br><span class="line">channel.queueDeclare(<span class="string">&quot;myqueue&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, args);</span><br></pre></td></tr></table></figure><h3 id="内存开销对比"><a href="#内存开销对比" class="headerlink" title="内存开销对比"></a>内存开销对比</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639814702-a29f5d48.png"></p></div><p>在发送 $1$ 百万条消息，每条消息大概占 $1$ <code>KB</code>的情况下，普通队列占用内存是 $1.2$ <code>GB</code>，而惰性队列仅仅占用 $1.5$ <code>MB</code>。</p><h1 id="RabbitMQ-集群"><a href="#RabbitMQ-集群" class="headerlink" title="RabbitMQ 集群"></a>RabbitMQ 集群</h1><h2 id="clustering"><a href="#clustering" class="headerlink" title="clustering"></a>clustering</h2><h3 id="使用集群的原因"><a href="#使用集群的原因" class="headerlink" title="使用集群的原因"></a>使用集群的原因</h3><p>最开始介绍了如何安装及运行<code>RabbitMQ</code>服务，不过这些是单机版的，无法满足目前真实应用的要求。如果<code>RabbitMQ</code>服务器遇到内存崩溃、机器掉电或者主板故障等情况，该怎么办？</p><p>单台<code>RabbitMQ</code>服务器可以满足每秒 $1000$ 条消息的吞吐量，那么如果应用需要<code>RabbitMQ</code>服务满足每秒 $10$ 万条消息的吞吐量呢？购买昂贵的服务器来增强单机<code>RabbitMQ</code>的性能显得捉襟见肘，搭建一个<code>RabbitMQ</code>集群才是解决实际问题的关键.</p><h3 id="搭建步骤"><a href="#搭建步骤" class="headerlink" title="搭建步骤"></a>搭建步骤</h3><ol><li>修改 $3$ 台机器的主机名称（修改后需重启） <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hostname</span><br></pre></td></tr></table></figure></li><li>配置各个节点的<code>hosts</code>文件，让各个节点都能互相识别对方 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line">192.168.30.129 centos01</span><br><span class="line">192.168.30.134 centos02</span><br><span class="line">192.168.30.130 centos03</span><br></pre></td></tr></table></figure></li><li>以确保各个节点的<code>cookie</code>文件使用的是同一个值<br> 在<code>centos01</code>上执行远程操作命令（先将各个节点上的防火墙关闭） <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos01 ~]<span class="comment"># scp /var/lib/rabbitmq/.erlang.cookie root@centos02:/var/lib/rabbitmq/.erlang.cookie</span></span><br><span class="line">[root@centos01 ~]<span class="comment"># scp /var/lib/rabbitmq/.erlang.cookie root@centos03:/var/lib/rabbitmq/.erlang.cookie</span></span><br></pre></td></tr></table></figure></li><li>启动<code>RabbitMQ</code>服务,顺带启动<code>Erlang</code>虚拟机和<code>RbbitMQ</code>应用服务（在三台节点上分别执行以下命令） <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-server -detached</span><br></pre></td></tr></table></figure></li><li>在节点 $2$ 执行 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rabbitmqctl stop 会将Erlang 虚拟机关闭，rabbitmqctl stop_app 只关闭 RabbitMQ 服务</span></span><br><span class="line">[root@centos02 ~]<span class="comment"># rabbitmqctl stop_app</span></span><br><span class="line">[root@centos02 ~]<span class="comment"># rabbitmqctl reset</span></span><br><span class="line">[root@centos02 ~]<span class="comment"># rabbitmqctl join_cluster rabbit@centos01</span></span><br><span class="line"><span class="comment"># 只启动应用服务</span></span><br><span class="line">[root@centos02 ~]<span class="comment"># rabbitmqctl start_app</span></span><br></pre></td></tr></table></figure></li><li>在节点 $3$ 执行 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos03 ~]<span class="comment"># rabbitmqctl stop_app</span></span><br><span class="line">[root@centos03 ~]<span class="comment"># rabbitmqctl reset</span></span><br><span class="line">[root@centos03 ~]<span class="comment"># rabbitmqctl join_cluster rabbit@centos02</span></span><br><span class="line">[root@centos03 ~]<span class="comment"># rabbitmqctl start_app</span></span><br></pre></td></tr></table></figure></li><li>集群状态（任意节点执行） <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl cluster_status</span><br></pre></td></tr></table></figure></li><li>需要重新设置用户<ul><li>创建账号<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl add_user admin admin</span><br></pre></td></tr></table></figure></li><li>设置用户角色<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl set_user_tags admin administrator</span><br></pre></td></tr></table></figure></li><li>设置用户权限<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl set_permissions -p <span class="string">&quot;/&quot;</span> admin <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span></span><br></pre></td></tr></table></figure></li></ul></li><li>解除集群节点（<code>node2</code>和<code>node3</code>机器分别执行） <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># centos02 上执行</span></span><br><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl reset</span><br><span class="line">rabbitmqctl start_app</span><br><span class="line">rabbitmqctl cluster_status</span><br><span class="line"><span class="comment"># centos01 机器上执行</span></span><br><span class="line">rabbitmqctl forget_cluster_node rabbit@centos2</span><br></pre></td></tr></table></figure></li></ol><p>　　<img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639814753-3bba4624.png"></p><h2 id="镜像队列"><a href="#镜像队列" class="headerlink" title="镜像队列"></a>镜像队列</h2><h3 id="使用镜像的原因"><a href="#使用镜像的原因" class="headerlink" title="使用镜像的原因"></a>使用镜像的原因</h3><p>如果<code>RabbitMQ</code>集群中只有一个<code>Broker</code>节点，那么该节点的失效将导致整体服务的临时性不可用，并且也可能会导致消息的丢失。可以将所有消息都设置为持久化，并且对应队列的<code>durable</code>属性也设置为<code>true</code>，但是这样仍然无法避免由于缓存导致的问题：因为消息在发送之后和被写入磁盘井执行刷盘动作之间存在一个短暂却会产生问题的时间窗。</p><p>通过<code>publisherconfirm</code>机制能够确保客户端知道哪些消息己经存入磁盘，尽管如此，一般不希望遇到因单点故障导致的服务不可用。</p><p>引入镜像队列（<code>Mirror Queue</code>）的机制，可以将队列镜像到集群中的其他<code>Broker</code>节点之上，如果集群中的一个节点失效了，队列能自动地切换到镜像中的另一个节点上以保证服务的可用性。</p><h3 id="搭建步骤-1"><a href="#搭建步骤-1" class="headerlink" title="搭建步骤"></a>搭建步骤</h3><ol><li><p>启动三台集群节点</p></li><li><p>随便找一个节点添加<code>policy</code><br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639814792-6f44b27a.png"></p></li><li><p>在<code>node1</code>上创建一个队列发送一条消息，队列存在镜像队列</p><ul><li>生产者<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME=<span class="string">&quot;mirroir.hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;<span class="number">11</span>; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;info&quot;</span>+i;</span><br><span class="line">                channel.basicPublish(<span class="string">&quot;&quot;</span>, QUEUE_NAME, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">                System.out.println(<span class="string">&quot;发送消息完成:&quot;</span> + message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>消费者<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME=<span class="string">&quot;mirroir.hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;消费者启动等待消费..............&quot;</span>);</span><br><span class="line"></span><br><span class="line">        DeliverCallback deliverCallback=(consumerTag, delivery) -&gt;&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">receivedMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody());</span><br><span class="line">            System.out.println(<span class="string">&quot;接收到消息:&quot;</span>+receivedMessage);</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(QUEUE_NAME,<span class="literal">true</span>,deliverCallback,(consumerTag) -&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;消费者无法消费消息时调用，如队列被删除&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><p> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639814839-1778a8d8.png"></p></li><li><p>停掉<code>centos01</code>之后发现<code>centos02</code>成为镜像队列</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos01 ~]<span class="comment"># rabbitmqctl stop_app</span></span><br></pre></td></tr></table></figure><p> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639814989-346a5efa.png"></p></li><li><p>就算整个集群只剩下一台机器了，依然能消费队列里面的消息，说明队列里面的消息被镜像队列传递到相应机器里面了</p></li></ol><h2 id="Haproxy-Keepalive-实现高可用负载均衡"><a href="#Haproxy-Keepalive-实现高可用负载均衡" class="headerlink" title="Haproxy+Keepalive 实现高可用负载均衡"></a>Haproxy+Keepalive 实现高可用负载均衡</h2><h3 id="整体架构图"><a href="#整体架构图" class="headerlink" title="整体架构图"></a>整体架构图</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639815046-9eb00489.png"></p></div><h3 id="HAProxy-实现负载均衡"><a href="#HAProxy-实现负载均衡" class="headerlink" title="HAProxy 实现负载均衡"></a>HAProxy 实现负载均衡</h3><p><code>HAProxy</code>提供高可用性、负载均衡及基于<code>TCP/HTTP</code>应用的代理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案，包括<code>Twitter</code>、<code>Reddit</code>、<code>StackOverflow</code>、<code>GitHub</code>在内的多家知名互联网公司在使用。  </p><p><code>HAProxy</code>实现了一种事件驱动、单一进程模型，此模型支持非常大的井发连接数。</p><p><code>Nginx</code>、<code>Lvs</code>、<code>HAProxy</code>之间的<a href="http://www.ha97.com/5646.html">区别</a>。</p><h4 id="搭建步骤-2"><a href="#搭建步骤-2" class="headerlink" title="搭建步骤"></a>搭建步骤</h4><ol><li>下载<code>haproxy</code>（在<code>centos01</code>和<code>centos02</code>） <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install haproxy</span><br></pre></td></tr></table></figure></li><li>修改<code>centos01</code>和<code>centos02</code>的<code>haproxy.cfg</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/haproxy/haproxy.cfg</span><br><span class="line"></span><br><span class="line">backend app</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server  rabbitmq_centos01 192.168.30.129:5672 check</span><br><span class="line">    server  rabbitmq_centos02 192.168.30.134:5672 check</span><br><span class="line">    server  rabbitmq_centos03 192.168.30.130:5672 check</span><br></pre></td></tr></table></figure></li><li>在两台节点启动<code>haproxy</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">haproxy -f /etc/haproxy/haproxy.cfg</span><br><span class="line">ps -ef | grep haproxy</span><br></pre></td></tr></table></figure></li><li>访问地址</li></ol><h3 id="Keepalived-实现双机（主备）热备"><a href="#Keepalived-实现双机（主备）热备" class="headerlink" title="Keepalived 实现双机（主备）热备"></a>Keepalived 实现双机（主备）热备</h3><p>试想如果前面配置的<code>HAProxy</code>主机突然宕机或者网卡失效，那么虽然<code>RbbitMQ</code>集群没有任何故障，但是对于外界的客户端来说所有的连接都会被断开，结果将是灾难性的。</p><p>确保负载均衡服务的可靠性同样显得十分重要，这里就要引入<code>Keepalived</code>，它能够通过自身健康检查、资源接管功能做高可用（双机热备），实现故障转移.</p><h4 id="搭建步骤-3"><a href="#搭建步骤-3" class="headerlink" title="搭建步骤"></a>搭建步骤</h4><ol><li>下载<code>keepalived</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install keepalived</span><br></pre></td></tr></table></figure></li><li>节点<code>centos01</code>配置文件 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure></li><li>节点<code>node2</code>配置文件<ol><li>需要修改<code>global_defs</code>的<code>router_id</code>，如<code>nodeB</code></li><li>其次要修改<code>vrrp_instance_VI</code>中<code>state</code>为<code>BACKUP</code></li><li>最后要将<code>priority</code>设置为小于<code>100</code>的值</li></ol></li><li>添加<code>haproxy_chk.sh</code><br> 为了防止<code>HAProxy</code>服务挂掉之后<code>Keepalived</code>还在正常工作而没有切换到<code>Backup</code>上，所以这里需要编写一个脚本来检测<code>HAProxy</code>服务的状态，当<code>HAProxy</code>服务挂掉之后该脚本会自动重启<code>HAProxy</code>的服务，如果不成功则关闭<code>Keepalived</code>服务，这样便可以切换到<code>Backup</code>继续工作。 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以直接上传文件</span></span><br><span class="line">vim /etc/keepalived/haproxy_chk.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改权限</span></span><br><span class="line"><span class="built_in">chmod</span> 777 /etc/keepalived/haproxy_chk.sh</span><br></pre></td></tr></table></figure></li><li>启动<code>keepalive</code>命令（<code>centos01</code>和<code>centos02</code>启动） <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start keepalived</span><br></pre></td></tr></table></figure></li><li>观察<code>Keepalived</code>的日志 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">tail</span> -f /var/log/messages -n 200</span><br></pre></td></tr></table></figure></li><li>观察最新添加的<code>vip</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip add show</span><br></pre></td></tr></table></figure></li><li><code>node1</code>模拟<code>keepalived</code>关闭状态 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop keepalived</span><br></pre></td></tr></table></figure></li><li>使用<code>vip</code>地址来访问<code>RabbitMQ</code>集群</li></ol><h2 id="Federation-Exchange"><a href="#Federation-Exchange" class="headerlink" title="Federation Exchange"></a>Federation Exchange</h2><h3 id="使用它的原因"><a href="#使用它的原因" class="headerlink" title="使用它的原因"></a>使用它的原因</h3><p>（<code>broker</code>北京），（<code>broker</code>深圳）彼此之间相距甚远，网络延迟是一个不得不面对的问题。</p><p>有一个在北京的业务（<code>Client</code>北京）需要连接（<code>broker</code>北京），向其中的交换器<code>exchangeA</code>发送消息，此时的网络延迟很小，（<code>Client</code>北京）可以迅速将消息发送至<code>exchangeA</code>中，就算在开启了<code>publisherconfirm</code>机制或者事务机制的情况下，也可以迅速收到确认信息。</p><p>此时又有个在深圳的业务（<code>Client</code>深圳）需要向<code>exchangeA</code>发送消息，那么（<code>Client</code>深圳）（<code>broker</code>北京）之间有很大的网络延迟，（<code>Client</code>深圳）将发送消息至<code>exchangeA</code>会经历一定的延迟，尤其是在开启了<code>publisherconfirm</code>机制或者事务机制的情况下，（<code>Client</code>深圳）会等待很长的延迟时间来接收（<code>broker</code>北京）的确认信息，进而必然造成这条发送线程的性能降低，甚至造成一定程度上的阻塞。</p><p>将业务（<code>Client</code>深圳）部署到北京的机房可以解决这个问题，但是如果（<code>Client</code>深圳）调用的其他服务都部署在深圳，那么又会引发新的时延问题，总不见得将所有业务全部部署在一个机房，那么容灾又何以实现？ 这里使用<code>Federation</code>插件就可以很好地解决这个问题.</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639815130-71a5e175.png"></p></div><h3 id="搭建步骤-4"><a href="#搭建步骤-4" class="headerlink" title="搭建步骤"></a>搭建步骤</h3><ol><li>需要保证每台节点单独运行</li><li>在每台机器上开启<code>federation</code>相关插件 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_federation</span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_federation_management</span><br></pre></td></tr></table></figure></li><li>原理图（先运行<code>consumer</code>在<code>ncentos02</code>创建<code>fed_exchange</code>）<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639815153-d7a929e0.png"> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;fed_exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME=<span class="string">&quot;centos02_queue&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String Route_KEY=<span class="string">&quot;routekey&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, Route_KEY);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息........... &quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            message=<span class="string">&quot;接收绑定键:&quot;</span>+delivery.getEnvelope().getRoutingKey()+<span class="string">&quot;,消息:&quot;</span>+message;</span><br><span class="line">            System.out.println(<span class="string">&quot;错误日志已经接收：&quot;</span> + message);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>在<code>downstream</code>（<code>centos02</code>）配置<code>upstream</code>（<code>centos01</code>）<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639815182-04d2e40d.png"></li><li>添加<code>policy</code><br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639815205-a41afe17.png"></li><li>成功的前提<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639815228-75e61b11.png"></li></ol><h2 id="Federation-Queue"><a href="#Federation-Queue" class="headerlink" title="Federation Queue"></a>Federation Queue</h2><h3 id="使用它的原因-1"><a href="#使用它的原因-1" class="headerlink" title="使用它的原因"></a>使用它的原因</h3><p>联邦队列可以在多个<code>Broker</code>节点（或者集群）之间为单个队列提供均衡负载的功能。一个联邦队列可以连接一个或者多个上游队列（<code>upstream queue</code>），并从这些上游队列中获取消息以满足本地消费者消费消息的需求。</p><h3 id="搭建步骤-5"><a href="#搭建步骤-5" class="headerlink" title="搭建步骤"></a>搭建步骤</h3><ol><li>原理图<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639815248-7bee7ab0.png"></li><li>添加<code>upstream</code>（同上）<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639815182-04d2e40d.png"></li><li>添加<code>policy</code><br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639815400-fe0ad7f8.png"></li></ol><h2 id="Shovel"><a href="#Shovel" class="headerlink" title="Shovel"></a>Shovel</h2><h3 id="使用它的原因-2"><a href="#使用它的原因-2" class="headerlink" title="使用它的原因"></a>使用它的原因</h3><p><code>Federation</code>具备的数据转发功能类似，<code>Shovel</code>能够可靠、持续地从一个<code>Broker</code>中的队列（作为源端，即<code>source</code>）拉取数据并转发至另一个<code>Broker</code>中的交换器（作为目的端，即<code>destination</code>）。</p><p>作为源端的队列和作为目的端的交换器可以同时位于同一个<code>Broker</code>，也可以位于不同的<code>Broker</code>上。<code>Shovel</code>可以翻译为”铲子”，是一种比较形象的比喻，这个”铲子”可以将消息从一方”铲子”另一方。<code>Shovel</code>行为就像优秀的客户端应用程序能够负责连接源和目的地、负责消息的读写及负责连接失败问题的处理。</p><h3 id="搭建步骤-6"><a href="#搭建步骤-6" class="headerlink" title="搭建步骤"></a>搭建步骤</h3><ol><li>开启插件（需要的机器都开启） <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_shovel</span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_shovel_management</span><br></pre></td></tr></table></figure></li><li>原理图（在源头发送的消息直接回进入到目的地队列）<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639815430-53247d11.png"></li><li>添加<code>shovel</code>源和目的地<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639815452-a62b64da.png">v<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637997470/1639815466-665b25cc.png"></li></ol>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RabbitMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>队列</title>
      <link href="/2021/11/25/RabbitMQ/03.%E9%98%9F%E5%88%97/"/>
      <url>/2021/11/25/RabbitMQ/03.%E9%98%9F%E5%88%97/</url>
      
        <content type="html"><![CDATA[<h1 id="死信队列"><a href="#死信队列" class="headerlink" title="死信队列"></a>死信队列</h1><h2 id="死信的概念"><a href="#死信的概念" class="headerlink" title="死信的概念"></a>死信的概念</h2><p>死信，顾名思义就是无法被消费的消息，字面意思可以这样理解，一般来说，<code>producer</code>将消息投递到<code>broker</code>或者直接到<code>queue</code>里了，<code>consumer</code>从<code>queue</code>取出消息进行消费，但某些时候由于特定的原因导致<code>queue</code>中的某些消息无法被消费，这样的消息如果没有后续的处理，就变成了死信，有死信自然就有了死信队列。</p><p>应用场景：为了保证订单业务的消息数据不丢失，需要使用到<code>RabbitMQ</code>的死信队列机制，当消息消费发生异常时，将消息投入死信队列中。还有比如说:：用户在商城下单成功并点击去支付后在指定时间未支付时自动失效。</p><h2 id="死信的来源"><a href="#死信的来源" class="headerlink" title="死信的来源"></a>死信的来源</h2><ul><li>消息<code>TTL</code>过期</li><li>队列达到最大长度队列满了，无法再添加数据到<code>MQ</code>中）</li><li>消息被拒绝（<code>basic.reject</code>或<code>basic.nack</code>）并且<code>requeue=false</code></li></ul><h2 id="死信实战"><a href="#死信实战" class="headerlink" title="死信实战"></a>死信实战</h2><h3 id="代码架构图"><a href="#代码架构图" class="headerlink" title="代码架构图"></a>代码架构图</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639811897-d4e16006.png"></p></div><h3 id="消息-TTL-过期"><a href="#消息-TTL-过期" class="headerlink" title="消息 TTL 过期"></a>消息 TTL 过期</h3><ul><li><p>生产者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NORMAL_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;normal_exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel()) &#123;</span><br><span class="line">            channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line">            <span class="comment">// 设置消息的 TTL 时间</span></span><br><span class="line">            AMQP.<span class="type">BasicProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AMQP</span>.BasicProperties().</span><br><span class="line">                    builder().expiration(<span class="string">&quot;10000&quot;</span>).build();</span><br><span class="line">            <span class="comment">// 该信息是用作演示队列个数限制</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; <span class="number">11</span>; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;info&quot;</span> + i;</span><br><span class="line">                channel.basicPublish(NORMAL_EXCHANGE, <span class="string">&quot;zhangsan&quot;</span>, properties, message.getBytes());</span><br><span class="line">                System.out.println(<span class="string">&quot;生产者发送消息：&quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>消费者</p><ul><li><p><code>C1</code>（启动之后关闭该消费者，模拟其接收不到消息）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer01</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 普通交换机名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NORMAL_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;normal_exchange&quot;</span>;</span><br><span class="line">    <span class="comment">// 死信交换机名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;dead_exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        <span class="comment">// 声明死信和普通交换机，类型均为 direct</span></span><br><span class="line">        channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line">        channel.exchangeDeclare(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 声明死信队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">deadQueue</span> <span class="operator">=</span> <span class="string">&quot;dead-queue&quot;</span>;</span><br><span class="line">        channel.queueDeclare(deadQueue, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 死信队列绑定死信交换机与 routingkey</span></span><br><span class="line">        channel.queueBind(deadQueue, DEAD_EXCHANGE, <span class="string">&quot;lisi&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 正常队列绑定死信队列信息</span></span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 正常队列设置死信交换机。参数 key 是固定值</span></span><br><span class="line">        params.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_EXCHANGE);</span><br><span class="line">        <span class="comment">// 正常队列设置死信 routing-key，参数 key 是固定值</span></span><br><span class="line">        params.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;lisi&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 声明正常队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">normalQueue</span> <span class="operator">=</span> <span class="string">&quot;normal-queue&quot;</span>;</span><br><span class="line">        channel.queueDeclare(normalQueue, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, params);</span><br><span class="line">        <span class="comment">// 正常队列绑定正常交换机与 routingkey</span></span><br><span class="line">        channel.queueBind(normalQueue, NORMAL_EXCHANGE, <span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息........... &quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Consumer01 接收到消息：&quot;</span>+message);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接收消息</span></span><br><span class="line">        channel.basicConsume(normalQueue, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>生产者未发消息<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639811929-e939021c.png"></li><li>生产者发送了 $10$ 条消息，此时正常消息队列中有 $10$ 条未消费消息<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639811950-01fbd419.png"></li><li>时间过去了 $10$ 秒，正常队列里的消息由于没有被消费，消息进入死信队列<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639811969-59ccb074.png"></li></ol></li><li><p><code>C2</code>（以上步骤完成后，启动<code>C2</code>消费者，它消费死信队列里面的消息）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer02</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;dead_exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        channel.exchangeDeclare(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 声明死信队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">deadQueue</span> <span class="operator">=</span> <span class="string">&quot;dead-queue&quot;</span>;</span><br><span class="line">        channel.queueDeclare(deadQueue, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 死信队列绑定死信交换机</span></span><br><span class="line">        channel.queueBind(deadQueue, DEAD_EXCHANGE, <span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收死信队列消息........... &quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Consumer02 接收死信队列的消息：&quot;</span> + message);</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(deadQueue, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div align="center"><pre><code>![](https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639812007-8ed1b164.png)![](https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639812025-38050fff.png)</code></pre></div></li></ul></li></ul><h3 id="队列达到最大长度"><a href="#队列达到最大长度" class="headerlink" title="队列达到最大长度"></a>队列达到最大长度</h3><ul><li><p>生产者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NORMAL_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;normal_exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel()) &#123;</span><br><span class="line">            channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line">            <span class="comment">// 该信息是用作演示队列个数限制</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; <span class="number">11</span>; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;info&quot;</span> + i;</span><br><span class="line">                channel.basicPublish(NORMAL_EXCHANGE, <span class="string">&quot;zhangsan&quot;</span>, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">                System.out.println(<span class="string">&quot;生产者发送消息：&quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>消费者</p><ul><li><p><code>C1</code>（启动之后关闭该消费者，模拟其接收不到消息）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer01</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 普通交换机名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NORMAL_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;normal_exchange&quot;</span>;</span><br><span class="line">    <span class="comment">// 死信交换机名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;dead_exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        <span class="comment">// 声明死信和普通交换机，类型均为 direct</span></span><br><span class="line">        channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line">        channel.exchangeDeclare(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 声明死信队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">deadQueue</span> <span class="operator">=</span> <span class="string">&quot;dead-queue&quot;</span>;</span><br><span class="line">        channel.queueDeclare(deadQueue, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 死信队列绑定死信交换机与 routingkey</span></span><br><span class="line">        channel.queueBind(deadQueue, DEAD_EXCHANGE, <span class="string">&quot;lisi&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 正常队列绑定死信队列信息</span></span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 正常队列设置死信交换机。参数 key 是固定值</span></span><br><span class="line">        params.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_EXCHANGE);</span><br><span class="line">        <span class="comment">// 正常队列设置死信 routing-key，参数 key 是固定值</span></span><br><span class="line">        params.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">        <span class="comment">// 正常队列设置长度限制</span></span><br><span class="line">        params.put(<span class="string">&quot;x-max-length&quot;</span>, <span class="number">6</span>);</span><br></pre></td></tr></table></figure><p>注意此时需要把原先队列删除 因为参数改变了，余下操作与前面相同。</p><ol><li>生产者未发消息<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639811929-e939021c.png"></li><li>生产者发送了 $10$ 条消息，此时正常消息队列中有 $10$ 条未消费消息<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639811950-01fbd419.png"></li><li>正常队列由于设置最多消费 $6$ 条消息，$4$ 条消息进入死信队列<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639812197-af59be10.png"></li></ol></li><li><p><code>C2</code>（以上步骤完成后，启动<code>C2</code>消费者，它消费死信队列里面的消息）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer02</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;dead_exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        channel.exchangeDeclare(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 声明死信队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">deadQueue</span> <span class="operator">=</span> <span class="string">&quot;dead-queue&quot;</span>;</span><br><span class="line">        channel.queueDeclare(deadQueue, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 死信队列绑定死信交换机</span></span><br><span class="line">        channel.queueBind(deadQueue, DEAD_EXCHANGE, <span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收死信队列消息........... &quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Consumer02 接收死信队列的消息：&quot;</span> + message);</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(deadQueue, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于正常队列设置最多接收 $6$ 条消息，因此会有 $4$ 条消息进入死信队列：</p><div align="center"><pre><code>![](https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639812232-74b2d75c.png)![](https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639812246-f9912643.png)</code></pre></div></li></ul></li></ul><h3 id="消息被拒"><a href="#消息被拒" class="headerlink" title="消息被拒"></a>消息被拒</h3><ul><li><p>生产者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NORMAL_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;normal_exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel()) &#123;</span><br><span class="line">            channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line">            <span class="comment">// 该信息是用作演示队列个数限制</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; <span class="number">11</span>; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;info&quot;</span> + i;</span><br><span class="line">                channel.basicPublish(NORMAL_EXCHANGE, <span class="string">&quot;zhangsan&quot;</span>, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">                System.out.println(<span class="string">&quot;生产者发送消息：&quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>消费者</p><ul><li><p><code>C1</code>（启动<code>C1</code> 然后再启动<code>C2</code>）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer01</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 普通交换机名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NORMAL_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;normal_exchange&quot;</span>;</span><br><span class="line">    <span class="comment">// 死信交换机名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;dead_exchange&quot;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  </span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 声明死信和普通交换机 类型为 direct</span></span><br><span class="line">        channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line">        channel.exchangeDeclare(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 声明死信队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">deadQueue</span> <span class="operator">=</span> <span class="string">&quot;dead-queue&quot;</span>;</span><br><span class="line">        channel.queueDeclare(deadQueue, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 死信队列绑定死信交换机与 routingkey</span></span><br><span class="line">        channel.queueBind(deadQueue, DEAD_EXCHANGE, <span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 正常队列绑定死信队列信息</span></span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 正常队列设置死信交换机，参数 key 是固定值</span></span><br><span class="line">        params.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_EXCHANGE);</span><br><span class="line">        <span class="comment">// 正常队列设置死信 routing-key，参数 key 是固定值</span></span><br><span class="line">        params.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 声明正常队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">normalQueue</span> <span class="operator">=</span> <span class="string">&quot;normal-queue&quot;</span>;</span><br><span class="line">        channel.queueDeclare(normalQueue, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, params);</span><br><span class="line">        <span class="comment">// 正常队列绑定正常交换机</span></span><br><span class="line">        channel.queueBind(normalQueue, NORMAL_EXCHANGE, <span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">  </span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息........... &quot;</span>);</span><br><span class="line">  </span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">      </span><br><span class="line">            <span class="comment">// 拒绝消息 info5</span></span><br><span class="line">            <span class="keyword">if</span>(message.equals(<span class="string">&quot;info5&quot;</span>))&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Consumer01 接收到消息：&quot;</span> + message + <span class="string">&quot;并拒绝签收该消息&quot;</span>);</span><br><span class="line">                <span class="comment">// requeue 设置为 false 代表拒绝重新入队，该队列如果配置了死信交换机将发送到死信队列中</span></span><br><span class="line">                <span class="comment">// delivery.getEnvelope().getDeliveryTag()：获取消息序号</span></span><br><span class="line">                channel.basicReject(delivery.getEnvelope().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Consumer01 接收到消息：&quot;</span>+message);</span><br><span class="line">                channel.basicAck(delivery.getEnvelope().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">autoAck</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        channel.basicConsume(normalQueue, autoAck, deliverCallback, consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>生产者未发消息<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639811929-e939021c.png"></li><li>生产者发送了 $10$ 条消息，此时正常消息队列中有 $10$ 条未消费消息<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639811969-59ccb074.png"></li><li>正常队列里的消息由于拒绝消费消息 <code>info5</code>，$1$ 条消息进入死信队列<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639812334-6d9174ba.png"><br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639812345-5c04a9cc.png"></li></ol></li><li><p><code>C2</code>（以上步骤完成后，启动<code>C2</code>消费者，它消费死信队列里面的消息）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer02</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;dead_exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        channel.exchangeDeclare(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 声明死信队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">deadQueue</span> <span class="operator">=</span> <span class="string">&quot;dead-queue&quot;</span>;</span><br><span class="line">        channel.queueDeclare(deadQueue, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 死信队列绑定死信交换机</span></span><br><span class="line">        channel.queueBind(deadQueue, DEAD_EXCHANGE, <span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收死信队列消息........... &quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Consumer02 接收死信队列的消息：&quot;</span> + message);</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(deadQueue, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639812370-89352eed.png"></p></li></ul></li></ul><h1 id="延迟队列"><a href="#延迟队列" class="headerlink" title="延迟队列"></a>延迟队列</h1><h2 id="延迟队列概念"><a href="#延迟队列概念" class="headerlink" title="延迟队列概念"></a>延迟队列概念</h2><p>延时队列，队列内部是有序的，最重要的特性就体现在它的延时属性上，延时队列中的元素是希望在指定时间到了以后或之前取出和处理，简单来说，延时队列就是用来存放需要在指定时间被处理的元素的队列。</p><h2 id="延迟队列使用场景"><a href="#延迟队列使用场景" class="headerlink" title="延迟队列使用场景"></a>延迟队列使用场景</h2><ol><li>订单在十分钟之内未支付则自动取消。</li><li>新创建的店铺，如果在十天内都没有上传过商品，则自动发送消息提醒。</li><li>用户注册成功后，如果三天内没有登陆则进行短信提醒。</li><li>用户发起退款，如果三天内没有得到处理则通知相关运营人员。</li><li>预定会议后，需要在预定的时间点前十分钟通知各个与会人员参加会议</li></ol><p>这些场景都有一个特点，需要在某个事件发生之后或者之前的指定时间点完成某一项任务，如：发生订单生成事件，在十分钟之后检查该订单支付状态，然后将未支付的订单进行关闭；看起来似乎使用定时任务，一直轮询数据，每秒查一次，取出需要被处理的数据，然后处理。</p><p>如果数据量比较少，确实可以这样做，比如：对于“如果账单一周内未支付则进行自动结算”这样的需求，如果对于时间不是严格限制，而是宽松意义上的一周，那么每天晚上跑个定时任务检查一下所有未支付的账单，确实也是一个可行的方案。</p><p>但对于数据量比较大，并且时效性较强的场景，如：“订单十分钟内未支付则关闭”，短期内未支付的订单数据可能会有很多，活动期间甚至会达到百万甚至千万级别，对这么庞大的数据量仍旧使用轮询的方式显然是不可取的，很可能在一秒内无法完成所有订单的检查，同时会给数据库带来很大压力，无法满足业务要求而且性能低下。</p><h2 id="RabbitMQ-中的-TTL"><a href="#RabbitMQ-中的-TTL" class="headerlink" title="RabbitMQ 中的 TTL"></a>RabbitMQ 中的 TTL</h2><p><code>TTL</code>是<code>RabbitMQ</code>中一个消息或者队列的属性，表明一条消息或者该队列中的所有消息的最大存活时间，单位是毫秒。换句话说，如果一条消息设置了<code>TTL</code>属性或者进入了设置<code>TTL</code>属性的队列，那么这条消息如果在<code>TTL</code>设置的时间内没有被消费，则会成为”死信”。如果同时配置了队列的<code>TTL</code>和消息的<code>TTL</code>，那么较小的那个值将会被使用，有两种方式设置<code>TTL</code>。</p><h3 id="消息设置TTL"><a href="#消息设置TTL" class="headerlink" title="消息设置TTL"></a>消息设置TTL</h3><p>一种方式便是针对每条消息设置<code>TTL</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;sendExpirationMsg/&#123;message&#125;/&#123;ttlTime&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@PathVariable</span> String message,<span class="meta">@PathVariable</span> String ttlTime)</span> &#123;</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;X&quot;</span>, <span class="string">&quot;XC&quot;</span>, message, correlationData -&gt; &#123;</span><br><span class="line">        correlationData.getMessageProperties().setExpiration(ttlTime);</span><br><span class="line">        <span class="keyword">return</span> correlationData;&#125;);</span><br><span class="line">    log.info(<span class="string">&quot;当前时间：&#123;&#125;，发送一条时长 &#123;&#125; 毫秒 TTL 信息：&#123;&#125; 给队列 C&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(),ttlTime, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="队列设置TTL"><a href="#队列设置TTL" class="headerlink" title="队列设置TTL"></a>队列设置TTL</h3><p>在创建队列的时候设置队列的<code>x-message-ttl</code>属性。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 声明队列 B</span></span><br><span class="line"><span class="comment"> * ttl 为 40s，并绑定到对应的死信交换机</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean(&quot;queueB&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">queueB</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">// 声明当前队列绑定的死信交换机</span></span><br><span class="line">    args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, Y_DEAD_LETTER_EXCHANGE);</span><br><span class="line">    <span class="comment">// 声明当前队列的死信路由 key</span></span><br><span class="line">    args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;YD&quot;</span>);</span><br><span class="line">    <span class="comment">// 声明队列的 TTL</span></span><br><span class="line">    args.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">40000</span>);</span><br><span class="line">    <span class="comment">// 声明队列 B，ttl 为 40s，并绑定到对应的死信交换机</span></span><br><span class="line">    <span class="keyword">return</span> QueueBuilder.durable(QUEUE_B).withArguments(args).build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="两者的区别"><a href="#两者的区别" class="headerlink" title="两者的区别"></a>两者的区别</h3><p>如果设置了队列的<code>TTL</code>属性，那么一旦消息过期，就会被队列丢弃（如果配置了死信队列被丢到死信队列中），而第二种方式，消息即使过期，也不一定会被马上丢弃，因为消息是否过期是在即将投递到消费者之前判定的，如果当前队列有严重的消息积压情况，则已过期的消息也许还能存活较长时间；另外，还需要注意的一点是，如果不设置<code>TTL</code>，表示消息永远不会过期，如果将<code>TTL</code>设置为 $0$，则表示除非此时可以直接投递该消息到消费者，否则该消息将会被丢弃。</p><p>前一小节介绍了死信队列，刚刚又介绍了<code>TTL</code>，至此利用<code>RabbitMQ</code>实现延时队列的两大要素已经集齐，接下来只需要将它们进行融合，再加入一点点调味料，延时队列就可以新鲜出炉了。</p><p>想想看，延时队列，不就是想要消息延迟多久被处理吗，<code>TTL</code>则刚好能让消息在延迟多久之后成为死信，另一方面，成为死信的消息都会被投递到死信队列里，这样只需要消费者一直消费死信队列里的消息就完事了，因为里面的消息都是希望被立即处理的消息。</p><h2 id="整合-springboot"><a href="#整合-springboot" class="headerlink" title="整合 springboot"></a>整合 springboot</h2><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><p><code>idea</code>中选择<code>Spring Initializr</code>。</p><h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--RabbitMQ 依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--swagger--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--RabbitMQ 测试依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.amqp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-rabbit-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.properties</span></span><br><span class="line"><span class="attr">spring.rabbitmq.host</span>=<span class="string">192.168.30.129</span></span><br><span class="line"><span class="attr">spring.rabbitmq.port</span>=<span class="string">5672</span></span><br><span class="line"><span class="attr">spring.rabbitmq.username</span>=<span class="string">admin</span></span><br><span class="line"><span class="attr">spring.rabbitmq.password</span>=<span class="string">admin</span></span><br></pre></td></tr></table></figure><h3 id="添加-Swagger-配置类"><a href="#添加-Swagger-配置类" class="headerlink" title="添加 Swagger 配置类"></a>添加 Swagger 配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiInfo;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.Contact;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spi.DocumentationType;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger2.annotations.EnableSwagger2;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwaggerConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Docket <span class="title function_">webApiConfig</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">                .groupName(<span class="string">&quot;webApi&quot;</span>)</span><br><span class="line">                .apiInfo(webApiInfo())</span><br><span class="line">                .select()</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> ApiInfo <span class="title function_">webApiInfo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">                .title(<span class="string">&quot;rabbitmq 接口文档&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;本文档描述了 rabbitmq 微服务接口定义&quot;</span>)</span><br><span class="line">                .version(<span class="string">&quot;1.0&quot;</span>)</span><br><span class="line">                .contact(<span class="keyword">new</span> <span class="title class_">Contact</span>(<span class="string">&quot;rabbitTest&quot;</span>, <span class="string">&quot;http://example.com&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;110119120@qq.com&quot;</span>)).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="队列-TTL"><a href="#队列-TTL" class="headerlink" title="队列 TTL"></a>队列 TTL</h2><h3 id="代码架构图-1"><a href="#代码架构图-1" class="headerlink" title="代码架构图"></a>代码架构图</h3><p>创建两个队列<code>QA</code>和<code>QB</code>，两者队列<code>TTL</code>分别设置为 $10s$ 和 $40s$，然后在创建一个交换机<code>X</code>和死信交换机<code>Y</code>，它们的类型都是<code>direct</code>，创建一个死信队列<code>QD</code>，它们的绑定关系如下：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639812487-28d11ab6.png"></p></div><ul><li>配置文件类代码<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TtlQueueConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交换机与队列名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">X_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;X&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_A</span> <span class="operator">=</span> <span class="string">&quot;QA&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_B</span> <span class="operator">=</span> <span class="string">&quot;QB&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">Y_DEAD_LETTER_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;Y&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_LETTER_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;QD&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明 xExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;xExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">xExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(X_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明 yExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;yExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">yExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(Y_DEAD_LETTER_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明队列 A</span></span><br><span class="line"><span class="comment">     * ttl 为 10s，并绑定到对应的死信交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;queueA&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queueA</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">        <span class="comment">// 声明当前队列绑定的死信交换机</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, Y_DEAD_LETTER_EXCHANGE);</span><br><span class="line">        <span class="comment">// 声明当前队列的死信路由 key</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;YD&quot;</span>);</span><br><span class="line">        <span class="comment">// 声明队列的 TTL</span></span><br><span class="line">        args.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">10000</span>);</span><br><span class="line">        <span class="comment">// 声明队列 A，ttl 为 10s，并绑定到对应的死信交换机</span></span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_A).withArguments(args).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明队列 A 绑定 X 交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queueA</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> xExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">queueABindingX</span><span class="params">(<span class="meta">@Qualifier(&quot;queueA&quot;)</span> Queue queueA,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@Qualifier(&quot;xExchange&quot;)</span> DirectExchange xExchange)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queueA).to(xExchange).with(<span class="string">&quot;XA&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明队列 B</span></span><br><span class="line"><span class="comment">     * ttl 为 40s，并绑定到对应的死信交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;queueB&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queueB</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">        <span class="comment">// 声明当前队列绑定的死信交换机</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, Y_DEAD_LETTER_EXCHANGE);</span><br><span class="line">        <span class="comment">// 声明当前队列的死信路由 key</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;YD&quot;</span>);</span><br><span class="line">        <span class="comment">// 声明队列的 TTL</span></span><br><span class="line">        args.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">40000</span>);</span><br><span class="line">        <span class="comment">// 声明队列 B，ttl 为 40s，并绑定到对应的死信交换机</span></span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_B).withArguments(args).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明队列 B 绑定 X 交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queue1B</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> xExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">queueBBindingX</span><span class="params">(<span class="meta">@Qualifier(&quot;queueB&quot;)</span> Queue queue1B,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@Qualifier(&quot;xExchange&quot;)</span> DirectExchange xExchange)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue1B).to(xExchange).with(<span class="string">&quot;XB&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明死信队列 QD</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;queueD&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queueD</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DEAD_LETTER_QUEUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明死信队列 QD 绑定关系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queueD</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> yExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">deadLetterBindingQAD</span><span class="params">(<span class="meta">@Qualifier(&quot;queueD&quot;)</span> Queue queueD,</span></span><br><span class="line"><span class="params">                                        <span class="meta">@Qualifier(&quot;yExchange&quot;)</span> DirectExchange yExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queueD).to(yExchange).with(<span class="string">&quot;YD&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>生产者<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/ttl&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SendMsgController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@GetMapping(&quot;sendMsg/&#123;message&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@PathVariable</span> String message)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;当前时间为：&#123;&#125;,发送一条信息：&#123;&#125; 给两个 TTL 队列&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), message);</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;X&quot;</span>, <span class="string">&quot;XA&quot;</span>, <span class="string">&quot;消息来自 ttl 为 10S 的队列: &quot;</span>+message);</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;X&quot;</span>, <span class="string">&quot;XB&quot;</span>, <span class="string">&quot;消息来自 ttl 为 40S 的队列: &quot;</span>+message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>消费者<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.Consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLetterQueueConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;QD&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveD</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody());</span><br><span class="line">        log.info(<span class="string">&quot;当前时间：&#123;&#125;,收到死信队列信息&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().toString(), msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure></li></ul><p>启动项目，发起一个请求：<code>http://localhost:8080/ttl/sendMsg/嘻嘻嘻</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.delayqueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication(scanBasePackages = &quot;com.example&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayQueueApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DelayQueueApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639812526-dc91dc76.png"></p></div><p>第一条消息在 $10s$ 后变成了死信消息，然后被消费者消费掉，第二条消息在 $40s$ 之后变成了死信消息，然后被消费掉，这样一个延时队列就打造完成了。</p><p>不过，如果这样使用的话，岂不是每增加一个新的时间需求，就要新增一个队列，这里只有 $10s$ 和 $40s$ 两个时间选项，如果需要一个小时后处理，那么就需要增加<code>TTL</code>为一个小时的队列，如果是预定会议室然后提前通知这样的场景，岂不是要增加无数个队列才能满足需求？</p><h2 id="延时队列优化"><a href="#延时队列优化" class="headerlink" title="延时队列优化"></a>延时队列优化</h2><h3 id="代码架构图-2"><a href="#代码架构图-2" class="headerlink" title="代码架构图"></a>代码架构图</h3><p>在这里新增了一个队列<code>QC</code>，绑定关系如下，该队列不设置<code>TTL</code>时间：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639812560-74ccf9d2.png"></p></div><ul><li>配置文件类<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MsgTtlQueueConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">Y_DEAD_LETTER_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;Y&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_C</span> <span class="operator">=</span> <span class="string">&quot;QC&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明队列 C 死信交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;queueC&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queueB</span><span class="params">()</span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">        <span class="comment">// 声明当前队列绑定的死信交换机</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, Y_DEAD_LETTER_EXCHANGE);</span><br><span class="line">        <span class="comment">// 声明当前队列的死信路由 key</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;YD&quot;</span>);</span><br><span class="line">        <span class="comment">// 没有声明 TTL 属性</span></span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_C).withArguments(args).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明队列 B 绑定 X 交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queueC</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> xExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">queueCBindingX</span><span class="params">(<span class="meta">@Qualifier(&quot;queueC&quot;)</span> Queue queueC,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@Qualifier(&quot;xExchange&quot;)</span> DirectExchange xExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queueC).to(xExchange).with(<span class="string">&quot;XC&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>生产者<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/ttl&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SendMsgController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;sendExpirationMsg/&#123;message&#125;/&#123;ttlTime&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@PathVariable</span> String message,<span class="meta">@PathVariable</span> String ttlTime)</span> &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;X&quot;</span>, <span class="string">&quot;XC&quot;</span>, message, correlationData -&gt; &#123;</span><br><span class="line">            correlationData.getMessageProperties().setExpiration(ttlTime);</span><br><span class="line">            <span class="keyword">return</span> correlationData;&#125;);</span><br><span class="line">        log.info(<span class="string">&quot;当前时间：&#123;&#125;，发送一条时长 &#123;&#125; 毫秒 TTL 信息：&#123;&#125; 给队列 C&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(),ttlTime, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>发起请求：</p><ul><li><code>http://localhost:8080/ttl/sendExpirationMsg/你好 1/20000</code></li><li><code>http://localhost:8080/ttl/sendExpirationMsg/你好 2/2000</code></li></ul><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639812594-a6e480fc.png"></p></div><p>看起来似乎没什么问题，但是在最开始的时候，就介绍过如果使用在消息属性上设置<code>TTL</code>的方式，消息可能并不会按时“死亡”，因为<code>RabbitMQ</code>只会检查第一个消息是否过期，如果过期则丢到死信队列，如果第一个消息的延时时长很长，而第二个消息的延时时长很短，第二个消息并不会优先得到执行。</p><h2 id="Rabbitmq-插件实现延迟队列"><a href="#Rabbitmq-插件实现延迟队列" class="headerlink" title="Rabbitmq 插件实现延迟队列"></a>Rabbitmq 插件实现延迟队列</h2><p>上文中提到的问题，确实是一个问题，如果不能实现在消息粒度上的<code>TTL</code>，并使其在设置的<code>TTL</code>时间及时死亡，就无法设计成一个通用的延时队列。那如何解决呢，接下来就去解决该问题。</p><h3 id="安装延时队列插件"><a href="#安装延时队列插件" class="headerlink" title="安装延时队列插件"></a>安装延时队列插件</h3><ol><li>在<a href="https://www.rabbitmq.com/community-plugins.html">官网</a>上下载<code>rabbitmq_delayed_message_exchange</code>插件，然后解压放置到<code>RabbitMQ</code>的插件目录<code>/usr/lib/rabbitmq/lib/rabbitmq_server-3.8.8/plugins</code>。 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos01 home]<span class="comment"># cp rabbitmq_delayed_message_exchange-3.8.0.ez /usr/lib/rabbitmq/lib/rabbitmq_server-3.8.8//plugins/</span></span><br><span class="line">[root@centos01 home]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>执行下面命令让该插件生效，然后重启<code>RabbitMQ</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos01 home]<span class="comment"># rabbitmq-plugins enable rabbitmq_delayed_message_exchange</span></span><br></pre></td></tr></table></figure></li></ol><ul><li>添加延迟插件之前<br><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639812623-6bf0ff33.png"></li><li>添加延迟插件之后<br><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639812648-d9216ddf.png"></li></ul><h3 id="代码架构图-3"><a href="#代码架构图-3" class="headerlink" title="代码架构图"></a>代码架构图</h3><p>在这里新增了一个队列<code>delayed.queue</code>，一个自定义交换机<code>delayed.exchange</code>，绑定关系如下：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639812678-06906f34.png"></p></div><ul><li>配置文件类<br>在自定义的交换机中，这是一种新的交换类型，该类型消息支持延迟投递机制 消息传递后并不会立即投递到目标队列中，而是存储在<code>mnesia</code>（一个分布式数据系统）表中，当达到投递时间时，才投递到目标队列中。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.CustomExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayedQueueConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;delayed.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;delayed.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;delayed.routingkey&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayedQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DELAYED_QUEUE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义交换机 我们在这里定义的是一个延迟交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomExchange <span class="title function_">delayedExchange</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 自定义交换机的类型</span></span><br><span class="line">        args.put(<span class="string">&quot;x-delayed-type&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomExchange</span>(DELAYED_EXCHANGE_NAME, <span class="string">&quot;x-delayed-message&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingDelayedQueue</span><span class="params">(<span class="meta">@Qualifier(&quot;delayedQueue&quot;)</span> Queue queue,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@Qualifier(&quot;delayedExchange&quot;)</span> CustomExchange delayedExchange)</span> &#123;</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(delayedExchange).with(DELAYED_ROUTING_KEY).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>生产者<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/ttl&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SendMsgController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;delayed.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;delayed.routingkey&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;sendDelayMsg/&#123;message&#125;/&#123;delayTime&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@PathVariable</span> String message,<span class="meta">@PathVariable</span> Integer delayTime)</span> &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(DELAYED_EXCHANGE_NAME, DELAYED_ROUTING_KEY, message,</span><br><span class="line">                correlationData -&gt; &#123;</span><br><span class="line">                    correlationData.getMessageProperties().setDelay(delayTime);</span><br><span class="line">                    <span class="keyword">return</span> correlationData;</span><br><span class="line">                &#125;);</span><br><span class="line">        log.info(<span class="string">&quot;当前时间：&#123;&#125;，发送一条延迟 &#123;&#125; 毫秒的信息：&#123;&#125; 给队列 delayed.queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), delayTime, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>消费者<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.Consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLetterQueueConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;delayed.queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DELAYED_QUEUE_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveDelayedQueue</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody());</span><br><span class="line">        log.info(<span class="string">&quot;当前时间：&#123;&#125;，收到延时队列的消息：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().toString(), msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>　　发起请求：</p><ul><li><code>http://localhost:8080/ttl/sendDelayMsg/come on baby1/20000</code></li><li><code>http://localhost:8080/ttl/sendDelayMsg/come on baby2/2000</code></li></ul><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637822906/1639812708-ab82e146.png"></p></div><p>第二个消息被先消费掉了，符合预期。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>延时队列在需要延时处理的场景下非常有用，使用<code>RabbitMQ</code>来实现延时队列可以很好的利用<code>RabbitMQ</code>的特性，如：消息可靠发送、消息可靠投递、死信队列来保障消息至少被消费一次以及未被正确处理的消息不会被丢弃。另外，通过<code>RabbitMQ</code>集群的特性，可以很好的解决单点故障问题，不会因为单个节点挂掉导致延时队列不可用或者消息丢失。</p><p>当然，延时队列还有很多其它选择，比如利用<code>Java</code>的<code>DelayQueue</code>，利用<code>Redis</code>的<code>zset</code>，利用 <code>Quartz</code>或者利用<code>kafka</code>的时间轮，这些方式各有特点,看需要适用的场景。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RabbitMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>发布确认与交换机</title>
      <link href="/2021/11/22/RabbitMQ/02.%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4%E4%B8%8E%E4%BA%A4%E6%8D%A2%E6%9C%BA/"/>
      <url>/2021/11/22/RabbitMQ/02.%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4%E4%B8%8E%E4%BA%A4%E6%8D%A2%E6%9C%BA/</url>
      
        <content type="html"><![CDATA[<h1 id="发布确认"><a href="#发布确认" class="headerlink" title="发布确认"></a>发布确认</h1><h2 id="发布确认原理"><a href="#发布确认原理" class="headerlink" title="发布确认原理"></a>发布确认原理</h2><p>生产者将信道设置成<code>confirm</code>模式，一旦信道进入<code>confirm</code>模式，所有在该信道上面发布的消息都将会被指派一个唯一的<code>ID</code>（从 $1$ 开始），一旦消息被投递到所有匹配的队列之后，<code>broker</code>就会发送一个确认给生产者（包含消息的唯一<code>ID</code>），这就使得生产者知道消息已经正确到达目的队列了，如果消息和队列是可持久化的，那么确认消息会在将消息写入磁盘之后发出，<code>broker</code>回传给生产者的确认消息中<code>delivery-tag</code>域包含了确认消息的序列号，此外<code>broker</code>也可以设<code>basic.ack</code> 的<code>multiple</code>域，表示到这个序列号之前的所有消息都已经得到了处理。</p><p><code>confirm</code>模式最大的好处在于他是异步的，一旦发布一条消息，生产者应用程序就可以在等信道返回确认的同时继续发送下一条消息，当消息最终得到确认之后，生产者应用便可以通过回调方法来处理该确认消息，如果<code>RabbitMQ</code>因为自身内部错误导致消息丢失，就会发送一条<code>nack</code>消息，生产者应用程序同样可以在回调方法中处理该<code>nack</code>消息。</p><h2 id="发布确认的策略"><a href="#发布确认的策略" class="headerlink" title="发布确认的策略"></a>发布确认的策略</h2><h3 id="开启发布确认的方法"><a href="#开启发布确认的方法" class="headerlink" title="开启发布确认的方法"></a>开启发布确认的方法</h3><p>发布确认默认是没有开启的，如果要开启需要调用方法<code>confirmSelect</code>，每当你要想使用发布确认，都需要在<code>channel</code>上调用该方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel()</span><br><span class="line">channel.confirmSelect();</span><br></pre></td></tr></table></figure><h3 id="单个确认发布"><a href="#单个确认发布" class="headerlink" title="单个确认发布"></a>单个确认发布</h3><p>这是一种简单的确认方式，它是一种同步确认发布的方式，也就是发布一个消息之后只有它被确认发布，后续的消息才能继续发布，<code>waitForConfirmsOrDie(long)</code>这个方法只有在消息被确认的时候才返回，如果在指定时间范围内这个消息没有被确认那么它将抛出异常。</p><p>这种确认方式有一个最大的缺点就是:发布速度特别的慢，因为如果没有确认发布的消息就会阻塞所有后续消息的发布，这种方式最多提供每秒不超过数百条发布消息的吞吐量。当然对于某些应用程序来说这可能已经足够了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Task</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 队列名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TASK_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ack_queue&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息条数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MESSAGE_COUNT</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分别测试 单个确认发布、批量确认发布、异步确认发布 消耗的时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 单个确认发布 消耗时间为：发布 1000 个单独确认消息,耗时 184 ms</span></span><br><span class="line">        publishMessageIndividually();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单个确认发布</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">publishMessageIndividually</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel()) &#123;</span><br><span class="line">            <span class="comment">// 随机取名</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">            channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// 开启发布确认</span></span><br><span class="line">            channel.confirmSelect();</span><br><span class="line">            <span class="comment">// 开始时间</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; MESSAGE_COUNT; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> i + <span class="string">&quot;&quot;</span>;</span><br><span class="line">                channel.basicPublish(<span class="string">&quot;&quot;</span>, queueName, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">                <span class="comment">// 单个确认发发布</span></span><br><span class="line">                <span class="comment">// 服务端返回 false 或超时时间内未返回，生产者可以消息重发</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> channel.waitForConfirms();</span><br><span class="line">                <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;消息发送成功&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 结束时间</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;发布 &quot;</span> + MESSAGE_COUNT + <span class="string">&quot; 个单独确认消息,耗时 &quot;</span> + (end - begin) + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="批量确认发布"><a href="#批量确认发布" class="headerlink" title="批量确认发布"></a>批量确认发布</h3><p>上面那种方式非常慢，与单个等待确认消息相比，先发布一批消息然后一起确认可以极大地提高吞吐量，当然这种方式的缺点就是：当发生故障导致发布出现问题时，不知道是哪个消息出现问题了，必须将整个批处理保存在内存中，以记录重要的信息而后重新发布消息。当然这种方案仍然是同步的，也一样阻塞消息的发布。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Task</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 队列名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TASK_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ack_queue&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息条数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MESSAGE_COUNT</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分别测试 单个确认发布、批量确认发布、异步确认发布 消耗的时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 单个确认发布 消耗时间为：发布 1000 个单独确认消息,耗时 184 ms</span></span><br><span class="line">        <span class="comment">// publishMessageIndividually();</span></span><br><span class="line">        <span class="comment">// 批量确认发布 消耗时间为：发布 1000 个批量确认消息,耗时 41 ms</span></span><br><span class="line">        publishMessageBatch();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量确认发布</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">publishMessageBatch</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">            channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// 开启发布确认</span></span><br><span class="line">            channel.confirmSelect();</span><br><span class="line">            <span class="comment">// 批量确认消息 批量大小</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">batchSize</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">            <span class="comment">// 未确认消息个数</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">outstandingMessageCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 开始时间</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; MESSAGE_COUNT; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> i + <span class="string">&quot;&quot;</span>;</span><br><span class="line">                channel.basicPublish(<span class="string">&quot;&quot;</span>, queueName, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">                <span class="comment">// 未确认消息个数 + 1</span></span><br><span class="line">                outstandingMessageCount++;</span><br><span class="line">                <span class="comment">// 未确认消息个数达到 100 时，发布确认</span></span><br><span class="line">                <span class="keyword">if</span> (outstandingMessageCount == batchSize) &#123;</span><br><span class="line">                    channel.waitForConfirms();</span><br><span class="line">                    outstandingMessageCount = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 为了确保还有剩余没有确认消息 再次确认</span></span><br><span class="line">            <span class="keyword">if</span> (outstandingMessageCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                channel.waitForConfirms();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 结束时间</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            System.out.println(<span class="string">&quot;发布 &quot;</span> + MESSAGE_COUNT + <span class="string">&quot; 个批量确认消息,耗时 &quot;</span> + (end - begin) + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="异步确认发布"><a href="#异步确认发布" class="headerlink" title="异步确认发布"></a>异步确认发布</h3><p>异步确认虽然编程逻辑比上两个要复杂，但是性价比最高，无论是可靠性还是效率都没得说，它是利用回调函数来达到消息可靠性传递的，这个中间件也是通过函数回调来保证是否投递成功，下面就来详细讲解异步确认是怎么实现的。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637584593/1639811402-19e5dd83.png"></p></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Task</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 队列名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TASK_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ack_queue&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息条数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MESSAGE_COUNT</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分别测试 单个确认发布、批量确认发布、异步确认发布 消耗的时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 单个确认发布 消耗时间为：发布 1000 个单独确认消息,耗时 184 ms</span></span><br><span class="line">        <span class="comment">// publishMessageIndividually();</span></span><br><span class="line">        <span class="comment">// 批量确认发布 消耗时间为：发布 1000 个批量确认消息,耗时 41 ms</span></span><br><span class="line">        <span class="comment">// publishMessageBatch();</span></span><br><span class="line">        <span class="comment">// 异步确认发布 消耗时间为：发布 1000 个异步确认消息,耗时 23 ms</span></span><br><span class="line">        publishMessageAsync();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异步发布确认</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">publishMessageAsync</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">            channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// 开启发布确认</span></span><br><span class="line">            channel.confirmSelect();</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 线程安全有序的一个哈希表，适用于高并发的情况</span></span><br><span class="line"><span class="comment">             * 1. 将序号与消息进行关联</span></span><br><span class="line"><span class="comment">             * 2. 只要给到序列号，可以批量删除条目</span></span><br><span class="line"><span class="comment">             * 3. 支持并发访问</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            ConcurrentSkipListMap&lt;Long, String&gt; outstandingConfirms = <span class="keyword">new</span> <span class="title class_">ConcurrentSkipListMap</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 确认收到消息的一个回调</span></span><br><span class="line"><span class="comment">             * 1. 消息序列号</span></span><br><span class="line"><span class="comment">             * 2. true 可以确认小于等于当前序列号的消息，false 确认当前序列号消息</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">ConfirmCallback</span> <span class="variable">ackCallback</span> <span class="operator">=</span> (sequenceNumber, multiple) -&gt; &#123;</span><br><span class="line">                <span class="comment">// 是否批量发布</span></span><br><span class="line">                <span class="keyword">if</span> (multiple) &#123;</span><br><span class="line">                    <span class="comment">// 批量发布</span></span><br><span class="line">                    <span class="comment">// 返回的是小于等于当前序列号的未确认消息 是一个 map</span></span><br><span class="line">                    ConcurrentNavigableMap&lt;Long, String&gt; confirmed = outstandingConfirms.headMap(sequenceNumber, <span class="literal">true</span>);</span><br><span class="line">                    <span class="comment">// 清除该部分未确认消息</span></span><br><span class="line">                    confirmed.clear();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 只清除当前序列号的消息</span></span><br><span class="line">                    outstandingConfirms.remove(sequenceNumber);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">// 未确认消息的回调函数</span></span><br><span class="line">            <span class="type">ConfirmCallback</span> <span class="variable">nackCallback</span> <span class="operator">=</span> (sequenceNumber, multiple) -&gt; &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> outstandingConfirms.get(sequenceNumber);</span><br><span class="line">                System.out.println(<span class="string">&quot;发布的消息 &quot;</span> + message + <span class="string">&quot; 未被确认，序列号 &quot;</span> + sequenceNumber);</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 添加一个异步确认的监听器</span></span><br><span class="line"><span class="comment">             * 1. 确认收到消息的回调</span></span><br><span class="line"><span class="comment">             * 2. 未收到消息的回调</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.addConfirmListener(ackCallback, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 开始时间</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; MESSAGE_COUNT; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;消息&quot;</span> + i;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * channel.getNextPublishSeqNo() 获取下一个消息的序列号</span></span><br><span class="line"><span class="comment">                 * 将序列号与消息体进行关联</span></span><br><span class="line"><span class="comment">                 * 全部都是未确认的消息体</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                outstandingConfirms.put(channel.getNextPublishSeqNo(), message);</span><br><span class="line">                channel.basicPublish(<span class="string">&quot;&quot;</span>, queueName, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 结束时间</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            System.out.println(<span class="string">&quot;发布 &quot;</span> + MESSAGE_COUNT + <span class="string">&quot; 个异步确认消息,耗时 &quot;</span> + (end - begin) + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="如何处理异步未确认消息"><a href="#如何处理异步未确认消息" class="headerlink" title="如何处理异步未确认消息"></a>如何处理异步未确认消息</h3><p>最好的解决的解决方案就是把未确认的消息放到一个基于内存的能被发布线程访问的队列，比如说用<code>ConcurrentLinkedQueue</code>这个队列在<code>confirm callbacks</code>与发布线程之间进行消息的传递。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 线程安全有序的一个哈希表，适用于高并发的情况</span></span><br><span class="line"><span class="comment">             * 1. 将序号与消息进行关联</span></span><br><span class="line"><span class="comment">             * 2. 只要给到序列号，可以批量删除条目</span></span><br><span class="line"><span class="comment">             * 3. 支持并发访问</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            ConcurrentSkipListMap&lt;Long, String&gt; outstandingConfirms = <span class="keyword">new</span> <span class="title class_">ConcurrentSkipListMap</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 确认收到消息的一个回调</span></span><br><span class="line"><span class="comment">             * 1. 消息序列号</span></span><br><span class="line"><span class="comment">             * 2. true 可以确认小于等于当前序列号的消息，false 确认当前序列号消息</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">ConfirmCallback</span> <span class="variable">ackCallback</span> <span class="operator">=</span> (sequenceNumber, multiple) -&gt; &#123;</span><br><span class="line">                <span class="comment">// 是否批量发布</span></span><br><span class="line">                <span class="keyword">if</span> (multiple) &#123;</span><br><span class="line">                    <span class="comment">// 批量发布</span></span><br><span class="line">                    <span class="comment">// 返回的是小于等于当前序列号的未确认消息 是一个 map</span></span><br><span class="line">                    ConcurrentNavigableMap&lt;Long, String&gt; confirmed = outstandingConfirms.headMap(sequenceNumber, <span class="literal">true</span>);</span><br><span class="line">                    <span class="comment">// 清除该部分未确认消息</span></span><br><span class="line">                    confirmed.clear();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 只清除当前序列号的消息</span></span><br><span class="line">                    outstandingConfirms.remove(sequenceNumber);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">// 未确认消息的回调函数</span></span><br><span class="line">            <span class="type">ConfirmCallback</span> <span class="variable">nackCallback</span> <span class="operator">=</span> (sequenceNumber, multiple) -&gt; &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> outstandingConfirms.get(sequenceNumber);</span><br><span class="line">                System.out.println(<span class="string">&quot;发布的消息 &quot;</span> + message + <span class="string">&quot; 未被确认，序列号 &quot;</span> + sequenceNumber);</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 添加一个异步确认的监听器</span></span><br><span class="line"><span class="comment">             * 1. 确认收到消息的回调</span></span><br><span class="line"><span class="comment">             * 2. 未收到消息的回调</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.addConfirmListener(ackCallback, <span class="literal">null</span>);  </span><br></pre></td></tr></table></figure><h3 id="以上-3-种发布确认速度对比"><a href="#以上-3-种发布确认速度对比" class="headerlink" title="以上 3 种发布确认速度对比"></a>以上 3 种发布确认速度对比</h3><ul><li>单独发布消息<br>同步等待确认，简单，但吞吐量非常有限。</li><li>批量发布消息<br>批量同步等待确认，简单，合理的吞吐量，一旦出现问题但很难推断出是那条消息出现了问题。</li><li>异步处理<br>最佳性能和资源使用，在出现错误的情况下可以很好地控制，但是实现起来稍微难些。</li></ul><h1 id="交换机"><a href="#交换机" class="headerlink" title="交换机"></a>交换机</h1><p>在上一节中创建了一个工作队列。假设的是工作队列背后，每个任务都恰好交付给一个消费者（工作进程）。在这一部分将做一些完全不同的事情：将消息传达给多个消费者。这种模式称为“发布/订阅”。</p><p>为了说明这种模式，将构建一个简单的日志系统。它将由两个程序组成：第一个程序将发出日志消息，第二个程序是消费者。启动两个消费者，其中一个消费者接收到消息后把日志存储在磁盘，另外一个消费者接收到消息后把消息打印在屏幕上，事实上第一个程序发出的日志消息将广播给所有消费者。</p><h2 id="Exchanges"><a href="#Exchanges" class="headerlink" title="Exchanges"></a>Exchanges</h2><h3 id="Exchanges-概念"><a href="#Exchanges-概念" class="headerlink" title="Exchanges 概念"></a>Exchanges 概念</h3><p><code>RabbitMQ</code>消息传递模型的核心思想是：生产者生产的消息从不会直接发送到队列。实际上，通常生产者甚至都不知道这些消息传递传递到了哪些队列中。</p><p>相反，生产者只能将消息发送到交换机（<code>exchange</code>），交换机工作的内容非常简单，一方面它接收来自生产者的消息，另一方面将它们推入队列。交换机必须确切知道如何处理收到的消息。是应该把这些消息放到特定队列还是说把他们到许多队列中还是说应该丢弃它们。这就的由交换机的类型来决定。</p><h3 id="Exchanges-的类型"><a href="#Exchanges-的类型" class="headerlink" title="Exchanges 的类型"></a>Exchanges 的类型</h3><p>总共有以下类型：</p><ul><li>直接（<code>direct</code>）</li><li>主题（<code>topic</code>）</li><li>标题（<code>headers</code>）</li><li>扇出（<code>fanout</code>）</li></ul><h3 id="无名exchange"><a href="#无名exchange" class="headerlink" title="无名exchange"></a>无名exchange</h3><p>在前面部分对<code>exchange</code>一无所知，但仍然能够将消息发送到队列。之前能实现的原因是因为使用的是默认交换，通过空字符串（<code>&quot;&quot;</code>）进行标识。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.basicPublish(<span class="string">&quot;&quot;</span>,<span class="string">&quot;hello&quot;</span>, <span class="literal">null</span>, message.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br></pre></td></tr></table></figure><p>第一个参数是交换机的名称。空字符串表示默认或无名称交换机：消息能路由发送到队列中其实是由<code>routingKey(bindingkey)</code>绑定<code>key</code>指定的，如果它存在的话。</p><h2 id="临时队列"><a href="#临时队列" class="headerlink" title="临时队列"></a>临时队列</h2><p>之前使用的是具有特定名称的队列（<code>hello</code>和<code>ack_queue</code>）。队列的名称至关重要——需要指定消费者去消费哪个队列的消息。</p><p>每当连接到<code>Rabbit</code>时，都需要一个全新的空队列，为此可以创建一个具有随机名称的队列，或者能让服务器选择一个随机队列名称那就更好了。其次一旦断开了消费者的连接，队列将被自动删除。</p><p>创建临时队列的方式如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br></pre></td></tr></table></figure><p>创建出来之后长成这样：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637584593/1639811486-9e08a2ab.png"></p></div><h2 id="绑定（bindings）"><a href="#绑定（bindings）" class="headerlink" title="绑定（bindings）"></a>绑定（bindings）</h2><p>什么是<code>bingding</code>呢，<code>binding</code>其实是<code>exchange</code>和<code>queue</code>之间的桥梁，它告诉我们<code>exchange</code>和那个队列进行了绑定关系。比如说下面这张图告诉我们的就是<code>X</code>与<code>Q1</code>和<code>Q2</code>进行了绑定。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637584593/1639811517-0977ec80.png"></p></div><h2 id="Fanout"><a href="#Fanout" class="headerlink" title="Fanout"></a>Fanout</h2><h3 id="Fanout-介绍"><a href="#Fanout-介绍" class="headerlink" title="Fanout 介绍"></a>Fanout 介绍</h3><p><code>Fanout</code>这种类型非常简单。正如从名称中猜到的那样，它是将接收到的所有消息广播到它知道的<br>所有队列中。系统中默认有些<code>exchange</code>类型：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637584593/1639811555-b2c495f7.png"></p></div><h3 id="Fanout-实战"><a href="#Fanout-实战" class="headerlink" title="Fanout 实战"></a>Fanout 实战</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637584593/1639811585-46f46f7b.png"></p></div><p><code>Logs</code>和临时队列的绑定关系如下图：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637584593/1639811615-5367e061.png"></p></div><ul><li><code>Receive01</code>将接收到的消息打印在控制台<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Receive01</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;logs&quot;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;fanout&quot;</span>);</span><br><span class="line">  </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 生成一个临时的队列 队列的名称是随机的</span></span><br><span class="line"><span class="comment">         * 当消费者断开和该队列的连接时 队列自动删除</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// 把该临时队列绑定 exchange，其中 RoutingKey（也称之为 binding key）为空字符串</span></span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;&quot;</span>);</span><br><span class="line">  </span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息,把接收到的消息打印在屏幕........... &quot;</span>);</span><br><span class="line">  </span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;控制台打印接收到的消息&quot;</span>+message);</span><br><span class="line">        &#125;;</span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 接收消息</span></span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123; &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><code>Receive02</code>将接收到的消息存储在磁盘<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Receive02</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;fanout&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 生成一个临时的队列 队列的名称是随机的</span></span><br><span class="line"><span class="comment">         * 当消费者断开和该队列的连接时 队列自动删除</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// 把该临时队列绑定 exchange，其中 RoutingKey（也称之为 binding key）为空字符串</span></span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息,把接收到的消息写到文件........... &quot;</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;rabbitmq_info.txt&quot;</span>);</span><br><span class="line">            FileUtils.writeStringToFile(file,message,<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;数据写入文件成功&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接收消息</span></span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123; &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><code>EmitLog</code>发送消息给两个消费者接收<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Emit</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;logs&quot;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel()) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 声明一个 exchange</span></span><br><span class="line"><span class="comment">             * 1. exchange 的名称</span></span><br><span class="line"><span class="comment">             * 2. exchange 的类型</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;fanout&quot;</span>);</span><br><span class="line">        </span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            System.out.println(<span class="string">&quot;请输入信息&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (sc.hasNext()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> sc.nextLine();</span><br><span class="line">                channel.basicPublish(EXCHANGE_NAME, <span class="string">&quot;&quot;</span>, <span class="literal">null</span>, message.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                System.out.println(<span class="string">&quot;生产者发出消息：&quot;</span> + message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="Direct-exchange"><a href="#Direct-exchange" class="headerlink" title="Direct exchange"></a>Direct exchange</h2><h3 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h3><p>在上一节中构建了一个简单的日志记录系统。能够向许多接收者广播日志消息。在本节我们向其中添加一些特别的功能：比方说只让某个消费者订阅发布的部分消息。例如只把严重错误消息定向存储到日志文件（以节省磁盘空间），同时仍然能够在控制台上打印所有日志消息。</p><p>再次来回顾一下什么是<code>bindings</code>，绑定是交换机和队列之间的桥梁关系。也可以这么理解：队列只对它绑定的交换机的消息感兴趣。</p><p>绑定用参数：<code>routingKey</code>来表示，也可称该参数为<code>binding key</code>，创建绑定用代码：<code>channel.queueBind(queueName, EXCHANGE_NAME, &quot;routingKey&quot;);</code>，绑定之后的意义由其交换类型决定。</p><h3 id="Direct-exchange-介绍"><a href="#Direct-exchange-介绍" class="headerlink" title="Direct exchange 介绍"></a>Direct exchange 介绍</h3><p>上一节中的日志系统将所有消息广播给所有消费者，对此想做一些改变，例如希望将日志消息写入磁盘的程序仅接收严重错误（<code>errros</code>），而不存储那些警告（<code>warning</code>）或信息（<code>info</code>）日志消息避免浪费磁盘空间。</p><p><code>Fanout</code>这种交换类型并不能带来很大的灵活性——它只能进行无意识的广播，在这里将使用<code>direct</code>这种类型来进行替换，这种类型的工作方式是，消息只去到它绑定的<code>routingKey</code>队列中去。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637584593/1639811671-988ffb44.png"></p></div><p>在上面这张图中，可以看到<code>X</code>绑定了两个队列，绑定类型是<code>direct</code>。队列<code>Q1</code>绑定键为<code>orange</code>，队列<code>Q2</code>绑定键有两个：一个绑定键为<code>black</code>，另一个绑定键为<code>green</code>。</p><p>在这种绑定情况下，生产者发布消息到<code>exchange</code>上，绑定键为<code>orange</code>的消息会被发布到队列<code>Q1</code>。绑定键为<code>black</code>和<code>green</code>的消息会被发布到队列<code>Q2</code>，其他消息类型的消息将被丢弃。</p><h3 id="多重绑定"><a href="#多重绑定" class="headerlink" title="多重绑定"></a>多重绑定</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637584593/1639811703-792e972e.png"></p></div><p>当然如果<code>exchange</code>的绑定类型是<code>direct</code>，但是它绑定的多个队列的<code>key</code>如果都相同，在这种情况下虽然绑定类型是<code>direct</code>，但是它表现的就和<code>fanout</code>有点类似了，就跟广播差不多，如上图所示。</p><h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637584593/1639811734-0811aa41.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637584593/1639811748-2018a20d.png"></p></div><ul><li><p>消费者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveDirect01</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;direct_logs&quot;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class="line">    </span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;disk&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">    </span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息........... &quot;</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            message=<span class="string">&quot;接收绑定键:&quot;</span>+delivery.getEnvelope().getRoutingKey()+<span class="string">&quot;,消息:&quot;</span>+message;</span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;../rabbitmq_info.txt&quot;</span>);</span><br><span class="line">            FileUtils.writeStringToFile(file,message,<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;错误日志已经接收&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    </span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveDirect02</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;direct_logs&quot;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  </span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;console&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;info&quot;</span>);</span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;warning&quot;</span>);</span><br><span class="line">  </span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息........... &quot;</span>);</span><br><span class="line">  </span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot; 接收绑定键：&quot;</span>+delivery.getEnvelope().getRoutingKey()+<span class="string">&quot;，消息：&quot;</span>+message);</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>生产者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmitDirect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;direct_logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel()) &#123;</span><br><span class="line">            channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class="line">            <span class="comment">// 创建多个 bindingKey</span></span><br><span class="line">            Map&lt;String, String&gt; bindingKeyMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;info&quot;</span>, <span class="string">&quot;普通 info 信息&quot;</span>);</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;warning&quot;</span>, <span class="string">&quot;警告 warning 信息&quot;</span>);</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;error&quot;</span>, <span class="string">&quot;错误 error 信息&quot;</span>);</span><br><span class="line">            <span class="comment">// debug 没有消费这接收这个消息 所有就丢失了</span></span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;debug&quot;</span>, <span class="string">&quot;调试 debug 信息&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; bindingKeyEntry : bindingKeyMap.entrySet()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">bindingKey</span> <span class="operator">=</span> bindingKeyEntry.getKey();</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> bindingKeyEntry.getValue();</span><br><span class="line">                channel.basicPublish(EXCHANGE_NAME, bindingKey, <span class="literal">null</span>, message.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                System.out.println(<span class="string">&quot;生产者发出消息：&quot;</span> + message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="Topics"><a href="#Topics" class="headerlink" title="Topics"></a>Topics</h2><h3 id="之前类型的问题"><a href="#之前类型的问题" class="headerlink" title="之前类型的问题"></a>之前类型的问题</h3><p>在上一个小节中改进了日志记录系统。没有使用只能进行随意广播的<code>fanout</code>交换机，而是使用了<code>direct</code>交换机，从而有能实现有选择性地接收日志。</p><p>尽管使用<code>direct</code>交换机改进了系统，但是它仍然存在局限性：比方说想接收的日志类型有<code>info.base</code>和<code>info.advantage</code>，某个队列只想<code>info.base</code>的消息，那这个时候<code>direct</code>就办不到了。这个时候就只能使用<code>topic</code>类型</p><h3 id="Topic-的要求"><a href="#Topic-的要求" class="headerlink" title="Topic 的要求"></a>Topic 的要求</h3><p>发送到类型是<code>topic</code>，交换机的消息的<code>routing_key</code>不能随意写，必须满足一定的要求，它必须是一个单词列表，以点号分隔开。这些单词可以是任意单词，比如说：<code>stock.usd.nyse</code>，<code>nyse.vmw</code>，<code>quick.orange.rabbit</code>这种类型的。当然这个单词列表最多不能超过 $255$ 个字节。</p><p>在这个规则列表中，其中有两个替换符是需要注意的：</p><ul><li><code>*</code>（星号）可以代替一个单词</li><li><code>#</code>（井号）可以替代零个或多个单词</li></ul><h3 id="Topic-匹配案例"><a href="#Topic-匹配案例" class="headerlink" title="Topic 匹配案例"></a>Topic 匹配案例</h3><p>下图绑定关系如下：</p><ul><li><code>Q1</code>绑定的是<ul><li>中间带<code>orange</code>带 $3$ 个单词的字符串（<code>*.orange.*</code>）</li></ul></li><li><code>Q2</code>绑定的是  <ul><li>最后一个单词是<code>rabbit</code>的 $3$ 个单词（<code>*.*.rabbit</code>）</li><li>第一个单词是<code>lazy</code>的多个单词（<code>lazy.#</code>）</li></ul></li></ul><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637584593/1639811796-26ca4050.png"></p></div><p>上图是一个队列绑定关系图，来看看他们之间数据接收情况是怎么样的：</p><ul><li><code>quick.orange.rabbit</code>被队列<code>Q1</code>、<code>Q2</code>接收到</li><li><code>lazy.orange.elephant</code>被队列<code>Q1</code>、<code>Q2</code>接收到</li><li><code>quick.orange.fox</code>被队列<code>Q1</code>接收到</li><li><code>lazy.brown.fox</code>被队列<code>Q2</code>接收到</li><li><code>lazy.pink.rabbit</code>虽然满足两个绑定但只被队列<code>Q2</code>接收一次</li><li><code>quick.brown.fox</code>不匹配任何绑定不会被任何队列接收到会被丢弃</li><li><code>quick.orange.male.rabbit</code>是四个单词不匹配任何绑定会被丢弃</li><li><code>lazy.orange.male.rabbit</code>是四个单词但匹配<code>Q2</code></li></ul><p>当队列绑定关系是下列这种情况时需要引起注意：</p><ul><li><strong>当一个队列绑定键是<code>#</code>，那么这个队列将接收所有数据，就有点像<code>fanout</code>了</strong></li><li><strong>如果队列绑定键当中没有<code>#</code>和<code>*</code>出现，那么该队列绑定类型就是<code>direct</code>了</strong></li></ul><h3 id="实战-1"><a href="#实战-1" class="headerlink" title="实战"></a>实战</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637584593/1639811839-aeece4a5.png"></p></div><ul><li><p>消费者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveTopic01</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;topic_logs&quot;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;topic&quot;</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 声明 Q1 队列与绑定关系</span></span><br><span class="line">        String queueName=<span class="string">&quot;Q1&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;*.orange.*&quot;</span>);</span><br><span class="line">    </span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息........... &quot;</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123; </span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;接收队列：&quot;</span>+queueName+<span class="string">&quot;绑定键：&quot;</span>+delivery.getEnvelope().getRoutingKey()+<span class="string">&quot;,消息:&quot;</span>+message);</span><br><span class="line">        &#125;;</span><br><span class="line">    </span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveTopic02</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;topic_logs&quot;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;topic&quot;</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 声明 Q2 队列与绑定关系</span></span><br><span class="line">        String queueName=<span class="string">&quot;Q2&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;*.*.rabbit&quot;</span>);</span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;lazy.#&quot;</span>);</span><br><span class="line">    </span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息........... &quot;</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123; </span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;接收队列：&quot;</span>+queueName+<span class="string">&quot;绑定键:&quot;</span>+delivery.getEnvelope().getRoutingKey()+<span class="string">&quot;，消息：&quot;</span>+message);</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>生产者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmitTopic</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;topic_logs&quot;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel()) &#123;</span><br><span class="line">            channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;topic&quot;</span>);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * Q1 绑定的是 中间带 orange 带 3 个单词的字符串（*.orange.*）</span></span><br><span class="line"><span class="comment">             * Q2 绑定的是 最后一个单词是 rabbit 的 3 个单词（*.*.rabbit），第一个单词是 lazy 的多个单词（lazy.#）</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            Map&lt;String, String&gt; bindingKeyMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;quick.orange.rabbit&quot;</span>,<span class="string">&quot;被队列 Q1 Q2 接收到&quot;</span>);</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;lazy.orange.elephant&quot;</span>,<span class="string">&quot;被队列 Q1 Q2 接收到&quot;</span>);</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;quick.orange.fox&quot;</span>,<span class="string">&quot;被队列 Q1 接收到&quot;</span>);</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;lazy.brown.fox&quot;</span>,<span class="string">&quot;被队列 Q2 接收到&quot;</span>);</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;lazy.pink.rabbit&quot;</span>,<span class="string">&quot;虽然满足两个绑定但只被队列 Q2 接收一次&quot;</span>);</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;quick.brown.fox&quot;</span>,<span class="string">&quot;不匹配任何绑定不会被任何队列接收到会被丢弃&quot;</span>);</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;quick.orange.male.rabbit&quot;</span>,<span class="string">&quot;是四个单词不匹配任何绑定会被丢弃&quot;</span>);</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;lazy.orange.male.rabbit&quot;</span>,<span class="string">&quot;是四个单词但匹配 Q2&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; bindingKeyEntry : bindingKeyMap.entrySet()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">bindingKey</span> <span class="operator">=</span> bindingKeyEntry.getKey();</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> bindingKeyEntry.getValue();</span><br><span class="line">                channel.basicPublish(EXCHANGE_NAME,bindingKey, <span class="literal">null</span>, message.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                System.out.println(<span class="string">&quot;生产者发出消息：&quot;</span> + message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RabbitMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>消息队列</title>
      <link href="/2021/11/19/RabbitMQ/01.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
      <url>/2021/11/19/RabbitMQ/01.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/</url>
      
        <content type="html"><![CDATA[<h1 id="MQ-的相关概念"><a href="#MQ-的相关概念" class="headerlink" title="MQ 的相关概念"></a>MQ 的相关概念</h1><h2 id="什么是-MQ"><a href="#什么是-MQ" class="headerlink" title="什么是 MQ"></a>什么是 MQ</h2><p><code>MQ(message queue)</code>，从字面意思上看，本质是个队列，<code>FIFO</code>先入先出，只不过队列中存放的内容是<code>message</code>而已，还是一种跨进程的通信机制，用于上下游传递消息。在互联网架构中，<code>MQ</code>是一种非常常见的上下游“逻辑解耦+物理解耦”的消息通信服务。使用了<code>MQ</code>之后，消息发送上游只需要依赖<code>MQ</code>，不用依赖其他服务。</p><h2 id="为什么要用-MQ"><a href="#为什么要用-MQ" class="headerlink" title="为什么要用 MQ"></a>为什么要用 MQ</h2><h3 id="流量消峰"><a href="#流量消峰" class="headerlink" title="流量消峰"></a>流量消峰</h3><p>举个例子，如果订单系统最多能处理一万次订单，这个处理能力应付正常时段的下单时绰绰有余，正常时段下单一秒后就能返回结果。但是在高峰期，如果有两万次下单操作系统是处理不了的，只能限制订单超过一万后不允许用户下单。</p><p>使用消息队列做缓冲，可以取消这个限制，把一秒内下的订单分散成一段时间来处理，这时有些用户可能在下单十几秒后才能收到下单成功的操作，但是比不能下单的体验要好。</p><h3 id="应用解耦"><a href="#应用解耦" class="headerlink" title="应用解耦"></a>应用解耦</h3><p>以电商应用为例，应用中有订单系统、库存系统、物流系统、支付系统。用户创建订单后，如果耦合调用库存系统、物流系统、支付系统，任何一个子系统出了故障，都会造成下单操作异常。</p><p>当转变成基于消息队列的方式后，系统间调用的问题会减少很多，比如物流系统因为发生故障，需要几分钟来修复。</p><p>在这几分钟的时间里，物流系统要处理的内存被缓存在消息队列中，用户的下单操作可以正常完成。当物流系统恢复后，继续处理订单信息即可，中单用户感受不到物流系统的故障，提升系统的可用性。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637306914/1639810494-4a4a2687.png"></p></div><h3 id="异步处理"><a href="#异步处理" class="headerlink" title="异步处理"></a>异步处理</h3><p>有些服务间调用是异步的，例如<code>A</code>调用<code>B</code>，<code>B</code>需要花费很长时间执行，但是<code>A</code>需要知道<code>B</code>什么时候可以执行完，以前一般有两种方式，<code>A</code>过一段时间去调用<code>B</code>的查询<code>api</code>查询。或者<code>A</code>提供一个<code>callback api</code>，<code>B</code>执行完之后调用<code>api</code>通知<code>A</code>服务。</p><p>这两种方式都不是很优雅，使用消息总线，可以很方便解决这个问题，<code>A</code>调用<code>B</code>服务后，只需要监听<code>B</code>处理完成的消息，当<code>B</code>处理完成后，会发送一条消息给<code>MQ</code>，<code>MQ</code>会将此消息转发给<code>A</code>服务。这样<code>A</code>服务既不用循环调用<code>B</code>的查询<code>api</code>，也不用提供<code>callback api</code>。同样<code>B</code>服务也不用做这些操作。<code>A</code>服务还能及时的得到异步处理成功的消息。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637306914/1639810532-dea0452e.png"></p></div><h2 id="MQ-的分类"><a href="#MQ-的分类" class="headerlink" title="MQ 的分类"></a>MQ 的分类</h2><ol><li><code>ActiveMQ</code><ul><li>优点：单机吞吐量万级，时效性<code>ms</code>级，可用性高，基于主从架构实现高可用性，消息可靠性较低的概率丢失数据</li><li>缺点：官方社区现在对<code>ActiveMQ 5.x</code>维护越来越少，高吞吐量场景较少使用</li></ul></li><li><code>Kafka</code><br> 大数据的杀手锏，谈到大数据领域内的消息传输，则绕不开<code>Kafka</code>，这款为大数据而生的消息中间件，以其百万级<code>TPS</code>的吞吐量名声大噪，迅速成为大数据领域的宠儿，在数据采集、传输、存储的过程中发挥着举足轻重的作用。目前已经被<code>LinkedIn</code>，<code>Uber</code>,<code> Twitter</code>, <code>Netflix</code>等大公司所采纳。<ul><li>优点：性能卓越，单机写入<code>TPS</code>约在百万条/秒，最大的优点，就是吞吐量高。时效性<code>ms</code>级可用性非常高，<code>kafka</code>是分布式的，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用，消费者采用<code>Pull</code>方式获取消息，消息有序，通过控制能够保证所有消息被消费且仅被消费一次；有优秀的第三方<code>Kafka Web</code>管理界面<code>Kafka-Manager</code>；在日志领域比较成熟，被多家公司和多个开源项目使用</li><li><code>Kafka</code>单机超过 $64$ 个队列/分区，<code>Load</code>会发生明显的飙高现象，队列越多，<code>load</code>越高，发送消息响应时间变长，使用短轮询方式，实时性取决于轮询间隔时间，消费失败不支持重试；支持消息顺序，但是一台代理宕机后，就会产生消息乱序，社区更新较慢</li><li>功能支持：功能较为简单，主要支持简单的<code>MQ</code>功能，在大数据领域的实时计算以及日志采集被大规模使用</li></ul></li><li><code>RocketMQ</code><br> <code>RocketMQ</code>出自阿里巴巴的开源产品，用<code>Java</code>语言实现，在设计时参考了<code>Kafka</code>，并做出了自己的一些改进。被阿里巴巴广泛应用在订单，交易，充值，流计算，消息推送，日志流式处理，<code>binglog</code>分发等场景。<ul><li>优点：单机吞吐量十万级,可用性非常高，分布式架构，消息可以做到 $0$ 丢失，<code>MQ</code>功能较为完善，还是分布式的，扩展性好，支持 $10$ 亿级别的消息堆积，不会因为堆积导致性能下降，源码是<code>java</code>，可以阅读源码，定制自己公司的<code>MQ</code></li><li>缺点：支持的客户端语言不多，目前是<code>java</code>及<code>c++</code>，其中<code>c++</code>不成熟；社区活跃度一般，没有在<code>MQ</code>核心中去实现<code>JMS</code>等接口，有些系统要迁移需要修改大量代码</li></ul></li><li><code>RabbitMQ</code><br> $2007$ 年发布，是一个在<code>AMQP</code>（高级消息队列协议）基础上完成的，可复用的企业消息系统，是当前最主流的消息中间件之一。<ul><li>优点：由于<code>erlang</code>语言的高并发特性，性能较好；吞吐量到万级，<code>MQ</code>功能比较完备，健壮、稳定、易用、跨平台、支持多种语言：<code>Python</code>、<code>Ruby</code>、<code>.NET</code>、<code>Java</code>、<code>JMS</code>、<code>C</code>、<code>PHP</code>、<code>ActionScript</code>、<code>XMPP</code>、<code>STOMP</code>等，支持<code>AJAX</code>文档齐全；开源提供的管理界面非常棒，用起来很好用，社区活跃度高；<a href="https://www.rabbitmq.com/news.html">更新频率相当高</a></li><li>缺点：商业版需要收费，学习成本较高</li></ul></li></ol><h2 id="MQ-的选择"><a href="#MQ-的选择" class="headerlink" title="MQ 的选择"></a>MQ 的选择</h2><ol><li><code>Kafka</code><br> <code>Kafka</code>主要特点是基于<code>Pull</code>的模式来处理消息消费，追求高吞吐量，一开始的目的就是用于日志收集和传输，适合产生大量数据的互联网服务的数据收集业务。大型公司建议可以选用，如果有日志采集功能，肯定是首选<code>kafka</code>了。</li><li><code>RocketMQ</code><br> 天生为金融互联网领域而生，对于可靠性要求很高的场景，尤其是电商里面的订单扣款，以及业务削峰，在大量交易涌入时，后端可能无法及时处理的情况。<code>RoketMQ</code>在稳定性上可能更值得信赖，这些业务场景在阿里双 $11$ 已经经历了多次考验，如果业务有上述并发场景，建议可以选择 <code>RocketMQ</code>。</li><li><code>RabbitMQ</code><br> 结合<code>erlang</code>语言本身的并发优势，性能好时效性微秒级，社区活跃度也比较高，管理界面用起来十分方便，如果数据量没有那么大，中小型公司优先选择功能比较完备的<code>RabbitMQ</code>。</li></ol><h1 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h1><h2 id="RabbitMQ-的概念"><a href="#RabbitMQ-的概念" class="headerlink" title="RabbitMQ 的概念"></a>RabbitMQ 的概念</h2><p><code>RabbitMQ</code>是一个消息中间件：它接受并转发消息。可以把它当做一个快递站点，当要发送一个包裹时，把包裹放到快递站，快递员最终会把快递送到收件人那里，按照这种逻辑，<code>RabbitMQ</code>是一个快递站，一个快递员帮你传递快件。<code>RabbitMQ</code>与快递站的主要区别在于，它不处理快件而是接收，存储和转发消息数据。</p><h2 id="四大核心概念"><a href="#四大核心概念" class="headerlink" title="四大核心概念"></a>四大核心概念</h2><ul><li>生产者：产生数据发送消息的程序是生产者</li><li>交换机：交换机是<code>RabbitMQ</code>非常重要的一个部件，一方面它接收来自生产者的消息，另一方面它将消息推送到队列中。交换机必须确切知道如何处理它接收到的消息，是将这些消息推送到特定队列还是推送到多个队列，亦或者是把消息丢弃，这个得有交换机类型决定。</li><li>队列：队列是<code>RabbitMQ</code>内部使用的一种数据结构，尽管消息流经<code>RabbitMQ</code>和应用程序，但它们只能存储在队列中。队列仅受主机的内存和磁盘限制的约束，本质上是一个大的消息缓冲区。许多生产者可以将消息发送到一个队列，许多消费者可以尝试从一个队列接收数据。这就是使用队列的方式。</li><li>消费者：消费与接收具有相似的含义。消费者大多时候是一个等待接收消息的程序。请注意生产者，消费者和消息中间件很多时候并不在同一机器上。同一个应用程序既可以是生产者又是可以是消费者。</li></ul><h2 id="名词介绍"><a href="#名词介绍" class="headerlink" title="名词介绍"></a>名词介绍</h2><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637306914/1639810578-e65bf41d.png"></p></div><ul><li><code>Broker</code>：接收和分发消息的应用，<code>RabbitMQ Server</code>就是<code>Message Broker</code></li><li><code>Virtual host</code>：出于多租户和安全因素设计的，把<code>AMQP</code>的基本组件划分到一个虚拟的分组中，类似于网络中的<code>namespace</code>概念。当多个不同的用户使用同一个<code>RabbitMQ Server</code>提供的服务时，可以划分出多个<code>vhost</code>，每个用户在自己的<code>vhost</code>创建<code>exchange／queue</code>等</li><li><code>Connection</code>：<code>publisher／consumer</code>和<code>broker</code>之间的<code>TCP</code>连接</li><li><code>Channel</code>：如果每一次访问<code>RabbitMQ</code>都建立一个<code>Connection</code>，在消息量大的时候建立<code>TCP Connection</code>的开销将是巨大的，效率也较低。<code>Channel</code>是在<code>connection</code>内部建立的逻辑连接，如果应用程序支持多线程，通常每个<code>thread</code>创建单独的<code>channel</code>进行通讯，<code>AMQP method</code>包含了<code>channel id</code>帮助客户端和<code>message broker</code>识别<code>channel</code>，所以<code>channel</code>之间是完全隔离的。<code>Channel</code>作为轻量级的<code>Connection</code>极大减少了操作系统建立<code>TCP connection</code>的开销</li><li><code>Exchange</code>：<code>message</code>到达<code>broker</code>的第一站，根据分发规则，匹配查询表中的<code>routing key</code>，分发消息到<code>queue</code>中去。常用的类型有：<code>direct (point-to-point)</code>，<code>topic (publish-subscribe) and fanout(multicast)</code></li><li><code>Queue</code>：消息最终被送到这里等待<code>consumer</code>取走</li><li><code>Binding</code>：<code>exchange</code>和<code>queue</code>之间的虚拟连接，<code>binding</code>中可以包含<code>routing key</code>，<code>Binding</code>信息被保存到<code>exchange</code>中的查询表中，用于<code>message</code>的分发依据</li></ul><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ol><li><p><a href="https://www.rabbitmq.com/download.html">官网地址</a></p></li><li><p>文件上传<br> <code>erlang</code>和<code>RabbitMQ</code>上传到<code>/usr/local/software</code>目录下（如果没有<code>software</code>需要自己创建）</p></li><li><p>安装文件（分别按照以下顺序安装）</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh erlang-21.3-1.el7.x86_64.rpm</span><br><span class="line">yum install socat -y</span><br><span class="line">rpm -ivh rabbitmq-server-3.8.8-1.el7.noarch.rpm</span><br></pre></td></tr></table></figure><p> 安装依赖问题：</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libcrypto.so<span class="number">.10</span>()(64bit) is needed by erlang-<span class="number">21.3</span><span class="number">.8</span><span class="number">.9</span>-<span class="number">1.</span>el7.x86_64</span><br></pre></td></tr></table></figure><p> <code>https://pkgs.org/</code>搜索<code>libcrypto.so.10()(64bit)</code></p></li><li><p>常用命令（按照以下顺序执行）</p><ol><li><p>添加开机启动<code>RabbitMQ</code>服务</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig rabbitmq-server on</span><br></pre></td></tr></table></figure></li><li><p>启动服务</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/sbin/service rabbitmq-server start</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">systemctl start rabbitmq-server</span><br></pre></td></tr></table></figure></li><li><p>查看服务状态</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/sbin/service rabbitmq-server status</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">systemctl status rabbitmq-server</span><br></pre></td></tr></table></figure></li><li><p>停止服务（选择执行）</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/sbin/service rabbitmq-server stop</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">systemctl stop rabbitmq-server</span><br></pre></td></tr></table></figure></li><li><p>开启<code>web</code>管理插件（停止服务后执行）</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</span><br></pre></td></tr></table></figure><p> 如果报错：</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;:query, :rabbit<span class="meta">@centos01</span>, &#123;:badrpc, :timeout&#125;&#125;</span><br></pre></td></tr></table></figure><p> 修改<code>/etc/hosts</code>，添加上</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> hostname</span><br></pre></td></tr></table></figure><p> 用默认账号密码（<code>guest</code>）访问地址<code>http://192.168.30.129:15672/</code>出现权限问题</p></li></ol></li><li><p>添加一个新的用户</p><ul><li>创建账号<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl add_user admin admin</span><br></pre></td></tr></table></figure></li><li>设置用户角色<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl set_user_tags admin administrator</span><br></pre></td></tr></table></figure></li><li>设置用户权限<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set_permissions [-p &lt;vhostpath&gt;] &lt;user&gt; &lt;conf&gt; &lt;write&gt; &lt;<span class="built_in">read</span>&gt;</span><br><span class="line"><span class="comment"># 用户 user_admin 具有/vhost1 这个 virtual host 中所有资源的配置、写、读权限</span></span><br><span class="line">rabbitmqctl set_permissions -p <span class="string">&quot;/&quot;</span> admin <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span></span><br></pre></td></tr></table></figure></li><li>当前用户和角色<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl list_users</span><br></pre></td></tr></table></figure></li></ul></li><li><p>再次利用<code>admin</code>用户登录</p></li><li><p>重置命令</p><ul><li>关闭应用的命令<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app</span><br></pre></td></tr></table></figure></li><li>清除的命令<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl reset</span><br></pre></td></tr></table></figure></li><li>重新启动命令<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl start_app</span><br></pre></td></tr></table></figure></li></ul></li></ol><h1 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h1><p>在这一部分中，将用<code>Java</code>编写两个程序。发送单个消息的生产者和接收消息并打印出来的消费者。将介绍<code>Java API</code>中的一些细节。</p><p>在下图中，<code>P</code>是生产者，<code>C</code>是我们的消费者。中间的框是一个<code>RabbitMQ</code>队列代表使用者保留的消息缓冲区。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637306914/1639810619-93b3dce9.png"></p></div><h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--指定 jdk 编译版本--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--rabbitmq 依赖客户端--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>amqp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--操作文件流的一个依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="消息生产者"><a href="#消息生产者" class="headerlink" title="消息生产者"></a>消息生产者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建一个连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.30.129&quot;</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="comment">// channel 实现了自动 close 接口 自动关闭 不需要显示关闭</span></span><br><span class="line">        <span class="keyword">try</span>( <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">            Channel channel= connection.createChannel()) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 生成一个队列</span></span><br><span class="line"><span class="comment">             * 1.队列名称</span></span><br><span class="line"><span class="comment">             * 2.队列里面的消息是否持久化 默认消息存储在内存中</span></span><br><span class="line"><span class="comment">             * 3.该队列是否只供一个消费者进行消费 是否进行共享 true 可以多个消费者消费</span></span><br><span class="line"><span class="comment">             * 4.是否自动删除 最后一个消费者端开连接以后 该队列是否自动删除 true 自动删除</span></span><br><span class="line"><span class="comment">             * 5.其他参数</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.queueDeclare(QUEUE_NAME,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">            String message=<span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 发送一个消息</span></span><br><span class="line"><span class="comment">             * 1.发送到那个交换机</span></span><br><span class="line"><span class="comment">             * 2.路由的 key 是哪个</span></span><br><span class="line"><span class="comment">             * 3.其他的参数信息</span></span><br><span class="line"><span class="comment">             * 4.发送消息的消息体</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>,QUEUE_NAME,<span class="literal">null</span>,message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;消息发送完毕&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="消息消费者"><a href="#消息消费者" class="headerlink" title="消息消费者"></a>消息消费者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.30.129&quot;</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息.........&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 推送的消息如何进行消费的接口回调</span></span><br><span class="line">        <span class="comment">// 使用 lambda 表达式更方便</span></span><br><span class="line">        DeliverCallback deliverCallback=(consumerTag,delivery)-&gt;&#123;</span><br><span class="line">            String message= <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody());</span><br><span class="line">            System.out.println(message);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 取消消费的一个回调接口 如在消费的时候队列被删除掉了</span></span><br><span class="line">        CancelCallback cancelCallback=(consumerTag)-&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;消息消费被中断&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 消费者消费消息</span></span><br><span class="line"><span class="comment">         * 1.消费哪个队列</span></span><br><span class="line"><span class="comment">         * 2.消费成功之后是否要自动应答 true 代表自动应答 false 手动应答</span></span><br><span class="line"><span class="comment">         * 3.消费者未成功消费的回调</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME,<span class="literal">true</span>,deliverCallback,cancelCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Work-Queues"><a href="#Work-Queues" class="headerlink" title="Work Queues"></a>Work Queues</h1><p>工作队列（又称任务队列）的主要思想是避免立即执行资源密集型任务，而不得不等待它完成。<br>相反安排任务在之后执行。把任务封装为消息并将其发送到队列。在后台运行的工作进程将弹出任务并最终执行作业。当有多个工作线程时，这些工作线程将一起处理这些任务。</p><h2 id="轮训分发消息"><a href="#轮训分发消息" class="headerlink" title="轮训分发消息"></a>轮训分发消息</h2><p>在这个案例中会启动两个工作线程，一个消息发送线程，来看看他们两个工作线程是如何工作的。</p><h3 id="抽取工具类"><a href="#抽取工具类" class="headerlink" title="抽取工具类"></a>抽取工具类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMqUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 得到一个连接的 channel</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Channel <span class="title function_">getChannel</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="comment">// 创建一个连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.30.129&quot;</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="keyword">return</span> channel;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="启动两个工作线程"><a href="#启动两个工作线程" class="headerlink" title="启动两个工作线程"></a>启动两个工作线程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Worker</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME=<span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line"></span><br><span class="line">        DeliverCallback deliverCallback=(consumerTag, delivery)-&gt;&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">receivedMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody());</span><br><span class="line">            System.out.println(<span class="string">&quot;接收到消息:&quot;</span>+receivedMessage);</span><br><span class="line">        &#125;;</span><br><span class="line">        CancelCallback cancelCallback=(consumerTag)-&gt;&#123;</span><br><span class="line">            System.out.println(consumerTag+<span class="string">&quot;消费者取消消费接口回调逻辑&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;消费者 W2 启动等待消费.................. &quot;</span>);</span><br><span class="line">        channel.basicConsume(QUEUE_NAME,<span class="literal">true</span>,deliverCallback,cancelCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637306914/1639810664-bcbcd48f.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637306914/1639810676-f0af35b1.png"></p></div><h3 id="启动一个发送线程"><a href="#启动一个发送线程" class="headerlink" title="启动一个发送线程"></a>启动一个发送线程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Task</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME=<span class="string">&quot;hello&quot;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span>(Channel channel= RabbitMqUtils.getChannel();) &#123;</span><br><span class="line">            channel.queueDeclare(QUEUE_NAME,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// 从控制台当中接受信息</span></span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            <span class="keyword">while</span> (scanner.hasNext())&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">                channel.basicPublish(<span class="string">&quot;&quot;</span>,QUEUE_NAME,<span class="literal">null</span>,message.getBytes());</span><br><span class="line">                System.out.println(<span class="string">&quot;发送消息完成:&quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="结果展示"><a href="#结果展示" class="headerlink" title="结果展示"></a>结果展示</h3><p>通过程序执行发现生产者总共发送 4 个消息，消费者 1 和消费者 2 分别分得两个消息，并且是按照有序的一个接收一次消息</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637306914/1639810715-a556600e.png"></p></div><h2 id="消息应答"><a href="#消息应答" class="headerlink" title="消息应答"></a>消息应答</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>消费者完成一个任务可能需要一段时间，如果其中一个消费者处理一个长的任务并仅只完成了部分突然它挂掉了，会发生什么情况。<code>RabbitMQ</code>一旦向消费者传递了一条消息，便立即将该消息标记为删除。在这种情况下，突然有个消费者挂掉了，将丢失正在处理的消息。以及后续发送给该消费这的消息，因为它无法接收到。</p><p>为了保证消息在发送过程中不丢失，<code>RabbitMQ</code>引入消息应答机制，消息应答就是：消费者在接收到消息并且处理该消息之后，告诉<code>RabbitMQ</code>它已经处理了，<code>RabbitMQ</code>可以把该消息删除了。</p><h3 id="自动应答"><a href="#自动应答" class="headerlink" title="自动应答"></a>自动应答</h3><p>消息发送后立即被认为已经传送成功，这种模式需要在<strong>高吞吐量和数据传输安全性方面做权衡</strong>,因为这种模式如果消息在接收到之前，消费者那边出现连接或者<code>channel</code>关闭，那么消息就丢失了，当然另一方面这种模式消费者那边可以传递过载的消息，<strong>没有对传递的消息数量进行限制</strong>，当然这样有可能使得消费者这边由于接收太多还来不及处理的消息，导致这些消息的积压，最终使得内存耗尽，最终这些消费者线程被操作系统杀死，所以这种模式<strong>仅适用在消费者可以高效并以某种速率能够处理这些消息的情况下使用</strong>。</p><h3 id="消息应答的方法"><a href="#消息应答的方法" class="headerlink" title="消息应答的方法"></a>消息应答的方法</h3><ul><li><code>Channel.basicAck</code>：用于肯定确认<ul><li><code>RabbitMQ</code>已知道该消息并且成功的处理消息，可以将其丢弃了</li></ul></li><li><code>Channel.basicNack</code>：用于否定确认</li><li><code>Channel.basicReject</code>：用于否定确认<ul><li>与<code>Channel.basicNack</code>相比少一个参数<code>Multiple</code></li><li>不处理该消息了直接拒绝，可以将其丢弃了</li></ul></li></ul><h3 id="Multiple-的解释"><a href="#Multiple-的解释" class="headerlink" title="Multiple 的解释"></a>Multiple 的解释</h3><p>手动应答的好处是可以批量应答并且减少网络拥堵。</p><p><code>multiple</code>的<code>true</code>和<code>false</code>代表不同意思：</p><ul><li><code>true</code>代表批量应答<code>channel</code>上未应答的消息<ul><li>比如说<code>channel</code>上有传送<code>tag</code>的消息是 $5, 6, 7, 8$，当前<code>tag</code>是 $8$，那么此时 $5-8$ 的这些还未应答的消息都会被确认收到消息应答</li></ul></li><li><code>false</code>同上面相比只会应答<code>tag=8</code>的消息，$5, 6, 7$ 这三个消息依然不会被确认收到消息应答</li></ul><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637306914/1639810756-996ed9d1.png"></p></div>　　### 消息自动重新入队<p>如果消费者由于某些原因失去连接（其通道已关闭，连接已关闭或<code>TCP</code>连接丢失），导致消息未发送<code>ACK</code>确认，<code>RabbitMQ</code>将了解到消息未完全处理，并将对其重新排队。如果此时其他消费者可以处理，它将很快将其重新分发给另一个消费者。这样，即使某个消费者偶尔死亡，也可以确保不会丢失任何消息。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637306914/1639810815-693af570.png"></p></div><h3 id="消息手动应答代码"><a href="#消息手动应答代码" class="headerlink" title="消息手动应答代码"></a>消息手动应答代码</h3><p>默认消息采用的是自动应答，所以我们要想实现消息消费过程中不丢失，需要把自动应答改为手动应答。</p><ul><li><p>生产者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Task</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TASK_QUEUE_NAME=<span class="string">&quot;ack_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span>(Channel channel= RabbitMqUtils.getChannel();) &#123;</span><br><span class="line">            channel.queueDeclare(TASK_QUEUE_NAME,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// 从控制台当中接受信息</span></span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            <span class="keyword">while</span> (scanner.hasNext())&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">                channel.basicPublish(<span class="string">&quot;&quot;</span>,QUEUE_NAME,<span class="literal">null</span>,message.getBytes());</span><br><span class="line">                System.out.println(<span class="string">&quot;发送消息完成:&quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>消费者</p><ol><li><p>```java<br> public class Work01 {</p><pre><code> private static final String ACK_QUEUE_NAME=&quot;ack_queue&quot;; public static void main(String[] args) throws Exception &#123;     Channel channel = RabbitMqUtils.getChannel();     System.out.println(&quot;W1 等待接收消息处理时间较短&quot;);     // 消息消费的时候如何处理消息     DeliverCallback deliverCallback=(consumerTag, delivery)-&gt;&#123;         String receivedMessage = new String(delivery.getBody());         SleepUtils.sleep(1);         System.out.println(&quot;接收到消息:&quot;+receivedMessage);         /**          * 1. 消息标记 tag          * 2. 是否批量应答未应答消息          */         channel.basicAck(delivery.getEnvelope().getDeliveryTag(), false);     &#125;;     CancelCallback cancelCallback=(consumerTag)-&gt;&#123;         System.out.println(consumerTag+&quot;消费者取消消费接口回调逻辑&quot;);     &#125;;     System.out.println(&quot;消费者 W2 启动等待消费.................. &quot;);     // 采用手动应答     boolean autoAck = false;     channel.basicConsume(ACK_QUEUE_NAME,autoAck, deliverCallback,cancelCallback); &#125;</code></pre><p> }</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">2. ```java</span><br><span class="line">    public class Work02 &#123;</span><br><span class="line"></span><br><span class="line">        private static final String ACK_QUEUE_NAME=&quot;ack_queue&quot;;</span><br><span class="line"></span><br><span class="line">        public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">            Channel channel = RabbitMqUtils.getChannel();</span><br><span class="line"></span><br><span class="line">            System.out.println(&quot;W2 等待接收消息处理时间较长&quot;);</span><br><span class="line"></span><br><span class="line">            // 消息消费的时候如何处理消息</span><br><span class="line">            DeliverCallback deliverCallback=(consumerTag, delivery)-&gt;&#123;</span><br><span class="line">                String receivedMessage = new String(delivery.getBody());</span><br><span class="line"></span><br><span class="line">                SleepUtils.sleep(30);</span><br><span class="line"></span><br><span class="line">                System.out.println(&quot;接收到消息:&quot;+receivedMessage);</span><br><span class="line"></span><br><span class="line">                /**</span><br><span class="line">                 * 1. 消息标记 tag</span><br><span class="line">                 * 2. 是否批量应答未应答消息</span><br><span class="line">                 */</span><br><span class="line">                channel.basicAck(delivery.getEnvelope().getDeliveryTag(), false);</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            CancelCallback cancelCallback=(consumerTag)-&gt;&#123;</span><br><span class="line">                System.out.println(consumerTag+&quot;消费者取消消费接口回调逻辑&quot;);</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            System.out.println(&quot;消费者 W2 启动等待消费.................. &quot;);</span><br><span class="line"></span><br><span class="line">            // 采用手动应答</span><br><span class="line">            boolean autoAck = false;</span><br><span class="line">            channel.basicConsume(ACK_QUEUE_NAME,autoAck, deliverCallback,cancelCallback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ol></li><li><p>睡眠工具类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SleepUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> second)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span> * second);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException exception)&#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="手动应答效果演示"><a href="#手动应答效果演示" class="headerlink" title="手动应答效果演示"></a>手动应答效果演示</h3><p>正常情况下消息发送方发送两个消息<code>C1</code>和<code>C2</code>分别接收到消息并进行处理：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637306914/1639810855-1b7c9365.png"></p></div><p>在发送者发送消息<code>dd</code>，发出消息之后的把<code>C2</code>消费者停掉，按理说该<code>C2</code>来处理该消息，但是由于它处理时间较长，在还未处理完，也就是说<code>C2</code>还没有执行<code>ack</code>代码的时候，<code>C2</code>被停掉了，此时会看到消息被<code>C1</code>接收到了，说明消息<code>dd</code>被重新入队，然后分配给能处理消息的<code>C1</code>处理了。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637306914/1639810883-d6604dd3.png"></p></div><h2 id="RabbitMQ-持久化"><a href="#RabbitMQ-持久化" class="headerlink" title="RabbitMQ 持久化"></a>RabbitMQ 持久化</h2><h3 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h3><p>刚刚已经看到了如何处理任务不丢失的情况，但是如何保障当<code>RabbitMQ</code>服务停掉以后消息生产者发送过来的消息不丢失。默认情况下<code>RabbitMQ</code>退出或由于某种原因崩溃时，它忽视队列和消息，除非告知它不要这样做。确保消息不会丢失需要做两件事：将队列和消息都标记为持久化。</p><h3 id="队列如何实现持久化"><a href="#队列如何实现持久化" class="headerlink" title="队列如何实现持久化"></a>队列如何实现持久化</h3><p>之前创建的队列都是非持久化的，<code>RabbitMQ</code>如果重启的话，该队列就会被删除掉，如果要队列实现持久化，需要在声明队列的时候把<code>durable</code>参数设置为持久化。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 让队列消息持久化</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">durable</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">channel.queueDeclare(TASK_QUEUE_NAME,durable,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Task</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TASK_QUEUE_NAME=<span class="string">&quot;ack_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>(Channel channel= RabbitMqUtils.getChannel();) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 让队列消息持久化</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">durable</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            channel.queueDeclare(TASK_QUEUE_NAME,durable,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// 从控制台当中接受信息</span></span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            System.out.println(<span class="string">&quot;请输入信息：&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (scanner.hasNext())&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">                <span class="comment">// UTF-8：防止中文乱码</span></span><br><span class="line">                channel.basicPublish(<span class="string">&quot;&quot;</span>,TASK_QUEUE_NAME,<span class="literal">null</span>,message.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                System.out.println(<span class="string">&quot;发送消息完成:&quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是需要注意的就是如果之前声明的队列不是持久化的，需要把原先队列先删除，或者重新创建一个持久化的队列，不然就会出现错误：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inequivalent arg <span class="string">&#x27;durable&#x27;</span> <span class="keyword">for</span> queue <span class="string">&#x27;ack_queue&#x27;</span> <span class="keyword">in</span> vhost <span class="string">&#x27;/&#x27;</span>: received <span class="string">&#x27;true&#x27;</span> but current is <span class="string">&#x27;false&#x27;</span></span><br></pre></td></tr></table></figure><p>以下为控制台中持久化与非持久化队列的<code>UI</code>显示区：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637306914/1639810936-b2bbf59c.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637306914/1639810950-64d946cb.png"></p></div><p>这个时候即使重启<code>RabbitMQ</code>，队列也依然存在。</p><h3 id="消息实现持久化"><a href="#消息实现持久化" class="headerlink" title="消息实现持久化"></a>消息实现持久化</h3><p>要想让消息实现持久化需要在消息生产者修改代码，添加属性<code>MessageProperties.PERSISTENT_TEXT_PLAIN</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.basicPublish(<span class="string">&quot;&quot;</span>,TASK_QUEUE_NAME, MessageProperties.PERSISTENT_TEXT_PLAIN,message.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Task</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TASK_QUEUE_NAME=<span class="string">&quot;ack_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>(Channel channel= RabbitMqUtils.getChannel();) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 让队列消息持久化</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">durable</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            channel.queueDeclare(TASK_QUEUE_NAME,durable,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// 从控制台当中接受信息</span></span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            System.out.println(<span class="string">&quot;请输入信息：&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (scanner.hasNext())&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">                <span class="comment">// UTF-8：防止中文乱码</span></span><br><span class="line">                channel.basicPublish(<span class="string">&quot;&quot;</span>,TASK_QUEUE_NAME, MessageProperties.PERSISTENT_TEXT_PLAIN,message.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                System.out.println(<span class="string">&quot;发送消息完成:&quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将消息标记为持久化并不能完全保证不会丢失消息。尽管它告诉<code>RabbitMQ</code>将消息保存到磁盘，但是这里依然存在当消息刚准备存储在磁盘但还没有存储完的时候，消息还在缓存的一个间隔点。此时并没有真正写入磁盘，持久性保证并不强。但是对于简单任务队列而言，这已经绰绰有余了。如果需要更强有力的持久化策略，可以参考后边的发布确认章节。</p><h3 id="不公平分发"><a href="#不公平分发" class="headerlink" title="不公平分发"></a>不公平分发</h3><p>在最开始的时候，学习到<code>RabbitMQ</code>分发消息采用的轮训分发，但是在某种场景下这种策略并不是很好，比方说有两个消费者在处理任务，其中有个消费者 $1$ 处理任务的速度非常快，而另外一个消费者 $2$ 处理速度却很慢，这个时候还是采用轮训分发的话就会到这处理速度快的这个消费者很大一部分时间处于空闲状态，而处理慢的那个消费者一直在干活，这种分配方式在这种情况下其实就不太好，但是<code>RabbitMQ</code>并不知道这种情况，它依然很公平的进行分发。</p><p>为了避免这种情况，可以设置参数<code>channel.basicQos(1);</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Work01</span>/<span class="number">2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACK_QUEUE_NAME=<span class="string">&quot;ack_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">prefetchCount</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        channel.basicQos(prefetchCount);</span><br><span class="line">  </span><br><span class="line">        System.out.println(<span class="string">&quot;W1/2 等待接收消息处理时间较长&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>意思就是如果这个任务还没有处理完或者还没有应答，就先别分配，因为目前只能处理一个任务，然后<code>RabbitMQ</code>就会把该任务分配给没有那么忙的那个空闲消费者，当然如果所有的消费者都没有完成手上任务，队列还在不停的添加新任务，队列有可能就会遇到队列被撑满的情况，这个时候就只能添加新的<code>worker</code>或者改变其他存储任务的策略。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637306914/1639811216-c71c7977.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637306914/1639811068-1f2f6f56.png"></p></div><h3 id="预取值"><a href="#预取值" class="headerlink" title="预取值"></a>预取值</h3><p>本身消息的发送就是异步发送的，所以在任何时候，<code>channel</code>上肯定不止只有一个消息。另外来自消费者的手动确认本质上也是异步的。因此这里就存在一个未确认的消息缓冲区，因此希望开发人员能<strong>限制此缓冲区的大小，以避免缓冲区里面无限制的未确认消息问题</strong>。</p><p>这个时候就可以通过使用<code>basic.qos</code>方法设置<strong>预取计数值</strong>来完成。该值<strong>定义通道上允许的未确认消息的最大数量</strong>。一旦数量达到配置的数量，<code>RabbitMQ</code>将停止在通道上传递更多消息，除非至少有一个未处理的消息被确认，例如，假设在通道上有未确认的消息 $5、6、7、8$，并且通道的预取计数设置为 $4$，此时<code>RabbitMQ</code>将不会在该通道上再传递任何消息，除非至少有一个未应答的消息被<code>ack</code>。比方说<code>tag=6</code>这个消息刚刚被确认<code>ACK</code>，<code>RabbitMQ</code>将会感知这个情况到并再发送一条消息。</p><p>消息应答和<code>QoS</code>预取值对用户吞吐量有重大影响。通常，增加预取将提高向消费者传递消息的速度。<strong>虽然自动应答传输消息速率是最佳的，但是，在这种情况下已传递但尚未处理的消息的数量也会增加，从而增加了消费者的<code>RAM</code>消耗（随机存取存储器）</strong>。</p><p>应该小心使用具有无限预处理的自动确认模式或手动确认模式，消费者消费了大量的消息如果没有确认的话，会导致消费者连接节点的内存消耗变大，所以找到合适的预取值是一个反复试验的过程，不同的负载该值取值也不同，$100$ 到 $300$ 范围内的值通常可提供最佳的吞吐量，并且不会给消费者带来太大的风险。</p><p>预取值为 $1$ 是最保守的。当然这将使吞吐量变得很低，特别是消费者连接延迟很严重的情况下，特别是在消费者连接等待时间较长的环境中。对于大多数应用来说，稍微高一点的值将是最佳的。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637306914/1639811112-a3b4a2c6.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637306914/1639811131-7c9c8948.png"></p></div><p><code>W2</code>消费能力差，当发送 $7$ 条数据，<code>W2</code>预取值为 $5$ 的情况下，信道中会堆积 $5$ 条消息：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1637306914/1639811182-ea8c9103.png">v</p></div>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RabbitMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据卷、Dockerfile 与 Docker 网络</title>
      <link href="/2021/11/01/Docker/02.%E6%95%B0%E6%8D%AE%E5%8D%B7%E3%80%81Dockerfile%E4%B8%8EDocker%E7%BD%91%E7%BB%9C/"/>
      <url>/2021/11/01/Docker/02.%E6%95%B0%E6%8D%AE%E5%8D%B7%E3%80%81Dockerfile%E4%B8%8EDocker%E7%BD%91%E7%BB%9C/</url>
      
        <content type="html"><![CDATA[<h1 id="数据卷"><a href="#数据卷" class="headerlink" title="数据卷"></a>数据卷</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><code>Docker</code>将运行的环境打包成容器运行。<code>Docker</code>容器运行中产生的数据，如果不通过<code>docker commit</code>命令生成新的镜像，使数据做为镜像的一部分保存下来，当删除容器后，数据也会被删除。</p><p>为了实现数据持久化，使容器之间可以共享数据。可以使用卷来保存在<code>Docker</code>容器产生的数据，将容器内的目录，挂载到宿主机上或其他容器内，实现同步和共享的操作。即使将容器删除，挂载到本地的数据卷也不会丢失。</p><p>卷就是目录或文件，存在于一个或多个容器中，由<code>Docker</code>挂载到容器，但卷不属于联合文件系统（<code>Union FileSystem</code>），因此能够绕过联合文件系统提供一些用于持续存储或共享数据的特性:。</p><p>卷的设计目的就是数据的持久化，完全独立于容器的生存周期，因此<code>Docker</code>不会在容器删除时删除其挂载的数据卷。</p><p>数据卷的特点:</p><ol><li>数据卷可在容器之间共享或重用数据</li><li>卷中的更改可以直接生效</li><li>数据卷中的更改不会包含在镜像的更新中</li><li>数据卷的生命周期一直持续到没有容器使用它为止</li></ol><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>运行容器，指定挂载数据卷：<code>docker run -it -v 主机目录:容器目录</code></p><ol><li>将主机目录<code>/home/test</code>和容器<code>/home</code>建立数据卷 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost home]<span class="comment"># pwd</span></span><br><span class="line">/home</span><br><span class="line">[root@localhost home]<span class="comment"># ls</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line">[root@localhost home]<span class="comment"># docker run -it -v /home/test:/home centos /bin/bash</span></span><br></pre></td></tr></table></figure></li><li>在容器目录下创建<code>test.java</code>文件，再去主机目录下查看是否有该文件 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@f5c27ef005ad /]<span class="comment"># cd /home</span></span><br><span class="line">[root@f5c27ef005ad home]<span class="comment"># ls</span></span><br><span class="line">[root@f5c27ef005ad home]<span class="comment"># touch test.java</span></span><br><span class="line">[root@f5c27ef005ad home]<span class="comment"># cat test.java</span></span><br><span class="line">[root@f5c27ef005ad home]<span class="comment"># ls</span></span><br><span class="line">test.java</span><br><span class="line">[root@f5c27ef005ad home]<span class="comment"># touch test.java[root@localhost home]#</span></span><br><span class="line">[root@localhost home]<span class="comment"># ls</span></span><br><span class="line"><span class="built_in">echo</span>  <span class="built_in">test</span></span><br><span class="line">[root@localhost home]<span class="comment"># cd test/</span></span><br><span class="line">[root@localhost <span class="built_in">test</span>]<span class="comment"># ls</span></span><br><span class="line">test.java</span><br><span class="line">[root@localhost <span class="built_in">test</span>]<span class="comment"># vi test.java</span></span><br><span class="line">[root@localhost <span class="built_in">test</span>]<span class="comment"># cat test.java</span></span><br><span class="line">Hello</span><br><span class="line">[root@localhost <span class="built_in">test</span>]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                 COMMAND        CREATED         STATUS         PORTS                                       NAMES</span><br><span class="line">f5c27ef005ad   centos                <span class="string">&quot;/bin/bash&quot;</span>    2 minutes ago   Up 2 minutes                                               objective_bhaskara</span><br><span class="line">[root@localhost <span class="built_in">test</span>]<span class="comment"># docker exec -it f5c27ef005ad /bin/bash</span></span><br><span class="line">[root@f5c27ef005ad /]<span class="comment"># cd /home</span></span><br><span class="line">[root@f5c27ef005ad home]<span class="comment"># ls</span></span><br><span class="line">test.java</span><br><span class="line">[root@f5c27ef005ad home]<span class="comment"># cat test.java</span></span><br><span class="line">Hello</span><br><span class="line">[root@f5c27ef005ad home]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><code>docker inspect 容器id</code>查看容器对应元数据，在<code>Mounts</code>节点可以查看建立的数据卷信息 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;bind&quot;</span>,</span><br><span class="line">        <span class="comment"># 主机文件夹地址</span></span><br><span class="line">        <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/home/test&quot;</span>,</span><br><span class="line">        <span class="comment"># 容器文件夹地址</span></span><br><span class="line">        <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/home&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Mode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;RW&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;Propagation&quot;</span>: <span class="string">&quot;rprivate&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure></li></ol><p>即使容器停止运行或者容器删除，仍然可以实现数据同步，本地的数据卷不会丢失</p><h2 id="MySQL-容器建立数据卷同步数据"><a href="#MySQL-容器建立数据卷同步数据" class="headerlink" title="MySQL 容器建立数据卷同步数据"></a>MySQL 容器建立数据卷同步数据</h2><p>在<code>Linux</code>下的<code>MySQL</code>默认的数据文档存储目录为<code>/var/lib/mysql</code>，默认的配置文件的位置<code>/etc/mysql/conf.d</code>，为了确保<code>MySQL</code>镜像或容器删除后数据不丢失，建立数据卷保存<code>MySQL</code>的数据和文件。</p><ol><li>建立数据卷 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost <span class="built_in">test</span>]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY            TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">mytomcat              1.0       97a599676bbb   42 hours ago   684MB</span><br><span class="line">tomcat                latest    b0e0b0a92cf9   10 days ago    680MB</span><br><span class="line">mysql                 5.7       938b57d64674   13 days ago    448MB</span><br><span class="line">nginx                 latest    87a94228f133   2 weeks ago    133MB</span><br><span class="line">hello-world           latest    feb5d9fea6a5   5 weeks ago    13.3kB</span><br><span class="line">centos                latest    5d0da3dc9764   6 weeks ago    231MB</span><br><span class="line">portainer/portainer   latest    580c0e4e98b0   7 months ago   79.1MB</span><br><span class="line">elasticsearch         latest    5acf0e8da90b   3 years ago    486MB</span><br><span class="line">abh1nav/dockerui      latest    6e4d05915b2a   6 years ago    470MB</span><br><span class="line">[root@localhost <span class="built_in">test</span>]<span class="comment"># docker run -d -p 6603:3306 -v /home/mysql/conf:/etc/mysql/conf.d -v /home/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 --name mysql01 mysql:5.7</span></span><br><span class="line">bd86b67cb648743b1871c70da061de1c43b99b0983994c4e6ffc9d7d07948619</span><br><span class="line">[root@localhost <span class="built_in">test</span>]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>查看数据 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost <span class="built_in">test</span>]<span class="comment"># cd /home</span></span><br><span class="line">[root@localhost home]<span class="comment"># ls</span></span><br><span class="line"><span class="built_in">echo</span>  mysql  <span class="built_in">test</span></span><br><span class="line">[root@localhost home]<span class="comment"># cd mysql/conf/</span></span><br><span class="line">[root@localhost conf]<span class="comment"># ls</span></span><br><span class="line">[root@localhost conf]<span class="comment"># cd /home/mysql/data/</span></span><br><span class="line">[root@localhost data]<span class="comment"># ls</span></span><br><span class="line">auto.cnf    ca.pem           client-key.pem  ibdata1      ib_logfile1  mysql               private_key.pem  server-cert.pem  sys</span><br><span class="line">ca-key.pem  client-cert.pem  ib_buffer_pool  ib_logfile0  ibtmp1       performance_schema  public_key.pem   server-key.pem</span><br></pre></td></tr></table></figure></li><li>向<code>MySQL</code>插入数据后再次查看数据 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment"># ls</span></span><br><span class="line">auto.cnf    ca.pem           client-key.pem  ibdata1      ib_logfile1  mysql               private_key.pem  server-cert.pem  sys</span><br><span class="line">ca-key.pem  client-cert.pem  ib_buffer_pool  ib_logfile0  ibtmp1       performance_schema  public_key.pem   server-key.pem   <span class="built_in">test</span></span><br><span class="line">[root@localhost data]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><h3 id="创建数据卷"><a href="#创建数据卷" class="headerlink" title="创建数据卷"></a>创建数据卷</h3><p><code>docker volume create</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment"># docker volume create my-vol</span></span><br><span class="line">my-vol</span><br><span class="line">[root@localhost data]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="查看所有的数据卷"><a href="#查看所有的数据卷" class="headerlink" title="查看所有的数据卷"></a>查看所有的数据卷</h3><p><code>docker volume ls</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment"># docker volume ls</span></span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>     2384cfb039b29ff058617012a6883694dabf5e1047aa5b4588b05d4403a75ec4</span><br><span class="line"><span class="built_in">local</span>     b4309f0bc3eda0a6b8d4837a0d56c5ea3ef2d016ec4294db720b04591245489c</span><br><span class="line"><span class="built_in">local</span>     c505a4ba768a4f507cc80216c13902724aec7388d6a35af6aa24e6f4fc81d68f</span><br><span class="line"><span class="built_in">local</span>     my-vol</span><br><span class="line">[root@localhost data]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="查看指定数据卷的信息"><a href="#查看指定数据卷的信息" class="headerlink" title="查看指定数据卷的信息"></a>查看指定数据卷的信息</h3><p><code>docker volume inspect</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment"># docker volume inspect my-vol</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;CreatedAt&quot;</span>: <span class="string">&quot;2021-11-01T11:02:30+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Mountpoint&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/my-vol/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;my-vol&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[root@localhost data]<span class="comment"># docker volume inspect 2384cfb039b29ff058617012a6883694dabf5e1047aa5b4588b05d4403a75ec4</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;CreatedAt&quot;</span>: <span class="string">&quot;2021-10-30T16:05:34+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;Mountpoint&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/2384cfb039b29ff058617012a6883694dabf5e1047aa5b4588b05d4403a75ec4/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;2384cfb039b29ff058617012a6883694dabf5e1047aa5b4588b05d4403a75ec4&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[root@localhost data]<span class="comment"># docker volume inspect b4309f0bc3eda0a6b8d4837a0d56c5ea3ef2d016ec4294db720b04591245489c</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;CreatedAt&quot;</span>: <span class="string">&quot;2021-10-29T17:15:12+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;Mountpoint&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/b4309f0bc3eda0a6b8d4837a0d56c5ea3ef2d016ec4294db720b04591245489c/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;b4309f0bc3eda0a6b8d4837a0d56c5ea3ef2d016ec4294db720b04591245489c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[root@localhost data]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="删除数据卷"><a href="#删除数据卷" class="headerlink" title="删除数据卷"></a>删除数据卷</h3><p><code>docker volume rm</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment"># docker volume rm my-vol</span></span><br><span class="line">my-vol</span><br><span class="line">[root@localhost data]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="删除容器时删除相关的卷"><a href="#删除容器时删除相关的卷" class="headerlink" title="删除容器时删除相关的卷"></a>删除容器时删除相关的卷</h3><p>数据卷是被设计用来持久化数据的，它的生命周期独立于容器，<code>Docker</code>不会在容器被删除后自动删除数据卷，并且也不存在垃圾回收这样的机制来处理没有任何容器引用的数据卷。</p><p>如果需要在删除容器的同时移除数据卷，可以在删除容器的时候使用<code>docker rm -v</code>这个命令。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment"># docker rm -v --help</span></span><br><span class="line">Usage:  docker <span class="built_in">rm</span> [OPTIONS] CONTAINER [CONTAINER...]</span><br><span class="line">Remove one or more containers</span><br><span class="line">Options:</span><br><span class="line">  -f, --force     Force the removal of a running container (uses SIGKILL)</span><br><span class="line">  -l, --<span class="built_in">link</span>      Remove the specified <span class="built_in">link</span></span><br><span class="line">  -v, --volumes   Remove anonymous volumes associated with the container</span><br><span class="line">[root@localhost data]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>无主的数据卷可能会占据很多空间，要清理使用命令<code>docker volume prune</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment"># docker volume prune</span></span><br><span class="line">WARNING! This will remove all <span class="built_in">local</span> volumes not used by at least one container.</span><br><span class="line">Are you sure you want to <span class="built_in">continue</span>? [y/N] y</span><br><span class="line">Total reclaimed space: 0B</span><br><span class="line">[root@localhost data]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h2 id="具名挂载和匿名挂载"><a href="#具名挂载和匿名挂载" class="headerlink" title="具名挂载和匿名挂载"></a>具名挂载和匿名挂载</h2><h3 id="匿名挂载"><a href="#匿名挂载" class="headerlink" title="匿名挂载"></a>匿名挂载</h3><p>匿名挂载就是在指定数据卷的时候，不指定容器路径对应的主机路径，这样对应映射的主机路径就是默认的路径<code>/var/lib/docker/volumes/</code>中自动生成一个随机命名的文件夹。</p><ol><li>运行并匿名挂载<code>Nginx</code>容器 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost home]<span class="comment"># docker run -d -P --name nginx01 -v /etc/nginx nginx</span></span><br><span class="line">a0b0ab7220cb20a79f49002ee57edfd991b748c23e28a71ba776b7a389876583</span><br><span class="line">[root@localhost home]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>使用<code>docker inspect</code>查看<code>Mounts</code>中显示的挂载信息 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost volumes]<span class="comment"># docker inspect a0b0ab7220cb20a79f49002ee57edfd991b748c23e28a71ba776b7a389876583</span></span><br><span class="line"><span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;volume&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;683898996d0153b4335e3b6c1e72451f0923155b39360facd5641ac9d31665a6&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/683898996d0153b4335e3b6c1e72451f0923155b39360facd5641ac9d31665a6/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/etc/nginx&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Mode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;RW&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;Propagation&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure></li><li>查看所有的数据卷<code>volume</code>的情况，每个<code>VOLUME NAME</code>对应一个挂载的卷，由于挂载时未指定主机目录，因此无法直接找到目录 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost home]<span class="comment"># docker volume ls</span></span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>     2384cfb039b29ff058617012a6883694dabf5e1047aa5b4588b05d4403a75ec4</span><br><span class="line"><span class="built_in">local</span>     683898996d0153b4335e3b6c1e72451f0923155b39360facd5641ac9d31665a6</span><br><span class="line"><span class="built_in">local</span>     b4309f0bc3eda0a6b8d4837a0d56c5ea3ef2d016ec4294db720b04591245489c</span><br><span class="line"><span class="built_in">local</span>     c505a4ba768a4f507cc80216c13902724aec7388d6a35af6aa24e6f4fc81d68f</span><br><span class="line">[root@localhost home]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>查看路径<code>/var/lib/docker/volumes/</code>中的文件夹 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost home]<span class="comment"># cd /var/lib/docker/volumes/</span></span><br><span class="line">[root@localhost volumes]<span class="comment"># ls</span></span><br><span class="line">2384cfb039b29ff058617012a6883694dabf5e1047aa5b4588b05d4403a75ec4  backingFsBlockDev</span><br><span class="line">683898996d0153b4335e3b6c1e72451f0923155b39360facd5641ac9d31665a6  c505a4ba768a4f507cc80216c13902724aec7388d6a35af6aa24e6f4fc81d68f</span><br><span class="line">b4309f0bc3eda0a6b8d4837a0d56c5ea3ef2d016ec4294db720b04591245489c  metadata.db</span><br><span class="line">[root@localhost volumes]<span class="comment"># ll</span></span><br><span class="line">总用量 24</span><br><span class="line">drwx-----x. 3 root root     19 10月 30 16:05 2384cfb039b29ff058617012a6883694dabf5e1047aa5b4588b05d4403a75ec4</span><br><span class="line">drwx-----x. 3 root root     19 11月  1 11:34 683898996d0153b4335e3b6c1e72451f0923155b39360facd5641ac9d31665a6</span><br><span class="line">drwx-----x. 3 root root     19 10月 29 17:15 b4309f0bc3eda0a6b8d4837a0d56c5ea3ef2d016ec4294db720b04591245489c</span><br><span class="line">brw-------. 1 root root 253, 0 11月  1 10:03 backingFsBlockDev</span><br><span class="line">drwx-----x. 3 root root     19 10月 30 15:35 c505a4ba768a4f507cc80216c13902724aec7388d6a35af6aa24e6f4fc81d68f</span><br><span class="line">-rw-------. 1 root root  32768 11月  1 11:34 metadata.db</span><br><span class="line">[root@localhost volumes]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="具名挂载"><a href="#具名挂载" class="headerlink" title="具名挂载"></a>具名挂载</h3><p>具名挂载，就是指定文件夹名称，区别于指定路径挂载，这里的指定文件夹名称是在<code>Docker</code>指定的默认数据卷路径下的。</p><ol><li>通过<code>docker volume ls</code>命令查看当前数据卷的目录情况 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker run -d -P --name nginx02 -v juming-nginx:/etc/nginx nginx</span></span><br><span class="line">0a2a21f561c2b3db9442bef96508413a06a6bd59a1e315226eaff6128fc66b02</span><br><span class="line">[root@localhost ~]<span class="comment"># docker volume ls</span></span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>     2384cfb039b29ff058617012a6883694dabf5e1047aa5b4588b05d4403a75ec4</span><br><span class="line"><span class="built_in">local</span>     683898996d0153b4335e3b6c1e72451f0923155b39360facd5641ac9d31665a6</span><br><span class="line"><span class="built_in">local</span>     b4309f0bc3eda0a6b8d4837a0d56c5ea3ef2d016ec4294db720b04591245489c</span><br><span class="line"><span class="built_in">local</span>     c505a4ba768a4f507cc80216c13902724aec7388d6a35af6aa24e6f4fc81d68f</span><br><span class="line"><span class="built_in">local</span>     juming-nginx</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>查看指定的数据卷信息，命令：<code>docker volume inspect 数据卷名称</code>，可以看到主机数据卷挂载在<code>/var/lib/docker/volumes/juming-nginx/_data</code>上 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker volume inspect juming-nginx</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;CreatedAt&quot;</span>: <span class="string">&quot;2021-11-01T15:35:29+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;Mountpoint&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/juming-nginx/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;juming-nginx&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li></ol><p><code>Docker</code>所有的数据卷默认在<code>/var/lib/docker/volumes/</code>目录下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cd /var/lib/docker/volumes/</span></span><br><span class="line">[root@localhost volumes]<span class="comment"># ll</span></span><br><span class="line">总用量 24</span><br><span class="line">drwx-----x. 3 root root     19 10月 30 16:05 2384cfb039b29ff058617012a6883694dabf5e1047aa5b4588b05d4403a75ec4</span><br><span class="line">drwx-----x. 3 root root     19 11月  1 11:34 683898996d0153b4335e3b6c1e72451f0923155b39360facd5641ac9d31665a6</span><br><span class="line">drwx-----x. 3 root root     19 10月 29 17:15 b4309f0bc3eda0a6b8d4837a0d56c5ea3ef2d016ec4294db720b04591245489c</span><br><span class="line">brw-------. 1 root root 253, 0 11月  1 15:30 backingFsBlockDev</span><br><span class="line">drwx-----x. 3 root root     19 10月 30 15:35 c505a4ba768a4f507cc80216c13902724aec7388d6a35af6aa24e6f4fc81d68f</span><br><span class="line">drwx-----x. 3 root root     19 11月  1 15:35 juming-nginx</span><br><span class="line">-rw-------. 1 root root  32768 11月  1 15:35 metadata.db</span><br><span class="line">[root@localhost volumes]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>所有<code>Docker</code>容器内的卷，在未指定主机内目录时，都在<code>/var/lib/docker/volumes/卷名/_data</code>下，可通过具名挂载可以方便的找到卷，因此广泛使用这种方式进行挂载。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost volumes]<span class="comment"># docker volume inspect juming-nginx</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;CreatedAt&quot;</span>: <span class="string">&quot;2021-11-01T15:35:29+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;Mountpoint&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/juming-nginx/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;juming-nginx&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[root@localhost volumes]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><p>匿名挂载，具名挂载，指定路径挂载的命令区别如下：</p><ul><li><code>-v 容器内路径</code>：匿名挂载</li><li><code>-v 卷名:容器内路径</code>：具名挂载</li><li><code>-v /宿主机路径:容器内路径</code>：指定路径挂载</li></ul><h3 id="数据卷映射相关参数"><a href="#数据卷映射相关参数" class="headerlink" title="数据卷映射相关参数"></a>数据卷映射相关参数</h3><p>指定数据卷映射的相关参数：</p><ul><li><p><code>ro</code>：<code>readonly</code>，只读，设置了只读则只能操作宿主机的路径，不能操作容器中的对应路径。</p></li><li><p><code>rw</code>：<code>readwrite</code>，可读可写</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost volumes]<span class="comment"># docker run -d -P --name nginx03 -v juming-nginx:/etc/nginx:ro nginx</span></span><br><span class="line">1c246890508f95987d5f9154e51f7a4992479829f2cd5621ddf4aa6e8b995f97</span><br><span class="line">[root@localhost volumes]<span class="comment"># docker exec -it nginx03 /bin/bash</span></span><br><span class="line">root@1c246890508f:/<span class="comment"># cd /etc/nginx/</span></span><br><span class="line">root@1c246890508f:/etc/nginx<span class="comment"># ls</span></span><br><span class="line">conf.d  fastcgi_params  mime.types  modules  nginx.conf  scgi_params  uwsgi_params</span><br><span class="line">root@1c246890508f:/etc/nginx<span class="comment"># touch test.txt</span></span><br><span class="line"><span class="built_in">touch</span>: cannot <span class="built_in">touch</span> <span class="string">&#x27;test.txt&#x27;</span>: Read-only file system</span><br><span class="line">root@1c246890508f:/etc/nginx<span class="comment"># </span></span><br><span class="line">[root@localhost volumes]<span class="comment">#</span></span><br><span class="line">[root@localhost volumes]<span class="comment"># docker run -d -P --name nginx04 -v juming-nginx:/etc/nginx:rw nginx</span></span><br><span class="line">1d39e0ad7fe5c7b5de1edf5d23b0269f59e15e7f25e76f058eaa9ac27461229b</span><br><span class="line">[root@localhost volumes]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h2 id="初识-Dockerfile"><a href="#初识-Dockerfile" class="headerlink" title="初识 Dockerfile"></a>初识 Dockerfile</h2><p>可以在<code>Dockerfile</code>中使用<code>VOLUME</code>指令来给镜像添加一个或多个数据卷。</p><p>下面使用<code>Dockerfile</code>构建一个新的镜像，<code>dockerfile01</code>文件的内容，匿名挂载了<code>volume01</code>和<code>volume02</code>两个目录：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> [<span class="string">&quot;volume01&quot;</span>,<span class="string">&quot;volume02&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;----end----&quot;</span></span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> /bin/bash</span></span><br></pre></td></tr></table></figure><ol><li>创建<code>Dockerfile</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost volumes]<span class="comment"># cd /home/</span></span><br><span class="line">[root@localhost home]<span class="comment"># ls</span></span><br><span class="line"><span class="built_in">echo</span>  mysql  <span class="built_in">test</span></span><br><span class="line">[root@localhost home]<span class="comment"># mkdir docker-test-volume</span></span><br><span class="line">[root@localhost home]<span class="comment"># cd docker-test-volume/</span></span><br><span class="line">[root@localhost docker-test-volume]<span class="comment"># vi Dockerfile01</span></span><br><span class="line">[root@localhost docker-test-volume]<span class="comment"># cat Dockerfile01</span></span><br><span class="line">FROM centos</span><br><span class="line"></span><br><span class="line">VOLUME [<span class="string">&quot;volume01&quot;</span>,<span class="string">&quot;volume02&quot;</span>]</span><br><span class="line"></span><br><span class="line">CMD <span class="built_in">echo</span> <span class="string">&quot;----end----&quot;</span></span><br><span class="line">CMD /bin/bash</span><br><span class="line"></span><br><span class="line">[root@localhost docker-test-volume]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>构建镜像 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost docker-test-volume]<span class="comment"># docker build -f /home/docker-test-volume/Dockerfile01 -t mycentso:1.0 .</span></span><br><span class="line">Sending build context to Docker daemon  2.048kB</span><br><span class="line">Step 1/4 : FROM centos</span><br><span class="line"> ---&gt; 5d0da3dc9764</span><br><span class="line">Step 2/4 : VOLUME [<span class="string">&quot;volume01&quot;</span>,<span class="string">&quot;volume02&quot;</span>]</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> c8a9fd0dc844</span><br><span class="line">Removing intermediate container c8a9fd0dc844</span><br><span class="line"> ---&gt; 6cead4388a3b</span><br><span class="line">Step 3/4 : CMD <span class="built_in">echo</span> <span class="string">&quot;----end----&quot;</span></span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> ebef18c40e02</span><br><span class="line">Removing intermediate container ebef18c40e02</span><br><span class="line"> ---&gt; 3e993838049c</span><br><span class="line">Step 4/4 : CMD /bin/bash</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> adfd9b894c7d</span><br><span class="line">Removing intermediate container adfd9b894c7d</span><br><span class="line"> ---&gt; 992cbdac9cbb</span><br><span class="line">Successfully built 992cbdac9cbb</span><br><span class="line">Successfully tagged mycentso:1.0</span><br><span class="line">[root@localhost docker-test-volume]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY            TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">mycentso              1.0       992cbdac9cbb   33 seconds ago   231MB</span><br><span class="line">mytomcat              1.0       97a599676bbb   2 days ago       684MB</span><br><span class="line">tomcat                latest    b0e0b0a92cf9   10 days ago      680MB</span><br><span class="line">mysql                 5.7       938b57d64674   13 days ago      448MB</span><br><span class="line">nginx                 latest    87a94228f133   2 weeks ago      133MB</span><br><span class="line">hello-world           latest    feb5d9fea6a5   5 weeks ago      13.3kB</span><br><span class="line">centos                latest    5d0da3dc9764   6 weeks ago      231MB</span><br><span class="line">portainer/portainer   latest    580c0e4e98b0   7 months ago     79.1MB</span><br><span class="line">elasticsearch         latest    5acf0e8da90b   3 years ago      486MB</span><br><span class="line">abh1nav/dockerui      latest    6e4d05915b2a   6 years ago      470MB</span><br><span class="line">[root@localhost docker-test-volume]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>运行生成的镜像，可以看到自动挂载的数据卷目录 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost docker-test-volume]<span class="comment"># docker run -it 992cbdac9cbb /bin/bash</span></span><br><span class="line">[root@80583205c391 /]<span class="comment"># ls -l</span></span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx.   1 root root   7 Nov  3  2020 bin -&gt; usr/bin</span><br><span class="line">drwxr-xr-x.   5 root root 360 Nov  1 09:29 dev</span><br><span class="line">drwxr-xr-x.   1 root root  66 Nov  1 09:29 etc</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 home</span><br><span class="line">lrwxrwxrwx.   1 root root   7 Nov  3  2020 lib -&gt; usr/lib</span><br><span class="line">lrwxrwxrwx.   1 root root   9 Nov  3  2020 lib64 -&gt; usr/lib64</span><br><span class="line">drwx------.   2 root root   6 Sep 15 14:17 lost+found</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 media</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 mnt</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 opt</span><br><span class="line">dr-xr-xr-x. 172 root root   0 Nov  1 09:29 proc</span><br><span class="line">dr-xr-x---.   2 root root 162 Sep 15 14:17 root</span><br><span class="line">drwxr-xr-x.  11 root root 163 Sep 15 14:17 run</span><br><span class="line">lrwxrwxrwx.   1 root root   8 Nov  3  2020 sbin -&gt; usr/sbin</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 srv</span><br><span class="line">dr-xr-xr-x.  13 root root   0 Nov  1 07:28 sys</span><br><span class="line">drwxrwxrwt.   7 root root 171 Sep 15 14:17 tmp</span><br><span class="line">drwxr-xr-x.  12 root root 144 Sep 15 14:17 usr</span><br><span class="line">drwxr-xr-x.  20 root root 262 Sep 15 14:17 var</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  1 09:29 volume01</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  1 09:29 volume02</span><br><span class="line">[root@80583205c391 /]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>查看对应宿主机的数据卷目录，可以看到<code>Mounts</code>下有宿主机的挂载目录。因为<code>Dockerfile</code>中没有指定宿主机目录，所以属于匿名挂载，在<code>/var/lib/docker/volumes/</code>目录下生成了随机命名的路径。 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost docker-test-volume]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE          COMMAND       CREATED         STATUS         PORTS     NAMES</span><br><span class="line">1db2a2a317a3   992cbdac9cbb   <span class="string">&quot;/bin/bash&quot;</span>   6 seconds ago   Up 5 seconds             eloquent_chatterjee</span><br><span class="line">[root@localhost docker-test-volume]<span class="comment"># docker inspect 1db2a2a317a3</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;1db2a2a317a3871d4f3fcb102ea9322188e727c4aa7a48b5b4d25aea0a908f9a&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2021-11-01T09:32:02.94570866Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Path&quot;</span>: <span class="string">&quot;/bin/bash&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Args&quot;</span>: [],</span><br><span class="line">        <span class="string">&quot;State&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Status&quot;</span>: <span class="string">&quot;running&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Running&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&quot;Paused&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Restarting&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;OOMKilled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Dead&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Pid&quot;</span>: 3235,</span><br><span class="line">            <span class="string">&quot;ExitCode&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;Error&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;StartedAt&quot;</span>: <span class="string">&quot;2021-11-01T09:32:03.131012761Z&quot;</span>,</span><br><span class="line">            <span class="string">&quot;FinishedAt&quot;</span>: <span class="string">&quot;0001-01-01T00:00:00Z&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Image&quot;</span>: <span class="string">&quot;sha256:992cbdac9cbbec0e30eeae73e43c0aff94d6512dc0adb87e73a3c6cbcb1fca76&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ResolvConfPath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/1db2a2a317a3871d4f3fcb102ea9322188e727c4aa7a48b5b4d25aea0a908f9a/resolv.conf&quot;</span>,</span><br><span class="line">        <span class="string">&quot;HostnamePath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/1db2a2a317a3871d4f3fcb102ea9322188e727c4aa7a48b5b4d25aea0a908f9a/hostname&quot;</span>,</span><br><span class="line">        <span class="string">&quot;HostsPath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/1db2a2a317a3871d4f3fcb102ea9322188e727c4aa7a48b5b4d25aea0a908f9a/hosts&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LogPath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/1db2a2a317a3871d4f3fcb102ea9322188e727c4aa7a48b5b4d25aea0a908f9a/1db2a2a317a3871d4f3fcb102ea9322188e727c4aa7a48b5b4d25aea0a908f9a-json.log&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;/eloquent_chatterjee&quot;</span>,</span><br><span class="line">        <span class="string">&quot;RestartCount&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;overlay2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Platform&quot;</span>: <span class="string">&quot;linux&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MountLabel&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ProcessLabel&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;AppArmorProfile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ExecIDs&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;HostConfig&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Binds&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;ContainerIDFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;LogConfig&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Config&quot;</span>: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;NetworkMode&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;PortBindings&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;RestartPolicy&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;no&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MaximumRetryCount&quot;</span>: 0</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;AutoRemove&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;VolumeDriver&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;VolumesFrom&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;CapAdd&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;CapDrop&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;CgroupnsMode&quot;</span>: <span class="string">&quot;host&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Dns&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;DnsOptions&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;DnsSearch&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;ExtraHosts&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;GroupAdd&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;IpcMode&quot;</span>: <span class="string">&quot;private&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Cgroup&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Links&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;OomScoreAdj&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;PidMode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Privileged&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;PublishAllPorts&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;ReadonlyRootfs&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;SecurityOpt&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;UTSMode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;UsernsMode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ShmSize&quot;</span>: 67108864,</span><br><span class="line">            <span class="string">&quot;Runtime&quot;</span>: <span class="string">&quot;runc&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ConsoleSize&quot;</span>: [</span><br><span class="line">                0,</span><br><span class="line">                0</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Isolation&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;CpuShares&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;Memory&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;NanoCpus&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;CgroupParent&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;BlkioWeight&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;BlkioWeightDevice&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;BlkioDeviceReadBps&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;BlkioDeviceWriteBps&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;BlkioDeviceReadIOps&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;BlkioDeviceWriteIOps&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;CpuPeriod&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;CpuQuota&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;CpuRealtimePeriod&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;CpuRealtimeRuntime&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;CpusetCpus&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;CpusetMems&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Devices&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;DeviceCgroupRules&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;DeviceRequests&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;KernelMemory&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;KernelMemoryTCP&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;MemoryReservation&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;MemorySwap&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;MemorySwappiness&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;OomKillDisable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;PidsLimit&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;Ulimits&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;CpuCount&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;CpuPercent&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;IOMaximumIOps&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;IOMaximumBandwidth&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;MaskedPaths&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;/proc/asound&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/acpi&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/kcore&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/keys&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/latency_stats&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/timer_list&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/timer_stats&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/sched_debug&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/scsi&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/sys/firmware&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;ReadonlyPaths&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;/proc/bus&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/fs&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/irq&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/sys&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/sysrq-trigger&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;GraphDriver&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Data&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;LowerDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/24da8b17e1760fe7543bab2fb2d7f89e3b39ff94cefc040f2b85c829162df215-init/diff:/var/lib/docker/overlay2/0ab1d01f204652c7e92e556e2dd1f08093d99ee5ba7a2ee15aeb70324e819ac0/diff&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MergedDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/24da8b17e1760fe7543bab2fb2d7f89e3b39ff94cefc040f2b85c829162df215/merged&quot;</span>,</span><br><span class="line">                <span class="string">&quot;UpperDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/24da8b17e1760fe7543bab2fb2d7f89e3b39ff94cefc040f2b85c829162df215/diff&quot;</span>,</span><br><span class="line">                <span class="string">&quot;WorkDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/24da8b17e1760fe7543bab2fb2d7f89e3b39ff94cefc040f2b85c829162df215/work&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;overlay2&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;volume&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;c73887234089554752e66d136b59e2d74e18978bcebf35b2f5b3e7e11f8d0ca2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/c73887234089554752e66d136b59e2d74e18978bcebf35b2f5b3e7e11f8d0ca2/_data&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;volume01&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Mode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;RW&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;Propagation&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;volume&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;924bf9661264ca16f1ad7b6ac1e1ba9a68f823c81510d723af1e6d4222f25d43&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/924bf9661264ca16f1ad7b6ac1e1ba9a68f823c81510d723af1e6d4222f25d43/_data&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;volume02&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Mode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;RW&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;Propagation&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;Config&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Hostname&quot;</span>: <span class="string">&quot;1db2a2a317a3&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Domainname&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;User&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AttachStdin&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&quot;AttachStdout&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&quot;AttachStderr&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&quot;Tty&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&quot;OpenStdin&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&quot;StdinOnce&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&quot;Env&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Cmd&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;/bin/bash&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Image&quot;</span>: <span class="string">&quot;992cbdac9cbb&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Volumes&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;volume01&quot;</span>: &#123;&#125;,</span><br><span class="line">                <span class="string">&quot;volume02&quot;</span>: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;WorkingDir&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Entrypoint&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;OnBuild&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;Labels&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;org.label-schema.build-date&quot;</span>: <span class="string">&quot;20210915&quot;</span>,</span><br><span class="line">                <span class="string">&quot;org.label-schema.license&quot;</span>: <span class="string">&quot;GPLv2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;org.label-schema.name&quot;</span>: <span class="string">&quot;CentOS Base Image&quot;</span>,</span><br><span class="line">                <span class="string">&quot;org.label-schema.schema-version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">                <span class="string">&quot;org.label-schema.vendor&quot;</span>: <span class="string">&quot;CentOS&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;NetworkSettings&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Bridge&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SandboxID&quot;</span>: <span class="string">&quot;a054eb9aafa23501d4a25121b3da1eb24b6469a07b0366e597a6bf87eb5f105a&quot;</span>,</span><br><span class="line">            <span class="string">&quot;HairpinMode&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;LinkLocalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;LinkLocalIPv6PrefixLen&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;Ports&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;SandboxKey&quot;</span>: <span class="string">&quot;/var/run/docker/netns/a054eb9aafa2&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SecondaryIPAddresses&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;SecondaryIPv6Addresses&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;a3906afead5332f63df3e73509fe25b46beae553b0825cae2979566889788ec0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.0.1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;GlobalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;GlobalIPv6PrefixLen&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.2&quot;</span>,</span><br><span class="line">            <span class="string">&quot;IPPrefixLen&quot;</span>: 16,</span><br><span class="line">            <span class="string">&quot;IPv6Gateway&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:02&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Networks&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;bridge&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;IPAMConfig&quot;</span>: null,</span><br><span class="line">                    <span class="string">&quot;Links&quot;</span>: null,</span><br><span class="line">                    <span class="string">&quot;Aliases&quot;</span>: null,</span><br><span class="line">                    <span class="string">&quot;NetworkID&quot;</span>: <span class="string">&quot;d16f04d8a8481cbd0d8a2112d724deb20e3e776be05b0ee1a669092695b148d1&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;a3906afead5332f63df3e73509fe25b46beae553b0825cae2979566889788ec0&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.0.1&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.2&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPPrefixLen&quot;</span>: 16,</span><br><span class="line">                    <span class="string">&quot;IPv6Gateway&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;GlobalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;GlobalIPv6PrefixLen&quot;</span>: 0,</span><br><span class="line">                    <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:02&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;DriverOpts&quot;</span>: null</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[root@localhost docker-test-volume]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li></ol><p>　　</p><h2 id="数据卷容器"><a href="#数据卷容器" class="headerlink" title="数据卷容器"></a>数据卷容器</h2><p><code>docker run -it --name container02 --volumes-from container01 镜像名/id</code></p><p>容器数据卷是指建立数据卷，来同步多个容器间的数据，实现容器间的数据同步。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635729252/1639727991-e90c6ed5.png"></p></div><ol><li>首先启动容器 $1$，<code>volume01</code>、<code>volume02</code>为挂载目录 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost docker-test-volume]<span class="comment"># docker run -it --name cnetos01 mycentso:1.0</span></span><br><span class="line">[root@b283552e8336 /]<span class="comment"># ls</span></span><br><span class="line">bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var  volume01  volume02</span><br><span class="line">[root@b283552e8336 /]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>然后启动容器 $2$，通过参数<code>--volumes-from</code>，设置容器 $2$ 和容器 $1$ 建立数据卷挂载关系 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost docker-test-volume]<span class="comment"># docker run -it --name centos02 --volumes-from cnetos01 mycentso:1.0</span></span><br><span class="line">[root@50d228c45e1f /]<span class="comment"># ls -l</span></span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx.   1 root root   7 Nov  3  2020 bin -&gt; usr/bin</span><br><span class="line">drwxr-xr-x.   5 root root 360 Nov  1 09:39 dev</span><br><span class="line">drwxr-xr-x.   1 root root  66 Nov  1 09:39 etc</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 home</span><br><span class="line">lrwxrwxrwx.   1 root root   7 Nov  3  2020 lib -&gt; usr/lib</span><br><span class="line">lrwxrwxrwx.   1 root root   9 Nov  3  2020 lib64 -&gt; usr/lib64</span><br><span class="line">drwx------.   2 root root   6 Sep 15 14:17 lost+found</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 media</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 mnt</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 opt</span><br><span class="line">dr-xr-xr-x. 176 root root   0 Nov  1 09:39 proc</span><br><span class="line">dr-xr-x---.   2 root root 162 Sep 15 14:17 root</span><br><span class="line">drwxr-xr-x.  11 root root 163 Sep 15 14:17 run</span><br><span class="line">lrwxrwxrwx.   1 root root   8 Nov  3  2020 sbin -&gt; usr/sbin</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 srv</span><br><span class="line">dr-xr-xr-x.  13 root root   0 Nov  1 07:28 sys</span><br><span class="line">drwxrwxrwt.   7 root root 171 Sep 15 14:17 tmp</span><br><span class="line">drwxr-xr-x.  12 root root 144 Sep 15 14:17 usr</span><br><span class="line">drwxr-xr-x.  20 root root 262 Sep 15 14:17 var</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  1 09:37 volume01</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  1 09:37 volume02</span><br><span class="line">[root@50d228c45e1f /]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>在容器 $2$ 中的<code>volume01</code>中添加文件 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@50d228c45e1f /]<span class="comment"># cd volume01</span></span><br><span class="line">[root@50d228c45e1f volume01]<span class="comment"># touch test.java</span></span><br><span class="line">[root@50d228c45e1f volume01]<span class="comment"># cat test.java</span></span><br><span class="line">[root@50d228c45e1f volume01]<span class="comment"># ls</span></span><br><span class="line">test.java</span><br><span class="line">[root@50d228c45e1f volume01]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>可以看到容器 $1$ 的文件也添加上了 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost docker-test-volume]<span class="comment"># docker exec -it cnetos01 /bin/bash</span></span><br><span class="line">[root@b283552e8336 /]<span class="comment"># cd volume01</span></span><br><span class="line">[root@b283552e8336 volume01]<span class="comment"># ls</span></span><br><span class="line">test.java</span><br><span class="line">[root@b283552e8336 volume01]<span class="comment"># cat test.java</span></span><br><span class="line">[root@b283552e8336 volume01]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="MySQL-数据卷容器同步数据"><a href="#MySQL-数据卷容器同步数据" class="headerlink" title="MySQL 数据卷容器同步数据"></a>MySQL 数据卷容器同步数据</h2><p>下面同步两个<code>MySQL</code>的数据库和配置文件，与前面的操作相同，首先建立数据卷，然后给另一个<code>MySQL</code>容器建立容器数据卷挂载。</p><ol><li>启动前面数据卷同步时创建的容器 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost docker-test-volume]<span class="comment"># docker start bd86b67cb648743b1871c70da061de1c43b99b0983994c4e6ffc9d7d07948619</span></span><br><span class="line">bd86b67cb648743b1871c70da061de1c43b99b0983994c4e6ffc9d7d07948619</span><br><span class="line">[root@localhost docker-test-volume]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>启动容器数据卷 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost docker-test-volume]<span class="comment"># docker run -d -p 6604:3306 -e MYSQL_ROOT_PASSWORD=123456 --name mysql02 --volumes-from mysql01 mysql:5.7</span></span><br><span class="line">6b96590d560acd433830a932488aa488a70541270a67bb7d377ee171a856ee46</span><br><span class="line">[root@localhost docker-test-volume]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li></ol><h1 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h1><h2 id="Dockerfile-介绍"><a href="#Dockerfile-介绍" class="headerlink" title="Dockerfile 介绍"></a>Dockerfile 介绍</h2><p><code>Dockerfile</code>是用来构建<code>Docker</code>镜像的文本文件，也可以说是命令参数脚本。</p><p><code>docker build</code>命令用于从<code>Dockerfile</code>构建镜像。可以在<code>docker build</code>命令中使用<code>-f</code>标志指向文件系统中任何位置的<code>Dockerfile</code>。</p><p><code>Docker</code>镜像发布的步骤：</p><ol><li>编写一个<code>dockerfile</code>文件</li><li><code>docker build</code>构建成为一个镜像</li><li><code>docker run</code>镜像</li><li><code>docker push</code>镜像（发布镜像到<code>DockerHub</code>、阿里云镜像仓库）</li></ol><p>示例一个镜像的结构图：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635729252/1639728052-3cb8269c.png"></p></div><h2 id="Dockerfile-指令说明"><a href="#Dockerfile-指令说明" class="headerlink" title="Dockerfile 指令说明"></a>Dockerfile 指令说明</h2><table><thead><tr><th>指令</th><th>说明</th></tr></thead><tbody><tr><td><code>FROM</code></td><td>指定基础镜像</td></tr><tr><td><code>MAINTAINER</code></td><td>镜像是谁写的，姓名+邮箱</td></tr><tr><td><code>RUN</code></td><td>镜像构建的时候需要运行的命令</td></tr><tr><td><code>ADD</code></td><td>将本地文件添加到容器中，<code>tar</code>类型文件会自动解压（网络压缩资源不会被解压），可以访问网络资源，类似<code>wget</code></td></tr><tr><td><code>WORKDIR</code></td><td>镜像的工作目录</td></tr><tr><td><code>VOLUME</code></td><td>挂载的目录</td></tr><tr><td><code>EXPOSE</code></td><td>保留端口配置</td></tr><tr><td><code>CMD</code></td><td>指定这个容器启动的时候要运行的命令（只有最后一个会生效）</td></tr><tr><td><code>EMTRYPOINT</code></td><td>指定这个容器启动的时候要运行的命令，可以追加命令</td></tr><tr><td><code>ONBUILD</code></td><td>当构建一个被继承<code>DockerFile</code>，这个时候就会运行<code>ONBUILD</code>的指令，触发指令</td></tr><tr><td><code>COPY</code></td><td>功能类似<code>ADD</code>，但是是不会自动解压文件，也不能访问网络资源</td></tr><tr><td><code>ENV</code></td><td>构建的时候设置环境变量</td></tr></tbody></table><p>一个形象的解释各个指令作用的图：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635729252/1639728095-c4191b76.png"></p></div><p><code>Dockerfile</code>一般分为四部分：</p><ul><li>基础镜像信息</li><li>维护者信息</li><li>镜像操作指令</li><li>容器启动时执行指令</li></ul><p>关于<code>Dockerfile</code>文件的脚本注意点有：</p><ol><li>每个保留关键字（指令）都必须是大写字母</li><li>文件中的指令从上到下顺序执行，第一个指令必须是<code>FROM</code></li><li><code>#</code>号表示注释</li><li>每一个指令都会创建一个新的镜像层并提交</li></ol><p>关于<code>Dockerfile</code>指令的详细语法解释：<a href="https://www.cnblogs.com/panwenbin-logs/p/8007348.html">Dockerfile文件详解</a><br><code>Dockerfile</code>指令介绍的<a href="https://docs.docker.com/engine/reference/builder/">官方文档</a>：<code>https://docs.docker.com/engine/reference/builder/</code>。</p><h2 id="制作CentOS镜像"><a href="#制作CentOS镜像" class="headerlink" title="制作CentOS镜像"></a>制作CentOS镜像</h2><p>下面通过编写<code>Dockerfile</code>文件来制作<code>CentOS</code>镜像，并在官方镜像的基础上添加<code>vim</code>和<code>net-tools</code>工具。</p><ol><li><p>在<code>/home/dockfile</code>目录下新建文件<code>mydockerfile-centos</code>。然后使用上述指令编写该文件</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost home]<span class="comment"># mkdir dockerfile</span></span><br><span class="line">[root@localhost home]<span class="comment"># cd dockerfile/</span></span><br><span class="line">[root@localhost dockerfile]<span class="comment"># vi mydockerfile-centos</span></span><br><span class="line">[root@localhost dockerfile]<span class="comment"># cat mydockerfile-centos</span></span><br><span class="line">FROM centos</span><br><span class="line">MAINTAINER ethan&lt;1258398543@qq.com&gt;</span><br><span class="line"></span><br><span class="line">ENV MYPATH /usr/local</span><br><span class="line">WORKDIR <span class="variable">$MYPATH</span></span><br><span class="line"></span><br><span class="line">RUN yum -y install vim</span><br><span class="line">RUN yum -y install net-tools</span><br><span class="line"></span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line">CMD <span class="built_in">echo</span> <span class="variable">$MYPATH</span></span><br><span class="line">CMD <span class="built_in">echo</span> <span class="string">&quot;---end---&quot;</span></span><br><span class="line">CMD /bin/bash</span><br><span class="line">[root@localhost dockerfile]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p> 逐行解释该<code>Dockerfile</code>文件的指令：</p><ul><li><code>FROM centos</code>：该<code>image</code>文件继承官方的<code>centos</code>，后面加冒号如<code>centos:7</code>，用于指定镜像的版本</li><li><code>ENV MYPATH /usr/local</code>：设置环境变量<code>MYPATH</code>，后面有用到</li><li><code>WORKDIR $MYPATH</code>：直接使用上面设置的环境变量，指定<code>/usr/local</code>为工作目录</li><li><code>RUN yum -y install vim</code>和<code>RUN yum -y install net-tools</code>：在<code>/usr/local</code>目录下，运行<code>yum -y install vim</code>和<code>yum -y install net-tools</code>命令安装工具，注意安装后的所有依赖和工具都会打包到<code>image</code>文件中</li><li><code>EXPOSE 80</code>：将容器 $80$ 端口暴露出来，允许外部连接这个端口</li><li><code>CMD</code>：指定容器启动的时候运行命令</li></ul></li><li><p>执行<code>build</code>命令生成<code>image</code>文件，构建镜像命令：<code>docker build -f dockerfile文件路径 -t 镜像名[:版本号] .</code>（这里有个小点<code>.</code>）；如果执行成功，可以通过<code>docker images</code>来查看新生成的镜像文件</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost dockerfile]<span class="comment">#  docker build -f mydockerfile-centos -t mycentos:1.0 .</span></span><br><span class="line">Sending build context to Docker daemon  2.048kB</span><br><span class="line">Step 1/10 : FROM centos</span><br><span class="line"> ---&gt; 5d0da3dc9764</span><br><span class="line">Step 2/10 : MAINTAINER ethan&lt;1258398543@qq.com&gt;</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 43b1033a97a4</span><br><span class="line">Removing intermediate container 43b1033a97a4</span><br><span class="line"> ---&gt; 095d1fbac30b</span><br><span class="line">Step 3/10 : ENV MYPATH /usr/local</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> ed78d9027e6b</span><br><span class="line">Removing intermediate container ed78d9027e6b</span><br><span class="line"> ---&gt; ed516bbef3f2</span><br><span class="line">Step 4/10 : WORKDIR <span class="variable">$MYPATH</span></span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 66194c150e8b</span><br><span class="line">Removing intermediate container 66194c150e8b</span><br><span class="line"> ---&gt; a497136254c6</span><br><span class="line">Step 5/10 : RUN yum -y install vim</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> a84eff373c59</span><br><span class="line">CentOS Linux 8 - AppStream                      1.2 MB/s | 9.5 MB     00:08</span><br><span class="line">CentOS Linux 8 - BaseOS                         2.2 MB/s | 7.5 MB     00:03</span><br><span class="line">CentOS Linux 8 - Extras                         1.8 kB/s |  10 kB     00:05</span><br><span class="line">Dependencies resolved.</span><br><span class="line">================================================================================</span><br><span class="line"> Package             Arch        Version                   Repository      Size</span><br><span class="line">================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> vim-enhanced        x86_64      2:8.0.1763-15.el8         appstream      1.4 M</span><br><span class="line">Installing dependencies:</span><br><span class="line"> gpm-libs            x86_64      1.20.7-17.el8             appstream       39 k</span><br><span class="line"> vim-common          x86_64      2:8.0.1763-15.el8         appstream      6.3 M</span><br><span class="line"> vim-filesystem      noarch      2:8.0.1763-15.el8         appstream       48 k</span><br><span class="line"> <span class="built_in">which</span>               x86_64      2.21-12.el8               baseos          49 k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">================================================================================</span><br><span class="line">Install  5 Packages</span><br><span class="line"></span><br><span class="line">Total download size: 7.8 M</span><br><span class="line">Installed size: 30 M</span><br><span class="line">Downloading Packages:</span><br><span class="line">(1/5): gpm-libs-1.20.7-17.el8.x86_64.rpm        474 kB/s |  39 kB     00:00</span><br><span class="line">(2/5): vim-filesystem-8.0.1763-15.el8.noarch.rp 1.4 MB/s |  48 kB     00:00</span><br><span class="line">(3/5): which-2.21-12.el8.x86_64.rpm              70 kB/s |  49 kB     00:00</span><br><span class="line">(4/5): vim-enhanced-8.0.1763-15.el8.x86_64.rpm  249 kB/s | 1.4 MB     00:05</span><br><span class="line">(5/5): vim-common-8.0.1763-15.el8.x86_64.rpm    852 kB/s | 6.3 MB     00:07</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Total                                           949 kB/s | 7.8 MB     00:08</span><br><span class="line">warning: /var/cache/dnf/appstream-02e86d1c976ab532/packages/gpm-libs-1.20.7-17.el8.x86_64.rpm: Header V3 RSA/SHA256 Signature, key ID 8483c65d: NOKEY</span><br><span class="line">CentOS Linux 8 - AppStream                      1.6 MB/s | 1.6 kB     00:00</span><br><span class="line">Importing GPG key 0x8483C65D:</span><br><span class="line"> Userid     : <span class="string">&quot;CentOS (CentOS Official Signing Key) &lt;security@centos.org&gt;&quot;</span></span><br><span class="line"> Fingerprint: 99DB 70FA E1D7 CE22 7FB6 4882 05B5 55B3 8483 C65D</span><br><span class="line"> From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial</span><br><span class="line">Key imported successfully</span><br><span class="line">Running transaction check</span><br><span class="line">Transaction check succeeded.</span><br><span class="line">Running transaction <span class="built_in">test</span></span><br><span class="line">Transaction <span class="built_in">test</span> succeeded.</span><br><span class="line">Running transaction</span><br><span class="line">  Preparing        :                                                        1/1</span><br><span class="line">  Installing       : which-2.21-12.el8.x86_64                               1/5</span><br><span class="line">  Installing       : vim-filesystem-2:8.0.1763-15.el8.noarch                2/5</span><br><span class="line">  Installing       : vim-common-2:8.0.1763-15.el8.x86_64                    3/5</span><br><span class="line">  Installing       : gpm-libs-1.20.7-17.el8.x86_64                          4/5</span><br><span class="line">  Running scriptlet: gpm-libs-1.20.7-17.el8.x86_64                          4/5</span><br><span class="line">  Installing       : vim-enhanced-2:8.0.1763-15.el8.x86_64                  5/5</span><br><span class="line">  Running scriptlet: vim-enhanced-2:8.0.1763-15.el8.x86_64                  5/5</span><br><span class="line">  Running scriptlet: vim-common-2:8.0.1763-15.el8.x86_64                    5/5</span><br><span class="line">  Verifying        : gpm-libs-1.20.7-17.el8.x86_64                          1/5</span><br><span class="line">  Verifying        : vim-common-2:8.0.1763-15.el8.x86_64                    2/5</span><br><span class="line">  Verifying        : vim-enhanced-2:8.0.1763-15.el8.x86_64                  3/5</span><br><span class="line">  Verifying        : vim-filesystem-2:8.0.1763-15.el8.noarch                4/5</span><br><span class="line">  Verifying        : which-2.21-12.el8.x86_64                               5/5</span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  gpm-libs-1.20.7-17.el8.x86_64         vim-common-2:8.0.1763-15.el8.x86_64</span><br><span class="line">  vim-enhanced-2:8.0.1763-15.el8.x86_64 vim-filesystem-2:8.0.1763-15.el8.noarch</span><br><span class="line">  which-2.21-12.el8.x86_64</span><br><span class="line"></span><br><span class="line">Complete!</span><br><span class="line">Removing intermediate container a84eff373c59</span><br><span class="line"> ---&gt; 6408950e74f3</span><br><span class="line">Step 6/10 : RUN yum -y install net-tools</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 597d5566b368</span><br><span class="line">Last metadata expiration check: 0:00:16 ago on Mon Nov  1 12:31:34 2021.</span><br><span class="line">Dependencies resolved.</span><br><span class="line">================================================================================</span><br><span class="line"> Package         Architecture Version                        Repository    Size</span><br><span class="line">================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> net-tools       x86_64       2.0-0.52.20160912git.el8       baseos       322 k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">================================================================================</span><br><span class="line">Install  1 Package</span><br><span class="line"></span><br><span class="line">Total download size: 322 k</span><br><span class="line">Installed size: 942 k</span><br><span class="line">Downloading Packages:</span><br><span class="line">net-tools-2.0-0.52.20160912git.el8.x86_64.rpm   1.8 MB/s | 322 kB     00:00</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Total                                           423 kB/s | 322 kB     00:00</span><br><span class="line">Running transaction check</span><br><span class="line">Transaction check succeeded.</span><br><span class="line">Running transaction <span class="built_in">test</span></span><br><span class="line">Transaction <span class="built_in">test</span> succeeded.</span><br><span class="line">Running transaction</span><br><span class="line">  Preparing        :                                                        1/1</span><br><span class="line">  Installing       : net-tools-2.0-0.52.20160912git.el8.x86_64              1/1</span><br><span class="line">  Running scriptlet: net-tools-2.0-0.52.20160912git.el8.x86_64              1/1</span><br><span class="line">  Verifying        : net-tools-2.0-0.52.20160912git.el8.x86_64              1/1</span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  net-tools-2.0-0.52.20160912git.el8.x86_64</span><br><span class="line"></span><br><span class="line">Complete!</span><br><span class="line">Removing intermediate container 597d5566b368</span><br><span class="line"> ---&gt; af57346b45d9</span><br><span class="line">Step 7/10 : EXPOSE 80</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 909587416a60</span><br><span class="line">Removing intermediate container 909587416a60</span><br><span class="line"> ---&gt; 0aa76c6c71d9</span><br><span class="line">Step 8/10 : CMD <span class="built_in">echo</span> <span class="variable">$MYPATH</span></span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 5190b077ed5e</span><br><span class="line">Removing intermediate container 5190b077ed5e</span><br><span class="line"> ---&gt; 8895bf084511</span><br><span class="line">Step 9/10 : CMD <span class="built_in">echo</span> <span class="string">&quot;---end---&quot;</span></span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 31128e5f3554</span><br><span class="line">Removing intermediate container 31128e5f3554</span><br><span class="line"> ---&gt; 051a1554ad1d</span><br><span class="line">Step 10/10 : CMD /bin/bash</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 54e5d791d01e</span><br><span class="line">Removing intermediate container 54e5d791d01e</span><br><span class="line"> ---&gt; 2b8eb73a11a5</span><br><span class="line">Successfully built 2b8eb73a11a5</span><br><span class="line">Successfully tagged mycentos:1.0</span><br><span class="line">[root@localhost dockerfile]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY            TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">mycentos              1.0       2b8eb73a11a5   2 minutes ago   337MB</span><br><span class="line">mycentso              1.0       992cbdac9cbb   3 hours ago     231MB</span><br><span class="line">mytomcat              1.0       97a599676bbb   2 days ago      684MB</span><br><span class="line">tomcat                latest    b0e0b0a92cf9   10 days ago     680MB</span><br><span class="line">mysql                 5.7       938b57d64674   13 days ago     448MB</span><br><span class="line">nginx                 latest    87a94228f133   2 weeks ago     133MB</span><br><span class="line">hello-world           latest    feb5d9fea6a5   5 weeks ago     13.3kB</span><br><span class="line">centos                latest    5d0da3dc9764   6 weeks ago     231MB</span><br><span class="line">portainer/portainer   latest    580c0e4e98b0   7 months ago    79.1MB</span><br><span class="line">elasticsearch         latest    5acf0e8da90b   3 years ago     486MB</span><br><span class="line">abh1nav/dockerui      latest    6e4d05915b2a   6 years ago     470MB</span><br><span class="line">[root@localhost dockerfile]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p> 上面命令中，<code>-t</code>参数用来指定<code>image</code>文件的名字，后面还可以用冒号指定标签。如果不指定，默认的标签就是<code>latest</code>。最后的那个点表示<code>Dockerfile</code>文件所在的路径，上例是当前路径，所以是一个点。</p></li><li><p>生成容器，测试相关命令，查看默认工作目录是否设置成功，<code>vim</code>和<code>net-tools</code>工具是否下载成功</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost dockerfile]<span class="comment"># docker run -it mycentos:1.0</span></span><br><span class="line">[root@ebcc9cd49fd2 <span class="built_in">local</span>]<span class="comment"># pwd</span></span><br><span class="line">/usr/local</span><br><span class="line">[root@ebcc9cd49fd2 <span class="built_in">local</span>]<span class="comment"># ifconfig</span></span><br><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.17.0.6  netmask 255.255.0.0  broadcast 172.17.255.255</span><br><span class="line">        ether 02:42:ac:11:00:06  txqueuelen 0  (Ethernet)</span><br><span class="line">        RX packets 8  bytes 656 (656.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">[root@ebcc9cd49fd2 <span class="built_in">local</span>]<span class="comment"># vi test.txt</span></span><br><span class="line">[root@ebcc9cd49fd2 <span class="built_in">local</span>]<span class="comment"># cat test.txt</span></span><br><span class="line">Hello World!</span><br><span class="line">[root@ebcc9cd49fd2 <span class="built_in">local</span>]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><p>通过<code>docker history 镜像id</code>命令来查看镜像的构建步骤</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost dockerfile]<span class="comment"># docker history 2b8eb73a11a5</span></span><br><span class="line">IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT</span><br><span class="line">2b8eb73a11a5   6 minutes ago   /bin/sh -c <span class="comment">#(nop)  CMD [&quot;/bin/sh&quot; &quot;-c&quot; &quot;/bin…   0B</span></span><br><span class="line">051a1554ad1d   6 minutes ago   /bin/sh -c <span class="comment">#(nop)  CMD [&quot;/bin/sh&quot; &quot;-c&quot; &quot;echo…   0B</span></span><br><span class="line">8895bf084511   6 minutes ago   /bin/sh -c <span class="comment">#(nop)  CMD [&quot;/bin/sh&quot; &quot;-c&quot; &quot;echo…   0B</span></span><br><span class="line">0aa76c6c71d9   6 minutes ago   /bin/sh -c <span class="comment">#(nop)  EXPOSE 80                    0B</span></span><br><span class="line">af57346b45d9   6 minutes ago   /bin/sh -c yum -y install net-tools             32.6MB</span><br><span class="line">6408950e74f3   6 minutes ago   /bin/sh -c yum -y install vim                   73.1MB</span><br><span class="line">a497136254c6   7 minutes ago   /bin/sh -c <span class="comment">#(nop) WORKDIR /usr/local            0B</span></span><br><span class="line">ed516bbef3f2   7 minutes ago   /bin/sh -c <span class="comment">#(nop)  ENV MYPATH=/usr/local        0B</span></span><br><span class="line">095d1fbac30b   7 minutes ago   /bin/sh -c <span class="comment">#(nop)  MAINTAINER ethan&lt;12583985…   0B</span></span><br><span class="line">5d0da3dc9764   6 weeks ago     /bin/sh -c <span class="comment">#(nop)  CMD [&quot;/bin/bash&quot;]            0B</span></span><br><span class="line">&lt;missing&gt;      6 weeks ago     /bin/sh -c <span class="comment">#(nop)  LABEL org.label-schema.sc…   0B</span></span><br><span class="line">&lt;missing&gt;      6 weeks ago     /bin/sh -c <span class="comment">#(nop) ADD file:805cb5e15fb6e0bb0…   231MB</span></span><br><span class="line">[root@localhost dockerfile]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="RUN，CMD和ENTRYPOINT的区别"><a href="#RUN，CMD和ENTRYPOINT的区别" class="headerlink" title="RUN，CMD和ENTRYPOINT的区别"></a>RUN，CMD和ENTRYPOINT的区别</h2><ul><li><p><code>RUN</code>命令与<code>CMD</code>命令的区别</p><ul><li><code>RUN</code>命令在<code>image</code>文件的构建阶段执行，执行结果都会打包进入<code>image</code>文件</li><li><code>CMD</code>命令则是在容器启动后执行</li><li>一个<code>Dockerfile</code>可以包含多个<code>RUN</code>命令，但是只能有一个<code>CMD</code>命令</li><li>指定了<code>CMD</code>命令以后，<code>docker container run</code>命令就不能附加命令了（比如前面的<code>/bin/bash</code>），否则它会覆盖<code>CMD</code>命令</li></ul></li><li><p><code>CMD</code>和<code>ENTRYPOINT</code>的区别</p><ul><li><p><code>CMD</code>：指定容器启动的时候要运行的命令，只有最后一个会生效</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost dockerfile]<span class="comment"># vi dockerfile-cmd-test</span></span><br><span class="line">[root@localhost dockerfile]<span class="comment"># cat dockerfile-cmd-test</span></span><br><span class="line">FROM centos</span><br><span class="line">CMD [<span class="string">&quot;ls&quot;</span>,<span class="string">&quot;-a&quot;</span>]</span><br><span class="line">[root@localhost dockerfile]<span class="comment"># docker build -f dockerfile-cmd-test -t cmdtest:1.0 .</span></span><br><span class="line">Sending build context to Docker daemon  3.072kB</span><br><span class="line">Step 1/2 : FROM centos</span><br><span class="line"> ---&gt; 5d0da3dc9764</span><br><span class="line">Step 2/2 : CMD [<span class="string">&quot;ls&quot;</span>,<span class="string">&quot;-a&quot;</span>]</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 9ca0b5024460</span><br><span class="line">Removing intermediate container 9ca0b5024460</span><br><span class="line"> ---&gt; 38015602d8a7</span><br><span class="line">Successfully built 38015602d8a7</span><br><span class="line">Successfully tagged cmdtest:1.0</span><br><span class="line">[root@localhost dockerfile]<span class="comment"># docker run cmdtest:1.0</span></span><br><span class="line">.</span><br><span class="line">..</span><br><span class="line">.dockerenv</span><br><span class="line">bin</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">home</span><br><span class="line">lib</span><br><span class="line">lib64</span><br><span class="line">lost+found</span><br><span class="line">media</span><br><span class="line">mnt</span><br><span class="line">opt</span><br><span class="line">proc</span><br><span class="line">root</span><br><span class="line">run</span><br><span class="line">sbin</span><br><span class="line">srv</span><br><span class="line">sys</span><br><span class="line">tmp</span><br><span class="line">usr</span><br><span class="line">var</span><br><span class="line"><span class="comment"># 由于使用的是 CMD 指令，命令无追加，-l 取代了原本的 ls -a，而 -l 命令不存在所以报错</span></span><br><span class="line">[root@localhost dockerfile]<span class="comment"># docker run cmdtest:1.0 -l</span></span><br><span class="line">docker: Error response from daemon: OCI runtime create failed: container_linux.go:380: starting container process caused: <span class="built_in">exec</span>: <span class="string">&quot;-l&quot;</span>: executable file not found <span class="keyword">in</span> <span class="variable">$PATH</span>: unknown.</span><br><span class="line">ERRO[0000] error waiting <span class="keyword">for</span> container: context canceled</span><br><span class="line">[root@localhost dockerfile]<span class="comment"># </span></span><br></pre></td></tr></table></figure><p>可以看到追加命令<code>-l</code> 出现了报错。</p></li><li><p><code>ENTRYPOINT</code>：指定容器启动的时候要运行的命令,命令可以追加</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost dockerfile]<span class="comment"># vi dockerfile-entrypoint-test</span></span><br><span class="line">[root@localhost dockerfile]<span class="comment"># cat dockerfile-entrypoint-test</span></span><br><span class="line">FROM centos</span><br><span class="line">ENTRYPOINT [<span class="string">&quot;ls&quot;</span>,<span class="string">&quot;-a&quot;</span>]</span><br><span class="line">[root@localhost dockerfile]<span class="comment"># docker build -f dockerfile-entrypoint-test -t entrypointtest:1.0 .</span></span><br><span class="line">Sending build context to Docker daemon  4.096kB</span><br><span class="line">Step 1/2 : FROM centos</span><br><span class="line"> ---&gt; 5d0da3dc9764</span><br><span class="line">Step 2/2 : ENTRYPOINT [<span class="string">&quot;ls&quot;</span>,<span class="string">&quot;-a&quot;</span>]</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> f4eae0dcc32f</span><br><span class="line">Removing intermediate container f4eae0dcc32f</span><br><span class="line"> ---&gt; 407fa467dbb2</span><br><span class="line">Successfully built 407fa467dbb2</span><br><span class="line">Successfully tagged entrypointtest:1.0</span><br><span class="line">[root@localhost dockerfile]<span class="comment"># docker run entrypointtest:1.0</span></span><br><span class="line">.</span><br><span class="line">..</span><br><span class="line">.dockerenv</span><br><span class="line">bin</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">home</span><br><span class="line">lib</span><br><span class="line">lib64</span><br><span class="line">lost+found</span><br><span class="line">media</span><br><span class="line">mnt</span><br><span class="line">opt</span><br><span class="line">proc</span><br><span class="line">root</span><br><span class="line">run</span><br><span class="line">sbin</span><br><span class="line">srv</span><br><span class="line">sys</span><br><span class="line">tmp</span><br><span class="line">usr</span><br><span class="line">var</span><br><span class="line">[root@localhost dockerfile]<span class="comment"># docker run entrypointtest:1.0 -l</span></span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x.   1 root root   6 Nov  1 13:23 .</span><br><span class="line">drwxr-xr-x.   1 root root   6 Nov  1 13:23 ..</span><br><span class="line">-rwxr-xr-x.   1 root root   0 Nov  1 13:23 .dockerenv</span><br><span class="line">lrwxrwxrwx.   1 root root   7 Nov  3  2020 bin -&gt; usr/bin</span><br><span class="line">drwxr-xr-x.   5 root root 340 Nov  1 13:23 dev</span><br><span class="line">drwxr-xr-x.   1 root root  66 Nov  1 13:23 etc</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 home</span><br><span class="line">lrwxrwxrwx.   1 root root   7 Nov  3  2020 lib -&gt; usr/lib</span><br><span class="line">lrwxrwxrwx.   1 root root   9 Nov  3  2020 lib64 -&gt; usr/lib64</span><br><span class="line">drwx------.   2 root root   6 Sep 15 14:17 lost+found</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 media</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 mnt</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 opt</span><br><span class="line">dr-xr-xr-x. 175 root root   0 Nov  1 13:23 proc</span><br><span class="line">dr-xr-x---.   2 root root 162 Sep 15 14:17 root</span><br><span class="line">drwxr-xr-x.  11 root root 163 Sep 15 14:17 run</span><br><span class="line">lrwxrwxrwx.   1 root root   8 Nov  3  2020 sbin -&gt; usr/sbin</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 srv</span><br><span class="line">dr-xr-xr-x.  13 root root   0 Nov  1 07:28 sys</span><br><span class="line">drwxrwxrwt.   7 root root 171 Sep 15 14:17 tmp</span><br><span class="line">drwxr-xr-x.  12 root root 144 Sep 15 14:17 usr</span><br><span class="line">drwxr-xr-x.  20 root root 262 Sep 15 14:17 var</span><br><span class="line">[root@localhost dockerfile]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="制作-Tomcat-镜像并发布"><a href="#制作-Tomcat-镜像并发布" class="headerlink" title="制作 Tomcat 镜像并发布"></a>制作 Tomcat 镜像并发布</h2><h3 id="制作-Tomcat-镜像"><a href="#制作-Tomcat-镜像" class="headerlink" title="制作 Tomcat 镜像"></a>制作 Tomcat 镜像</h3><ol><li><p>准备镜像文件<code>tomcat</code>、<code>jdk</code>压缩包</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tomcat]<span class="comment"># pwd</span></span><br><span class="line">/home/dockerfile/tomcat</span><br><span class="line">[root@localhost tomcat]<span class="comment"># vi readme.md</span></span><br><span class="line">[root@localhost tomcat]<span class="comment"># ll</span></span><br><span class="line">总用量 153496</span><br><span class="line">-rw-r--r--. 1 root root  10371538 11月  1 21:48 apache-tomcat-8.5.55.tar.gz</span><br><span class="line">-rw-r--r--. 1 root root 146799982 11月  1 21:48 jdk-8u311-linux-x64.tar.gz</span><br><span class="line">-rw-r--r--. 1 root root         9 11月  1 21:28 readme.md</span><br><span class="line">[root@localhost tomcat]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><p>编写<code>dockerfile</code>文件，文件名使用官方命名：<code>Dockerfile</code> ，<code>build</code>的时候就会默认寻找当前目录下的文件，不需要使用<code>-f</code>参数指定</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tomcat]<span class="comment"># vim Dockerfile</span></span><br><span class="line">[root@localhost tomcat]<span class="comment"># cat Dockerfile</span></span><br><span class="line">FROM centos</span><br><span class="line">MAINTAINER <span class="built_in">echo</span>&lt;3153896464@qq.com&gt;</span><br><span class="line"></span><br><span class="line">COPY readme.md /usr/local/readme.md</span><br><span class="line"></span><br><span class="line">ADD jdk-8u311-linux-x64.tar.gz /usr/local/</span><br><span class="line">ADD apache-tomcat-8.5.55.tar.gz /usr/local/</span><br><span class="line"></span><br><span class="line">RUN yum -y install vim</span><br><span class="line"></span><br><span class="line">ENV MYPATH /usr/local</span><br><span class="line">WORKDIR <span class="variable">$MYPATH</span></span><br><span class="line"></span><br><span class="line">ENV JAVA_HOME /usr/local/jdk1.8.0_311</span><br><span class="line">ENV CLASSPATH <span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line">ENV CATALINA_HOME /usr/local/apache-tomcat-8.5.55</span><br><span class="line">ENV CATALINA_BASH /usr/local/apache-tomcat-8.5.55</span><br><span class="line">ENV PATH <span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$CATALINA_HOME</span>/lib:<span class="variable">$CATALINA_HOME</span>/bin</span><br><span class="line"></span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line">CMD /usr/local/apache-tomcat-8.5.55/bin/startup.sh &amp;&amp; <span class="built_in">tail</span> -F /usr/local/apache-tomcat-8.5.55/bin/logs/catalina.out</span><br><span class="line">[root@localhost tomcat]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><p>使用该<code>Dockerfile</code>构建镜像</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tomcat]<span class="comment"># docker build -t diytomcat:1.0 .</span></span><br><span class="line">Sending build context to Docker daemon  157.2MB</span><br><span class="line">Step 1/15 : FROM centos</span><br><span class="line"> ---&gt; 5d0da3dc9764</span><br><span class="line">Step 2/15 : MAINTAINER <span class="built_in">echo</span>&lt;3153896464@qq.com&gt;</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 988b7c14fa96</span><br><span class="line">Removing intermediate container 988b7c14fa96</span><br><span class="line"> ---&gt; 6e0311b858c9</span><br><span class="line">Step 3/15 : COPY readme.md /usr/local/readme.md</span><br><span class="line"> ---&gt; f92145359284</span><br><span class="line">Step 4/15 : ADD jdk-8u311-linux-x64.tar.gz /usr/local/</span><br><span class="line"> ---&gt; d53b12117404</span><br><span class="line">Step 5/15 : ADD apache-tomcat-8.5.55.tar.gz /usr/local/</span><br><span class="line"> ---&gt; fdd0092e4339</span><br><span class="line">Step 6/15 : RUN yum -y install vim</span><br><span class="line">Installed:</span><br><span class="line">  gpm-libs-1.20.7-17.el8.x86_64         vim-common-2:8.0.1763-15.el8.x86_64</span><br><span class="line">  vim-enhanced-2:8.0.1763-15.el8.x86_64 vim-filesystem-2:8.0.1763-15.el8.noarch</span><br><span class="line">  which-2.21-12.el8.x86_64</span><br><span class="line"></span><br><span class="line">Complete!</span><br><span class="line">Removing intermediate container ec335e3411bb</span><br><span class="line"> ---&gt; 1377af46cd65</span><br><span class="line">Step 7/15 : ENV MYPATH /usr/local</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 555def29db17</span><br><span class="line">Removing intermediate container 555def29db17</span><br><span class="line"> ---&gt; 25267120e30d</span><br><span class="line">Step 8/15 : WORKDIR <span class="variable">$MYPATH</span></span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 818a61866bba</span><br><span class="line">Removing intermediate container 818a61866bba</span><br><span class="line"> ---&gt; 0ed85871370b</span><br><span class="line">Step 9/15 : ENV JAVA_HOME /usr/local/jdk1.8.0_311</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> aa6de69dc2a5</span><br><span class="line">Removing intermediate container aa6de69dc2a5</span><br><span class="line"> ---&gt; 81dd801c3581</span><br><span class="line">Step 10/15 : ENV CLASSPATH <span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 4fdfce5e2045</span><br><span class="line">Removing intermediate container 4fdfce5e2045</span><br><span class="line"> ---&gt; 1d41f7e74c58</span><br><span class="line">Step 11/15 : ENV CATALINA_HOME /usr/local/apache-tomcat-8.5.55</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 84625d8d36af</span><br><span class="line">Removing intermediate container 84625d8d36af</span><br><span class="line"> ---&gt; d30f19634463</span><br><span class="line">Step 12/15 : ENV CATALINA_BASH /usr/local/apache-tomcat-8.5.55</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 2843ec285371</span><br><span class="line">Removing intermediate container 2843ec285371</span><br><span class="line"> ---&gt; 39c1dbf31a63</span><br><span class="line">Step 13/15 : ENV PATH <span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$CATALINA_HOME</span>/lib:<span class="variable">$CATALINA_HOME</span>/bin</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 62c8b67ea09d</span><br><span class="line">Removing intermediate container 62c8b67ea09d</span><br><span class="line"> ---&gt; b4ca5a701807</span><br><span class="line">Step 14/15 : EXPOSE 8080</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 3595d16f3ca0</span><br><span class="line">Removing intermediate container 3595d16f3ca0</span><br><span class="line"> ---&gt; 8dc48ca6d1fe</span><br><span class="line">Step 15/15 : CMD /usr/local/apache-tomcat-8.5.55/bin/startup.sh &amp;&amp; <span class="built_in">tail</span> -F /usr/local/apache-tomcat-8.5.55/bin/logs/catalina.out</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> e8bbb9e7e0c5</span><br><span class="line">Removing intermediate container e8bbb9e7e0c5</span><br><span class="line"> ---&gt; 3c423f22b8ed</span><br><span class="line">Successfully built 3c423f22b8ed</span><br><span class="line">Successfully tagged diytomcat:1.0</span><br><span class="line">[root@localhost tomcat]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><p>启动生成的镜像，构建<code>Tomcat</code>容器<br> 这里设置了数据卷，宿主机的<code>/home/dockerfile/tomcat/test</code>对应该容器的<code>/usr/local/apache-tomcat-8.5.55/webapps/test</code>。这样关于<code>test</code>项目的修复只需要在宿主机上修改就可以了，不需要进入到容器中修改</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tomcat]<span class="comment"># docker run -d -p 8088:8080 --name diytomcat -v /home/dockerfile/tomcat/test:/usr/local/apache-tomcat-8.5.55/webapps/test diytomcat:1.0</span></span><br><span class="line">5e3707f7e7692dad464e7d39e040ef512d103265ed0ed0b236c5a6d631d17e44</span><br><span class="line">[root@localhost tomcat]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><p>在<code>/home/dockerfile/tomcat/test</code>的目录下，新建<code>index.html</code>测试<code>Tomcat</code>是否能正常使用</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tomcat]<span class="comment"># cd test/</span></span><br><span class="line">[root@localhost <span class="built_in">test</span>]<span class="comment"># ls</span></span><br><span class="line">[root@localhost <span class="built_in">test</span>]<span class="comment"># vi index.html</span></span><br><span class="line">[root@localhost <span class="built_in">test</span>]<span class="comment"># cat index.html</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;<span class="built_in">head</span>&gt;</span><br><span class="line">         &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span><br><span class="line">        &lt;title&gt;这是个标题&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h1&gt;这是一个一个简单的HTML&lt;/h1&gt;</span><br><span class="line">        &lt;p&gt;Hello World！&lt;/p&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@localhost <span class="built_in">test</span>]<span class="comment"># mkdir WEB-INF</span></span><br><span class="line">[root@localhost <span class="built_in">test</span>]<span class="comment"># cd WEB-INF/</span></span><br><span class="line">[root@localhost WEB-INF]<span class="comment"># vi web.xml</span></span><br><span class="line">[root@localhost WEB-INF]<span class="comment"># cat web.xml</span></span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;web-app xmlns=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span><br><span class="line">         xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">         xsi:schemaLocation=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee</span></span><br><span class="line"><span class="string">                      http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span><br><span class="line">         version=<span class="string">&quot;4.0&quot;</span></span><br><span class="line">         metadata-complete=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">        &lt;welcome-file-list&gt;</span><br><span class="line">                &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;</span><br><span class="line">        &lt;/welcome-file-list&gt;</span><br><span class="line">&lt;/web-app&gt;</span><br><span class="line">[root@localhost WEB-INF]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><p>访问测试，浏览器访问查看是否能正常访问<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635729252/1639728189-9c5034c9.png"></p><p> 如果页面显示乱码，就需要修改<code>tomcat</code>的<code>server.xml</code>文件</p> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span> </span></span><br><span class="line"><span class="tag">             <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span> </span></span><br><span class="line"><span class="tag">             <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> <span class="attr">URIEncoding</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p> 这里添加了一个属性：<code>URIEncoding</code>，将该属性值设置为<code>UTF-8</code>，即可让<code>Tomcat</code>（默认<code>ISO-8859-1</code>编码）以<code>UTF-8</code>的编码处理<code>get</code>请求。</p></li></ol><h3 id="发布镜像到-DockerHub"><a href="#发布镜像到-DockerHub" class="headerlink" title="发布镜像到 DockerHub"></a>发布镜像到 DockerHub</h3><ol><li><p>登录<code>DockerHub</code><a href="https://hub.docker.com/">官网</a><code>https://hub.docker.com/</code> 进行注册</p></li><li><p>进行登录，<code>docker login -u 用户名</code></p> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost WEB-INF]# docker login --help</span><br><span class="line"></span><br><span class="line">Usage:  docker login [OPTIONS] [SERVER]</span><br><span class="line"></span><br><span class="line">Log in to a Docker registry.</span><br><span class="line">If no server is specified, the default is defined by the daemon.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -p, --password string   Password</span><br><span class="line">      --password-stdin    Take the password from stdin</span><br><span class="line">  -u, --username string   Username</span><br><span class="line">[root@localhost WEB-INF]#</span><br></pre></td></tr></table></figure></li><li><p>使用<code>docker push</code>命令推送镜像到<code>DockerHub</code>上的仓库</p> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost WEB-INF]# docker push arrebols/diytomcat:1.0</span><br><span class="line">The push refers to repository [docker.io/arrebols/diytomcat]</span><br><span class="line">5ae6f0025e05: Pushed</span><br><span class="line">e99deaf1aa3c: Pushed</span><br><span class="line">e698a7f407c0: Pushed</span><br><span class="line">ccf9c9482e50: Pushed</span><br><span class="line">74ddd0ec08fa: Mounted from library/centos</span><br></pre></td></tr></table></figure><p> 因为<code>push</code>的时候，镜像名前面需要加上用户名（<code>arrebol</code>是用户名。如果用户名不是当前登录用户则会拒绝<code>push</code>请求），所以需要使用命令<code>docker tag 镜像名 新的镜像名</code>复制出一份镜像重新打个<code>Tag</code>。</p></li></ol><h3 id="发布镜像到阿里云容器服务"><a href="#发布镜像到阿里云容器服务" class="headerlink" title="发布镜像到阿里云容器服务"></a>发布镜像到阿里云容器服务</h3><ol><li>登录阿里云，找到容器镜像服务</li><li>创建命名空间</li><li>与上面<code>DockerHub</code>的操作类似，按官方提供的操作指南操作即可</li></ol><h1 id="Docker-网络"><a href="#Docker-网络" class="headerlink" title="Docker 网络"></a>Docker 网络</h1><h2 id="理解-Docker"><a href="#理解-Docker" class="headerlink" title="理解 Docker"></a>理解 Docker</h2><ol><li><p>查看本机的<code>ip addr</code><br> 通过命令<code>ip addr</code>查看本地<code>ip</code>地址，发现除了本机回环地址和内网地址外，还多了一个网卡：<code>Docker0</code>，这是<code>Docker</code>服务启动后自动生成的。<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635729252/1639728368-754cc587.png"></p></li><li><p>启动<code>tomcat</code>，并查看容器内部的<code>ip addr</code><br> 进入一个正在后台运行的<code>tomcat</code>容器，同样使用<code>ip addr</code>命令，发现容器得到了一个新的网络：<code>6: eth0@if7</code>，<code>ip</code>地址：$172.17.0.3/16$。这是<code>Docker</code>在容器启动时为其分配的。</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker run -d -it -P --name tomcat01 tomcat</span></span><br><span class="line">Unable to find image <span class="string">&#x27;tomcat:latest&#x27;</span> locally</span><br><span class="line">latest: Pulling from library/tomcat</span><br><span class="line">...</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> tomcat:latest</span><br><span class="line">b8f8e90162f789577b678ea020e54e5e091b62081b2ed34580288761b1c6c55a</span><br><span class="line">[root@localhost ~]<span class="comment"># docker exec -it tomcat01 /bin/bash</span></span><br><span class="line">root@b8f8e90162f7:/usr/local/tomcat<span class="comment"># apt-get update</span></span><br><span class="line">Get:1 http://deb.debian.org/debian bullseye InRelease [116 kB]</span><br><span class="line">Get:2 http://security.debian.org/debian-security bullseye-security InRelease [44.1 kB]</span><br><span class="line">Get:3 http://security.debian.org/debian-security bullseye-security/main amd64 Packages [85.2 kB]</span><br><span class="line">Get:4 http://deb.debian.org/debian bullseye-updates InRelease [39.4 kB]</span><br><span class="line">Get:5 http://deb.debian.org/debian bullseye/main amd64 Packages [8180 kB]</span><br><span class="line">Get:6 http://deb.debian.org/debian bullseye-updates/main amd64 Packages [2592 B]</span><br><span class="line">Fetched 8467 kB <span class="keyword">in</span> 8min 23s (16.8 kB/s)</span><br><span class="line">Reading package lists... Done</span><br><span class="line">root@b8f8e90162f7:/usr/local/tomcat<span class="comment"># apt-get -y  install iproute2 iproute2-doc</span></span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree... Done</span><br><span class="line">Reading state information... Done</span><br><span class="line">The following additional packages will be installed:</span><br><span class="line">  libatm1 libbpf0 libcap2 libcap2-bin libelf1 libmnl0 libpam-cap libxtables12</span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  iproute2 iproute2-doc libatm1 libbpf0 libcap2 libcap2-bin libelf1 libmnl0 libpam-cap libxtables12</span><br><span class="line">0 upgraded, 10 newly installed, 0 to remove and 1 not upgraded.</span><br><span class="line">Need to get 1424 kB of archives.</span><br><span class="line">After this operation, 4734 kB of additional disk space will be used.</span><br><span class="line">Get:1 http://deb.debian.org/debian bullseye/main amd64 libelf1 amd64 0.183-1 [165 kB]</span><br><span class="line">Get:2 http://deb.debian.org/debian bullseye/main amd64 libbpf0 amd64 1:0.3-2 [98.3 kB]</span><br><span class="line">Get:3 http://deb.debian.org/debian bullseye/main amd64 libcap2 amd64 1:2.44-1 [23.6 kB]</span><br><span class="line">Get:4 http://deb.debian.org/debian bullseye/main amd64 libmnl0 amd64 1.0.4-3 [12.5 kB]</span><br><span class="line">Get:5 http://deb.debian.org/debian bullseye/main amd64 libxtables12 amd64 1.8.7-1 [45.1 kB]</span><br><span class="line">Get:6 http://deb.debian.org/debian bullseye/main amd64 libcap2-bin amd64 1:2.44-1 [32.6 kB]</span><br><span class="line">Get:7 http://deb.debian.org/debian bullseye/main amd64 iproute2 amd64 5.10.0-4 [930 kB]</span><br><span class="line">Get:8 http://deb.debian.org/debian bullseye/main amd64 iproute2-doc all 5.10.0-4 [30.1 kB]</span><br><span class="line">Get:9 http://deb.debian.org/debian bullseye/main amd64 libatm1 amd64 1:2.5.1-4 [71.3 kB]</span><br><span class="line">Get:10 http://deb.debian.org/debian bullseye/main amd64 libpam-cap amd64 1:2.44-1 [15.4 kB]</span><br><span class="line">Fetched 1424 kB <span class="keyword">in</span> 17s (83.3 kB/s)</span><br><span class="line">debconf: delaying package configuration, since apt-utils is not installed</span><br><span class="line">Selecting previously unselected package libelf1:amd64.</span><br><span class="line">(Reading database ... 12676 files and directories currently installed.)</span><br><span class="line">Preparing to unpack .../0-libelf1_0.183-1_amd64.deb ...</span><br><span class="line">Unpacking libelf1:amd64 (0.183-1) ...</span><br><span class="line">Selecting previously unselected package libbpf0:amd64.</span><br><span class="line">Preparing to unpack .../1-libbpf0_1%3a0.3-2_amd64.deb ...</span><br><span class="line">Unpacking libbpf0:amd64 (1:0.3-2) ...</span><br><span class="line">Selecting previously unselected package libcap2:amd64.</span><br><span class="line">Preparing to unpack .../2-libcap2_1%3a2.44-1_amd64.deb ...</span><br><span class="line">Unpacking libcap2:amd64 (1:2.44-1) ...</span><br><span class="line">Selecting previously unselected package libmnl0:amd64.</span><br><span class="line">Preparing to unpack .../3-libmnl0_1.0.4-3_amd64.deb ...</span><br><span class="line">Unpacking libmnl0:amd64 (1.0.4-3) ...</span><br><span class="line">Selecting previously unselected package libxtables12:amd64.</span><br><span class="line">Preparing to unpack .../4-libxtables12_1.8.7-1_amd64.deb ...</span><br><span class="line">Unpacking libxtables12:amd64 (1.8.7-1) ...</span><br><span class="line">Selecting previously unselected package libcap2-bin.</span><br><span class="line">Preparing to unpack .../5-libcap2-bin_1%3a2.44-1_amd64.deb ...</span><br><span class="line">Unpacking libcap2-bin (1:2.44-1) ...</span><br><span class="line">Selecting previously unselected package iproute2.</span><br><span class="line">Preparing to unpack .../6-iproute2_5.10.0-4_amd64.deb ...</span><br><span class="line">Unpacking iproute2 (5.10.0-4) ...</span><br><span class="line">Selecting previously unselected package iproute2-doc.</span><br><span class="line">Preparing to unpack .../7-iproute2-doc_5.10.0-4_all.deb ...</span><br><span class="line">Unpacking iproute2-doc (5.10.0-4) ...</span><br><span class="line">Selecting previously unselected package libatm1:amd64.</span><br><span class="line">Preparing to unpack .../8-libatm1_1%3a2.5.1-4_amd64.deb ...</span><br><span class="line">Unpacking libatm1:amd64 (1:2.5.1-4) ...</span><br><span class="line">Selecting previously unselected package libpam-cap:amd64.</span><br><span class="line">Preparing to unpack .../9-libpam-cap_1%3a2.44-1_amd64.deb ...</span><br><span class="line">Unpacking libpam-cap:amd64 (1:2.44-1) ...</span><br><span class="line">Setting up iproute2-doc (5.10.0-4) ...</span><br><span class="line">Setting up libatm1:amd64 (1:2.5.1-4) ...</span><br><span class="line">Setting up libcap2:amd64 (1:2.44-1) ...</span><br><span class="line">Setting up libcap2-bin (1:2.44-1) ...</span><br><span class="line">Setting up libmnl0:amd64 (1.0.4-3) ...</span><br><span class="line">Setting up libxtables12:amd64 (1.8.7-1) ...</span><br><span class="line">Setting up libelf1:amd64 (0.183-1) ...</span><br><span class="line">Setting up libpam-cap:amd64 (1:2.44-1) ...</span><br><span class="line">debconf: unable to initialize frontend: Dialog</span><br><span class="line">debconf: (No usable dialog-like program is installed, so the dialog based frontend cannot be used. at /usr/share/perl5/Debconf/FrontEnd/Dialog.pm line 78.)</span><br><span class="line">debconf: falling back to frontend: Readline</span><br><span class="line">Setting up libbpf0:amd64 (1:0.3-2) ...</span><br><span class="line">Setting up iproute2 (5.10.0-4) ...</span><br><span class="line">debconf: unable to initialize frontend: Dialog</span><br><span class="line">debconf: (No usable dialog-like program is installed, so the dialog based frontend cannot be used. at /usr/share/perl5/Debconf/FrontEnd/Dialog.pm line 78.)</span><br><span class="line">debconf: falling back to frontend: Readline</span><br><span class="line">Processing triggers <span class="keyword">for</span> libc-bin (2.31-13+deb11u2) ...</span><br><span class="line">root@b8f8e90162f7:/usr/local/tomcat<span class="comment"># ip addr</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">6: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 172.17.0.3/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">root@b8f8e90162f7:/usr/local/tomcat<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><p>在主机中再次<code>ip addr</code>，发现多了一个 网卡</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ip addr</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:69:13:06 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.61.131/24 brd 192.168.61.255 scope global dynamic noprefixroute ens160</span><br><span class="line">       valid_lft 1074sec preferred_lft 1074sec</span><br><span class="line">    inet6 fe80::20c:29ff:fe69:1306/64 scope <span class="built_in">link</span> noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:8d:e3:44:c9 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:8dff:fee3:44c9/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">5: vethb7bc992@if4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span><br><span class="line">    <span class="built_in">link</span>/ether 16:80:<span class="built_in">dd</span>:50:8e:<span class="built_in">dd</span> brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::1480:ddff:fe50:8edd/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="comment"># 这是多出来的网卡</span></span><br><span class="line">7: veth3686f69@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span><br><span class="line">    <span class="built_in">link</span>/ether 86:4b:1c:e0:25:97 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class="line">    inet6 fe80::844b:1cff:fee0:2597/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><p>宿主机<code>ping</code>通容器内部<br> <code>linux</code>可以<code>ping</code>通<code>docker</code>容器内部，因为<code>docker0</code>的<code>ip</code>地址为 $172.17.0.1$，容器为 $172.17.0.3$</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ping 172.17.0.3</span></span><br><span class="line">PING 172.17.0.3 (172.17.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.0.3: icmp_seq=1 ttl=64 time=0.051 ms</span><br><span class="line">64 bytes from 172.17.0.3: icmp_seq=2 ttl=64 time=0.035 ms</span><br><span class="line">64 bytes from 172.17.0.3: icmp_seq=3 ttl=64 time=0.035 ms</span><br><span class="line">64 bytes from 172.17.0.3: icmp_seq=4 ttl=64 time=0.033 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.17.0.3 ping statistics ---</span><br><span class="line">4 packets transmitted, 4 received, 0% packet loss, time 3061ms</span><br><span class="line">rtt min/avg/max/mdev = 0.033/0.038/0.051/0.009 ms</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><p>再次启动第二个<code>tomcat</code>容器后，又多了一对网卡</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker run -d -it -P --name tomcat02 tomcat</span></span><br><span class="line">e7a9c8acb5fadde4aa70d8027dcd922e15c42d2c261255ac5bc837a1cdca22db</span><br><span class="line">[root@localhost ~]<span class="comment"># ip addr</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:69:13:06 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.61.131/24 brd 192.168.61.255 scope global dynamic noprefixroute ens160</span><br><span class="line">       valid_lft 1136sec preferred_lft 1136sec</span><br><span class="line">    inet6 fe80::20c:29ff:fe69:1306/64 scope <span class="built_in">link</span> noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:8d:e3:44:c9 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:8dff:fee3:44c9/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">7: veth3686f69@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span><br><span class="line">    <span class="built_in">link</span>/ether 86:4b:1c:e0:25:97 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class="line">    inet6 fe80::844b:1cff:fee0:2597/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">9: veth1399007@if8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span><br><span class="line">    <span class="built_in">link</span>/ether 56:08:3f:19:95:f9 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::5408:3fff:fe19:95f9/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><p>测试两个容器之间的通信</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker exec -it tomcat02 /bin/bash</span></span><br><span class="line">root@e7a9c8acb5fa:/usr/local/tomcat<span class="comment"># apt-get update</span></span><br><span class="line">root@e7a9c8acb5fa:/usr/local/tomcat<span class="comment"># apt-get -y  install iproute2 iproute2-doc</span></span><br><span class="line">root@e7a9c8acb5fa:/usr/local/tomcat<span class="comment"># ip addr</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">8: eth0@if9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">root@e7a9c8acb5fa:/usr/local/tomcat<span class="comment"># apt-get -y install iputils-ping</span></span><br><span class="line">root@e7a9c8acb5fa:/usr/local/tomcat<span class="comment"># ping 172.17.0.2</span></span><br><span class="line">PING 172.17.0.2 (172.17.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=1 ttl=64 time=0.037 ms</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=2 ttl=64 time=0.023 ms</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=3 ttl=64 time=0.023 ms</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=4 ttl=64 time=0.045 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.17.0.2 ping statistics ---</span><br><span class="line">4 packets transmitted, 4 received, 0% packet loss, time 3087ms</span><br><span class="line">rtt min/avg/max/mdev = 0.023/0.032/0.045/0.009 ms</span><br><span class="line">root@e7a9c8acb5fa:/usr/local/tomcat<span class="comment">#</span></span><br></pre></td></tr></table></figure><p> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635729252/1639728436-051bd6c8.png"></p></li><li><p>小结</p><ul><li>原理：每启动一个<code>docker</code>容器，<code>docker</code>就会给容器分配一个默认的可用<code>ip</code>，只要安装了<code>docker</code>，就会有一个网卡<code>docker0(bridge)</code>。网卡采用桥接模式，并使用<code>veth-pair</code>技术<ul><li><code>veth-pair</code>就是一堆虚拟设备接口，成对出现，一段连着协议，一段彼此相连，充当一个桥梁</li></ul></li><li>容器 $1$→<code>Docker0</code>→容器 $2$<br><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635729252/1639728469-ca82b588.png"></li><li><code>tomcat01</code>和<code>tomcat02</code>是公用的一个路由器, <code>docker0</code>所有的容器不指定网络的情况下，都是<code>docker0</code>路由的，<code>docker</code>会给容器分配一个默认的可用</li><li><code>docker</code>中的所有网络接口都是虚拟的 ，转发效率高。删除容器后，对应的网桥也随之删除</li><li>只要容器删除，对应网桥一对就没了</li></ul></li></ol><h2 id="–link"><a href="#–link" class="headerlink" title="–link"></a>–link</h2><h3 id="单向联通"><a href="#单向联通" class="headerlink" title="单向联通"></a>单向联通</h3><p>若编写一个微服务并连接数据库，如果数据库<code>ip</code>改变，如何根据容器名而不是<code>ip</code>访问容器？显然，直接使用容器名是无法<code>ping</code>通容器内部的：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker exec -it tomcat01 ping tomcat02</span></span><br><span class="line">ping: tomcat02: Name or service not known</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>这时可以在容器启动命令中加入一个选项：<code>link</code>，使得可以根据容器名来访问容器：<code>docker run -d -P --link 容器名/id 镜像名/id</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker run -d -it -P --name tomcat03 --link tomcat01 tomcat</span></span><br><span class="line">13e1188a87a82c545770e00eaa7f263d300c8515b3037de51d4d915599ba3d6c</span><br><span class="line">[root@localhost ~]<span class="comment"># docker exec -it tomcat03 /bin/bash</span></span><br><span class="line">root@13e1188a87a8:/usr/local/tomcat<span class="comment"># apt-get update</span></span><br><span class="line">root@13e1188a87a8:/usr/local/tomcat<span class="comment"># apt-get -y  install iproute2 iproute2-doc</span></span><br><span class="line">root@13e1188a87a8:/usr/local/tomcat<span class="comment"># apt-get -y install iputils-ping</span></span><br><span class="line">[root@localhost ~]<span class="comment"># docker exec -it tomcat03 ping tomcat01</span></span><br><span class="line">PING tomcat01 (172.17.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat01 (172.17.0.3): icmp_seq=1 ttl=64 time=0.097 ms</span><br><span class="line">64 bytes from tomcat01 (172.17.0.3): icmp_seq=2 ttl=64 time=0.049 ms</span><br><span class="line">64 bytes from tomcat01 (172.17.0.3): icmp_seq=3 ttl=64 time=0.061 ms</span><br><span class="line">^C</span><br><span class="line">--- tomcat01 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2030ms</span><br><span class="line">rtt min/avg/max/mdev = 0.049/0.069/0.097/0.020 ms</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>然而反向就不可以<code>ping</code>通：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker exec -it tomcat01 ping tomcat03</span></span><br><span class="line">ping: tomcat03: Name or service not known</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p><code>link</code>就是在<code>tomcat03</code>的<code>hosts</code>配置中增加了一个<code>172.17.0.3 tomcat01 b8f8e90162f7</code></p><ul><li><code>tomcat03</code>中直接指明了<code>tomcat01</code>的<code>ip</code></li><li><code>tomcat01</code>中没有<code>tomcat03</code>的地址</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker exec -it tomcat03 cat /etc/hosts</span></span><br><span class="line">127.0.0.1       localhost</span><br><span class="line">::1     localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0 ip6-localnet</span><br><span class="line">ff00::0 ip6-mcastprefix</span><br><span class="line">ff02::1 ip6-allnodes</span><br><span class="line">ff02::2 ip6-allrouters</span><br><span class="line"><span class="comment">#  tomcat03 中直接指明了  tomcat01 的ip</span></span><br><span class="line">172.17.0.3      tomcat01 b8f8e90162f7</span><br><span class="line">172.17.0.4      13e1188a87a8</span><br><span class="line">[root@localhost ~]<span class="comment"># docker exec -it tomcat01 cat /etc/hosts</span></span><br><span class="line">127.0.0.1       localhost</span><br><span class="line">::1     localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0 ip6-localnet</span><br><span class="line">ff00::0 ip6-mcastprefix</span><br><span class="line">ff02::1 ip6-allnodes</span><br><span class="line">ff02::2 ip6-allrouters</span><br><span class="line">172.17.0.3      b8f8e90162f7</span><br><span class="line"><span class="comment">#  tomcat01 中没有 tomcat03的地址</span></span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h2 id="自定义网络"><a href="#自定义网络" class="headerlink" title="自定义网络"></a>自定义网络</h2><h3 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h3><p>查看所有的<code>docker</code>网络：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker network ls</span></span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">4086aaa171e8   bridge    bridge    <span class="built_in">local</span></span><br><span class="line">092a8a93c45e   host      host      <span class="built_in">local</span></span><br><span class="line">176ae67894b3   none      null      <span class="built_in">local</span></span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p><code>docker</code>中的网络模式有：</p><ul><li><code>bridge</code>：桥接<code>docker</code>（默认，自己创建也使用<code>bridge</code>模式）</li><li><code>none</code>：不配置网络</li><li><code>host</code>：和宿主机共享网络</li><li><code>container</code>：容器网络连通（用的少，局限很大）</li></ul><p><code>docker run</code>命令默认带有一个参数<code>–net bridge</code>，此处的<code>bridge</code>指的就是<code>docker0</code>。</p><p><code>docker0</code>特点：默认，域名不能访问，<code>--link</code>可以打通连接</p><p>如果不想使用<code>docker0</code>，可以创建一个新的网络：<code>docker  network create --driver 网络模式 --subnet 子网ip --gateway 网关 网络名</code></p><ul><li>桥接：<code>--driver bridge</code></li><li>子网的地址：<code>--subnet 192.168.0.0/16</code></li><li>范围：<code>192.168.0.2  -- 192.168.255.255</code></li><li>网关地址（路由器）：<code>--gateway 192.168.0.1 mynet</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker network create --driver bridge --subnet 192.168.0.0/16 --gateway 192.168.0.1 mynet</span></span><br><span class="line">f21a60d02f90fd464ce95db06c8a7ea4c7895a17c9d282208a6f773d52d0f2dc</span><br><span class="line">[root@localhost ~]<span class="comment"># docker network ls</span></span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">4086aaa171e8   bridge    bridge    <span class="built_in">local</span></span><br><span class="line">092a8a93c45e   host      host      <span class="built_in">local</span></span><br><span class="line">f21a60d02f90   mynet     bridge    <span class="built_in">local</span></span><br><span class="line">176ae67894b3   none      null      <span class="built_in">local</span></span><br><span class="line">[root@localhost ~]<span class="comment"># docker network inspect mynet</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;mynet&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;f21a60d02f90fd464ce95db06c8a7ea4c7895a17c9d282208a6f773d52d0f2dc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2021-11-02T11:29:54.296389266+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EnableIPv6&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;IPAM&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;Config&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;192.168.0.0/16&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;192.168.0.1&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Internal&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Attachable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Ingress&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ConfigOnly&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Containers&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h3><p>只要两个容器启动时都通过<code>–net</code>选用同一个已创建的网络，不同容器间即可通过<code>ip</code>地址或<code>容器名/id</code>连通。</p><ol><li>在自定义的网络里启动两个<code>tomcat</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker run -d -P --name tomcat-net-01 --net mynet tomcat</span></span><br><span class="line">3246acdb17e3363a725c8a930c83ffdd634e086846a8445a88b04765f12c2cac</span><br><span class="line">[root@localhost ~]<span class="comment"># docker run -d -P --name tomcat-net-02 --net mynet tomcat</span></span><br><span class="line">8f3db1f3d2132c98d960da9dba551a309d6e0c26e5b87a1cfd48a29a5c65612a</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>查看自定义的网络，发现里面多了两个容器的信息 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker network inspect mynet</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;mynet&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;f21a60d02f90fd464ce95db06c8a7ea4c7895a17c9d282208a6f773d52d0f2dc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2021-11-02T11:29:54.296389266+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EnableIPv6&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;IPAM&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;Config&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;192.168.0.0/16&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;192.168.0.1&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Internal&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Attachable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Ingress&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ConfigOnly&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Containers&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;3246acdb17e3363a725c8a930c83ffdd634e086846a8445a88b04765f12c2cac&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;tomcat-net-01&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;4d6c7d3af887105c3211c911b05d34eecebb9774ec01053d7eba93f28e171fac&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:c0:a8:00:02&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;192.168.0.2/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;8f3db1f3d2132c98d960da9dba551a309d6e0c26e5b87a1cfd48a29a5c65612a&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;tomcat-net-02&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;d0391a5a208420f2ce935a78f7031b612085519bb94eb8cb7b7af8de8bddd7c1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:c0:a8:00:03&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;192.168.0.3/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>两个容器之间相互用名称<code>ping</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker exec -it tomcat-net-01 /bin/bash</span></span><br><span class="line">root@3246acdb17e3:/usr/local/tomcat<span class="comment"># apt-get update</span></span><br><span class="line">root@3246acdb17e3:/usr/local/tomcat<span class="comment"># apt-get -y install iproute2 iproute2-doc</span></span><br><span class="line">root@3246acdb17e3:/usr/local/tomcat<span class="comment"># apt-get -y install iputils-ping</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># docker exec -it tomcat-net-02 /bin/bash</span></span><br><span class="line">root@8f3db1f3d213:/usr/local/tomcat<span class="comment"># apt update</span></span><br><span class="line">root@8f3db1f3d213:/usr/local/tomcat<span class="comment"># apt-get -y install iproute2 iproute2-doc</span></span><br><span class="line">root@8f3db1f3d213:/usr/local/tomcat<span class="comment"># apt-get -y install iputils-ping</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># docker exec tomcat-net-01 ping tomcat-net-02</span></span><br><span class="line">PING tomcat-net-02 (192.168.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat-net-02.mynet (192.168.0.3): icmp_seq=1 ttl=64 time=0.073 ms</span><br><span class="line">64 bytes from tomcat-net-02.mynet (192.168.0.3): icmp_seq=2 ttl=64 time=0.066 ms</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># docker exec tomcat-net-02 ping tomcat-net-01</span></span><br><span class="line">PING tomcat-net-01 (192.168.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat-net-01.mynet (192.168.0.2): icmp_seq=1 ttl=64 time=0.055 ms</span><br><span class="line">64 bytes from tomcat-net-01.mynet (192.168.0.2): icmp_seq=2 ttl=64 time=0.078 ms</span><br></pre></td></tr></table></figure></li></ol><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p><code>docker</code>已经帮自定义网络维护好了对应的关系，推荐平时这样使用网络!</p><p>好处：</p><ul><li><code>redis</code>不同的集群使用不同的网络，保证<strong>集群是安全和健康的</strong></li><li><code>mysql</code>不同的集群使用不同的网络，保证<strong>集群是安全和健康的</strong></li></ul><h2 id="网络连通"><a href="#网络连通" class="headerlink" title="网络连通"></a>网络连通</h2><h3 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h3><p>对于建立在不同网络下（<code>docker0</code>，<code>mynet</code>）的两个容器<code>tomcat01</code>和<code>tomcat-net-02</code>，他们的网段不同，因此是无法彼此<code>ping</code>通容器内部的：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker exec -it tomcat01 ping tomcat-net-02</span></span><br><span class="line">ping: tomcat-net-02: Name or service not known</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>这时需要通过<code>docker network connect</code>命令打通容器与网络之间的连接：<code>docker network connect 网络名 容器名/id</code>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker network connect --help</span></span><br><span class="line"></span><br><span class="line">Usage:  docker network connect [OPTIONS] NETWORK CONTAINER</span><br><span class="line"></span><br><span class="line">Connect a container to a network</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">      --<span class="built_in">alias</span> strings           Add network-scoped <span class="built_in">alias</span> <span class="keyword">for</span> the container</span><br><span class="line">      --driver-opt strings      driver options <span class="keyword">for</span> the network</span><br><span class="line">      --ip string               IPv4 address (e.g., 172.30.100.104)</span><br><span class="line">      --ip6 string              IPv6 address (e.g., 2001:db8::33)</span><br><span class="line">      --<span class="built_in">link</span> list               Add <span class="built_in">link</span> to another container</span><br><span class="line">      --link-local-ip strings   Add a link-local address <span class="keyword">for</span> the container</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="连接-1"><a href="#连接-1" class="headerlink" title="连接"></a>连接</h3><ol><li>使用<code>docker network connect</code>将容器和网络联通<br> 可以发现容器<code>tomcat01</code>有两个<code>ip</code>地址，就好比阿里云服务器：公网<code>ip</code>和私网<code>ip</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker network connect mynet tomcat01</span></span><br><span class="line">[root@localhost ~]<span class="comment"># docker network inspect mynet</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;mynet&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;f21a60d02f90fd464ce95db06c8a7ea4c7895a17c9d282208a6f773d52d0f2dc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2021-11-02T11:29:54.296389266+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EnableIPv6&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;IPAM&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;Config&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;192.168.0.0/16&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;192.168.0.1&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Internal&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Attachable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Ingress&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ConfigOnly&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Containers&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;3246acdb17e3363a725c8a930c83ffdd634e086846a8445a88b04765f12c2cac&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;tomcat-net-01&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;4d6c7d3af887105c3211c911b05d34eecebb9774ec01053d7eba93f28e171fac&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:c0:a8:00:02&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;192.168.0.2/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;8f3db1f3d2132c98d960da9dba551a309d6e0c26e5b87a1cfd48a29a5c65612a&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;tomcat-net-02&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;d0391a5a208420f2ce935a78f7031b612085519bb94eb8cb7b7af8de8bddd7c1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:c0:a8:00:03&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;192.168.0.3/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">             <span class="comment"># 发现此处多了一个容器，即 tomcat01，它有两个地址，一个在网络 docker0，一个在是 mynet</span></span><br><span class="line">            <span class="string">&quot;b8f8e90162f789577b678ea020e54e5e091b62081b2ed34580288761b1c6c55a&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;tomcat01&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;32d7e1c2fc6773e2704262ab2926047008b8f09fe8a426419e870e26063685be&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:c0:a8:00:04&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;192.168.0.4/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>再次测试两者之间的联通情况：成功<code>ping</code>通，相互均可访问 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker exec tomcat01 ping tomcat-net-02</span></span><br><span class="line">PING tomcat-net-02 (192.168.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat-net-02.mynet (192.168.0.3): icmp_seq=1 ttl=64 time=0.107 ms</span><br><span class="line">64 bytes from tomcat-net-02.mynet (192.168.0.3): icmp_seq=2 ttl=64 time=0.050 ms</span><br><span class="line">64 bytes from tomcat-net-02.mynet (192.168.0.3): icmp_seq=3 ttl=64 time=0.050 ms</span><br><span class="line">64 bytes from tomcat-net-02.mynet (192.168.0.3): icmp_seq=4 ttl=64 time=0.048 ms</span><br><span class="line">^C</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br><span class="line">[root@localhost ~]<span class="comment"># docker exec tomcat-net-01 ping tomcat01</span></span><br><span class="line">PING tomcat01 (192.168.0.4) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat01.mynet (192.168.0.4): icmp_seq=1 ttl=64 time=0.076 ms</span><br><span class="line">64 bytes from tomcat01.mynet (192.168.0.4): icmp_seq=2 ttl=64 time=0.080 ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># tomcat02 依旧打不通</span></span><br><span class="line">[root@localhost /]<span class="comment"># docker exec -it tomcat-net-01 ping tomcat02</span></span><br><span class="line">ping: tomcat02: Temporary failure <span class="keyword">in</span> name resolution</span><br></pre></td></tr></table></figure></li></ol><h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><p>假设要跨网操作，就需要使用<code>docker network connect</code>连通。</p><h2 id="部署-Redis-集群"><a href="#部署-Redis-集群" class="headerlink" title="部署 Redis 集群"></a>部署 Redis 集群</h2><p>优点：快速部署，高可用，主机故障后从机可以使用。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635729252/1639728604-8d2decfa.png"></p></div><ol><li>创建网卡   <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis]<span class="comment"># docker network create redis --subnet 172.38.0.0/16</span></span><br><span class="line">74feee91cddf96bc654464db39700a317f5265c18c0a5d30d5147ec06f6e6dd9</span><br><span class="line">[root@localhost redis]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>准备<code>shell</code>脚本，通过脚本创建六个<code>redis</code>配置<ul><li>准备<code>shell</code>脚本<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">for port in $(seq 1 6);\</span><br><span class="line">do \</span><br><span class="line">mkdir -p /mydata/redis/node-$&#123;port&#125;/conf</span><br><span class="line">touch /mydata/redis/node-$&#123;port&#125;/conf/redis.conf</span><br><span class="line">cat &lt;&lt; EOF &gt;&gt; /mydata/redis/node-$&#123;port&#125;/conf/redis.conf</span><br><span class="line">port 6379</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">cluster-announce-ip 172.38.0.1$&#123;port&#125;</span><br><span class="line">cluster-announce-port 6379</span><br><span class="line">cluster-announce-bus-port 16379</span><br><span class="line">appendonly ye</span><br><span class="line">EOF</span><br><span class="line">done</span><br></pre></td></tr></table></figure></li><li>通过脚本创建六个<code>redis</code>配置<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># for port in $(seq 1 6);\</span></span><br><span class="line"><span class="keyword">do</span> \</span><br><span class="line"><span class="built_in">mkdir</span> -p /mydata/redis/node-<span class="variable">$&#123;port&#125;</span>/conf</span><br><span class="line"><span class="built_in">touch</span> /mydata/redis/node-<span class="variable">$&#123;port&#125;</span>/conf/redis.conf</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt;&gt; /mydata/redis/node-$&#123;port&#125;/conf/redis.conf</span></span><br><span class="line"><span class="string">port 6379</span></span><br><span class="line"><span class="string">bind 0.0.0.0</span></span><br><span class="line"><span class="string">cluster-enabled yes</span></span><br><span class="line"><span class="string">cluster-config-file nodes.conf</span></span><br><span class="line"><span class="string">cluster-node-timeout 5000</span></span><br><span class="line"><span class="string">cluster-announce-ip 172.38.0.1$&#123;port&#125;</span></span><br><span class="line"><span class="string">cluster-announce-port 6379</span></span><br><span class="line"><span class="string">cluster-announce-bus-port 16379</span></span><br><span class="line"><span class="string">appendonly ye</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cd /mydata/redis/</span></span><br><span class="line">[root@localhost redis]<span class="comment"># ls</span></span><br><span class="line">node-1  node-2  node-3  node-4  node-5  node-6</span><br><span class="line">[root@localhost redis]<span class="comment"># cat node-1/conf/redis.conf</span></span><br><span class="line">port 6379</span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">cluster-enabled <span class="built_in">yes</span></span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">cluster-announce-ip 172.38.0.11</span><br><span class="line">cluster-announce-port 6379</span><br><span class="line">cluster-announce-bus-port 16379</span><br><span class="line">appendonly ye</span><br><span class="line">[root@localhost redis]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li></ul></li><li>准备<code>shell</code>脚本，通过脚本创建六个<code>redis</code>容器<ul><li>准备<code>shell</code>脚本<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">for port in $(seq 1 6);\</span><br><span class="line">do \</span><br><span class="line">docker run -d -p 637$&#123;port&#125;:6379 -p 1637$&#123;port&#125;:16379 --name redis-$&#123;port&#125; \</span><br><span class="line">-v /mydata/redis/node-$&#123;port&#125;/data:/data \</span><br><span class="line">-v /mydata/redis/node-$&#123;port&#125;/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">-d --net redis --ip 172.38.0.1$&#123;port&#125; redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf;  </span><br><span class="line">done</span><br></pre></td></tr></table></figure></li><li>通过脚本创建六个<code>redis</code>容器<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost home]<span class="comment"># for port in $(seq 1 6);\</span></span><br><span class="line"><span class="keyword">do</span> \</span><br><span class="line">docker run -p 637<span class="variable">$&#123;port&#125;</span>:6379 -p 1637<span class="variable">$&#123;port&#125;</span>:16379 --name redis-<span class="variable">$&#123;port&#125;</span> \</span><br><span class="line">-v /mydata/redis/node-<span class="variable">$&#123;port&#125;</span>/data:/data \</span><br><span class="line">-v /mydata/redis/node-<span class="variable">$&#123;port&#125;</span>/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">-d --net redis --ip 172.38.0.1<span class="variable">$&#123;port&#125;</span> redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">Unable to find image <span class="string">&#x27;redis:5.0.9-alpine3.11&#x27;</span> locally</span><br><span class="line">5.0.9-alpine3.11: Pulling from library/redis</span><br><span class="line">cbdbe7a5bc2a: Already exists</span><br><span class="line">dc0373118a0d: Already exists</span><br><span class="line">cfd369fe6256: Already exists</span><br><span class="line">3e45770272d9: Already exists</span><br><span class="line">558de8ea3153: Already exists</span><br><span class="line">a2c652551612: Already exists</span><br><span class="line">Digest: sha256:83a3af36d5e57f2901b4783c313720e5fa3ecf0424ba86ad9775e06a9a5e35d0</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> redis:5.0.9-alpine3.11</span><br><span class="line">b6cc24c4e437bb76adb626d410f3e0a28e0e4b7b664aee512846413c9e57a7b8</span><br><span class="line">c0dc8e64df033dd763bfe840fe5421e4e181960ef66e0d41088529a3a363b7ab</span><br><span class="line">3889a96d8939cfbcd90b02588a8ebe22a06f9ed1954d61b47768d46723bbd477</span><br><span class="line">b6e5081783943a7c3e29770903a37d637b612b5c59a7161af3cedcd883f1f490</span><br><span class="line">8c0727fad4a4cb44387f88f9067029a248645f7df757867502e1d771c098ced4</span><br><span class="line">e74d9e9633bd4e9546c2201af3d68cdc33888317142cad911267f44bc933161a</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li></ul></li><li>创建集群 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker exec -it redis-1 /bin/sh</span></span><br><span class="line">[root@b6cc24c4e data]<span class="comment"># redis-cli --cluster create 172.38.0.11:6379 172.38.0.12:6379 172.38.0.13:6379 172.38.0.14:6379 172.38.0.15:6379 172.38.0.16:6379 --cluster-replicas 1</span></span><br></pre></td></tr></table></figure></li><li>连接集群 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@b6cc24c4e data]<span class="comment"># redis-cli -c</span></span><br><span class="line">127.0.0.1:6379&gt; cluster info</span><br></pre></td></tr></table></figure></li><li>测试 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> a b</span><br></pre></td></tr></table></figure></li><li>主服务器宕机测试 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    ```</span><br><span class="line"></span><br><span class="line"><span class="comment"># Springboot 微服务打包镜像</span></span><br><span class="line"></span><br><span class="line">1. 构建`Springboot`项目并打包为`jar`包：`demo-0.0.1-SNAPSHOT.jar`</span><br><span class="line">2. 创建`Dockerfile`</span><br><span class="line">    ```bash</span><br><span class="line">    FROM java:8</span><br><span class="line"></span><br><span class="line">    COPY *.jar /app.jar</span><br><span class="line"></span><br><span class="line">    CMD [<span class="string">&quot;server.port=8080&quot;</span>]</span><br><span class="line"></span><br><span class="line">    EXPOSE 8080</span><br><span class="line"></span><br><span class="line">    ENTRYPOINT [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/app.jar&quot;</span>]</span><br></pre></td></tr></table></figure></li><li>生成镜像 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost idea]<span class="comment"># ls</span></span><br><span class="line">demo-0.0.1-SNAPSHOT.jar  Dockerfile</span><br><span class="line">[root@localhost idea]<span class="comment"># docker build -t demo.</span></span><br><span class="line">Sending build context to Docker daemon  17.64MB</span><br><span class="line">Step 1/5 : FROM java:8</span><br><span class="line">8: Pulling from library/java</span><br><span class="line">5040bd298390: Pull complete </span><br><span class="line">fce5728aad85: Pull complete </span><br><span class="line">76610ec20bf5: Pull complete </span><br><span class="line">60170fec2151: Pull complete </span><br><span class="line">e98f73de8f0d: Pull complete </span><br><span class="line">11f7af24ed9c: Pull complete </span><br><span class="line">49e2d6393f32: Pull complete </span><br><span class="line">bb9cdec9c7f3: Pull complete </span><br><span class="line">Digest: sha256:c1ff613e8ba25833d2e1940da0940c3824f03f802c449f3d1815a66b7f8c0e9d</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> java:8</span><br><span class="line"> ---&gt; d23bdf5b1b1b</span><br><span class="line">Step 2/5 : COPY *.jar /app.jar</span><br><span class="line"> ---&gt; e42a797c0b05</span><br><span class="line">Step 3/5 : CMD [<span class="string">&quot;--server.port=8080&quot;</span>]</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 03599b100a83</span><br><span class="line">Removing intermediate container 03599b100a83</span><br><span class="line"> ---&gt; 13ec0d67a13b</span><br><span class="line">Step 4/5 : EXPOSE 8080</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> b3ba4dbc3fef</span><br><span class="line">Removing intermediate container b3ba4dbc3fef</span><br><span class="line"> ---&gt; 00af26b78234</span><br><span class="line">Step 5/5 : ENTRYPOINT [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/app.jar&quot;</span>]</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> b6e654da4ebe</span><br><span class="line">Removing intermediate container b6e654da4ebe</span><br><span class="line"> ---&gt; c8a4d6157a3c</span><br><span class="line">Successfully built c8a4d6157a3c</span><br><span class="line">Successfully tagged demo:latest</span><br><span class="line">[root@localhost idea]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">demo          latest    c8a4d6157a3c   56 seconds ago   661MB</span><br><span class="line">tomcat        latest    bd431ca8553c   7 days ago       667MB</span><br><span class="line">hello-world   latest    d1165f221234   6 weeks ago      13.3kB</span><br><span class="line">java          8         d23bdf5b1b1b   4 years ago      643MB</span><br></pre></td></tr></table></figure></li><li>发布运行 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost idea]<span class="comment"># docker run -d -P --name idea-hello demo</span></span><br><span class="line">4121f0b3b285bf7035302a6c54386423fc8c59179abde75038c4c7b51a8e23fd</span><br><span class="line">[root@kk idea]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED             STATUS             PORTS                                         NAMES</span><br><span class="line">4121f0b3b285   my-idea-demo   <span class="string">&quot;java -jar /app.jar …&quot;</span>   17 seconds ago      Up 12 seconds      0.0.0.0:49160-&gt;8080/tcp, :::49160-&gt;8080/tcp   idea-hello</span><br></pre></td></tr></table></figure></li><li>访问 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost idea]<span class="comment"># curl localhost:49160</span></span><br><span class="line">hello,docker...</span><br><span class="line">[root@localhost idea]<span class="comment"># curl localhost:49160/hello</span></span><br><span class="line">&#123;<span class="string">&quot;timestamp&quot;</span>:<span class="string">&quot;2021-04-16T14:28:24.866+00:00&quot;</span>,<span class="string">&quot;status&quot;</span>:404,<span class="string">&quot;error&quot;</span>:<span class="string">&quot;Not Found&quot;</span>,<span class="string">&quot;message&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;path&quot;</span>:<span class="string">&quot;/hello&quot;</span>&#125;</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Dockcer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>镜像与容器</title>
      <link href="/2021/10/26/Docker/01.%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8/"/>
      <url>/2021/10/26/Docker/01.%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="Docker概述"><a href="#Docker概述" class="headerlink" title="Docker概述"></a>Docker概述</h1><h2 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h2><p><code>Docker</code>是一个开源的应用容器引擎，基于<code>Go</code>语言并遵从<code>Apache2.0</code>协议开源。</p><p><code>Docker</code>可以让开发者打包他们的应用以及依赖包到一个轻量级、可移植的容器中，然后发布到任何流行的<code>Linux</code>机器上，也可以实现虚拟化。</p><p>容器是完全使用沙箱机制，相互之间不会有任何接口（类似<code>iPhone</code>的<code>app</code>）,更重要的是容器性能开销极低。</p><p><code>Docker</code>从 $17.03$ 版本之后分为<code>CE</code>（<code>Community Edition</code>：社区版） 和<code>EE</code>（<code>Enterprise Edition</code>：企业版），一般用社区版就可以了。</p><p><a href="https://docs.docker.com/">官网</a>：<code>https://docs.docker.com/</code>。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ul><li><code>Web</code>应用的自动化打包和发布</li><li>自动化测试和持续集成、发布</li><li>在服务型环境中部署和调整数据库或其他的后台应用</li><li>从头编译或者扩展现有的<code>OpenShift</code>或<code>Cloud Foundry</code>平台来搭建自己的<code>PaaS</code>环境</li></ul><h2 id="Docker-的优势"><a href="#Docker-的优势" class="headerlink" title="Docker 的优势"></a>Docker 的优势</h2><p><code>Docker</code>是一个用于开发，交付和运行应用程序的开放平台。<code>Docker</code>能够将应用程序与基础架构分开，从而可以快速交付软件。借助<code>Docker</code>，可以与管理应用程序相同的方式来管理基础架构。通过利用<code>Docker</code>的方法来快速交付，测试和部署代码，可以大大减少编写代码和在生产环境中运行代码之间的延迟。</p><ol><li>快速，一致地交付您的应用程序。<br> <code>Docker</code>允许开发人员使用提供的应用程序或服务的本地容器在标准化环境中工作，从而简化了开发的生命周期。<br> 容器非常适合持续集成和持续交付（<code>CI / CD</code>）工作流程，考虑以下示例方案：<br> 开发人员在本地编写代码，并使用 Docker 容器与同事共享他们的工作。他们使用<code>Docker</code>将其应用程序推送到测试环境中，并执行自动或手动测试。<br> 当开发人员发现错误时，他们可以在开发环境中对其进行修复，然后将其重新部署到测试环境中，以进行测试和验证。<br> 测试完成后，将修补程序推送给生产环境，就像将更新的镜像推送到生产环境一样简单。</li><li>响应式部署和扩展<br> <code>Docker</code>是基于容器的平台，允许高度可移植的工作负载。<code>Docker</code>容器可以在开发人员的本机上，数据中心的物理或虚拟机上，云服务上或混合环境中运行。<br> <code>Docker</code>的可移植性和轻量级的特性，还可以轻松地完成动态管理的工作负担，并根据业务需求指示，实时扩展或拆除应用程序和服务。</li><li>在同一硬件上运行更多工作负载<br> <code>Docker</code>轻巧快速。它为基于虚拟机管理程序的虚拟机提供了可行、经济、高效的替代方案，因此您可以利用更多的计算能力来实现业务目标。<br> <code>Docker</code>非常适合于高密度环境以及中小型部署，可以用更少的资源做更多的事情。</li></ol><h1 id="虚拟化技术和容器化技术"><a href="#虚拟化技术和容器化技术" class="headerlink" title="虚拟化技术和容器化技术"></a>虚拟化技术和容器化技术</h1><h2 id="容器化技术"><a href="#容器化技术" class="headerlink" title="容器化技术"></a>容器化技术</h2><h3 id="容器官方解释"><a href="#容器官方解释" class="headerlink" title="容器官方解释"></a>容器官方解释</h3><p>一句话概括容器：容器就是将软件打包成标准化单元，以用于开发、交付和部署。</p><ul><li>容器镜像是轻量的、可执行的独立软件包，包含软件运行所需的所有内容：代码、运行时环境、系统工具、系统库和设置。</li><li>容器化软件适用于基于<code>Linux</code>和<code>Windows</code>的应用，在任何环境中都能够始终如一地运行。</li><li>容器赋予了软件独立性，使其免受外在环境差异（例如，开发和预演环境的差异）的影响，从而有助于减少团队间在相同基础设施上运行不同软件时的冲突。</li></ul><h3 id="容器通俗解释"><a href="#容器通俗解释" class="headerlink" title="容器通俗解释"></a>容器通俗解释</h3><p>容器化技术不是模拟的一个完整的操作系统。</p><p>通俗地描述容器，容器就是一个存放东西的地方，就像书包可以装各种文具、衣柜可以放各种衣服、鞋架可以放各种鞋子一样。现在所说的容器存放的东西可能更偏向于应用比如网站、程序甚至是系统环境。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639726617-7503696c.png"></p></div><h2 id="虚拟化技术"><a href="#虚拟化技术" class="headerlink" title="虚拟化技术"></a>虚拟化技术</h2><p><code>Docker</code>容器虚拟化技术为基础的软件，什么是虚拟化技术呢？</p><p>简单的说，虚拟化技术可以这样定义：</p><blockquote><p>虚拟化技术是一种资源管理技术，是将计算机的各种实体资源（<code>CPU</code>、内存、磁盘空间、网络适配器等），予以抽象、转换后呈现出来并可供分割、组合为一个或多个电脑配置环境。由此，打破实体结构间的不可切割的障碍，使用户可以比原本的配置更好的方式来应用这些电脑硬件资源。这些资源的新虚拟部分是不受现有资源的架设方式，地域或物理配置所限制。一般所指的虚拟化资源包括计算能力和数据存储。</p></blockquote><p>虚拟化技术特点：</p><ol><li>资源占用多</li><li>冗余步骤多</li><li>启动很慢</li></ol><h2 id="Docker-基于-LXC-虚拟容器技术"><a href="#Docker-基于-LXC-虚拟容器技术" class="headerlink" title="Docker 基于 LXC 虚拟容器技术"></a>Docker 基于 LXC 虚拟容器技术</h2><p><code>Docker</code>技术是基于<code>LXC</code>（<code>Linux container</code>：<code>Linux</code>容器）虚拟容器技术的。</p><blockquote><p><code>LXC</code>，其名称来自<code>Linux</code>软件容器（<code>Linux Containers</code>）的缩写，一种操作系统层虚拟化（<code>Operating system–level virtualization</code>）技术，为<code>Linux</code>内核容器功能的一个用户空间接口。它将应用软件系统打包成一个软件容器（<code>Container</code>），内含应用软件本身的代码，以及所需要的操作系统核心和库。通过统一的名字空间和共用<code>API</code>来分配不同软件容器的可用硬件资源，创造出应用程序的独立沙箱运行环境，使得<code>Linux</code>用户可以容易的创建和管理系统或应用容器。</p></blockquote><p><code>LXC</code>技术主要是借助<code>Linux</code>内核中提供的<code>CGroup</code>功能和<code>namespace</code>来实现的，通过<code>LXC</code>可以为软件提供一个独立的操作系统运行环境。</p><p><code>Docker</code>和虚拟机的不同：</p><ol><li>传统虚拟机，虚拟出硬件，运行一个完整的操作系统，然后在这个系统上安装和运行软件。</li><li><code>Docker</code>容器内的应用直接运行在宿主机的内容，容器是没有自己的内核的，也没有虚拟硬件。</li><li>每个容器都是相互隔离的，每个容器都有属于自己的文件系统，互不影响。</li></ol><h3 id="cgroup-和-namespace"><a href="#cgroup-和-namespace" class="headerlink" title="cgroup 和 namespace"></a>cgroup 和 namespace</h3><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><ul><li><code>namespace</code>是<code>Linux</code>内核用来隔离内核资源的方式。 通过<code>namespace</code>可以让一些进程只能看到与自己相关的一部分资源，而另外一些进程也只能看到与它们自己相关的资源，这两拨进程根本就感觉不到对方的存在。具体的实现方式是把一个或多个进程的相关资源指定在同一个<code>namespace</code>中。<code>Linux namespaces</code>是对全局系统资源的一种封装隔离，使得处于不同<code>namespace</code>的进程拥有独立的全局系统资源，改变一个<code>namespace</code>中的系统资源只会影响当前 <code>namespace</code>里的进程，对其他<code>namespace</code>中的进程没有影响。<br>（更多关于<code>namespace</code>的呢内容可以查看”Namespace 简介”[^1]）</li><li><code>CGroup</code>是<code>Control Groups</code>的缩写，是<code>Linux</code>内核提供的一种可以限制、记录、隔离进程组 （<code>process groups</code>）所使用的物力资源（如<code>cpu</code>、<code>memory</code>、<code>i/o</code>等）的机制。</li></ul><h4 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h4><p>两者都是将进程进行分组，但是两者的作用还是有本质区别。<code>namespace</code>是为了隔离进程组之间的资源，而<code>cgroup</code>是为了对一组进程进行统一的资源监控和限制。</p><h3 id="容器化的好处"><a href="#容器化的好处" class="headerlink" title="容器化的好处"></a>容器化的好处</h3><ol><li>应用更快速的交互和部署<ul><li>传统：一堆帮助文档，安装程序</li><li><code>Docker</code>：打包镜像发布测试，一键运行</li></ul></li><li>更便捷的升级和扩容<br> 使用<code>Docker</code>之后，项目打包为一个镜像，部署应用就像搭积木一样</li><li>更简单的系统运维<br> 在容器化之后，开发、测试环境都是高度统一的</li><li>更高效的计算资源利用<br> <code>Docker</code>是内核级别的虚拟化，可以在一个物理机上运行很多的容器实例，服务器的性能可以被压榨到极致</li></ol><h1 id="Docker-基本组成"><a href="#Docker-基本组成" class="headerlink" title="Docker 基本组成"></a>Docker 基本组成</h1><p><code>Docker</code>中有非常重要的三个基本概念，理解了这三个概念，就理解了<code>Docker</code>的整个生命周期。</p><ul><li>镜像（<code>Image</code>）<br><code>Docker</code>镜像就好比是一个模板，可以通过这个模板来创建容器服务，运行<code>tomcat</code>镜像 ===&gt; <code>tomcat01</code>容器提供<code>web</code>服务器服务</li><li>容器（<code>Container</code>）<br><code>Docker</code>利用容器技术，独立运行一个或者一组通过镜像创建的应用</li><li>仓库（<code>Repository</code>）<ul><li>仓库就是存放镜像的地方</li><li>仓库分为公有仓库（<code>Docker Hub</code>）和私有仓库</li></ul></li></ul><h1 id="Docker-的安装与卸载"><a href="#Docker-的安装与卸载" class="headerlink" title="Docker 的安装与卸载"></a>Docker 的安装与卸载</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ol><li><p>查看系统内核和系统信息</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看系统内核版本</span></span><br><span class="line"><span class="built_in">uname</span> -r   </span><br><span class="line"><span class="comment"># 查看系统版本</span></span><br><span class="line"><span class="built_in">cat</span> /etc/os-release</span><br></pre></td></tr></table></figure></li><li><p>卸载旧版本</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum remove docker \</span><br><span class="line">           docker-client \</span><br><span class="line">           docker-client-latest \</span><br><span class="line">           docker-common \</span><br><span class="line">           docker-latest \</span><br><span class="line">           docker-latest-logrotate \</span><br><span class="line">           docker-logrotate \</span><br><span class="line">           docker-engine</span><br></pre></td></tr></table></figure></li><li><p>下载依赖安装包</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils</span><br></pre></td></tr></table></figure></li><li><p>配置镜像仓库</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 国外的地址</span></span><br><span class="line">yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置阿里云的Docker镜像仓库</span></span><br><span class="line">yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure></li><li><p>更新<code>yum</code>软件包</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache</span><br></pre></td></tr></table></figure></li><li><p>下载<code>Docker</code></p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装社区版</span></span><br><span class="line">yum install docker-ce docker-ce-cli containerd.io   </span><br><span class="line"><span class="comment"># 安装企业版</span></span><br><span class="line">yum install docker-ee docker-ee-cli containerd.io </span><br></pre></td></tr></table></figure><p> 一般情况下安装社区版</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CentOS 8 安装 Docker 会和 podman 冲突</span></span><br><span class="line">yum erase podman buildah</span><br></pre></td></tr></table></figure></li><li><p>启动<code>Docker</code></p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动 Docker</span></span><br><span class="line">systemctl start docker   </span><br><span class="line"><span class="comment"># 查看当前版本号，是否启动成功</span></span><br><span class="line">docker version   </span><br><span class="line"><span class="comment"># 设置开机自启动</span></span><br><span class="line">systemctl <span class="built_in">enable</span> docker  </span><br></pre></td></tr></table></figure></li><li><p><code>Docker</code>的<code>HelloWorld</code></p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run hello-world</span><br><span class="line"><span class="comment"># 查看下载的hello world镜像</span></span><br><span class="line">docker images</span><br></pre></td></tr></table></figure></li></ol><h2 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 卸载依赖</span></span><br><span class="line">yum remove docker-ce docker-ce-cli containerd.io  </span><br><span class="line"><span class="comment"># 删除资源  . /var/lib/docker 是 docker 的默认工作路径</span></span><br><span class="line"><span class="built_in">rm</span> -rf /var/lib/docker   </span><br></pre></td></tr></table></figure><h2 id="Docker-容器运行流程和原理"><a href="#Docker-容器运行流程和原理" class="headerlink" title="Docker 容器运行流程和原理"></a>Docker 容器运行流程和原理</h2><h3 id="运行流程"><a href="#运行流程" class="headerlink" title="运行流程"></a>运行流程</h3><p>启动一个容器，<code>Docker</code>的运行流程如下图：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639726767-6adcda81.png"></p></div><h2 id="底层原理"><a href="#底层原理" class="headerlink" title="底层原理"></a>底层原理</h2><p><code>Docker</code>是一个<code>Client-Server</code>结构的系统，<code>Docker</code>的守护进程运行在主机上，通过<code>Socker</code>从客户端访问！<code>Docker Server</code>接收到<code>Docker-Client</code>的指令，就会执行这个指令！</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639726823-8afc62d6.png"></p></div><h3 id="Docker-整体架构"><a href="#Docker-整体架构" class="headerlink" title="Docker 整体架构"></a>Docker 整体架构</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639726844-2cd2733e.png">v</p></div><p><code>Docker</code>为什么比<code>VM Ware</code>快？</p><ol><li><code>Docker</code>比虚拟机更少的抽象层</li><li><code>Docker</code>利用宿主机的内核，<code>VM</code>需要的是<code>Guest OS</code></li></ol><p><code>Docker</code>新建一个容器的时候，不需要像虚拟机一样重新加载一个操作系统内核，直接利用宿主机的操作系统，而虚拟机是需要加载<code>Guest OS</code>。<code>Docker</code>和<code>VM</code>的对比如下：</p><table><thead><tr><th></th><th>Docker 容器</th><th>LXC</th><th>VM</th></tr></thead><tbody><tr><td>虚拟化类型</td><td><code>OS</code>虚拟化</td><td><code>OS</code>虚拟化</td><td>硬件虚拟化</td></tr><tr><td>性能</td><td>物理机性能</td><td>物理机性能</td><td>$5 %-20 %$损耗</td></tr><tr><td>隔离性</td><td><code>NS</code>隔离</td><td><code>NS</code>隔离</td><td>强</td></tr><tr><td><code>Qos</code></td><td><code>Cgroup</code>弱</td><td><code>Cgroup</code>弱</td><td>强</td></tr><tr><td>安全性</td><td>中</td><td>差</td><td>强</td></tr><tr><td><code>GuestOS</code></td><td>只支持<code>Linux</code></td><td>只支持<code>Linux</code></td><td>全部</td></tr></tbody></table><h1 id="配置阿里云镜像"><a href="#配置阿里云镜像" class="headerlink" title="配置阿里云镜像"></a>配置阿里云镜像</h1><ol><li>进入阿里云官网，搜索容器镜像服务</li><li>执行命令 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line">sudo <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://axvfsf7e.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure></li></ol><h1 id="Docker-常用命令"><a href="#Docker-常用命令" class="headerlink" title="Docker 常用命令"></a>Docker 常用命令</h1><h2 id="基础命令"><a href="#基础命令" class="headerlink" title="基础命令"></a>基础命令</h2><ol><li>查看<code>Docker</code>的版本信息：<code>docker version</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker version</span></span><br><span class="line">Client: Docker Engine - Community</span><br><span class="line"> Version:           20.10.10</span><br><span class="line"> API version:       1.41</span><br><span class="line"> Go version:        go1.16.9</span><br><span class="line"> Git commit:        b485636</span><br><span class="line"> Built:             Mon Oct 25 07:42:56 2021</span><br><span class="line"> OS/Arch:           linux/amd64</span><br><span class="line"> Context:           default</span><br><span class="line"> Experimental:      <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line"> Engine:</span><br><span class="line">  Version:          20.10.10</span><br><span class="line">  API version:      1.41 (minimum version 1.12)</span><br><span class="line">  Go version:       go1.16.9</span><br><span class="line">  Git commit:       e2f740d</span><br><span class="line">  Built:            Mon Oct 25 07:41:17 2021</span><br><span class="line">  OS/Arch:          linux/amd64</span><br><span class="line">  Experimental:     <span class="literal">false</span></span><br><span class="line"> containerd:</span><br><span class="line">  Version:          1.4.11</span><br><span class="line">  GitCommit:        5b46e404f6b9f661a205e28d59c982d3634148f8</span><br><span class="line"> runc:</span><br><span class="line">  Version:          1.0.2</span><br><span class="line">  GitCommit:        v1.0.2-0-g52b36a2</span><br><span class="line"> docker-init:</span><br><span class="line">  Version:          0.19.0</span><br><span class="line">  GitCommit:        de40ad0</span><br></pre></td></tr></table></figure></li><li>查看<code>Docker</code>的系统信息，包括镜像和容器的数量：<code>docker info</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker info</span></span><br><span class="line">Client:</span><br><span class="line"> Context:    default</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"> Plugins:</span><br><span class="line">  app: Docker App (Docker Inc., v0.9.1-beta3)</span><br><span class="line">  buildx: Build with BuildKit (Docker Inc., v0.6.3-docker)</span><br><span class="line">  scan: Docker Scan (Docker Inc., v0.9.0)</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Containers: 1</span><br><span class="line">  Running: 0</span><br><span class="line">  Paused: 0</span><br><span class="line">  Stopped: 1</span><br><span class="line"> Images: 2</span><br><span class="line"> Server Version: 20.10.10</span><br><span class="line"> Storage Driver: overlay2</span><br><span class="line">  Backing Filesystem: xfs</span><br><span class="line">  Supports d_type: <span class="literal">true</span></span><br><span class="line">  Native Overlay Diff: <span class="literal">true</span></span><br><span class="line">  userxattr: <span class="literal">false</span></span><br><span class="line"> Logging Driver: json-file</span><br><span class="line"> Cgroup Driver: cgroupfs</span><br><span class="line"> Cgroup Version: 1</span><br><span class="line"> Plugins:</span><br><span class="line">  Volume: <span class="built_in">local</span></span><br><span class="line">  Network: bridge host ipvlan macvlan null overlay</span><br><span class="line">  Log: awslogs fluentd gcplogs gelf journald json-file <span class="built_in">local</span> logentries splunk syslog</span><br><span class="line"> Swarm: inactive</span><br><span class="line"> Runtimes: io.containerd.runc.v2 io.containerd.runtime.v1.linux runc</span><br><span class="line"> Default Runtime: runc</span><br><span class="line"> Init Binary: docker-init</span><br><span class="line"> containerd version: 5b46e404f6b9f661a205e28d59c982d3634148f8</span><br><span class="line"> runc version: v1.0.2-0-g52b36a2</span><br><span class="line"> init version: de40ad0</span><br><span class="line"> Security Options:</span><br><span class="line">  seccomp</span><br><span class="line">   Profile: default</span><br><span class="line"> Kernel Version: 4.18.0-305.19.1.el8_4.x86_64</span><br><span class="line"> Operating System: CentOS Linux 8</span><br><span class="line"> OSType: linux</span><br><span class="line"> Architecture: x86_64</span><br><span class="line"> CPUs: 2</span><br><span class="line"> Total Memory: 1.748GiB</span><br><span class="line"> Name: localhost.localdomain</span><br><span class="line"> ID: B5XT:RYL7:BWKX:PBVC:P4UM:VECG:ITI7:S4GJ:J3GP:DR5E:KXT7:III4</span><br><span class="line"> Docker Root Dir: /var/lib/docker</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"> Registry: https://index.docker.io/v1/</span><br><span class="line"> Labels:</span><br><span class="line"> Experimental: <span class="literal">false</span></span><br><span class="line"> Insecure Registries:</span><br><span class="line">  127.0.0.0/8</span><br><span class="line"> Registry Mirrors:</span><br><span class="line">  https://axvfsf7e.mirror.aliyuncs.com/</span><br><span class="line"> Live Restore Enabled: <span class="literal">false</span></span><br></pre></td></tr></table></figure></li><li>帮助命令（可查看可选的参数）：<code>docker 命令 --help</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker info --help</span></span><br><span class="line">Usage:  docker info [OPTIONS]</span><br><span class="line">Display system-wide information</span><br><span class="line">Options:</span><br><span class="line">  -f, --format string   Format the output using the given Go template</span><br></pre></td></tr></table></figure></li></ol><p>命令<a href="https://docs.docker.com/engine/reference/commandline/docker/">帮助文档</a>：<code>https://docs.docker.com/engine/reference/commandline/docker/</code>。</p><h2 id="镜像命令"><a href="#镜像命令" class="headerlink" title="镜像命令"></a>镜像命令</h2><h3 id="查看本地主机的所有镜像"><a href="#查看本地主机的所有镜像" class="headerlink" title="查看本地主机的所有镜像"></a>查看本地主机的所有镜像</h3><p><code>docker images</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">hello-world   latest    d1165f221234   5 months ago   13.3kB</span><br></pre></td></tr></table></figure><p>列表参数介绍：</p><ul><li><code>REPOSITORY</code>： 镜像的仓库源</li><li><code>TAG</code>：镜像的标签</li><li><code>IMAGE ID</code>：镜像的<code>id</code></li><li><code>CREATED</code>：镜像的创建时间</li><li><code>SIZE</code>：镜像的大小</li></ul><p>可选参数：</p><ul><li><code>-a/--all</code>：列出所有镜像</li><li><code>-q/--quiet</code>：只显示镜像的<code>id</code></li></ul><h3 id="搜索镜像"><a href="#搜索镜像" class="headerlink" title="搜索镜像"></a>搜索镜像</h3><p><code>docker search</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker search mysql</span></span><br><span class="line">NAME                              DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">mysql                             MySQL is a widely used, open-source relation…   10308     [OK]</span><br><span class="line">mariadb                           MariaDB is a community-developed fork of MyS…   3819      [OK]</span><br><span class="line">mysql/mysql-server                Optimized MySQL Server Docker images. Create…   754                  [OK]</span><br><span class="line">percona                           Percona Server is a fork of the MySQL relati…   517       [OK]</span><br><span class="line">centos/mysql-57-centos7           MySQL 5.7 SQL database server                   86</span><br><span class="line">mysql/mysql-cluster               Experimental MySQL Cluster Docker images. Cr…   79</span><br><span class="line">centurylink/mysql                 Image containing mysql. Optimized to be <span class="built_in">link</span>…   60                   [OK]</span><br></pre></td></tr></table></figure><p>可选参数：</p><ul><li><code>-f, --filter filter</code>：根据提供的条件过滤输出<ul><li>搜索收藏数大于 $3000$ 的镜像<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker search mysql --filter=STARS=3000</span></span><br><span class="line">NAME      DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">mysql     MySQL is a widely used, open-source relation…   11603     [OK]</span><br><span class="line">mariadb   MariaDB Server is a high performing open sou…   4414      [OK]</span><br></pre></td></tr></table></figure></li></ul></li><li><code>--format string</code>：使用<code>Go</code>模板的漂亮打印搜索</li><li><code>--limit int</code>：最大搜索结果数量（默认为 $25$）</li><li><code>--no-trunc</code>：不截断输出</li></ul><h3 id="下载镜像"><a href="#下载镜像" class="headerlink" title="下载镜像"></a>下载镜像</h3><p><code>docker pull 镜像名[:tag]</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果不写 tag 默认就是 latest，写上 tag 就下载指定版本</span></span><br><span class="line">[root@localhost ~]<span class="comment"># docker pull mysql:5.7</span></span><br><span class="line">5.7: Pulling from library/mysql</span><br><span class="line"><span class="comment"># 分层下载，docker image 的核心-联合文件系统</span></span><br><span class="line">33847f680f63: Pull complete </span><br><span class="line">5cb67864e624: Pull complete </span><br><span class="line">1a2b594783f5: Pull complete </span><br><span class="line">b30e406dd925: Pull complete </span><br><span class="line">48901e306e4c: Pull complete </span><br><span class="line">603d2b7147fd: Pull complete </span><br><span class="line">802aa684c1c4: Pull complete </span><br><span class="line">5b5a19178915: Pull complete </span><br><span class="line">f9ce7411c6e4: Pull complete </span><br><span class="line">f51f6977d9b2: Pull complete </span><br><span class="line">aeb6b16ce012: Pull complete </span><br><span class="line">Digest: sha256:be70d18aedc37927293e7947c8de41ae6490ecd4c79df1db40d1b5b5af7d9596</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> mysql:5.7</span><br><span class="line">docker.io/library/mysql:5.7</span><br></pre></td></tr></table></figure><h3 id="删除镜像"><a href="#删除镜像" class="headerlink" title="删除镜像"></a>删除镜像</h3><p><code>docker rmi</code></p><ol><li>查看镜像<ul><li>查看全部镜像<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">mysql         5.7       938b57d64674   10 days ago   448MB</span><br><span class="line">hello-world   latest    feb5d9fea6a5   5 weeks ago   13.3kB</span><br></pre></td></tr></table></figure></li><li>查看全部镜像（只显示<code>id</code>）<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker images -aq</span></span><br><span class="line">938b57d64674</span><br><span class="line">feb5d9fea6a5</span><br></pre></td></tr></table></figure></li></ul></li><li>删除镜像<ul><li>删除指定的镜像<code>id</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker rmi -f  镜像id</span></span><br></pre></td></tr></table></figure></li><li>删除多个镜像<code>id</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker rmi -f  镜像id 镜像id 镜像id</span></span><br></pre></td></tr></table></figure></li><li>删除全部的镜像<code>id</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker rmi -f  $(docker images -aq)</span></span><br></pre></td></tr></table></figure></li></ul></li></ol><h2 id="容器命令"><a href="#容器命令" class="headerlink" title="容器命令"></a>容器命令</h2><h3 id="运行容器"><a href="#运行容器" class="headerlink" title="运行容器"></a>运行容器</h3><p><code>docker run [可选参数] image</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]<span class="comment"># docker run 8cf625070931</span></span><br><span class="line">2021-08-03 06:48:07+00:00 [Note] [Entrypoint]: Entrypoint script <span class="keyword">for</span> MySQL Server 5.7.35-1debian10 started.</span><br><span class="line">2021-08-03 06:48:07+00:00 [Note] [Entrypoint]: Switching to dedicated user <span class="string">&#x27;mysql&#x27;</span></span><br><span class="line">2021-08-03 06:48:07+00:00 [Note] [Entrypoint]: Entrypoint script <span class="keyword">for</span> MySQL Server 5.7.35-1debian10 started.</span><br><span class="line">2021-08-03 06:48:07+00:00 [ERROR] [Entrypoint]: Database is uninitialized and password option is not specified</span><br><span class="line">    You need to specify one of the following:</span><br><span class="line">    - MYSQL_ROOT_PASSWORD</span><br><span class="line">    - MYSQL_ALLOW_EMPTY_PASSWORD</span><br><span class="line">    - MYSQL_RANDOM_ROOT_PASSWORD</span><br></pre></td></tr></table></figure><p>参数说明：</p><ul><li><code>--name=&quot;名字&quot;</code>：指定容器名字</li><li><code>-d</code>：后台方式运行</li><li><code>-it</code>：使用交互方式运行,进入容器查看内容</li><li><code>-p</code>：指定容器的端口<ul><li><code>-p ip:主机端口:容器端口</code>： 配置主机端口映射到容器端口<ul><li>简化版：<code>-p 主机端口:容器端口</code>或<code>-p 容器端口</code></li></ul></li></ul></li><li><code>-P</code>：随机指定端口（大写的<code>P</code>）<br /></li></ul><h3 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h3><p><code>docker run</code></p><p><code>docker run -it [容器ID] /bin/bash</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># </span></span><br><span class="line">[root@localhost ~]<span class="comment"># docker run -it centos /bin/bash</span></span><br><span class="line">Unable to find image <span class="string">&#x27;centos:latest&#x27;</span> locally</span><br><span class="line">latest: Pulling from library/centos</span><br><span class="line">a1d0c7532777: Pull complete</span><br><span class="line">Digest: sha256:a27fd8080b517143cbbbab9dfb7c8571c40d67d534bbdee55bd6c473f432b177</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> centos:latest</span><br><span class="line">[root@25027261f0db /]<span class="comment"># ls</span></span><br><span class="line">bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line">[root@25027261f0db /]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="退出容器"><a href="#退出容器" class="headerlink" title="退出容器"></a>退出容器</h3><ul><li><code>exit</code>：停止并退出容器（后台方式运行则仅退出）<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@950ba2403e4c /]<span class="comment"># ls</span></span><br><span class="line">bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line">[root@950ba2403e4c /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><code>Ctrl+P+Q</code>：不停止容器，直接退出<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@25027261f0db /]<span class="comment"># [root@localhost ~]#</span></span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="列出容器"><a href="#列出容器" class="headerlink" title="列出容器"></a>列出容器</h3><p><code>docker ps</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED         STATUS         PORTS     NAMES</span><br><span class="line">25027261f0db   centos    <span class="string">&quot;/bin/bash&quot;</span>   6 minutes ago   Up 6 minutes             hardcore_galileo</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>参数说明：</p><ul><li><code>-a</code>：列出所有容器的运行记录</li><li><code>-n=?</code>：显示最近创建的<code>n</code>个容器</li><li><code>-q</code>：只显示容器的编号</li></ul><h3 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h3><p><code>docker rm</code></p><ul><li>删除指定的容器，不能删除正在运行的容器，强制删除使用<code>rm -f</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">rm</span> 容器<span class="built_in">id</span></span><br></pre></td></tr></table></figure></li><li>删除所有的容器<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">rm</span> -f $(docker ps -aq)</span><br></pre></td></tr></table></figure></li><li>删除所有的容器<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a -q|xargs docker <span class="built_in">rm</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="启动和重启容器命令"><a href="#启动和重启容器命令" class="headerlink" title="启动和重启容器命令"></a>启动和重启容器命令</h4><ul><li>启动容器：<code>docker start 容器id</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker start 25027261f0db</span></span><br><span class="line">25027261f0db</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>重启容器：<code>docker restart 容器id</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker restart 25027261f0db</span></span><br><span class="line">25027261f0db</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>停止当前运行的容器：<code>docker stop 容器id</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker stop 25027261f0db</span></span><br><span class="line">25027261f0db</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>强制停止当前容器：<code>docker kill 容器id</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker kill 25027261f0db</span></span><br><span class="line">25027261f0db</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="其他命令"><a href="#其他命令" class="headerlink" title="其他命令"></a>其他命令</h2><h3 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h3><p><code>docker logs</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker logs --help</span></span><br><span class="line"></span><br><span class="line">Usage:  docker logs [OPTIONS] CONTAINER</span><br><span class="line"></span><br><span class="line">Fetch the logs of a container</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">      --details        Show extra details provided to logs</span><br><span class="line">  -f, --follow         Follow <span class="built_in">log</span> output</span><br><span class="line">      --since string   Show logs since timestamp (e.g. 2013-01-02T13:23:37Z) or relative (e.g. 42m <span class="keyword">for</span> 42 minutes)</span><br><span class="line">  -n, --<span class="built_in">tail</span> string    Number of lines to show from the end of the logs (default <span class="string">&quot;all&quot;</span>)</span><br><span class="line">  -t, --timestamps     Show timestamps</span><br><span class="line">      --until string   Show logs before a timestamp (e.g. 2013-01-02T13:23:37Z) or relative (e.g. 42m <span class="keyword">for</span> 42 minutes)</span><br></pre></td></tr></table></figure><p>常用：</p><ul><li><code>docker logs -tf 容器id</code></li><li><code>docker logs --tail number 容器id</code><ul><li><code>num</code>为要显示的日志条数</li></ul></li></ul><p><code>Docker</code>容器后台运行必须要有一个前台的进程，否则会自动停止；编写<code>shell</code>脚本循环执行，使<code>centos</code>容器保持运行状态。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker run -d centos /bin/sh -c &quot;while true;do echo hi;sleep 5;done&quot;</span></span><br><span class="line">4c57edbf79227f256452ebb719716ed2b4b9dcd5170fce1a8a1da10dff225082</span><br><span class="line">[root@localhost ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">4c57edbf7922   centos    <span class="string">&quot;/bin/sh -c &#x27;while t…&quot;</span>   12 seconds ago   Up 11 seconds             xenodochial_lalande</span><br><span class="line">[root@localhost ~]<span class="comment"># docker logs -tf --tail 10 4c57edbf7922</span></span><br><span class="line">2021-10-29T07:12:38.680645208Z hi</span><br><span class="line">2021-10-29T07:12:43.682316339Z hi</span><br><span class="line">2021-10-29T07:12:48.684010465Z hi</span><br><span class="line">2021-10-29T07:12:53.686100268Z hi</span><br><span class="line">2021-10-29T07:12:58.687727415Z hi</span><br><span class="line">2021-10-29T07:13:03.689642682Z hi</span><br><span class="line">2021-10-29T07:13:08.691281535Z hi</span><br><span class="line">2021-10-29T07:13:13.692534177Z hi</span><br><span class="line">2021-10-29T07:13:18.693935678Z hi</span><br><span class="line">2021-10-29T07:13:23.695554000Z hi</span><br><span class="line">^C</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="查看容器中进程信息"><a href="#查看容器中进程信息" class="headerlink" title="查看容器中进程信息"></a>查看容器中进程信息</h3><p><code>docker top</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker top 4c57edbf7922</span></span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">root                2523                2504                0                   15:12               ?                   00:00:00            /bin/sh -c <span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span> <span class="built_in">echo</span> hi;<span class="built_in">sleep</span> 5;<span class="keyword">done</span></span><br><span class="line">root                2595                2523                0                   15:14               ?                   00:00:00            /usr/bin/coreutils --coreutils-prog-shebang=<span class="built_in">sleep</span> /usr/bin/sleep 5</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="查看容器的元数据"><a href="#查看容器的元数据" class="headerlink" title="查看容器的元数据"></a>查看容器的元数据</h3><p><code>docker inspect 容器id</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker inspect 4c57edbf7922</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;4c57edbf79227f256452ebb719716ed2b4b9dcd5170fce1a8a1da10dff225082&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2021-10-29T07:12:38.500368814Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Path&quot;</span>: <span class="string">&quot;/bin/sh&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Args&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;-c&quot;</span>,</span><br><span class="line">            <span class="string">&quot;while true;do echo hi;sleep 5;done&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;State&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Status&quot;</span>: <span class="string">&quot;running&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Running&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&quot;Paused&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Restarting&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;OOMKilled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Dead&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Pid&quot;</span>: 2523,</span><br><span class="line">            <span class="string">&quot;ExitCode&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;Error&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;StartedAt&quot;</span>: <span class="string">&quot;2021-10-29T07:12:38.681818995Z&quot;</span>,</span><br><span class="line">            <span class="string">&quot;FinishedAt&quot;</span>: <span class="string">&quot;0001-01-01T00:00:00Z&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Image&quot;</span>: <span class="string">&quot;sha256:5d0da3dc976460b72c77d94c8a1ad043720b0416bfc16c52c45d4847e53fadb6&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ResolvConfPath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/4c57edbf79227f256452ebb719716ed2b4b9dcd5170fce1a8a1da10dff225082/resolv.conf&quot;</span>,</span><br><span class="line">        <span class="string">&quot;HostnamePath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/4c57edbf79227f256452ebb719716ed2b4b9dcd5170fce1a8a1da10dff225082/hostname&quot;</span>,</span><br><span class="line">        <span class="string">&quot;HostsPath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/4c57edbf79227f256452ebb719716ed2b4b9dcd5170fce1a8a1da10dff225082/hosts&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LogPath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/4c57edbf79227f256452ebb719716ed2b4b9dcd5170fce1a8a1da10dff225082/4c57edbf79227f256452ebb719716ed2b4b9dcd5170fce1a8a1da10dff225082-json.log&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;/xenodochial_lalande&quot;</span>,</span><br><span class="line">        <span class="string">&quot;RestartCount&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;overlay2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Platform&quot;</span>: <span class="string">&quot;linux&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MountLabel&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ProcessLabel&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;AppArmorProfile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ExecIDs&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;HostConfig&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Binds&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;ContainerIDFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;LogConfig&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Config&quot;</span>: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;NetworkMode&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;PortBindings&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;RestartPolicy&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;no&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MaximumRetryCount&quot;</span>: 0</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;AutoRemove&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;VolumeDriver&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;VolumesFrom&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;CapAdd&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;CapDrop&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;CgroupnsMode&quot;</span>: <span class="string">&quot;host&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Dns&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;DnsOptions&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;DnsSearch&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;ExtraHosts&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;GroupAdd&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;IpcMode&quot;</span>: <span class="string">&quot;private&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Cgroup&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Links&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;OomScoreAdj&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;PidMode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Privileged&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;PublishAllPorts&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;ReadonlyRootfs&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;SecurityOpt&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;UTSMode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;UsernsMode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ShmSize&quot;</span>: 67108864,</span><br><span class="line">            <span class="string">&quot;Runtime&quot;</span>: <span class="string">&quot;runc&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ConsoleSize&quot;</span>: [</span><br><span class="line">                0,</span><br><span class="line">                0</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Isolation&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;CpuShares&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;Memory&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;NanoCpus&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;CgroupParent&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;BlkioWeight&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;BlkioWeightDevice&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;BlkioDeviceReadBps&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;BlkioDeviceWriteBps&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;BlkioDeviceReadIOps&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;BlkioDeviceWriteIOps&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;CpuPeriod&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;CpuQuota&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;CpuRealtimePeriod&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;CpuRealtimeRuntime&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;CpusetCpus&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;CpusetMems&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Devices&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;DeviceCgroupRules&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;DeviceRequests&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;KernelMemory&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;KernelMemoryTCP&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;MemoryReservation&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;MemorySwap&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;MemorySwappiness&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;OomKillDisable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;PidsLimit&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;Ulimits&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;CpuCount&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;CpuPercent&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;IOMaximumIOps&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;IOMaximumBandwidth&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;MaskedPaths&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;/proc/asound&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/acpi&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/kcore&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/keys&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/latency_stats&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/timer_list&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/timer_stats&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/sched_debug&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/scsi&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/sys/firmware&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;ReadonlyPaths&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;/proc/bus&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/fs&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/irq&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/sys&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/sysrq-trigger&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;GraphDriver&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Data&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;LowerDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/294a9e60f30995ad07636a45030fc9ac104cfe0f35d3197a6bc7171186f5fe5f-init/diff:/var/lib/docker/overlay2/0ab1d01f204652c7e92e556e2dd1f08093d99ee5ba7a2ee15aeb70324e819ac0/diff&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MergedDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/294a9e60f30995ad07636a45030fc9ac104cfe0f35d3197a6bc7171186f5fe5f/merged&quot;</span>,</span><br><span class="line">                <span class="string">&quot;UpperDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/294a9e60f30995ad07636a45030fc9ac104cfe0f35d3197a6bc7171186f5fe5f/diff&quot;</span>,</span><br><span class="line">                <span class="string">&quot;WorkDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/294a9e60f30995ad07636a45030fc9ac104cfe0f35d3197a6bc7171186f5fe5f/work&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;overlay2&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Mounts&quot;</span>: [],</span><br><span class="line">        <span class="string">&quot;Config&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Hostname&quot;</span>: <span class="string">&quot;4c57edbf7922&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Domainname&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;User&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AttachStdin&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;AttachStdout&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;AttachStderr&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Tty&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;OpenStdin&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;StdinOnce&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Env&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Cmd&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;/bin/sh&quot;</span>,</span><br><span class="line">                <span class="string">&quot;-c&quot;</span>,</span><br><span class="line">                <span class="string">&quot;while true;do echo hi;sleep 5;done&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Image&quot;</span>: <span class="string">&quot;centos&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Volumes&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;WorkingDir&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Entrypoint&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;OnBuild&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;Labels&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;org.label-schema.build-date&quot;</span>: <span class="string">&quot;20210915&quot;</span>,</span><br><span class="line">                <span class="string">&quot;org.label-schema.license&quot;</span>: <span class="string">&quot;GPLv2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;org.label-schema.name&quot;</span>: <span class="string">&quot;CentOS Base Image&quot;</span>,</span><br><span class="line">                <span class="string">&quot;org.label-schema.schema-version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">                <span class="string">&quot;org.label-schema.vendor&quot;</span>: <span class="string">&quot;CentOS&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;NetworkSettings&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Bridge&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SandboxID&quot;</span>: <span class="string">&quot;0a7fdfc5a908ad18bf51398c0328cf7b4e515286df97592d367d80d9290e5033&quot;</span>,</span><br><span class="line">            <span class="string">&quot;HairpinMode&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;LinkLocalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;LinkLocalIPv6PrefixLen&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;Ports&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;SandboxKey&quot;</span>: <span class="string">&quot;/var/run/docker/netns/0a7fdfc5a908&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SecondaryIPAddresses&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;SecondaryIPv6Addresses&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;c68d2781bd2dc7144ea44e21b3c72ebf3058eb0dde2b6523e303dfc9dc3edb0c&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.0.1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;GlobalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;GlobalIPv6PrefixLen&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.2&quot;</span>,</span><br><span class="line">            <span class="string">&quot;IPPrefixLen&quot;</span>: 16,</span><br><span class="line">            <span class="string">&quot;IPv6Gateway&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:02&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Networks&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;bridge&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;IPAMConfig&quot;</span>: null,</span><br><span class="line">                    <span class="string">&quot;Links&quot;</span>: null,</span><br><span class="line">                    <span class="string">&quot;Aliases&quot;</span>: null,</span><br><span class="line">                    <span class="string">&quot;NetworkID&quot;</span>: <span class="string">&quot;70b9319ee22c471f91a2b307d7444a3e0ffe8ddb4b22340b2e62684cf59fd26d&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;c68d2781bd2dc7144ea44e21b3c72ebf3058eb0dde2b6523e303dfc9dc3edb0c&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.0.1&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.2&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPPrefixLen&quot;</span>: 16,</span><br><span class="line">                    <span class="string">&quot;IPv6Gateway&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;GlobalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;GlobalIPv6PrefixLen&quot;</span>: 0,</span><br><span class="line">                    <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:02&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;DriverOpts&quot;</span>: null</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h4 id="进入当前正在运行的容器"><a href="#进入当前正在运行的容器" class="headerlink" title="进入当前正在运行的容器"></a>进入当前正在运行的容器</h4><ol><li><code>docker exec</code>：进入容器后开启一个新的终端，可以在里面操作 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker exec -it  4c57edbf7922 /bin/bash</span></span><br><span class="line">[root@4c57edbf7922 /]<span class="comment"># ls</span></span><br><span class="line">bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line">[root@4c57edbf7922 /]<span class="comment"># ps -es</span></span><br><span class="line">  UID     PID          PENDING          BLOCKED          IGNORED           CAUGHT STAT TTY        TIME COMMAND</span><br><span class="line">    0      66 0000000000000000 0000000000010000 0000000000380004 000000004b817efb Ss   pts/0      0:00 /bin/bash PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/b</span><br><span class="line">    0      84 0000000000000000 0000000000000000 0000000000000000 00000001f3d1fef9 R+   pts/0      0:00 ps -es LANG=en_US.UTF-8 HOSTNAME=4c57edbf7922 PWD=/ HOME=/root</span><br><span class="line">[root@4c57edbf7922 /]<span class="comment"># ps -ef</span></span><br><span class="line">UID          PID    PPID  C STIME TTY          TIME CMD</span><br><span class="line">root           1       0  0 07:12 ?        00:00:00 /bin/sh -c <span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span> <span class="built_in">echo</span> hi;<span class="built_in">sleep</span> 5;<span class="keyword">done</span></span><br><span class="line">root          66       0  0 07:17 pts/0    00:00:00 /bin/bash</span><br><span class="line">root          85       1  0 07:17 ?        00:00:00 /usr/bin/coreutils --coreutils-prog-shebang=<span class="built_in">sleep</span> /usr/bin/sleep 5</span><br><span class="line">root          86      66  0 07:17 pts/0    00:00:00 ps -ef</span><br><span class="line">[root@4c57edbf7922 /]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><code>docker attach</code>：进入容器正在执行的终端，不会启动新的进程 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker attach 4c57edbf7922</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="拷贝容器文件到主机"><a href="#拷贝容器文件到主机" class="headerlink" title="拷贝容器文件到主机"></a>拷贝容器文件到主机</h3><p><code>docker cp 容器id:容器内路径 目的主机路径</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker exec -it 4c57edbf7922 /bin/bash</span></span><br><span class="line">[root@4c57edbf7922 /]<span class="comment"># cd home</span></span><br><span class="line">[root@4c57edbf7922 home]<span class="comment"># ls</span></span><br><span class="line">[root@4c57edbf7922 home]<span class="comment"># touch text.java</span></span><br><span class="line">[root@4c57edbf7922 home]<span class="comment"># ls</span></span><br><span class="line">text.java</span><br><span class="line">[root@4c57edbf7922 home]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">[root@localhost ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">4c57edbf7922   centos    <span class="string">&quot;/bin/sh -c &#x27;while t…&quot;</span>   11 minutes ago   Up 11 minutes             xenodochial_lalande</span><br><span class="line">[root@localhost ~]<span class="comment"># docker cp 4c57edbf7922:/home/text.java /home</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ls /home</span></span><br><span class="line"><span class="built_in">echo</span>  text.java</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h2 id="常用命令小结"><a href="#常用命令小结" class="headerlink" title="常用命令小结"></a>常用命令小结</h2><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639727166-4edd5755.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639727185-a7af770b.png"></p></div><h2 id="Docker-图形化管理工具"><a href="#Docker-图形化管理工具" class="headerlink" title="Docker 图形化管理工具"></a>Docker 图形化管理工具</h2><h3 id="Docker-UI"><a href="#Docker-UI" class="headerlink" title="Docker UI"></a>Docker UI</h3><ol><li>查找 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker search dockerui</span></span><br><span class="line">NAME                           DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">uifd/ui-for-docker             A web interface <span class="keyword">for</span> Docker, formerly known a…   108                  [OK]</span><br><span class="line">abh1nav/dockerui               An updated version of crosbymichael/dockerui…   98                   [OK]</span><br><span class="line">kevan/dockerui                 Deprecated: Use  uifd/ui-for-docker             15                   [OK]</span><br><span class="line">microbox/dockerui              Trusted Automated dockerui image (16MB size)    9</span><br><span class="line">madhavkobal/dockerui           Docker Updated Version having Search, Pull, …   7</span><br><span class="line">mgtsai/dockerui.base-xpra      Provide base docker images <span class="keyword">for</span> X application…   2</span><br><span class="line">rediceli/dockerui              Dockerui with nginx <span class="keyword">for</span> basic auth              1</span><br><span class="line">navionics/dockerui             Docker UI                                       1                    [OK]</span><br><span class="line">elegoev/dockerui               dockerui image based on crosbymichael/docker…   1                    [OK]</span><br><span class="line">levkov/dockerui                dockerui                                        0</span><br><span class="line">yungsang/dockerui              Docker API Version: v1.8 UI Version: v0.4 Bu…   0</span><br><span class="line">david510c/dockerui.base-xpra   dockerui.base-xpra with Firefox                 0                    [OK]</span><br><span class="line">winking/dockerui               The latest DockerUI build, see https://githu…   0</span><br><span class="line">bbdinc/dockerui                A rebuild of the dockerui-with-auth             0</span><br><span class="line">devalih/dockerui               To run :  docker pull devalih/dockerui  dock…   0</span><br><span class="line">bettse/dockerui                Fork of crosbymichael/dockerui                  0</span><br><span class="line">alexerm/dockerui-auth                                                          0</span><br><span class="line">drakin/dockerui                                                                0</span><br><span class="line">cloudaku/dockerui                                                              0                    [OK]</span><br><span class="line">allincloud/dockerui                                                            0                    [OK]</span><br><span class="line">psychemedia/dockerui_patch                                                     0</span><br><span class="line">c0710204/dockerui                                                              0                    [OK]</span><br><span class="line">pemcconnell/dockerui                                                           0</span><br><span class="line">biibds/dockerui                                                                0</span><br><span class="line">wansc/dockerui                                                                 0                    [OK]</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>下载 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker pull abh1nav/dockerui</span></span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from abh1nav/dockerui</span><br><span class="line">Image docker.io/abh1nav/dockerui:latest uses outdated schema1 manifest format. Please upgrade to a schema2 image <span class="keyword">for</span> better future compatibility. More information at https://docs.docker.com/registry/spec/deprecated-schema-v1/</span><br><span class="line">a3ed95caeb02: Pull complete</span><br><span class="line">5d3df020ecd3: Pull complete</span><br><span class="line">bebf5a3b4dfb: Pull complete</span><br><span class="line">e4452c0fe72b: Pull complete</span><br><span class="line">6167d9726b07: Pull complete</span><br><span class="line">53ebae19a314: Pull complete</span><br><span class="line">Digest: sha256:a9c6c5393f561a0f42f41cfa80572b666e745d9b419569c42bac1e5cf9ceda32</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> abh1nav/dockerui:latest</span><br><span class="line">docker.io/abh1nav/dockerui:latest</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>运行 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker run -d --privileged --name dockerui -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock abh1nav/dockerui</span></span><br><span class="line">ee4f62f8a2da81a3f3d7ccf105fb263e9b2bacea0f65e2693e8893e1d87bf6b7</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>测试<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639727226-687c000d.png"></li></ol><h3 id="Shipyard"><a href="#Shipyard" class="headerlink" title="Shipyard"></a>Shipyard</h3><h3 id="Portainer"><a href="#Portainer" class="headerlink" title="Portainer"></a>Portainer</h3><ol><li>查找 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker search portainer</span></span><br><span class="line">NAME                             DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">portainer/portainer              This Repo is now deprecated, use portainer/p…   2136</span><br><span class="line">portainer/portainer-ce           Portainer CE - Making Docker and Kubernetes …   818</span><br><span class="line">portainer/agent                  An agent used to manage all the resources <span class="keyword">in</span>…   120</span><br><span class="line">portainer/templates              App Templates <span class="keyword">for</span> Portainer http://portainer…   23</span><br><span class="line">lihaixin/portainer               docker ui                                       15                   [OK]</span><br><span class="line">greenled/portainer-stack-utils   Bash scripts to deploy/undeploy stacks <span class="keyword">in</span> a …   6                    [OK]</span><br><span class="line">portainer/portainer-k8s-beta     Portainer <span class="keyword">for</span> Kubernetes BETA                   5</span><br><span class="line">portainerci/portainer            Portainer images automatically created via P…   5</span><br><span class="line">portainer/golang-builder         Utility to build Golang binaries.               4                    [OK]</span><br><span class="line">hassioaddons/portainer                                                           2</span><br><span class="line">portainer/portainer-ee           Portainer EE - Making Docker and Kubernetes …   2</span><br><span class="line">portainer/base                   Multi-stage build image to create the Portai…   2                    [OK]</span><br><span class="line">portainer/agent-k8s-beta         Portainer <span class="keyword">for</span> Kubernetes BETA (agent)           1</span><br><span class="line">cqkz/portainer-zh                portainer-ce:2.1.1-alpine，汉化文件来自恩山…             1</span><br><span class="line">softonic/portainer-endpoint      Allows auto register all the swarm nodes <span class="keyword">in</span> …   1                    [OK]</span><br><span class="line">portainerci/portainer-ee         Portainer EE CI repository                      0</span><br><span class="line">xanderstrike/portainer-issue     <span class="keyword">for</span> illustrating a portainer issue              0</span><br><span class="line">iconviet/portainer                                                               0</span><br><span class="line">hassioaddons/portainer-amd64                                                     0</span><br><span class="line">6053537/portainer-ce             portainer-ce中文汉化版                               0</span><br><span class="line">portainerci/agent                Portainer agent images automatically created…   0</span><br><span class="line">helloysd/portainer                                                               0</span><br><span class="line">antsoftxyz/portainer-api         A portainer api wrapper <span class="built_in">which</span> can <span class="built_in">help</span> you C…   0</span><br><span class="line">11384eb/portainer                                                                0</span><br><span class="line">nenadilic84/portainer                                                            0</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>下载 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker pull portainer/portainer</span></span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from portainer/portainer</span><br><span class="line">94cfa856b2b1: Pull complete</span><br><span class="line">49d59ee0881a: Pull complete</span><br><span class="line">a2300fd28637: Pull complete</span><br><span class="line">Digest: sha256:fb45b43738646048a0a0cc74fcee2865b69efde857e710126084ee5de9be0f3f</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> portainer/portainer:latest</span><br><span class="line">docker.io/portainer/portainer:latest</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>运行 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker run -d --name portainerui -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock portainer/portainer</span></span><br><span class="line">fb7e6dd2e3296b05868cf17f00902d3da598abde5e9959a0db39c84bb28cdcf6</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>测试<ol><li>第一次登录设置<code>admin</code>用户的密码<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639727261-a31a260c.png"></li><li>如果是阿里云服务器记得设置安全组，选择连接本地的<code>Docker</code><br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639727290-b8214680.png"></li></ol></li></ol><h2 id="Docker-镜像详解"><a href="#Docker-镜像详解" class="headerlink" title="Docker 镜像详解"></a>Docker 镜像详解</h2><h3 id="什么是镜像"><a href="#什么是镜像" class="headerlink" title="什么是镜像"></a>什么是镜像</h3><p>镜像是一种轻量级、可执行的独立软件包，用来打包软件运行环境和基于运行环境开发的软件，它包含运行某个软件所需要的所有内容，包括代码，运行时（一个程序在运行或者在被执行的依赖）、库，环境变量和配置文件。</p><h3 id="UnionFS（联合文件系统）"><a href="#UnionFS（联合文件系统）" class="headerlink" title="UnionFS（联合文件系统）"></a>UnionFS（联合文件系统）</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639727320-7d07ca30.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639727339-7761f7cb.png"></p></div><ul><li>联合文件系统（<code>UnionFS</code>）是一种分层、轻量级并且高性能的文件系统，它支持对文件系统的修改作为一次提交来一层层的叠加，同时可以将不同目录挂载到同一个虚拟文件系统下。联合文件系统是<code>Docker</code>镜像的基础。镜像可以通过分层来进行继承，基于基础镜像（没有父镜像），可以制作各种具体的应用镜像。</li><li>特性：一次同时加载多个文件系统，但从外面看起来只能看到一个文件系统。联合加载会把各层文件系统叠加起来，这样最终的文件系统会包含所有底层的文件和目录。</li></ul><h3 id="镜像加载原理"><a href="#镜像加载原理" class="headerlink" title="镜像加载原理"></a>镜像加载原理</h3><p><code>Docker</code>的镜像实际由一层一层的文件系统组成：</p><ul><li><code>bootfs</code>（<code>boot file system</code>）主要包含<code>bootloader</code>和<code>kernel</code>。<code>bootloader</code>主要是引导加载<code>kernel</code>，完成后整个内核就都在内存中了。此时内存的使用权已由<code>bootfs</code>转交给内核，系统卸载<code>bootfs</code>。可以被不同的<code>Linux</code>发行版公用。</li><li><code>rootfs</code>（<code>root file system</code>），包含典型<code>Linux</code>系统中的<code>/dev</code>，<code>/proc</code>，<code>/bin</code>，<code>/etc</code>等标准目录和文件。<code>rootfs</code>就是各种不同操作系统发行版（<code>Ubuntu</code>，<code>Centos</code>等）。因为底层直接用<code>Host</code>的<code>kernel</code>，<code>rootfs</code>只包含最基本的命令，工具和程序就可以了。</li></ul><h3 id="分层理解"><a href="#分层理解" class="headerlink" title="分层理解"></a>分层理解</h3><p>所有的<code>Docker</code>镜像都起始于一个基础镜像层，当进行修改或增加新的内容时，就会在当前镜像层之上，创建新的容器层。</p><p>容器在启动时会在镜像最外层上建立一层可读写的容器层（<code>R/W</code>），而镜像层是只读的（<code>R/O</code>）。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639727391-8a4db6f8.png"></p></div>　查看镜像分层的方式可以通过`docker image inspect`命令：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker image inspect tomcat:latest</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;sha256:b0e0b0a92cf96022059ea14d7c0bee5f51cc856f21be4566d435125d6b261a6b&quot;</span>,</span><br><span class="line">        <span class="string">&quot;RepoTags&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;tomcat:latest&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;RepoDigests&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;tomcat@sha256:509cf786b26a8bd43e58a90beba60bdfd6927d2ce9c7902cfa675d3ea9f4c631&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;Parent&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Comment&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2021-10-22T00:23:10.031482334Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Container&quot;</span>: <span class="string">&quot;3910543988c25e096c2ed3920ba0fd86a1d227fad82651cd6c8176d1427e3cbb&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ContainerConfig&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Hostname&quot;</span>: <span class="string">&quot;3910543988c2&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Domainname&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;User&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AttachStdin&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;AttachStdout&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;AttachStderr&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;ExposedPorts&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;8080/tcp&quot;</span>: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;Tty&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;OpenStdin&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;StdinOnce&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Env&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;PATH=/usr/local/tomcat/bin:/usr/local/openjdk-11/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span>,</span><br><span class="line">                <span class="string">&quot;JAVA_HOME=/usr/local/openjdk-11&quot;</span>,</span><br><span class="line">                <span class="string">&quot;LANG=C.UTF-8&quot;</span>,</span><br><span class="line">                <span class="string">&quot;JAVA_VERSION=11.0.13&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CATALINA_HOME=/usr/local/tomcat&quot;</span>,</span><br><span class="line">                <span class="string">&quot;TOMCAT_NATIVE_LIBDIR=/usr/local/tomcat/native-jni-lib&quot;</span>,</span><br><span class="line">                <span class="string">&quot;LD_LIBRARY_PATH=/usr/local/tomcat/native-jni-lib&quot;</span>,</span><br><span class="line">                <span class="string">&quot;GPG_KEYS=A9C5DF4D22E99998D9875A5110C01C5A2F6059E7&quot;</span>,</span><br><span class="line">                <span class="string">&quot;TOMCAT_MAJOR=10&quot;</span>,</span><br><span class="line">                <span class="string">&quot;TOMCAT_VERSION=10.0.12&quot;</span>,</span><br><span class="line">                <span class="string">&quot;TOMCAT_SHA512=e084fc0cc243c0a9ac7de85ffd4b96d00b40b5493ed7ef276d91373fe8036bc953406cd3c48db6b5ae116f2af162fd1bfb13ecdddf5d64523fdd69a9463de8a3&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Cmd&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;/bin/sh&quot;</span>,</span><br><span class="line">                <span class="string">&quot;-c&quot;</span>,</span><br><span class="line">                <span class="string">&quot;#(nop) &quot;</span>,</span><br><span class="line">                <span class="string">&quot;CMD [\&quot;catalina.sh\&quot; \&quot;run\&quot;]&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Image&quot;</span>: <span class="string">&quot;sha256:9b2ff315119c435ad9053c0af16ad0e7b888bb8c78f54428b83de6edac04d00a&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Volumes&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;WorkingDir&quot;</span>: <span class="string">&quot;/usr/local/tomcat&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Entrypoint&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;OnBuild&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;DockerVersion&quot;</span>: <span class="string">&quot;20.10.7&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Author&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Config&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Hostname&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Domainname&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;User&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AttachStdin&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;AttachStdout&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;AttachStderr&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;ExposedPorts&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;8080/tcp&quot;</span>: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;Tty&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;OpenStdin&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;StdinOnce&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Env&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;PATH=/usr/local/tomcat/bin:/usr/local/openjdk-11/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span>,</span><br><span class="line">                <span class="string">&quot;JAVA_HOME=/usr/local/openjdk-11&quot;</span>,</span><br><span class="line">                <span class="string">&quot;LANG=C.UTF-8&quot;</span>,</span><br><span class="line">                <span class="string">&quot;JAVA_VERSION=11.0.13&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CATALINA_HOME=/usr/local/tomcat&quot;</span>,</span><br><span class="line">                <span class="string">&quot;TOMCAT_NATIVE_LIBDIR=/usr/local/tomcat/native-jni-lib&quot;</span>,</span><br><span class="line">                <span class="string">&quot;LD_LIBRARY_PATH=/usr/local/tomcat/native-jni-lib&quot;</span>,</span><br><span class="line">                <span class="string">&quot;GPG_KEYS=A9C5DF4D22E99998D9875A5110C01C5A2F6059E7&quot;</span>,</span><br><span class="line">                <span class="string">&quot;TOMCAT_MAJOR=10&quot;</span>,</span><br><span class="line">                <span class="string">&quot;TOMCAT_VERSION=10.0.12&quot;</span>,</span><br><span class="line">                <span class="string">&quot;TOMCAT_SHA512=e084fc0cc243c0a9ac7de85ffd4b96d00b40b5493ed7ef276d91373fe8036bc953406cd3c48db6b5ae116f2af162fd1bfb13ecdddf5d64523fdd69a9463de8a3&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Cmd&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;catalina.sh&quot;</span>,</span><br><span class="line">                <span class="string">&quot;run&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Image&quot;</span>: <span class="string">&quot;sha256:9b2ff315119c435ad9053c0af16ad0e7b888bb8c78f54428b83de6edac04d00a&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Volumes&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;WorkingDir&quot;</span>: <span class="string">&quot;/usr/local/tomcat&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Entrypoint&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;OnBuild&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;Labels&quot;</span>: null</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Architecture&quot;</span>: <span class="string">&quot;amd64&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Os&quot;</span>: <span class="string">&quot;linux&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Size&quot;</span>: 679601323,</span><br><span class="line">        <span class="string">&quot;VirtualSize&quot;</span>: 679601323,</span><br><span class="line">        <span class="string">&quot;GraphDriver&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Data&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;LowerDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/d790d6db212523ea1193ce0b069697c847cf1f46dd7ee49426dbcd7143e6c178/diff:/var/lib/docker/overlay2/92a2c12ab39fe48f706f82bb5676d1864f599e9ab599d9db39cccbfe92039638/diff:/var/lib/docker/overlay2/407eb8f0c69437754677107d8fd7f17f4a1860145be1efc8b42346ce0fd4dbfe/diff:/var/lib/docker/overlay2/463c9c2a46ab7dd277bd856e02fa289c79c35ec8448d5bd928b9cc5f8c135c20/diff:/var/lib/docker/overlay2/4fece198c14710f63376f1cbad8eeb9d6d96ef2bc0abae8f0151e6f747860e4a/diff:/var/lib/docker/overlay2/bea7f4174b9fed08da36a6410fda3c8ac58f435775b9c421cd99728fff3e9886/diff:/var/lib/docker/overlay2/7067926d50fd10ed3aa0640305af85fa6dcc06a97a5673d7a5e6bc18a0e22fc9/diff:/var/lib/docker/overlay2/f7216c6e8ddb0119daa9c817454fe291cbe2ffdda129215ae36ce4c75f211b3d/diff:/var/lib/docker/overlay2/821accbe6656f334993170bbd8d3eddeef16b7b6aa257612b8dd7f829bbf2786/diff&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MergedDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/196ca3b125c83355469032ec19738aa2dc468a29d3ae7877904abc5a06b967a5/merged&quot;</span>,</span><br><span class="line">                <span class="string">&quot;UpperDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/196ca3b125c83355469032ec19738aa2dc468a29d3ae7877904abc5a06b967a5/diff&quot;</span>,</span><br><span class="line">                <span class="string">&quot;WorkDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/196ca3b125c83355469032ec19738aa2dc468a29d3ae7877904abc5a06b967a5/work&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;overlay2&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;RootFS&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;layers&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Layers&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;sha256:62a747bf1719d2d37fff5670ed40de6900a95743172de1b4434cb019b56f30b4&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:0b3c02b5d746e8cc8d537922b7c2abc17b22da7de268d068f2a4ebd55ac4f6d7&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:9f9f651e9303146e4dd98aca7da21fd8e21dd1a47d71da3d6d187da7691a6dc9&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:ba6e5ff31f235bbfd34aae202da4e6d4dc759f266f284d79018cae755f36f9e3&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:36e0782f115904773d06f7d03af94a1ec9ca9ad42736ec55baae8823c457ba69&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:62a5b8741e8334844625c513016da47cf2b61afb1145f6317edacb4c13ab010e&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:78700b6b35d0ab6e70befff1d26c5350222a8fea49cc874916bce950eeae35a1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:cb80689c9aefc3f455b35b0110fa04a7c13e21a25f342ee2bb27c28f618a0eb5&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:5122793ce9cb2007fe52ae7bb8ff25001e7c29c04d081a0a4bb1986d1b06a4cb&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:450346f29d28210054da70889add4cf59f9c9f3964a94cfa213f905620ade8e2&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Metadata&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;LastTagTime&quot;</span>: <span class="string">&quot;0001-01-01T00:00:00Z&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>这里指示了分层信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;RootFS&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;layers&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Layers&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;sha256:62a747bf1719d2d37fff5670ed40de6900a95743172de1b4434cb019b56f30b4&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sha256:0b3c02b5d746e8cc8d537922b7c2abc17b22da7de268d068f2a4ebd55ac4f6d7&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sha256:9f9f651e9303146e4dd98aca7da21fd8e21dd1a47d71da3d6d187da7691a6dc9&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sha256:ba6e5ff31f235bbfd34aae202da4e6d4dc759f266f284d79018cae755f36f9e3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sha256:36e0782f115904773d06f7d03af94a1ec9ca9ad42736ec55baae8823c457ba69&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sha256:62a5b8741e8334844625c513016da47cf2b61afb1145f6317edacb4c13ab010e&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sha256:78700b6b35d0ab6e70befff1d26c5350222a8fea49cc874916bce950eeae35a1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sha256:cb80689c9aefc3f455b35b0110fa04a7c13e21a25f342ee2bb27c28f618a0eb5&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sha256:5122793ce9cb2007fe52ae7bb8ff25001e7c29c04d081a0a4bb1986d1b06a4cb&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sha256:450346f29d28210054da70889add4cf59f9c9f3964a94cfa213f905620ade8e2&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>举一个简单的例子，加入基于<code>Ubuntu Linux 16.04</code>创建一个新的镜像，这就是新镜像的第一层；如果在该镜像中添加<code>Python</code>包，就会在基础镜像层之上创建第二个镜像层；如果继续添加一个安全补丁，就会创建第三个镜像层。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639727453-772dd27c.png"></p></div><p>在添加额外镜像层的同时，镜像始终保持是当前所有镜像的组合。下图举了一个简单的例子，每个镜像层包含三个文件，而镜像包含了来自两个镜像层的六个文件。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639727478-140d1457.png"></p></div><p>这种情况下，上层镜像层中的文件覆盖了底层镜像层中的文件，这样就使得文件的更新版本作为一个新镜像层添加到镜像当中。</p><p><code>Docker</code>通过存储引擎（新版本采用快照机制）的方式来实现镜像层堆栈，并保证多镜像层对外展示为统一的文件系统。</p><p><code>Linux</code>上可用的存储引擎有<code>AUFS</code>、<code>Overlay2</code>、<code>Device Mapper</code>、<code>Btrfs</code>以及<code>ZFS</code>。顾名思义，每种存储引擎都基于<code>Linux</code>中对应的文件系统或者块设备技术，并且每种存储引擎都有其独有的性能特点。</p><p><code>Docker</code>在<code>Windows</code>上仅支持<code>windowsfilter</code>一种存储引擎，该引擎基于<code>NTFS</code>文件系统之上实现了分层和<code>CoW</code>。</p><p>下图展示了与系统显示相同的三层镜像，所有镜像层堆叠并合并，对外提供统一的试图。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639727537-aa627b9c.png"></p></div><p><code>Docker</code>镜像都是只读的，当容器启动时，一个新的可写层被加载到镜像的底部，这一层就是通常说的容器层，容器层之下都叫镜像层.</p><h3 id="提交镜像"><a href="#提交镜像" class="headerlink" title="提交镜像"></a>提交镜像</h3><p>使用<code>docker commit</code>命令提交容器成为一个新的版本，<code>docker commit -m=“提交的描述信息”  -a=&quot;作者&quot; 容器id 目标镜像名:[TAG]</code>。</p><p>由于默认的<code>Tomcat</code>镜像的<code>webapps</code>文件夹中没有任何内容，需要从<code>webapps.dist</code>中拷贝文件到<code>webapps</code>文件夹。下面自行制作镜像：就是从<code>webapps.dist</code>中拷贝文件到<code>webapps</code>文件夹下，并提交该镜像作为一个新的镜像。使得该镜像默认的<code>webapps</code>文件夹下就有文件。具体命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker run -it tomcat /bin/bash</span></span><br><span class="line">root@36d34cc37920:/usr/local/tomcat<span class="comment"># cd webapps</span></span><br><span class="line">root@36d34cc37920:/usr/local/tomcat/webapps<span class="comment"># ls</span></span><br><span class="line">root@36d34cc37920:/usr/local/tomcat/webapps<span class="comment"># cd ../</span></span><br><span class="line">root@36d34cc37920:/usr/local/tomcat<span class="comment"># cp -r webapps.dist/* webapps</span></span><br><span class="line">root@36d34cc37920:/usr/local/tomcat<span class="comment"># cd webapps</span></span><br><span class="line">root@36d34cc37920:/usr/local/tomcat/webapps<span class="comment"># ls</span></span><br><span class="line">ROOT  docs  examples  host-manager  manager</span><br><span class="line">root@36d34cc37920:/usr/local/tomcat/webapps<span class="comment"># [root@localhost ~]#</span></span><br><span class="line">[root@localhost ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED              STATUS              PORTS      NAMES</span><br><span class="line">36d34cc37920   tomcat    <span class="string">&quot;/bin/bash&quot;</span>   About a minute ago   Up About a minute   8080/tcp   sweet_meninsky</span><br><span class="line">[root@localhost ~]<span class="comment"># docker commit -m=&quot;add files to  webapps&quot; -a=&quot;echo&quot; 36d34cc37920 mytomcat:1.0</span></span><br><span class="line">sha256:97a599676bbb23fb8ee80fc9872c07660893560cc5af3450d53b6967cb516611</span><br><span class="line">[root@localhost ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY            TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">mytomcat              1.0       97a599676bbb   4 seconds ago   684MB</span><br><span class="line">tomcat                latest    b0e0b0a92cf9   8 days ago      680MB</span><br><span class="line">mysql                 5.7       938b57d64674   11 days ago     448MB</span><br><span class="line">nginx                 latest    87a94228f133   2 weeks ago     133MB</span><br><span class="line">hello-world           latest    feb5d9fea6a5   5 weeks ago     13.3kB</span><br><span class="line">centos                latest    5d0da3dc9764   6 weeks ago     231MB</span><br><span class="line">portainer/portainer   latest    580c0e4e98b0   7 months ago    79.1MB</span><br><span class="line">elasticsearch         latest    5acf0e8da90b   3 years ago     486MB</span><br><span class="line">abh1nav/dockerui      latest    6e4d05915b2a   6 years ago     470MB</span><br><span class="line">[root@localhost ~]<span class="comment"># docker run -it mytomcat:1.0 /bin/bash</span></span><br><span class="line">root@3821c6f35992:/usr/local/tomcat<span class="comment"># cd webapps</span></span><br><span class="line">root@3821c6f35992:/usr/local/tomcat/webapps<span class="comment"># ls</span></span><br><span class="line">ROOT  docs  examples  host-manager  manager</span><br><span class="line">root@3821c6f35992:/usr/local/tomcat/webapps<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>　　参数说明：</p><ul><li><code>-m</code>：提交的描述信息</li><li><code>-a</code>：作者</li><li><code>:[TAG]</code>：版本号</li></ul><h1 id="常见容器部署"><a href="#常见容器部署" class="headerlink" title="常见容器部署"></a>常见容器部署</h1><h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><ol><li><p>查找</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker search nginx</span></span><br><span class="line">NAME                              DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">nginx                             Official build of Nginx.                        15725     [OK]</span><br><span class="line">jwilder/nginx-proxy               Automated Nginx reverse proxy <span class="keyword">for</span> docker con…   2088                 [OK]</span><br><span class="line">richarvey/nginx-php-fpm           Container running Nginx + PHP-FPM capable of…   818                  [OK]</span><br><span class="line">jc21/nginx-proxy-manager          Docker container <span class="keyword">for</span> managing Nginx proxy ho…   266</span><br><span class="line">linuxserver/nginx                 An Nginx container, brought to you by LinuxS…   159</span><br><span class="line">tiangolo/nginx-rtmp               Docker image with Nginx using the nginx-rtmp…   142                  [OK]</span><br><span class="line">jlesage/nginx-proxy-manager       Docker container <span class="keyword">for</span> Nginx Proxy Manager        142                  [OK]</span><br><span class="line">alfg/nginx-rtmp                   NGINX, nginx-rtmp-module and FFmpeg from sou…   110                  [OK]</span><br><span class="line">nginxdemos/hello                  NGINX webserver that serves a simple page co…   76                   [OK]</span><br><span class="line">privatebin/nginx-fpm-alpine       PrivateBin running on an Nginx, php-fpm &amp; Al…   59                   [OK]</span><br><span class="line">nginx/nginx-ingress               NGINX and  NGINX Plus Ingress Controllers fo…   55</span><br><span class="line">nginxinc/nginx-unprivileged       Unprivileged NGINX Dockerfiles                  54</span><br><span class="line">staticfloat/nginx-certbot         Opinionated setup <span class="keyword">for</span> automatic TLS certs lo…   25                   [OK]</span><br><span class="line">nginxproxy/nginx-proxy            Automated Nginx reverse proxy <span class="keyword">for</span> docker con…   23</span><br><span class="line">nginx/nginx-prometheus-exporter   NGINX Prometheus Exporter <span class="keyword">for</span> NGINX and NGIN…   21</span><br><span class="line">schmunk42/nginx-redirect          A very simple container to redirect HTTP tra…   19                   [OK]</span><br><span class="line">centos/nginx-112-centos7          Platform <span class="keyword">for</span> running nginx 1.12 or building …   15</span><br><span class="line">centos/nginx-18-centos7           Platform <span class="keyword">for</span> running nginx 1.8 or building n…   13</span><br><span class="line">bitwarden/nginx                   The Bitwarden nginx web server acting as a r…   11</span><br><span class="line">flashspys/nginx-static            Super Lightweight Nginx Image                   11                   [OK]</span><br><span class="line">mailu/nginx                       Mailu nginx frontend                            9                    [OK]</span><br><span class="line">sophos/nginx-vts-exporter         Simple server that scrapes Nginx vts stats a…   7                    [OK]</span><br><span class="line">ansibleplaybookbundle/nginx-apb   An APB to deploy NGINX                          2                    [OK]</span><br><span class="line">wodby/nginx                       Generic nginx                                   1                    [OK]</span><br><span class="line">arnau/nginx-gate                  Docker image with Nginx with Lua enabled on …   1                    [OK]</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><p>下载</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker pull nginx</span></span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/nginx</span><br><span class="line">b380bbd43752: Already exists</span><br><span class="line">fca7e12d1754: Pull complete</span><br><span class="line">745ab57616cb: Pull complete</span><br><span class="line">a4723e260b6f: Pull complete</span><br><span class="line">1c84ebdff681: Pull complete</span><br><span class="line">858292fd2e56: Pull complete</span><br><span class="line">Digest: sha256:644a70516a26004c97d0d85c7fe1d0c3a67ea8ab7ddf4aff193d9f301670cf36</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> nginx:latest</span><br><span class="line">docker.io/library/nginx:latest</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><p>启动</p><ul><li><code>-d</code>：后台运行</li><li><code>--name</code>：给容器命名</li><li><code>-p 3334:80</code>：将宿主机的端口 $3334$ 映射到该容器的 $80$ 端口</li></ul> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker run -d --name nginx -p 9000:80 nginx</span></span><br><span class="line">e8eb3635abc7f90fe9e7c75cf863f60682c9220550b76041177e4080292438c3</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639727793-8af40eeb.png"></p></li><li><p>配置文件<br> 进入容器，自定义配置文件</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker exec -it nginx /bin/bash</span></span><br><span class="line">root@e8eb3635abc7:/<span class="comment"># whereis nginx</span></span><br><span class="line">nginx: /usr/sbin/nginx /usr/lib/nginx /etc/nginx /usr/share/nginx</span><br><span class="line">root@e8eb3635abc7:/<span class="comment"># cd /etc/nginx</span></span><br><span class="line">root@e8eb3635abc7:/etc/nginx<span class="comment"># ls</span></span><br><span class="line">conf.d  fastcgi_params  mime.types  modules  nginx.conf  scgi_params  uwsgi_params</span><br><span class="line">root@e8eb3635abc7:/etc/nginx<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><p>访问测试</p><ul><li>本地主机访问测试，<code>curl</code>命令发起请求，如果使用阿里云服务器需要设置安全组<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS                                   NAMES</span><br><span class="line">e8eb3635abc7   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   19 minutes ago   Up 19 minutes   0.0.0.0:9000-&gt;80/tcp, :::9000-&gt;80/tcp   nginx</span><br><span class="line">[root@localhost ~]<span class="comment"># curl localhost:9000</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>浏览器访问<br><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639727832-3b5adcba.png"></li></ul></li></ol><h2 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h2><ol><li><p>查找</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker search tomcat</span></span><br><span class="line">NAME                          DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">tomcat                        Apache Tomcat is an open <span class="built_in">source</span> implementati…   3161      [OK]</span><br><span class="line">tomee                         Apache TomEE is an all-Apache Java EE certif…   93        [OK]</span><br><span class="line">dordoka/tomcat                Ubuntu 14.04, Oracle JDK 8 and Tomcat 8 base…   58                   [OK]</span><br><span class="line">kubeguide/tomcat-app          Tomcat image <span class="keyword">for</span> Chapter 1                      31</span><br><span class="line">consol/tomcat-7.0             Tomcat 7.0.57, 8080, <span class="string">&quot;admin/admin&quot;</span>              18                   [OK]</span><br><span class="line">cloudesire/tomcat             Tomcat server, 6/7/8                            15                   [OK]</span><br><span class="line">aallam/tomcat-mysql           Debian, Oracle JDK, Tomcat &amp; MySQL              13                   [OK]</span><br><span class="line">arm32v7/tomcat                Apache Tomcat is an open <span class="built_in">source</span> implementati…   11</span><br><span class="line">andreptb/tomcat               Debian Jessie based image with Apache Tomcat…   10                   [OK]</span><br><span class="line">rightctrl/tomcat              CentOS , Oracle Java, tomcat application ssl…   7                    [OK]</span><br><span class="line">arm64v8/tomcat                Apache Tomcat is an open <span class="built_in">source</span> implementati…   6</span><br><span class="line">unidata/tomcat-docker         Security-hardened Tomcat Docker container.      5                    [OK]</span><br><span class="line">amd64/tomcat                  Apache Tomcat is an open <span class="built_in">source</span> implementati…   3</span><br><span class="line">cfje/tomcat-resource          Tomcat Concourse Resource                       2</span><br><span class="line">fabric8/tomcat-8              Fabric8 Tomcat 8 Image                          2                    [OK]</span><br><span class="line">oobsri/tomcat8                Testing CI Jobs with different names.           2</span><br><span class="line">jelastic/tomcat               An image of the Tomcat Java application serv…   2</span><br><span class="line">chenyufeng/tomcat-centos      tomcat基于centos6的镜像                              1                    [OK]</span><br><span class="line">picoded/tomcat7               tomcat7 with jre8 and MANAGER_USER / MANAGER…   1                    [OK]</span><br><span class="line">ppc64le/tomcat                Apache Tomcat is an open <span class="built_in">source</span> implementati…   1</span><br><span class="line">99taxis/tomcat7               Tomcat7                                         1                    [OK]</span><br><span class="line">camptocamp/tomcat-logback     Docker image <span class="keyword">for</span> tomcat with logback integra…   1                    [OK]</span><br><span class="line">secoresearch/tomcat-varnish   Tomcat and Varnish 5.0                          0                    [OK]</span><br><span class="line">s390x/tomcat                  Apache Tomcat is an open <span class="built_in">source</span> implementati…   0</span><br><span class="line">softwareplant/tomcat          Tomcat images <span class="keyword">for</span> jira-cloud testing            0                    [OK]</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><p>下载</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker pull tomcat</span></span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/tomcat</span><br><span class="line">bb7d5a84853b: Pull complete</span><br><span class="line">f02b617c6a8c: Pull complete</span><br><span class="line">d32e17419b7e: Pull complete</span><br><span class="line">c9d2d81226a4: Pull complete</span><br><span class="line">fab4960f9cd2: Pull complete</span><br><span class="line">da1c1e7baf6d: Pull complete</span><br><span class="line">1d2ade66c57e: Pull complete</span><br><span class="line">ea2ad3f7cb7c: Pull complete</span><br><span class="line">d75cb8d0a5ae: Pull complete</span><br><span class="line">76c37a4fffe6: Pull complete</span><br><span class="line">Digest: sha256:509cf786b26a8bd43e58a90beba60bdfd6927d2ce9c7902cfa675d3ea9f4c631</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> tomcat:latest</span><br><span class="line">docker.io/library/tomcat:latest</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><p>启动</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker run -d --name tomcat -p 9000:8080 tomcat</span></span><br><span class="line">3b86e8c4255c9d42448e50cae8b6fd528ab0b801a20e66d2bb79dc702be17fb5</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><p>进入容器</p><ul><li>容器中的命令少了</li><li>阿里云镜像默认下载的是最小的镜像，保证最小的运行环境</li></ul> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker exec -it tomcat /bin/bash</span></span><br><span class="line">root@3b86e8c4255c:/usr/local/tomcat<span class="comment"># ls</span></span><br><span class="line">BUILDING.txt  CONTRIBUTING.md  LICENSE  NOTICE  README.md  RELEASE-NOTES  RUNNING.txt  bin  conf  lib  logs  native-jni-lib  temp  webapps  webapps.dist  work</span><br><span class="line">root@3b86e8c4255c:/usr/local/tomcat<span class="comment"># cd webapps.dist</span></span><br><span class="line">root@3b86e8c4255c:/usr/local/tomcat/webapps.dist<span class="comment"># ls</span></span><br><span class="line">ROOT  docs  examples  host-manager  manager</span><br><span class="line">root@3b86e8c4255c:/usr/local/tomcat/webapps.dist<span class="comment"># cd ../webapps</span></span><br><span class="line">root@3b86e8c4255c:/usr/local/tomcat/webapps<span class="comment"># ls</span></span><br><span class="line">root@3b86e8c4255c:/usr/local/tomcat/webapps<span class="comment"># cp -r /usr/local/tomcat/webapps.dist/* /usr/local/tomcat/webapps/</span></span><br><span class="line">root@3b86e8c4255c:/usr/local/tomcat/webapps<span class="comment"># ls</span></span><br><span class="line">ROOT  docs  examples  host-manager  manager</span><br><span class="line">root@3b86e8c4255c:/usr/local/tomcat/webapps<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><p>访问测试</p><ul><li>本地主机访问测试，<code>curl</code>命令发起请求，如果使用阿里云服务器需要设置安全组<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># curl localhost:9000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">    &lt;<span class="built_in">head</span>&gt;</span><br><span class="line">        &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span><br><span class="line">        &lt;title&gt;Apache Tomcat/10.0.12&lt;/title&gt;</span><br><span class="line">        &lt;<span class="built_in">link</span> href=<span class="string">&quot;favicon.ico&quot;</span> rel=<span class="string">&quot;icon&quot;</span> <span class="built_in">type</span>=<span class="string">&quot;image/x-icon&quot;</span> /&gt;</span><br><span class="line">        &lt;<span class="built_in">link</span> href=<span class="string">&quot;tomcat.css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span> <span class="built_in">type</span>=<span class="string">&quot;text/css&quot;</span> /&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>浏览器访问<br><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639727903-4973d00f.png"></li></ul></li></ol><h2 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h2><ol><li>查找 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker search elasticsearch</span></span><br><span class="line">NAME                                         DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">elasticsearch                                Elasticsearch is a powerful open <span class="built_in">source</span> sear…   5289      [OK]</span><br><span class="line">nshou/elasticsearch-kibana                   Elasticsearch-7.15.1 Kibana-7.15.1              132                  [OK]</span><br><span class="line">mobz/elasticsearch-head                      elasticsearch-head front-end and standalone …   81</span><br><span class="line">elastichq/elasticsearch-hq                   Official Docker image <span class="keyword">for</span> ElasticHQ: Elastic…   76                   [OK]</span><br><span class="line">itzg/elasticsearch                           Provides an easily configurable Elasticsearc…   71                   [OK]</span><br><span class="line">elastic/elasticsearch                        The Elasticsearch Docker image maintained by…   56</span><br><span class="line">taskrabbit/elasticsearch-dump                Import and <span class="built_in">export</span> tools <span class="keyword">for</span> elasticsearch       27                   [OK]</span><br><span class="line">lmenezes/elasticsearch-kopf                  elasticsearch kopf                              18                   [OK]</span><br><span class="line">barnybug/elasticsearch                       Latest Elasticsearch 1.7.2 and previous rele…   17                   [OK]</span><br><span class="line">justwatch/elasticsearch_exporter             Elasticsearch stats exporter <span class="keyword">for</span> Prometheus     17</span><br><span class="line">blacktop/elasticsearch                       Alpine Linux based Elasticsearch Docker Image   16                   [OK]</span><br><span class="line">esystemstech/elasticsearch                   Debian based Elasticsearch packing <span class="keyword">for</span> Lifer…   15</span><br><span class="line">monsantoco/elasticsearch                     ElasticSearch Docker image                      11                   [OK]</span><br><span class="line">mesoscloud/elasticsearch                     [UNMAINTAINED] Elasticsearch                    9                    [OK]</span><br><span class="line">dtagdevsec/elasticsearch                     elasticsearch                                   4                    [OK]</span><br><span class="line">centerforopenscience/elasticsearch           Elasticsearch                                   4                    [OK]</span><br><span class="line">barchart/elasticsearch-aws                   Elasticsearch AWS node                          3</span><br><span class="line">jetstack/elasticsearch-pet                   An elasticsearch image <span class="keyword">for</span> kubernetes PetSets   1                    [OK]</span><br><span class="line">axway/elasticsearch-docker-beat              <span class="string">&quot;Beat&quot;</span> extension to <span class="built_in">read</span> logs of containers …   1                    [OK]</span><br><span class="line">thingswise/elasticsearch                     Elasticsearch + etcd2 peer discovery            1                    [OK]</span><br><span class="line">kuzzleio/elasticsearch                       Elasticsearch container based on Alpine Linu…   1                    [OK]</span><br><span class="line">phenompeople/elasticsearch                   Elasticsearch is a powerful open <span class="built_in">source</span> sear…   1                    [OK]</span><br><span class="line">dsteinkopf/elasticsearch-ingest-attachment   elasticsearch + ingest-attachment to be used…   1                    [OK]</span><br><span class="line">wreulicke/elasticsearch                      elasticsearch                                   0                    [OK]</span><br><span class="line">travix/elasticsearch-kubernetes              To run ElasticSearch <span class="keyword">in</span> kubernetes and expor…   0                    [OK]</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>下载 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker pull elasticsearch</span></span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/elasticsearch</span><br><span class="line">05d1a5232b46: Pull complete</span><br><span class="line">5cee356eda6b: Pull complete</span><br><span class="line">89d3385f0fd3: Pull complete</span><br><span class="line">65dd87f6620b: Pull complete</span><br><span class="line">78a183a01190: Pull complete</span><br><span class="line">1a4499c85f97: Pull complete</span><br><span class="line">2c9d39b4bfc1: Pull complete</span><br><span class="line">1b1cec2222c9: Pull complete</span><br><span class="line">59ff4ce9df68: Pull complete</span><br><span class="line">1976bc3ee432: Pull complete</span><br><span class="line">5af49e8af381: Pull complete</span><br><span class="line">42c8b75ff7af: Pull complete</span><br><span class="line">7e6902915254: Pull complete</span><br><span class="line">99853874fa54: Pull complete</span><br><span class="line">596fbad6fcff: Pull complete</span><br><span class="line">Digest: sha256:a8081d995ef3443dc6d077093172a5931e02cdb8ffddbf05c67e01d348a9770e</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> elasticsearch:latest</span><br><span class="line">docker.io/library/elasticsearch:latest</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>运行<ol><li>添加 <code>-e ES_JAVA_OPTS=&quot;-Xms128m -Xmx512m&quot;</code> 配置<code>ElasticSearch</code>的虚拟机占用的内存大小 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker run -d --name elasticsearch -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; -e ES_JAVA_OPTS=&quot;-Xms128m -Xmx512m&quot; elasticsearch</span></span><br><span class="line">f0df576e243ccb3d0fffdd85924f3241a9490876783440c5fe237d283c76b82f</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><code>docker stats</code>：查看资源占用情况 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE           COMMAND                  CREATED              STATUS              PORTS                                                                                  NAMES</span><br><span class="line">f0df576e243c   elasticsearch   <span class="string">&quot;/docker-entrypoint.…&quot;</span>   About a minute ago   Up About a minute   0.0.0.0:9200-&gt;9200/tcp, :::9200-&gt;9200/tcp, 0.0.0.0:9300-&gt;9300/tcp, :::9300-&gt;9300/tcp   elasticsearch</span><br><span class="line">[root@localhost ~]<span class="comment"># docker stats</span></span><br><span class="line">CONTAINER ID   NAME            CPU %     MEM USAGE / LIMIT     MEM %     NET I/O     BLOCK I/O     PIDS</span><br><span class="line">f0df576e243c   elasticsearch   0.05%     280.3MiB / 1.748GiB   15.66%    976B / 0B   0B / 48.1kB   31</span><br><span class="line">CONTAINER ID   NAME            CPU %     MEM USAGE / LIMIT     MEM %     NET I/O     BLOCK I/O     PIDS</span><br><span class="line">f0df576e243c   elasticsearch   0.05%     280.3MiB / 1.748GiB   15.66%    976B / 0B   0B / 48.1kB   31</span><br><span class="line">^C</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li></ol></li><li>进入容器 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker exec -it elasticsearch /bin/bash</span></span><br><span class="line">root@f0df576e243c:/usr/share/elasticsearch<span class="comment"># ls</span></span><br><span class="line">NOTICE.txt  README.textile  bin  config  data  lib  logs  modules  plugins</span><br><span class="line">root@f0df576e243c:/usr/share/elasticsearch<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>访问<ul><li>本地主机访问测试，<code>curl</code>命令发起请求，如果使用阿里云服务器需要设置安全组<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@f0df576e243c:/usr/share/elasticsearch<span class="comment"># curl localhost:9200</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span> : <span class="string">&quot;6F1a2UH&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cluster_name&quot;</span> : <span class="string">&quot;elasticsearch&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cluster_uuid&quot;</span> : <span class="string">&quot;D_t1vzAURlmAP6TwqcjKPA&quot;</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;number&quot;</span> : <span class="string">&quot;5.6.12&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_hash&quot;</span> : <span class="string">&quot;cfe3d9f&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_date&quot;</span> : <span class="string">&quot;2018-09-10T20:12:43.732Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_snapshot&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;lucene_version&quot;</span> : <span class="string">&quot;6.6.1&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;tagline&quot;</span> : <span class="string">&quot;You Know, for Search&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">root@f0df576e243c:/usr/share/elasticsearch<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li>浏览器访问<br><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1635214301/1639727935-092f9793.png"></li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Dockcer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Elasticsearch 优化与面试题</title>
      <link href="/2021/10/21/ElasticSearch/06.Elasticsearch%20%E4%BC%98%E5%8C%96%E4%B8%8E%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
      <url>/2021/10/21/ElasticSearch/06.Elasticsearch%20%E4%BC%98%E5%8C%96%E4%B8%8E%E9%9D%A2%E8%AF%95%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h1 id="硬件选择"><a href="#硬件选择" class="headerlink" title="硬件选择"></a>硬件选择</h1><p><code>Elasticsearch</code>的基础是<code>Lucene</code>，所有的索引和文档数据是存储在本地的磁盘中，具体的路径可在<code>ES</code>的配置文件<code>../config/elasticsearch.yml</code>中配置，如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Path to directory where to store the data (separate multiple locations by comma): </span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#path.data: /path/to/data </span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Path to log files: </span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#path.logs: /path/to/logs </span></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure><p>磁盘在现代服务器上通常都是瓶颈。<code>Elasticsearch</code>重度使用磁盘，磁盘能处理的吞吐量越大，节点就越稳定。这里有一些优化磁盘<code>I/O</code>的技巧：</p><ul><li>使用<code>SSD</code>。就像其他地方提过的， 他们比机械磁盘优秀多了。</li><li>使用<code>RAID0</code>。条带化<code>RAID</code>会提高磁盘<code>I/O</code>，代价显然就是当一块硬盘故障时整个就故障了。不要使用镜像或者奇偶校验<code>RAID</code>因为副本已经提供了这个功能。</li><li>另外，使用多块硬盘，并允许<code>Elasticsearch</code>通过多个<code>path.data</code>目录配置把数据条带化分配到它们上面。</li><li>不要使用远程挂载的存储，比如<code>NFS</code>或者<code>SMB/CIFS</code>。这个引入的延迟对性能来说完全是背道而驰的。</li></ul><h1 id="分片策略"><a href="#分片策略" class="headerlink" title="分片策略"></a>分片策略</h1><h2 id="合理设置分片数"><a href="#合理设置分片数" class="headerlink" title="合理设置分片数"></a>合理设置分片数</h2><p>分片和副本的设计为<code>ES</code>提供了支持分布式和故障转移的特性，但并不意味着分片和副本是可以无限分配的。而且索引的分片完成分配后由于索引的路由机制，是不能重新修改分片数的。</p><p>可能有人会说，不知道这个索引将来会变得多大，并且过后也不能更改索引的大小，所以为了保险起见，还是给它设为 $1000$ 个分片吧。但是需要知道的是，一个分片并不是没有代价的。需要了解：</p><ul><li>一个分片的底层即为一个<code>Lucene</code>索引，会消耗一定文件句柄、内存、以及<code>CPU</code>运转。</li><li>每一个搜索请求都需要命中索引中的每一个分片，如果每一个分片都处于不同的节点还好，<br>但如果多个分片都需要在同一个节点上竞争使用相同的资源就有些糟糕了。<br /></li><li>用于计算相关度的词项统计信息是基于分片的。如果有许多分片，每一个都只有很少的数据会导致很低的相关度。</li></ul><p>一个业务索引具体需要分配多少分片可能需要架构师和技术人员对业务的增长有个预先的判断，横向扩展应当分阶段进行。为下一阶段准备好足够的资源。 只有当进入到下一个阶段，才有时间思考需要作出哪些改变来达到这个阶段。</p><p>一般来说，遵循一些原则：</p><ul><li>控制每个分片占用的硬盘容量不超过<code>ES</code>的最大<code>JVM</code>的堆空间设置（一般设置不超过 $32$ G，参考下文的<code>JVM</code>设置原则），因此，如果索引的总容量在 $500$ G 左右，那分片大小在 $16$ 个左右即可；当然，最好同时考虑原则 $2$。</li><li>考虑一下<code>node</code>数量，一般一个节点有时候就是一台物理机，如果分片数过多，大大超过了节点数，很可能会导致一个节点上存在多个分片，一旦该节点故障，即使保持了 $1$ 个以上的副本，同样有可能会导致数据丢失，集群无法恢复。所以， 一般都设置分片数不超过节点数的 $3$ 倍。</li><li>主分片，副本和节点最大数之间数量，我们分配的时候可以参考以下关系：<blockquote><p>节点数&lt;=主分片数*（副本数+1）</p></blockquote></li></ul><h2 id="推迟分片分配"><a href="#推迟分片分配" class="headerlink" title="推迟分片分配"></a>推迟分片分配</h2><p>对于节点瞬时中断的问题，默认情况，集群会等待一分钟来查看节点是否会重新加入，如果这个节点在此期间重新加入，重新加入的节点会保持其现有的分片数据，不会触发新的分片分配。这样就可以减少<code>ES</code>在自动再平衡可用分片时所带来的极大开销。</p><p>通过修改参数<code>delayed_timeout</code>，可以延长再均衡的时间，可以全局设置也可以在索引级别进行修改：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># PUT /_all/_settings</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">        <span class="attr">&quot;index.unassigned.node_left.delayed_timeout&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5m&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h1 id="路由选择"><a href="#路由选择" class="headerlink" title="路由选择"></a>路由选择</h1><p>当查询文档的时候，<code>Elasticsearch</code>如何知道一个文档应该存放到哪个分片中呢？它其实是通过下面这个公式来计算出来：</p><blockquote><p>shard=hash(routing)%number_of_primary_shards</p></blockquote><p><code>routing</code>默认值是文档的<code>id</code>，也可以采用自定义值，比如用户<br>id。</p><h2 id="不带-routing-查询"><a href="#不带-routing-查询" class="headerlink" title="不带 routing 查询"></a>不带 routing 查询</h2><p>在查询的时候因为不知道要查询的数据具体在哪个分片上，所以整个过程分为 $2$ 个步骤：</p><ol><li>分发：请求到达协调节点后，协调节点将查询请求分发到每个分片上。</li><li>聚合: 协调节点搜集到每个分片上查询结果，在将查询的结果进行排序，之后给用户返回结果。</li></ol><h2 id="带-routing-查询"><a href="#带-routing-查询" class="headerlink" title="带 routing 查询"></a>带 routing 查询</h2><p>查询的时候，可以直接根据<code>routing</code>信息定位到某个分配查询，不需要查询所有的分配，经过协调节点排序。</p><p>向上面自定义的用户查询，如果<code>routing</code>设置为<code>userid</code>的话，就可以直接查询出数据来，效率提升很多。</p><h1 id="写入速度优化"><a href="#写入速度优化" class="headerlink" title="写入速度优化"></a>写入速度优化</h1><p><code>ES</code>的默认配置，是综合了数据可靠性、写入速度、搜索实时性等因素。实际使用时，需要根据公司要求，进行偏向性的优化。</p><p>针对于搜索性能要求不高，但是对写入要求较高的场景，需要尽可能的选择恰当写优化策略。综合来说，可以考虑以下几个方面来提升写索引的性能：</p><ul><li>加大<code>TranslogFlush</code>，目的是降低<code>Iops</code>、<code>Writeblock</code>。</li><li>增加<code>IndexRefresh</code>间隔，目的是减少<code>SegmentMerge</code>的次数。</li><li>调整<code>Bulk</code>线程池和队列。</li><li>优化节点间的任务分布。</li><li>优化<code>Lucene</code>层的索引建立，目的是降低<code>CPU</code>及<code>IO</code>。</li></ul><h2 id="批量数据提交"><a href="#批量数据提交" class="headerlink" title="批量数据提交"></a>批量数据提交</h2><p><code>ES</code>提供了<code>BulkAPI</code>支持批量操作，当有大量的写任务时，可以使用<code>Bulk</code>来进行批量写入。</p><p>通用的策略如下：<code>Bulk</code>默认设置批量提交的数据量不能超过 $100$ M。数据条数一般是根据文档的大小和服务器性能而定的，但是单次批处理的数据大小应从 $5$ MB～$15$ MB逐渐增加，当性能没有提升时，把这个数据量作为最大值。</p><h2 id="优化存储设备"><a href="#优化存储设备" class="headerlink" title="优化存储设备"></a>优化存储设备</h2><p><code>ES</code>是一种密集使用磁盘的应用，在段合并的时候会频繁操作磁盘，所以对磁盘要求较高，当磁盘速度提升之后，集群的整体性能会大幅度提高。</p><h2 id="合理使用合并"><a href="#合理使用合并" class="headerlink" title="合理使用合并"></a>合理使用合并</h2><p><code>Lucene</code>以段的形式存储数据。当有新的数据写入索引时，<code>Lucene</code>就会自动创建一个新的段。</p><p>随着数据量的变化，段的数量会越来越多，消耗的多文件句柄数及<code>CPU</code>就越多，查询效率就会下降。</p><p>由于<code>Lucene</code>段合并的计算量庞大，会消耗大量的<code>I/O</code>，所以<code>ES</code>默认采用较保守的策略，让后台定期进行段合并。</p><h2 id="减少-Refresh-的次数"><a href="#减少-Refresh-的次数" class="headerlink" title="减少 Refresh 的次数"></a>减少 Refresh 的次数</h2><p><code>Lucene</code>在新增数据时，采用了延迟写入的策略，默认情况下索引的<code>refresh_interval</code>为 $1$ 秒。</p><p><code>Lucene</code>将待写入的数据先写到内存中，超过 $1$ 秒（默认）时就会触发一次<code>Refresh</code>，然后 <code>Refresh</code>会把内存中的的数据刷新到操作系统的文件缓存系统中。</p><p>如果对搜索的实效性要求不高，可以将<code>Refresh</code>周期延长，例如 $30$ 秒。这样还可以有效地减少段刷新次数，但这同时意味着需要消耗更多的<code>Heap</code>内存。</p><h2 id="加大-Flush-设置"><a href="#加大-Flush-设置" class="headerlink" title="加大 Flush 设置"></a>加大 Flush 设置</h2><p><code>Flush</code>的主要目的是把文件缓存系统中的段持久化到硬盘，当<code>Translog</code>的数据量达到 $512$ MB或者 $30$ 分钟时，会触发一次<code>Flush</code>。</p><p><code>index.translog.flush_threshold_size</code>参数的默认值是 $512$ MB，对此进行修改。</p><p>增加参数值意味着文件缓存系统中可能需要存储更多的数据，所以需要为操作系统的文件缓存系统留下足够的空间。</p><h2 id="减少副本的数量"><a href="#减少副本的数量" class="headerlink" title="减少副本的数量"></a>减少副本的数量</h2><p><code>ES</code>为了保证集群的可用性，提供了<code>Replicas</code>（副本）支持，然而每个副本也会执行分析、索引及可能的合并过程，所以<code>Replicas</code>的数量会严重影响写索引的效率。</p><p>当写索引时，需要把写入的数据都同步到副本节点，副本节点越多，写索引的效率就越慢。如果需要大批量进行写入操作，可以先禁止<code>Replica</code>复制，设置<code>index.number_of_replicas: 0</code>关闭副本。在写入完成后，<code>Replica</code>修改回正常的状态。</p><h1 id="内存设置"><a href="#内存设置" class="headerlink" title="内存设置"></a>内存设置</h1><p><code>ES</code>默认安装后设置的内存是 $1$ GB，对于任何一个现实业务来说，这个设置都太小了。如果是通过解压安装的<code>ES</code>，则在<code>ES</code>安装文件中包含一个<code>jvm.option</code>文件，添加如下命令来设置<code>ES</code>的堆大小，<code>Xms</code>表示堆的初始大小，<code>Xmx</code>表示可分配的最大内存，默认都是 $1$ GB。</p><p>确保<code>Xmx</code>和<code>Xms</code>的大小是相同的，其目的是为了能够在<code>Java</code>垃圾回收机制清理完堆区后不需要重新分隔计算堆区的大小而浪费资源，可以减轻伸缩堆大小带来的压力。</p><p>假设你有一个 $64$ G内存的机器，按照正常思维思考，可能会认为把 $64$ G内存都给<code>ES</code>比较好，但现实是这样吗，越大越好？虽然内存对<code>ES</code>来说是非常重要的，但是答案是否定的！</p><p>因为<code>ES</code>堆内存的分配需要满足以下两个原则：</p><ul><li>不要超过物理内存的 $50 %$：<code>Lucene</code>的设计目的是把底层<code>OS</code>里的数据缓存到内存中。<br><code>Lucene</code>的段是分别存储到单个文件中的，这些文件都是不会变化的，所以很利于缓存，同时操作系统也会把这些段文件缓存起来，以便更快的访问。<br>如果设置的堆内存过大，<code>Lucene</code>可用的内存将会减少，就会严重影响降低<code>Lucene</code>的全文本查询性能。</li><li>堆内存的大小最好不要超过 $32$ GB：在<code>Java</code>中，所有对象都分配在堆上，然后有一个<code>KlassPointer</code>指针指向它的类元数据。<br>这个指针在 $64$ 位的操作系统上为 $64$ 位，$64$ 位的操作系统可以使用更多的内存（$2^{64}$）。在<br> $32$ 位的系统上为 $32$ 位，$32$ 位的操作系统的最大寻址空间为 $4$ GB（$2^{32}$）。<br>但是 $64$ 位的指针意味着更大的浪费，因为指针本身大了。浪费内存不算，更糟糕的是，更大的指针在主内存和缓存器（例如<code>LLC</code>，<code>L1</code>等）之间移动数据的时候，会占用更多的带宽。</li></ul><p>最终都会采用 $31$ G设置：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Xms <span class="number">31</span>g</span><br><span class="line">-Xmx <span class="number">31</span>g</span><br></pre></td></tr></table></figure><p>假设有个机器有 $128$ GB的内存，可以创建两个节点，每个节点内存分配不超过 $32$ GB。 也就是说不超过 $64$ GB内存给<code>ES</code>的堆内存，剩下的超过 $64$ GB的内存给`Lucene。</p><h1 id="重要配置"><a href="#重要配置" class="headerlink" title="重要配置"></a>重要配置</h1><table><thead><tr><th>参数名</th><th>参数值</th><th>说明</th></tr></thead><tbody><tr><td><code>cluster.name</code></td><td><code>elasticsearch</code></td><td>配置<code>ES</code>的集群名称，默认值是<code>ES</code>，建议改成与所存数据相关的名称，<code>ES</code>会自动发现在同一网段下的 集群名称相同的节点</td></tr><tr><td><code>node.name</code></td><td><code>node-1</code></td><td>集群中的节点名，在同一个集群中不能重复。节点的名称一旦设置，就不能再改变了。当然，也可以设置成服务器的主机名称，例如<code>node.name:$&#123;HOSTNAME&#125;</code>。</td></tr><tr><td><code>node.master</code></td><td><code>true</code></td><td>指定该节点是否有资格被选举成为<code>Master</code>节点，默认是<code>True</code>，如果被设置为<code>True</code>，则只是有资格成为<code>Master</code>节点，具体能否成为<code>Master</code>节点，需要通过选举产生。</td></tr><tr><td><code>node.data</code></td><td><code>true</code></td><td>指定该节点是否存储索引数据，默认为<code>True</code>。数据的增、删、改、查都是在<code>Data</code>节点完成的。</td></tr><tr><td><code>index.number_of_shards</code></td><td>$1$</td><td>设置都索引分片个数，默认是 $1$ 片。也可以在创建索引时设置该值，具体设置为多大都值要根据数据量的大小来定。如果数据量不大，则设置成 $1$ 时效率最高</td></tr><tr><td><code>index.number_of_replicas</code></td><td>$1$</td><td>设置默认的索引副本个数，默认为 $1$ 个。副本数越多，集群的可用性越好，但是写索引时需要同步的数据越多。</td></tr><tr><td><code>transport.tcp.compress</code></td><td><code>true</code></td><td>设置在节点间传输数据时是否压缩，默认为<code>False</code>，不压缩</td></tr><tr><td><code>discovery.zen.minimum_master_nodes</code></td><td>$1$</td><td>设置在选举<code>Master</code>节点时需要参与的最少的候选主节点数，默认为 $1$。如果使用默认值，则当网络不稳定时有可能会出现脑裂。 合理的数值为<code>(master_eligible_nodes/2)+1</code>，其中<code>master_eligible_nodes</code>表示集群中的候选主节点数</td></tr><tr><td><code>discovery.zen.ping.timeout</code></td><td>$3s$</td><td>设置在集群中自动发现其他节点时<code>Ping</code>连接的超时时间，默认为 $3$ 秒。 在较差的网络环境下需要设置得大一点，防止因误判该节点的存活状态而导致分片的转移</td></tr></tbody></table><h1 id="Elasticsearch-面试题"><a href="#Elasticsearch-面试题" class="headerlink" title="Elasticsearch 面试题"></a>Elasticsearch 面试题</h1><h2 id="为什么要使用-Elasticsearch"><a href="#为什么要使用-Elasticsearch" class="headerlink" title="为什么要使用 Elasticsearch?"></a>为什么要使用 Elasticsearch?</h2><p>系统中的数据，随着业务的发展，时间的推移，将会非常多，而业务中往往采用模糊查询进行数据的搜索，而模糊查询会导致查询引擎放弃索引，导致系统查询数据时都是全表扫描，在百万级别的数据库中，查询效率是非常低下的，而使用<code>ES</code>做一个全文索引，将经常查询的系统功能的某些字段，比如说电商系统的商品表中商品名，描述、价格还有<code>id</code>这些字段我们放入 ES索引库里，可以提高查询速度。</p><h2 id="Elasticsearch-的-master-选举流程？"><a href="#Elasticsearch-的-master-选举流程？" class="headerlink" title="Elasticsearch 的 master 选举流程？"></a>Elasticsearch 的 master 选举流程？</h2><ul><li><code>Elasticsearch</code>的选主是<code>ZenDiscovery</code>模块负责的，主要包含<code>Ping</code>（节点之间通过这个<code>RPC</code>来发现彼此）和<code>Unicast</code>（单播模块包含一个主机列表以控制哪些节点需要<code>ping</code>通）这两部分。</li><li>对所有可以成为<code>master</code>的节点（<code>node.master:true</code>）根据<code>nodeId</code>字典排序，每次选举每个节点都把自己所知道节点排一次序，然后选出第一个（第 $0$ 位）节点，暂且认为它是<code>master</code>节点。</li><li>如果对某个节点的投票数达到一定的值（可以成为<code>master</code>节点数 $n/2+1$）并且该节点自己也选举自己，那这个节点就是<code>master</code>。否则重新选举一直到满足上述条件。</li><li><code>master</code>节点的职责主要包括集群、节点和索引的管理，不负责文档级别的管理；<code>data</code>节点可以关闭<code>http</code>功能。</li></ul><h2 id="Elasticsearch-集群脑裂问题？"><a href="#Elasticsearch-集群脑裂问题？" class="headerlink" title="Elasticsearch 集群脑裂问题？"></a>Elasticsearch 集群脑裂问题？</h2><h3 id="脑裂问题可能的成因"><a href="#脑裂问题可能的成因" class="headerlink" title="脑裂问题可能的成因"></a>脑裂问题可能的成因</h3><ul><li><strong>网络问题</strong>：集群间的网络延迟导致一些节点访问不到<code>master</code>，认为<code>master</code>挂掉了从而选举出新的<code>master</code>，并对<code>master</code>上的分片和副本标红，分配新的主分片。</li><li><strong>节点负载</strong>：主节点的角色既为<code>master</code>又为<code>data</code>，访问量较大时可能会导致<code>ES</code>停止响应造成大面积延迟，此时其他节点得不到主节点的响应认为主节点挂掉了，会重新选取主节点。</li><li><strong>内存回收</strong>：<code>data</code>节点上的<code>ES</code>进程占用的内存较大，引发<code>JVM</code>的大规模内存回收，造成<code>ES</code>进程失去响应。</li></ul><h3 id="脑裂问题解决方案："><a href="#脑裂问题解决方案：" class="headerlink" title="脑裂问题解决方案："></a>脑裂问题解决方案：</h3><ul><li><strong>减少误判</strong>：<code>discovery.zen.ping_timeout</code>节点状态的响应时间，默认为 $3s$，可以适当调大，如果<code>master</code>在该响应时间的范围内没有做出响应应答，判断该节点已经挂掉了。调大参数（如  $6s$，<code>discovery.zen.ping_timeout:6</code>），可适当减少误判。</li><li><strong>选举触发</strong>：<code>discovery.zen.minimum_master_nodes:1</code>该参数是用于控制选举行为发生的最小集群主节点数量。当备选主节点的个数大于等于该参数的值，且备选主节点中有该参数个节点认为主节点挂了，进行选举。官方建议为 $(n/2)+1$，$n$ 为主节点个数（即有资格成为主节点的节点个数）。</li><li><strong>角色分离</strong>：即<code>master</code>节点与<code>data</code>节点分离，限制角色。<ul><li>主节点配置为：<code>node.master:truenode.data: false</code></li><li>从节点配置为：<code>node.master:falsenode.data:true</code></li></ul></li></ul><h2 id="Elasticsearch-索引文档的流程？"><a href="#Elasticsearch-索引文档的流程？" class="headerlink" title="Elasticsearch 索引文档的流程？"></a>Elasticsearch 索引文档的流程？</h2><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634806185/1639829499-30a7a106.png"></p></div><ul><li>协调节点默认使用文档<code>ID</code>参与计算（也支持通过<code>routing</code>），以便为路由提供合适的分片：<blockquote><p>shard=hash(document_id)%(num_of_primary_shards)</p></blockquote></li><li>当分片所在的节点接收到来自协调节点的请求后，会将请求写入到<code>MemoryBuffer</code>，然后定时（默认是每隔 $1$ 秒）写入到<code>FilesystemCache</code>，这个从<code>MemoryBuffer</code>到<code>FilesystemCache</code>的过程就叫做<code>refresh</code>；</li><li>当然在某些情况下，存在<code>MomeryBuffer</code>和<code>FilesystemCache</code>的数据可能会丢失，<code>ES</code>是通过<code>translog</code>的机制来保证数据的可靠性的。其实现机制是接收到请求后，同时也会写入到<code>translog</code>中，当<code>Filesystemcache</code>中的数据写入到磁盘中时，才会清除掉，这个过程叫做<code>flush</code>；</li><li>在<code>flush</code>过程中，内存中的缓冲将被清除，内容被写入一个新段，段的<code>fsync</code>将创建一个新的提交点，并将内容刷新到磁盘，旧的<code>translog</code>将被删除并开始一个新的<code>translog</code>。</li><li><code>flush</code>触发的时机是定时触发（默认 $30$ 分钟）或者<code>translog</code>变得太大（默认为 $512$ M）时；</li></ul><h2 id="Elasticsearch-更新和删除文档的流程？"><a href="#Elasticsearch-更新和删除文档的流程？" class="headerlink" title="Elasticsearch 更新和删除文档的流程？"></a>Elasticsearch 更新和删除文档的流程？</h2><ul><li>删除和更新也都是写操作，但是<code>Elasticsearch</code>中的文档是不可变的，因此不能被删除或者改动以展示其变更；</li><li>磁盘上的每个段都有一个相应的<code>.del</code>文件。当删除请求发送后，文档并没有真的被删除，而是在<code>.del</code>文件中被标记为删除。该文档依然能匹配查询，但是会在结果中被过滤掉。当段合并时，在<code>.del</code>文件中被标记为删除的文档将不会被写入新段。</li><li>在新的文档被创建时，<code>Elasticsearch</code>会为该文档指定一个版本号，当执行更新时，旧版本的文档在<code>.del</code>文件中被标记为删除，新版本的文档被索引到一个新段。旧版本的文档依然能匹配查询，但是会在结果中被过滤掉。</li></ul><h2 id="Elasticsearch-搜索的流程？"><a href="#Elasticsearch-搜索的流程？" class="headerlink" title="Elasticsearch 搜索的流程？"></a>Elasticsearch 搜索的流程？</h2><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634806185/1639829527-6ffbd7aa.png"></p></div><ul><li>搜索被执行成一个两阶段过程，称之为<code>QueryThen Fetch</code>；</li><li>在初始查询阶段时，查询会广播到索引中每一个分片拷贝（主分片或者副本分片）。每个分片在本地执行搜索并构建一个匹配文档的大小为<code>from + size</code>的优先队列。<br>PS：在搜索的时候是会查询<code>FilesystemCache</code>的，但是有部分数据还在<code>MemoryBuffer</code>，所以搜索是近实时的。</li><li>每个分片返回各自优先队列中 所有文档的<code>ID</code>和排序值给协调节点，它合并这些值到自己的优先队列中来产生一个全局排序后的结果列表。</li><li>接下来就是取回阶段，协调节点辨别出哪些文档需要被取回并向相关的分片提交多个<code>GET</code>请求。每个分片加载并丰富文档，如果有需要的话，接着返回文档给协调节点。一旦所有的文档都被取回了，协调节点返回结果给客户端。</li><li><code>QueryThenFetch</code>的搜索类型在文档相关性打分的时候参考的是本分片的数据，这样在文档数量较少的时候可能不够准确，<code>DFSQueryThenFetch</code>增加了一个预查询的处理，询问<code>Term</code>和<code>Documentfrequency</code>，这个评分更准确，但是性能会变差。</li></ul><h2 id="Elasticsearch-在部署时，对-Linux-的设置有哪些优化方法？"><a href="#Elasticsearch-在部署时，对-Linux-的设置有哪些优化方法？" class="headerlink" title="Elasticsearch 在部署时，对 Linux 的设置有哪些优化方法？"></a>Elasticsearch 在部署时，对 Linux 的设置有哪些优化方法？</h2><ul><li>$64$ GB内存的机器是非常理想的，但是 $32$ GB和 $16$ GB机器也是很常见的。少于 $8$ GB会适得其反。</li><li>如果要在更快的<code>CPUs</code>和更多的核心之间选择，选择更多的核心更好。多个内核提供的额外并发<br>远胜过稍微快一点点的时钟频率。</li><li>如果负担得起<code>SSD</code>，它将远远超出任何旋转介质。基于<code>SSD</code>的节点，查询和索引性能都有提升。如果负担得起，<code>SSD</code>是一个好的选择。</li><li>即使数据中心们近在咫尺，也要避免集群跨越多个数据中心。绝对要避免集群跨越大的地理距离。</li><li>请确保运行你应用程序的<code>JVM</code>和服务器的<code>JVM</code>是完全一样的。在<code>Elasticsearch</code>的几个地方，使用<code>Java</code>的本地序列化。</li><li>通过设置<code>gateway.recover_after_nodes</code>、<code>gateway.expected_nodes</code>、<code>gateway.recover_after_time</code>可以在集群重启的时候避免过多的分片交换，这可能会让数据恢复从数个小时缩短为几秒钟。</li><li><code>Elasticsearch</code>默认被配置为使用单播发现，以防止节点无意中加入集群。只有在同一台机器上运行的节点才会自动组成集群。最好使用单播代替组播。</li><li>不要随意修改垃圾回收器（<code>CMS</code>）和各个线程池的大小。</li><li>把你的内存的（少于）一半给<code>Lucene</code>（但不要超过 $32$ GB！），通过<code>ES_HEAP_SIZE</code>环境变量设置。</li><li>内存交换到磁盘对服务器性能来说是致命的。如果内存交换到磁盘上，一个 $100$ 微秒的操作可能变成 $10$ 毫秒。再想想那么多 $10$ 微秒的操作时延累加起来。不难看出<code>swapping</code>对于性能是多么可怕。</li><li><code>Lucene</code>使用了大量的文件。同时，<code>Elasticsearch</code>在节点和<code>HTTP</code>客户端之间进行通信也使用了大量的套接字。所有这一切都需要足够的文件描述符。你应该增加你的文件描述符，设置一个很大的值，如 $64000$。</li></ul><h3 id="索引阶段性能提升方法"><a href="#索引阶段性能提升方法" class="headerlink" title="索引阶段性能提升方法"></a>索引阶段性能提升方法</h3><ul><li>使用批量请求并调整其大小：每次批量数据 $5–15$ MB大是个不错的起始点。</li><li>存储：使用<code>SSD</code></li><li>段和合并：<code>Elasticsearch</code>默认值是 $20$ MB/s，对机械磁盘应该是个不错的设置。如果用的是<br><code>SSD</code>，可以考虑提高到 $100–200$ MB/s。如果在做批量导入，完全不在意搜索，可以彻底关掉合并限流。另外还可以增加<code>index.translog.flush_threshold_size</code>设置，从默认的 $512$ MB到更大一些的值，比如 $1$ GB，这可以在一次清空触发的时候在事务日志里积累出更大的段。</li><li>如果搜索结果不需要近实时的准确度，考虑把每个索引的<code>index.refresh_interval</code>改到 $30s$。</li><li>如果在做大批量导入，考虑通过设置`index.number_of_replicas: 0关闭副本。</li></ul><h2 id="GC-方面，在使用-Elasticsearch时要注意什么？"><a href="#GC-方面，在使用-Elasticsearch时要注意什么？" class="headerlink" title="GC 方面，在使用 Elasticsearch时要注意什么？"></a>GC 方面，在使用 Elasticsearch时要注意什么？</h2><ul><li>倒排词典的索引需要常驻内存，无法<code>GC</code>，需要监控<code>data node</code>上<code>segmentmemory</code>增长趋势。</li><li>各类缓存，<code>fieldcache</code>，<code>filtercache</code>，<code>indexingcache</code>，<code>bulkqueue</code>等等，要设置合理的大小，并且要应该根据最坏的情况来看<code>heap</code>是否够用，也就是各类缓存全部占满的时候，还有 <code>heap</code>空间可以分配给其他任务吗？避免采用<code>clear cache</code>等“自欺欺人”的方式来释放内存。</li><li>避免返回大量结果集的搜索与聚合。确实需要大量拉取数据的场景，可以采用<code>scan&amp;scroll api</code>来实现。</li><li><code>cluster stats</code>驻留内存并无法水平扩展，超大规模集群可以考虑分拆成多个集群通过<code>tribenode</code>连接。</li><li>想知道<code>heap</code>够不够，必须结合实际应用场景，并对集群的`heap使用情况做持续的监控。</li></ul><h2 id="Elasticsearch-对于大数据量（上亿量级）的聚合如何实现？"><a href="#Elasticsearch-对于大数据量（上亿量级）的聚合如何实现？" class="headerlink" title="Elasticsearch 对于大数据量（上亿量级）的聚合如何实现？"></a>Elasticsearch 对于大数据量（上亿量级）的聚合如何实现？</h2><p><code>Elasticsearch</code>提供的首个近似聚合是<code>cardinality</code>度量。</p><p>它提供一个字段的基数，即该字段的<code>distinct</code>或者<code>unique</code>值的数目。它是基于<code>HLL</code>算法的。<code>HLL</code>会先对输入作哈希运算，然后根据哈希运算的结果中的<code>bits</code>做概率估算从而得到基数。</p><p>其特点是：可配置的精度，用来控制内存的使用（更精确 ＝ 更多内存）；小的数据集精度是非常高的；可以通过配置参数，来设置去重需要的固定内存使用量。无论数千还是数十亿的唯一值，内存使用量只与配置的精确度相关</p><h2 id="在并发情况下，Elasticsearch如果保证读写一致？"><a href="#在并发情况下，Elasticsearch如果保证读写一致？" class="headerlink" title="在并发情况下，Elasticsearch如果保证读写一致？"></a>在并发情况下，Elasticsearch如果保证读写一致？</h2><ul><li>可以通过版本号使用乐观并发控制，以确保新版本不会被旧版本覆盖，由应用层来处理具体的冲突；</li><li>另外对于写操作，一致性级别支持<code>quorum/one/all</code>，默认为<code>quorum</code>，即只有当大多数分片可用时才允许写操作。但即使大多数可用，也可能存在因为网络等原因导致写入副本失败，这样该副本被认为故障，分片将会在一个不同的节点上重建。</li><li>对于读操作，可以设置<code>replication</code>为<code>sync</code>（默认），这使得操作在主分片和副本分片都完成后才会返回；如果设置<code>replication</code>为<code>async</code>时，也可以通过设置搜索请求参数<code>_preference</code>为<code>primary</code>来查询主分片，确保文档是最新版本。</li></ul><h2 id="如何监控-Elasticsearch集群状态？"><a href="#如何监控-Elasticsearch集群状态？" class="headerlink" title="如何监控 Elasticsearch集群状态？"></a>如何监控 Elasticsearch集群状态？</h2><ul><li><code>elasticsearch-head</code>插件</li><li>通过<code>Kibana</code>监控<code>Elasticsearch</code>。可以实时查看你的集群健康状态和性能，也可以分析过去的集群、索引和节点指标</li></ul><h2 id="是否了解字典树？"><a href="#是否了解字典树？" class="headerlink" title="是否了解字典树？"></a>是否了解字典树？</h2><p>常用字典数据结构如下所示：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634806185/1639829564-20bc958c.png"></p></div><p>字典树又称单词查找树，<a href="https://baike.baidu.com/item/Trie%E6%A0%91">Trie树</a>，是一种<a href="https://baike.baidu.com/item/%E6%A0%91%E5%BD%A2%E7%BB%93%E6%9E%84/9663807">树形结构</a>，是一种哈希树的变种。</p><p>典型应用是用于统计，排序和保存大量的<a href="https://baike.baidu.com/item/%E5%AD%97%E7%AC%A6">字符</a>串（但不仅限于字符串），所以经常被搜索引擎系统用于文本词频统计。</p><p>它的优点是：利用字符串的公共前缀来减少查询时间，最大限度地减少无谓的字符串比较，查询效率比哈希树高。</p><ul><li><code>Trie</code>的核心思想是空间换时间，利用字符串的公共前缀来降低查询时间的开销以达到提高效率的目的。它有 $3$ 个基本性质：<ul><li>根节点不包含字符，除根节点外每一个节点都只包含一个字符。</li><li>从根节点到某一节点，路径上经过的字符连接起来，为该节点对应的字符串。</li><li>每个节点的所有子节点包含的字符都不相同。</li></ul></li></ul><p>对于中文的字典树，每个节点的子节点用一个哈希表存储，这样就不用浪费太大的空间，而且查询速度上可以保留哈希的复杂度 $O(1)$。</p><h2 id="Elasticsearch-中的集群、节点、索引、文档、类型是什么？"><a href="#Elasticsearch-中的集群、节点、索引、文档、类型是什么？" class="headerlink" title="Elasticsearch 中的集群、节点、索引、文档、类型是什么？"></a>Elasticsearch 中的集群、节点、索引、文档、类型是什么？</h2><ul><li>集群是一个或多个节点（服务器）的集合，它们共同保存您的整个数据，并提供跨所有节点的联合索引和搜索功能。群集由唯一名称标识，默认情况下为<code>elasticsearch</code>。此名称很重要，因为如果节点设置为按名称加入群集，则该节点只能是群集的一部分。</li><li>节点是属于集群一部分的单个服务器。它存储数据并参与群集索引和搜索功能。</li><li>索引就像关系数据库中的“数据库”。它有一个定义多种类型的映射。索引是逻辑名称空间，映射到一个或多个主分片，并且可以有零个或多个副本分片。<code>MySQL =&gt;数据库 Elasticsearch =&gt;索引</code>。</li><li>文档类似于关系数据库中的一行。不同之处在于索引中的每个文档可以具有不同的结构（字段），但是对于通用字段应该具有相同的数据类型。 <code>MySQL =&gt; Databases =&gt; Tables =&gt; Columns / RowsElasticsearch =&gt; Indices =&gt; Types =&gt;具有属性的文档</code>。</li><li>类型是索引的逻辑类别/分区，其语义完全取决于用户。</li></ul><h2 id="Elasticsearch-中的倒排索引是什么？"><a href="#Elasticsearch-中的倒排索引是什么？" class="headerlink" title="Elasticsearch 中的倒排索引是什么？"></a>Elasticsearch 中的倒排索引是什么？</h2><p>倒排索引是搜索引擎的核心。</p><p>搜索引擎的主要目标是在查找发生搜索条件的文档时提供快速搜索。</p><p><code>ES</code>中的倒排索引其实就是<code>lucene</code>的倒排索引，区别于传统的正向索引，倒排索引会再存储数据时将关键词和数据进行关联，保存到倒排表中，然后查询时，将查询内容进行分词后在倒排表中进行查询，最后匹配数据即可。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ElasticSearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Elasticsearch 集成</title>
      <link href="/2021/10/21/ElasticSearch/05.Elasticsearch%20%E9%9B%86%E6%88%90/"/>
      <url>/2021/10/21/ElasticSearch/05.Elasticsearch%20%E9%9B%86%E6%88%90/</url>
      
        <content type="html"><![CDATA[<h1 id="Spring-Data-框架集成"><a href="#Spring-Data-框架集成" class="headerlink" title="Spring Data 框架集成"></a>Spring Data 框架集成</h1><h2 id="Spring-Data-框架介绍"><a href="#Spring-Data-框架介绍" class="headerlink" title="Spring Data 框架介绍"></a>Spring Data 框架介绍</h2><p><code>Spring Data</code>是一个用于简化数据库、非关系型数据库、索引库访问，并支持云服务的开源框架。其主要目标是使得对数据的访问变得方便快捷，并支持<code>map-reduce</code>框架和云计算数据服务。</p><p><code>Spring Data</code>可以极大的简化<code>JPA</code>（<code>Elasticsearch</code>）的写法，可以在几乎不用写实现的情况下，实现对数据的访问和操作。除了<code>CRUD</code>外，还包括如分页、排序等一些常用的功能。</p><p><code>Spring Data</code>的<a href="https://spring.io/projects/spring-data">官网</a>：<code>https://spring.io/projects/spring-data</code>。</p><p><code>Spring Data</code>常用的功能模块如下：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634786425/1639829172-6ef01128.png"></p></div><h2 id="Spring-Data-Elasticsearch-介绍"><a href="#Spring-Data-Elasticsearch-介绍" class="headerlink" title="Spring Data Elasticsearch 介绍"></a>Spring Data Elasticsearch 介绍</h2><p><code>Spring Data Elasticsearch</code>基于<code>spring data API</code>简化<code>Elasticsearch</code>操作，将原始操作<code>Elasticsearch</code>的客户端<code>API</code>进行封装 。</p><p><code>Spring Data</code>为<code>Elasticsearch</code>项目提供集成搜索引擎。<code>Spring Data Elasticsearch POJO</code>的关键功能区域为中心的模型与<code>Elastichsearch</code>交互文档和轻松地编写一个存储索引库数据访问层。</p><p><a href="https://spring.io/projects/spring-data-elasticsearch">官方网站</a>：<code>https://spring.io/projects/spring-data-elasticsearch</code>。</p><h2 id="Spring-Data-Elasticsearch-版本对比"><a href="#Spring-Data-Elasticsearch-版本对比" class="headerlink" title="Spring Data Elasticsearch 版本对比"></a>Spring Data Elasticsearch 版本对比</h2><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634786425/1639829204-3245b569.png"></p></div><p>目前最新<code>spring boot</code>对应<code>Elasticsearch7.6.2</code>，<code>Spring boot2.3.x</code>一般可以兼容<code>Elasticsearch7.x</code>。</p><h2 id="框架集成"><a href="#框架集成" class="headerlink" title="框架集成"></a>框架集成</h2><ol><li><p>创建<code>Maven</code>项目</p></li><li><p>修改<code>pom</code>文件，增加依赖关系</p> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ESSpringData<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>ESSpringData<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- FIXME change it to the project&#x27;s website --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://www.example.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginManagement</span>&gt;</span><span class="comment">&lt;!-- lock down plugins versions to avoid using Maven defaults (may be moved to parent pom) --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- clean lifecycle, see https://maven.apache.org/ref/current/maven-core/lifecycles.html#clean_Lifecycle --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-clean-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- default lifecycle, jar packaging: see https://maven.apache.org/ref/current/maven-core/default-bindings.html#Plugin_bindings_for_jar_packaging --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-resources-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.22.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-install-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-deploy-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- site lifecycle, see https://maven.apache.org/ref/current/maven-core/lifecycles.html#site_Lifecycle --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-site-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-project-info-reports-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>增加配置文件<br> 在<code>resources</code>目录中增加<code>application.properties</code>文件。</p> <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># es 服务地址</span></span><br><span class="line"><span class="attr">elasticsearch.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="comment"># es 服务端口</span></span><br><span class="line"><span class="attr">elasticsearch.port</span>=<span class="string">9200</span></span><br><span class="line"><span class="comment"># 配置日志级别,开启 debug 日志</span></span><br><span class="line"><span class="attr">logging.level.com.atguigu.es</span>=<span class="string">debug</span></span><br></pre></td></tr></table></figure></li><li><p><code>Spring Boot</code>主程序</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataElasticSearchMainApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(SpringDataElasticSearchMainApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>数据实体类</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor; <span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor; <span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span> </span><br><span class="line"><span class="meta">@NoArgsConstructor</span> </span><br><span class="line"><span class="meta">@AllArgsConstructor</span> </span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Product</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//商品唯一标识</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">//商品名称</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="comment">//分类名称</span></span><br><span class="line">    <span class="keyword">private</span> String category;</span><br><span class="line">    <span class="comment">//商品价格</span></span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line">    <span class="comment">//图片地址</span></span><br><span class="line">    <span class="keyword">private</span> String images;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>配置类</p><ul><li><code>ElasticsearchRestTemplate</code>是<code>spring-data-elasticsearch</code>项目中的一个类，和其他 <code>spring</code>项目中的<code>template</code>类似。</li><li>在新版的<code>spring-data-elasticsearch</code>中，<code>ElasticsearchRestTemplate</code>代替了原来的<code>ElasticsearchTemplate</code>。</li><li>原因是<code>ElasticsearchTemplate</code>基于<code>TransportClient</code>，<code>TransportClient</code>即将在 $8.x$ 以后的版本中移除。所以，推荐使用<code>ElasticsearchRestTemplate</code>。</li><li><code>ElasticsearchRestTemplate</code>基于<code>RestHighLevelClient</code>客户端的。需要自定义配置类，继承<code>AbstractElasticsearchConfiguration</code>，并实现<code>elasticsearchClient()</code>抽象方法，创建 <code>RestHighLevelClient</code>对象。</li></ul> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClientBuilder; </span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties; </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.config.AbstractElasticsearchConfiguration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;elasticsearch&quot;)</span> </span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticsearchConfig</span> <span class="keyword">extends</span> <span class="title class_">AbstractElasticsearchConfiguration</span> &#123; </span><br><span class="line">    <span class="keyword">private</span> String host ;</span><br><span class="line">    <span class="keyword">private</span> Integer port ;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重写父类方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RestHighLevelClient <span class="title function_">elasticsearchClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RestClientBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> RestClient.builder(<span class="keyword">new</span> <span class="title class_">HttpHost</span>(host, port));</span><br><span class="line">        <span class="type">RestHighLevelClient</span> <span class="variable">restHighLevelClient</span> <span class="operator">=</span> <span class="keyword">new</span>  <span class="title class_">RestHighLevelClient</span>(builder);</span><br><span class="line">        <span class="keyword">return</span> restHighLevelClient;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>DAO</code>数据访问对象</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.repository.ElasticsearchRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProductDao</span> <span class="keyword">extends</span> <span class="title class_">ElasticsearchRepository</span>&lt;Product,Long&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>实体类映射操作</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor; <span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor; <span class="keyword">import</span> lombok.ToString;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.Document; </span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.Field; </span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.FieldType;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span> <span class="meta">@NoArgsConstructor</span> </span><br><span class="line"><span class="meta">@AllArgsConstructor</span> </span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Document(indexName = &quot;shopping&quot;, shards = 3, replicas = 1)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Product</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 必须有 id,这里的 id 是全局唯一的标识，等同于 es 中的&quot;_id&quot;</span></span><br><span class="line">    <span class="comment">// 商品唯一标识</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *type : 字段数据类型</span></span><br><span class="line"><span class="comment">     *analyzer : 分词器类型</span></span><br><span class="line"><span class="comment">     *index : 是否索引(默认:true)</span></span><br><span class="line"><span class="comment">     *Keyword : 短语,不进行分词</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 商品名称</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;)</span> </span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="comment">// 分类名称</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword)</span> </span><br><span class="line">    <span class="keyword">private</span> String category;</span><br><span class="line">    <span class="comment">// 商品价格</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Double)</span> </span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 图片地址</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword, index = false)</span> </span><br><span class="line">    <span class="keyword">private</span> String images;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>索引操作</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.ElasticsearchRestTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataESIndexTest</span> &#123;</span><br><span class="line">    <span class="comment">// 注入 ElasticsearchRestTemplate</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchRestTemplate elasticsearchRestTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建索引并增加映射配置@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createIndex</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// 创建索引，系统初始化会自动创建索引</span></span><br><span class="line">        System.out.println(<span class="string">&quot;创建索引&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteIndex</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// 创建索引，系统初始化会自动创建索引</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flg</span> <span class="operator">=</span> elasticsearchRestTemplate.deleteIndex(Product.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;删除索引 = &quot;</span> + flg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>文档操作</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.PageRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Sort;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataESProductDaoTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductDao productDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Product</span>();</span><br><span class="line">        product.setId(<span class="number">2L</span>);</span><br><span class="line">        product.setTitle(<span class="string">&quot;华为手机&quot;</span>);</span><br><span class="line">        product.setCategory(<span class="string">&quot;手机&quot;</span>);</span><br><span class="line">        product.setPrice(<span class="number">2999.0</span>);</span><br><span class="line">        product.setImages(<span class="string">&quot;http://www.atguigu/hw.jpg&quot;</span>);</span><br><span class="line">        productDao.save(product);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Product</span>();</span><br><span class="line">        product.setId(<span class="number">1L</span>);</span><br><span class="line">        product.setTitle(<span class="string">&quot;小米 2 手机&quot;</span>);</span><br><span class="line">        product.setCategory(<span class="string">&quot;手机&quot;</span>);</span><br><span class="line">        product.setPrice(<span class="number">9999.0</span>);</span><br><span class="line">        product.setImages(<span class="string">&quot;http://www.atguigu/xm.jpg&quot;</span>);</span><br><span class="line">        productDao.save(product);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据 id 查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findById</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> productDao.findById(<span class="number">1L</span>).get();</span><br><span class="line">        System.out.println(product);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询所有</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findAll</span><span class="params">()</span> &#123;</span><br><span class="line">        Iterable&lt;Product&gt; products = productDao.findAll();</span><br><span class="line">        <span class="keyword">for</span> (Product product : products) &#123;</span><br><span class="line">            System.out.println(product);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Product</span>();</span><br><span class="line">        product.setId(<span class="number">1L</span>);</span><br><span class="line">        productDao.delete(product);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 批量新增</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveAll</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Product&gt; productList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Product</span>();</span><br><span class="line">            product.setId(Long.valueOf(i));</span><br><span class="line">            product.setTitle(<span class="string">&quot;[&quot;</span> + i + <span class="string">&quot;]小米手机&quot;</span>);</span><br><span class="line">            product.setCategory(<span class="string">&quot;手机&quot;</span>);</span><br><span class="line">            product.setPrice(<span class="number">1999.0</span> + i);</span><br><span class="line">            product.setImages(<span class="string">&quot;http://www.atguigu/xm.jpg&quot;</span>);</span><br><span class="line">            productList.add(product);</span><br><span class="line">        &#125;</span><br><span class="line">        productDao.saveAll(productList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分页查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findByPageable</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 设置排序(排序方式，正序还是倒序，排序的 id)</span></span><br><span class="line">        <span class="type">Sort</span> <span class="variable">sort</span> <span class="operator">=</span> Sort.by(Sort.Direction.DESC, <span class="string">&quot;id&quot;</span>);</span><br><span class="line">        <span class="comment">// 当前页，第一页从 0 开始，1 表示第二页</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">currentPage</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 每页显示多少条</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">pageSize</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">        <span class="comment">// 设置查询分页</span></span><br><span class="line">        <span class="type">PageRequest</span> <span class="variable">pageRequest</span> <span class="operator">=</span> PageRequest.of(currentPage, pageSize, sort);</span><br><span class="line">        <span class="comment">// 分页查询</span></span><br><span class="line">        Page&lt;Product&gt; productPage = productDao.findAll(pageRequest);</span><br><span class="line">        <span class="keyword">for</span> (Product Product : productPage.getContent()) &#123;</span><br><span class="line">            System.out.println(Product);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>文档搜索</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.TermQueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.PageRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataESSearchTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductDao productDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *term 查询</span></span><br><span class="line"><span class="comment">     *search(termQueryBuilder) 调用搜索方法，参数查询构建器对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">termQuery</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">TermQueryBuilder</span> <span class="variable">termQueryBuilder</span> <span class="operator">=</span> QueryBuilders.termQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;小米&quot;</span>);</span><br><span class="line">        Iterable&lt;Product&gt; products = productDao.search(termQueryBuilder);</span><br><span class="line">        <span class="keyword">for</span> (Product product : products) &#123;</span><br><span class="line">            System.out.println(product);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *term 查询加分页</span></span><br><span class="line"><span class="comment">     */</span> <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">termQueryByPage</span><span class="params">()</span>&#123; <span class="type">int</span> currentPage= <span class="number">0</span> ;</span><br><span class="line">        <span class="type">int</span> <span class="variable">pageSize</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">        <span class="comment">// 设置查询分页</span></span><br><span class="line">        <span class="type">PageRequest</span> <span class="variable">pageRequest</span> <span class="operator">=</span> PageRequest.of(currentPage, pageSize);</span><br><span class="line">        <span class="type">TermQueryBuilder</span> <span class="variable">termQueryBuilder</span> <span class="operator">=</span> QueryBuilders.termQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;小米&quot;</span>);</span><br><span class="line">        Iterable&lt;Product&gt; products = productDao.search(termQueryBuilder,pageRequest);</span><br><span class="line">        <span class="keyword">for</span> (Product product : products) &#123;</span><br><span class="line">            System.out.println(product);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h1 id="Spark-Streaming-框架集成"><a href="#Spark-Streaming-框架集成" class="headerlink" title="Spark Streaming 框架集成"></a>Spark Streaming 框架集成</h1><h2 id="Spark-Streaming框架介绍"><a href="#Spark-Streaming框架介绍" class="headerlink" title="Spark Streaming框架介绍"></a>Spark Streaming框架介绍</h2><p><code>Spark Streaming</code>是<code>Spark core API</code>的扩展，支持实时数据流的处理，并且具有可扩展，高吞吐量，容错的特点。</p><p>数据可以从许多来源获取，如<code>Kafka</code>，<code>Flume</code>，<code>Kinesis</code>或<code>TCPsockets</code>，并且可以使用复杂的算法进行处理，这些算法使用诸如<code>map</code>，<code>reduce</code>，<code>join</code>和<code>window</code>等高级函数表示。 最后，处理后的数据可以推送到文件系统，数据库等。  </p><p>实际上，可以将`Spark的机器学习和图形处理算法应用于数据流。</p><h2 id="框架集成-1"><a href="#框架集成-1" class="headerlink" title="框架集成"></a>框架集成</h2><ol><li>创建<code>Maven</code>项目</li><li>修改<code>pom</code>文件，增加依赖关系 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ESSpark<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>ESSpark<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- FIXME change it to the project&#x27;s website --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://www.example.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-core_2.12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-streaming_2.12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- elasticsearch 的客户端 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- elasticsearch 依赖 2.x 的 log4j --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    &lt;dependency&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    &lt;version&gt;2.11.1&lt;/version&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    &lt;/dependency&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginManagement</span>&gt;</span><span class="comment">&lt;!-- lock down plugins versions to avoid using Maven defaults (may be moved to parent pom) --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- clean lifecycle, see https://maven.apache.org/ref/current/maven-core/lifecycles.html#clean_Lifecycle --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-clean-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- default lifecycle, jar packaging: see https://maven.apache.org/ref/current/maven-core/default-bindings.html#Plugin_bindings_for_jar_packaging --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-resources-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.22.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-install-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-deploy-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- site lifecycle, see https://maven.apache.org/ref/current/maven-core/lifecycles.html#site_Lifecycle --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-site-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-project-info-reports-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li>功能实现 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.SparkConf</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.dstream.ReceiverInputDStream</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.&#123;Seconds, StreamingContext&#125;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexRequest</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.indices.CreateIndexRequest</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.&#123;RequestOptions,RestClient,RestHighLevelClient&#125;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentType</span><br><span class="line"><span class="keyword">import</span> java.util.Date</span><br><span class="line"></span><br><span class="line"><span class="comment">// scale 程序，要在 idea 项目中添加 scale 框架支持</span></span><br><span class="line">object SparkStreamingESTest &#123;</span><br><span class="line"></span><br><span class="line">    def <span class="title function_">main</span><span class="params">(args: Array[String])</span>: Unit = &#123;</span><br><span class="line">        <span class="type">val</span><span class="variable">sparkConf</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">SparkConf</span>().setMaster(<span class="string">&quot;local[*]&quot;</span>).setAppName(<span class="string">&quot;ESTest&quot;</span>)</span><br><span class="line">        <span class="type">val</span> <span class="variable">ssc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StreamingContext</span>(sparkConf, Seconds(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">        val ds : ReceiverInputDStream[String] = ssc.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line">        ds.foreachRDD(</span><br><span class="line">            rdd =&gt; &#123;</span><br><span class="line">                println(<span class="string">&quot;*************** &quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">                rdd.foreach(</span><br><span class="line">                    data =&gt; &#123;</span><br><span class="line">                        <span class="type">val</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(</span><br><span class="line">                            RestClient.builder(<span class="keyword">new</span><span class="title class_">HttpHost</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>))</span><br><span class="line">                        );</span><br><span class="line">                        <span class="comment">// 新增文档 - 请求对象</span></span><br><span class="line">                        <span class="type">val</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>();</span><br><span class="line">                        <span class="comment">// 设置索引及唯一性标识</span></span><br><span class="line">                        <span class="type">val</span> <span class="variable">ss</span> <span class="operator">=</span> data.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">                        println(<span class="string">&quot;ss = &quot;</span> + ss.mkString(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">                        request.index(<span class="string">&quot;sparkstreaming&quot;</span>).id(ss(<span class="number">0</span>));</span><br><span class="line">                        <span class="type">val</span> <span class="variable">productJson</span> <span class="operator">=</span> s.stripMargin;</span><br><span class="line">                            <span class="string">&quot;&quot;&quot; | &#123; &quot;data&quot;:&quot;$&#123;ss(1)&#125;&quot; &#125;|&quot;&quot;&quot;</span></span><br><span class="line">                        <span class="comment">// 添加文档数据，数据格式为 JSON 格式</span></span><br><span class="line">                        request.source(productJson,XContentType.JSON);</span><br><span class="line">                        <span class="comment">// 客户端发送请求，获取响应对象</span></span><br><span class="line">                        <span class="type">val</span> <span class="variable">response</span> <span class="operator">=</span> client.index(request,RequestOptions.DEFAULT);</span><br><span class="line">                        System.out.println(<span class="string">&quot;_index:&quot;</span> + response.getIndex());</span><br><span class="line">                        System.out.println(<span class="string">&quot;_id:&quot;</span> + response.getId());</span><br><span class="line">                        System.out.println(<span class="string">&quot;_result:&quot;</span> + response.getResult());</span><br><span class="line"></span><br><span class="line">                        client.close()</span><br><span class="line">                    &#125;</span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        ssc.start()</span><br><span class="line">        ssc.awaitTermination()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h1 id="Flink-框架集成"><a href="#Flink-框架集成" class="headerlink" title="Flink 框架集成"></a>Flink 框架集成</h1><h2 id="Flink-框架介绍"><a href="#Flink-框架介绍" class="headerlink" title="Flink 框架介绍"></a>Flink 框架介绍</h2><p><code>Apache Spark</code>是一种基于内存的快速、通用、可扩展的大数据分析计算引擎。</p><p><code>Apache Spark</code>掀开了内存计算的先河，以内存作为赌注，赢得了内存计算的飞速发展。但是在其火热的同时，开发人员发现，在<code>Spark</code>中，计算框架普遍存在的缺点和不足依然没有完全解决，而这些问题随着<code>5G</code>时代的来临以及决策者对实时数据分析结果的迫切需要而凸显的更加明显：</p><ul><li>数据精准一次性处理（<code>Exactly-Once</code>）</li><li>乱序数据，迟到数据</li><li>低延迟，高吞吐，准确性</li><li>容错性</li></ul><p><code>Apache Flink</code>是一个框架和分布式处理引擎，用于对无界和有界数据流进行有状态计算。在<code>Spark</code>火热的同时，也默默地发展自己，并尝试着解决其他计算框架的问题。</p><p>慢慢地，随着这些问题的解决，<code>Flink</code>慢慢被绝大数程序员所熟知并进行大力推广，阿里公司在  $2015$ 年改进<code>Flink</code>，并创建了内部分支<code>Blink</code>，目前服务于阿里集团内部搜索、推荐、广告和蚂蚁等大量核心实时业务。</p><h2 id="框架集成-2"><a href="#框架集成-2" class="headerlink" title="框架集成"></a>框架集成</h2><ol><li>创建<code>Maven</code>项目</li><li>修改<code>pom</code>文件，增加相关依赖类库 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ESFlink<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>ESFlink<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- FIXME change it to the project&#x27;s website --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://www.example.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-scala_2.12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-streaming-scala_2.12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-clients_2.12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-elasticsearch7_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- jackson --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.11.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginManagement</span>&gt;</span><span class="comment">&lt;!-- lock down plugins versions to avoid using Maven defaults (may be moved to parent pom) --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- clean lifecycle, see https://maven.apache.org/ref/current/maven-core/lifecycles.html#clean_Lifecycle --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-clean-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- default lifecycle, jar packaging: see https://maven.apache.org/ref/current/maven-core/default-bindings.html#Plugin_bindings_for_jar_packaging --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-resources-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.22.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-install-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-deploy-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- site lifecycle, see https://maven.apache.org/ref/current/maven-core/lifecycles.html#site_Lifecycle --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-site-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-project-info-reports-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li>功能实现 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.RuntimeContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStreamSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.elasticsearch.ElasticsearchSinkFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.elasticsearch.RequestIndexer;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.elasticsearch7.ElasticsearchSink;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.Requests;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList; <span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlinkElasticsearchSinkTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构建 Flink 环境对象</span></span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span><span class="variable">env</span><span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// source：数据的输入</span></span><br><span class="line">        DataStreamSource&lt;String&gt; source = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;HttpHost&gt; httpHosts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        httpHosts.add(<span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>));</span><br><span class="line">        <span class="comment">//httpHosts.add(new HttpHost(&quot;10.2.3.1&quot;, 9200, &quot;http&quot;));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 ESBuilder 构建输出</span></span><br><span class="line">        <span class="comment">// use a ElasticsearchSink.Builder to create an ElasticsearchSink</span></span><br><span class="line">        ElasticsearchSink.Builder&lt;String&gt; esSinkBuilder= <span class="keyword">new</span> <span class="title class_">ElasticsearchSink</span>.Builder&lt;&gt;(httpHosts,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ElasticsearchSinkFunction</span>&lt;String&gt;() &#123;</span><br><span class="line">                    <span class="keyword">public</span> IndexRequest <span class="title function_">createIndexRequest</span><span class="params">(String element)</span> &#123;</span><br><span class="line">                        Map&lt;String, String&gt; json = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                        json.put(<span class="string">&quot;data&quot;</span>, element);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> Requests.indexRequest().index(<span class="string">&quot;my-index&quot;</span>)</span><br><span class="line">                                <span class="comment">//.type(&quot;my-type&quot;)</span></span><br><span class="line">                                .source(json);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(String element, RuntimeContext ctx, RequestIndexer indexer)</span> &#123;</span><br><span class="line">                        indexer.add(createIndexRequest(element));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// configuration for the bulk requests; this instructs the sink to emit after every element, otherwise they would be buffered</span></span><br><span class="line">        esSinkBuilder.setBulkFlushMaxActions(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// provide a RestClientFactory for custom configuration on the internally created REST client</span></span><br><span class="line">        <span class="comment">//esSinkBuilder.setRestClientFactory(</span></span><br><span class="line">        <span class="comment">//restClientBuilder -&gt; &#123;</span></span><br><span class="line">        <span class="comment">//restClientBuilder.setDefaultHeaders(...)</span></span><br><span class="line">        <span class="comment">//restClientBuilder.setMaxRetryTimeoutMillis(...)</span></span><br><span class="line">        <span class="comment">//restClientBuilder.setPathPrefix(...)</span></span><br><span class="line">        <span class="comment">//restClientBuilder.setHttpClientConfigCallback(...)</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line">        <span class="comment">//);</span></span><br><span class="line">        <span class="comment">// Sink：数据的输出</span></span><br><span class="line">        source.addSink(esSinkBuilder.build()); env.execute(<span class="string">&quot;flink-es&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ElasticSearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Elasticsearch 进阶</title>
      <link href="/2021/10/17/ElasticSearch/04.Elasticsearch%20%E8%BF%9B%E9%98%B6/"/>
      <url>/2021/10/17/ElasticSearch/04.Elasticsearch%20%E8%BF%9B%E9%98%B6/</url>
      
        <content type="html"><![CDATA[<h1 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h1><h2 id="索引（Index）"><a href="#索引（Index）" class="headerlink" title="索引（Index）"></a>索引（Index）</h2><p>一个索引就是一个拥有几分相似特征的文档的集合。比如说，可以有一个客户数据的索引，一个产品目录的索引，还有一个订单数据的索引。</p><p>一个索引由一个名字来标识（必须全部是小写字母），并且当要对这个索引中的文档进行索引、搜索、更新和删除时，都要使用到这个名字。</p><p>在一个集群中，可以定义任意多的索引。</p><p>能搜索的数据必须索引，这样的好处是可以提高查询速度，比如：新华字典前面的目录就是索引的意思，目录可以提高查询速度。</p><p><strong><code>Elasticsearch</code>索引的精髓：一切设计都是为了提高搜索的性能</strong>。</p><h2 id="类型（Type）"><a href="#类型（Type）" class="headerlink" title="类型（Type）"></a>类型（Type）</h2><p>在一个索引中可以定义一种或多种类型。</p><p>一个类型是索引的一个逻辑上的分类/分区，其语义完全由自己来定。通常会为具有一组共同字段的文档定义一个类型。</p><p>不同的版本，类型发生了不同的变化。</p><table><thead><tr><th>版本</th><th>Type</th></tr></thead><tbody><tr><td>5.x</td><td>支持多种<code>type</code></td></tr><tr><td>6.x</td><td>只能有一种<code>type</code></td></tr><tr><td>7.x</td><td>默认不再支持自定义索引类型（默认类型为<code>_doc</code>）</td></tr></tbody></table><h2 id="文档（Document）"><a href="#文档（Document）" class="headerlink" title="文档（Document）"></a>文档（Document）</h2><p>一个文档是一个可被索引的基础信息单元，也就是一条数据。</p><p>比如：可以拥有某一个客户的文档，某一个产品的一个文档，当然，也可以拥有某个订单的一个文档。文档以<code>JSON</code>（<code>Javascript Object Notation</code>）格式来表示，而<code>JSON</code>是一个到处存在的互联网数据交互格式。</p><p>在一个<code>index/type</code>里面可以存储任意多的文档。</p><h2 id="字段（Field）"><a href="#字段（Field）" class="headerlink" title="字段（Field）"></a>字段（Field）</h2><p>相当于是数据表的字段，对文档数据根据不同属性进行的分类标识。</p><h2 id="映射（Mapping）"><a href="#映射（Mapping）" class="headerlink" title="映射（Mapping）"></a>映射（Mapping）</h2><p><code>mapping</code>是处理数据的方式和规则方面做一些限制，如：某个字段的数据类型、默认值、分析器、是否被索引等等。</p><p>这些都是映射里面可以设置的，其它就是处理<code>ES</code>里面数据的一些使用规则设置也叫做映射，按着最优规则处理数据对性能提高很大，因此才需要建立映射，并且需要思考如何建立映射才能对性能更好。</p><h2 id="分片（Shards）"><a href="#分片（Shards）" class="headerlink" title="分片（Shards）"></a>分片（Shards）</h2><p>一个索引可以存储超出单个节点硬件限制的大量数据。</p><p>比如，一个具有 $10$ 亿文档数据的索引占据 $1TB$的磁盘空间，而任一节点都可能没有这样大的磁盘空间，或者单个节点处理搜索请求，响应太慢。</p><p>为了解决这个问题，<code>Elasticsearch</code>提供了将索引划分成多份的能力，每一份就称之为分片。当创建一个索引的时候，可以指定想要的分片的数量。每个分片本身也是一个功能完善并且独立的“索引”，这个“索引”可以被放置到集群中的任何节点上。</p><p>分片很重要，主要有两方面的原因：</p><ol><li>允许你水平分割 / 扩展你的内容容量</li><li>允许你在分片之上进行分布式的、并行的操作，进而提高性能/吞吐量</li></ol><p>至于一个分片怎样分布，它的文档怎样聚合和搜索请求，是完全由<code>Elasticsearch</code>管理的，对于作为用户的人来说，这些都是透明的，无需过分关心。</p><p><strong>被混淆的概念是，一个<code>Lucene</code>索引——在<code>Elasticsearch</code>称作分片。一个<code>Elasticsearch</code>索引是分片的集合。 当<code>Elasticsearch</code>在索引中搜索的时候， 它发送查询到每一个属于索引的分片（<code>Lucene</code>索引），然后合并每个分片的结果到一个全局的结果集</strong>。</p><h2 id="副本（Replicas）"><a href="#副本（Replicas）" class="headerlink" title="副本（Replicas）"></a>副本（Replicas）</h2><p>在一个网络 / 云的环境里，失败随时都可能发生，在某个分片/节点不知怎么的就处于离线状态，或者由于任何原因消失了，这种情况下，有一个故障转移机制是非常有用并且是强烈推荐的。为此目的，<code>Elasticsearch</code>允许创建分片的一份或多份拷贝，这些拷贝叫做复制分片(副本)。</p><p>复制分片之所以重要，有两个主要原因：</p><ul><li>在分片/节点失败的情况下，提供了高可用性。因为这个原因，注意到复制分片从不与原/主要（<code>original/primary</code>）分片置于同一节点上是非常重要的。</li><li>Ø  扩展你的搜索量/吞吐量，因为搜索可以在所有的副本上并行运行。</li></ul><p>总之，每个索引可以被分成多个分片。</p><p>一个索引也可以被复制 $0$ 次（意思是没有复制）或多次。一旦复制了，每个索引就有了主分片（作为复制源的原来的分片）和复制分片（主分片的拷贝）之别。分片和复制的数量可以在索引创建的时候指定。在索引创建之后，可以在任何时候动态地改变复制的数量，但是事后不能改变分片的数量。</p><p>默认情况下，<code>Elasticsearch</code>中的每个索引被分片 $1$ 个主分片和 $1$ 个复制，这意味着，如果集群中至少有两个节点，索引将会有 $1$ 个主分片和另外 $1$ 个复制分片（$1$ 个完全拷贝），这样的话</p><p>每个索引总共就有 $2$ 个分片，我们需要根据索引需要确定分片个数。</p><h2 id="分配（Allocation）"><a href="#分配（Allocation）" class="headerlink" title="分配（Allocation）"></a>分配（Allocation）</h2><p>将分片分配给某个节点的过程，包括分配主分片或者副本。如果是副本，还包含从主分片复制数据的过程。这个过程是由<code>master</code>节点完成的。</p><h1 id="系统架构"><a href="#系统架构" class="headerlink" title="系统架构"></a>系统架构</h1><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826347-287f5615.png"></p></div><p>一个运行中的<code>Elasticsearch</code>实例称为一个节点，而集群是由一个或者多个拥有相同<code>cluster.name</code>配置的节点组成， 它们共同承担数据和负载的压力。</p><p>当有节点加入集群中或者从集群中移除节点时，集群将会重新平均分布所有的数据。</p><p>当一个节点被选举成为主节点时， 它将负责管理集群范围内的所有变更，例如增加、删除索引，或者增加、删除节点等。  </p><p>而主节点并不需要涉及到文档级别的变更和搜索等操作，所以当集群只拥有一个主节点的情况下，即使流量的增加它也不会成为瓶颈。</p><p>任何节点都可以成为主节点。示例集群就只有一个节点，所以它同时也成为了主节点。</p><p>作为用户，可以将请求发送到集群中的任何节点，包括主节点。 </p><p>每个节点都知道任意文档所处的位置，并且能够将请求直接转发到存储所需文档的节点。无论将请求发送到哪个节点，它都能负责从各个包含所需文档的节点收集回数据，并将最终结果返回給客户端。</p><p><code>Elasticsearch</code>对这一切的管理都是透明的。</p><h1 id="分布式集群"><a href="#分布式集群" class="headerlink" title="分布式集群"></a>分布式集群</h1><h2 id="单节点集群"><a href="#单节点集群" class="headerlink" title="单节点集群"></a>单节点集群</h2><p>在包含一个空节点的集群内创建名为<code>users</code>的索引，为了演示目的，将分配 $3$ 个主分片和一份副本（每个主分片拥有一个副本分片）。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;number_of_shards&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;number_of_replicas&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826389-2a96694e.png"></p></div><p>集群现在是拥有一个索引的单节点集群。所有 $3$ 个主分片都被分配在<code>node-1</code>。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826412-8ccdb9a8.png"></p></div><p>通过<code>Elasticsearch Head</code>插件查看集群情况：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826438-8beccf33.png"></p></div><ul><li>集群健康值<code>yellow (3 of 6)</code> : 表示当前集群的全部主分片都正常运行，但是副本分片没有全部处在正常状态</li><li><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826460-494733a4.png">：$3$ 个主分片正常</li><li><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826493-b4fdc852.png">：$3$ 个副本分片都是<code>Unassigned</code>—— 它们都没有被分配到任何节点。 在同一个节点上既保存原始数据又保存副本是没有意义的，因为一旦失去了那个节点，也将丢失该节点上的所有副本数据。</li></ul><p>当前集群是正常运行的，但是在硬件故障时有丢失数据的风险。</p><h2 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h2><p>当集群中只有一个节点在运行时，意味着会有一个单点故障问题——没有冗余。 </p><p>幸运的是，只需再启动一个节点即可防止数据丢失。</p><p>当在同一台机器上启动了第二个节点时，只要它和第一个节点有同样的<code>cluster.name</code>配置，它就会自动发现集群并加入到其中。但是在不同机器上启动节点的时候，为了加入到同一集群，需要配置一个可连接到的单播主机列表。之所以配置为使用单播发现，以防止节点无意中加入集群。只有在同一台机器上运行的节点才会自动组成集群。</p><p>如果启动了第二个节点，我们的集群将会拥有两个节点的集群</p><p>所有主分片和副本分片都已被分配：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826535-2e5a15b4.png"></p></div><p>通过<code>Elasticsearch Head</code>插件查看集群情况：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826560-af7dc74f.png"></p></div><ul><li>**集群健康值 : green (6 of 6)**：表示所有 $6$ 个分片（包括 $3$ 个主分片和 $3$ 个副本分片）都在正常运行</li><li><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826582-dd8c76ca.png">：$3$ 个主分片正常</li><li><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826603-c7be1ae7.png">：当第二个节点加入到集群后，$3$ 个副本分片将会分配到这个节点上——每个主分片对应一个副本分片。这意味着当集群内任何一个节点出现问题时，数据都完好无损。所有新近被索引的文档都将会保存在主分片上，然后被并行的复制到对应的副本分片上。这就保证了既可以从主分片又可以从副本分片上获得文档。</li></ul><h2 id="水平扩容"><a href="#水平扩容" class="headerlink" title="水平扩容"></a>水平扩容</h2><p>怎样为正在增长中的应用程序按需扩容呢？</p><p>当启动了第三个节点，集群将会拥有三个节点的集群 : 为了分散负载而对.分片进行重新分配。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826631-7f6586cf.png"></p></div><p>通过<code>Elasticsearch Head</code>插件查看集群情况：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826657-06c01416.png"></p></div><p><code>集群健康值 : green (6 of 6)</code>：表示所有 $6$ 个分片（包括 $3$ 个主分片和 $3$ 个副本分片）都在正常运行</p><p><code>node-1</code>和<code>node-2</code>上各有一个分片被迁移到了新的<code>node-3</code>节点，现在每个节点上都拥有 $2$ 个分片， 而不是之前的 $3$ 个。 这表示每个节点的硬件资源（<code>CPU</code>，<code>RAM</code>，<code>I/O</code>）将被更少的分片所共享，每个分片的性能将会得到提升。</p><p>分片是一个功能完整的搜索引擎，它拥有使用一个节点上的所有资源的能力。这个拥有 $6$ 个分片（$3$ 个主分片和 $3$ 个副本分片）的索引可以最大扩容到 $6$ 个节点，每个节点上存在一个分片，并且每个分片拥有所在节点的全部资源。</p><p><strong>但是如果想要扩容超过 $6$ 个节点怎么办呢</strong>？</p><p>主分片的数目在索引创建时就已经确定了下来。实际上，这个数目定义了这个索引能够存储的最大数据量（实际大小取决于数据、硬件和使用场景）。</p><p>但是，读操作——搜索和返回数据——可以同时被主分片或副本分片所处理，所以当拥有越多的副本分片时，也将拥有越高的吞吐量。</p><p>在运行中的集群上是可以动态调整副本分片数目的，可以按需伸缩集群。</p><p>先把副本数从默认的 $1$ 增加到 $2$。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826724-09ad5d75.png"></p></div><p><code>users</code>索引现在拥有 $9$ 个分片：$3$ 个主分片和 $6$ 个副本分片。这意味着可以将集群扩容到 $9$ 个节点，每个节点上一个分片。相比原来 $3$ 个节点时，集群搜索性能可以提升 $3$ 倍。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826746-20c62458.png"></p></div><p>通过<code>Elasticsearch Head</code>插件查看集群情况：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826774-2f4cad19.png"></p></div><p>当然，如果只是在相同节点数目的集群上增加更多的副本分片并不能提高性能，因为每个分片从节点上获得的资源会变少。 你需要增加更多的硬件资源来提升吞吐量。</p><p>但是更多的副本分片数提高了数据冗余量：按照上面的节点配置，我们可以在失去 $2$ 个节点的情况下不丢失任何数据。</p><h2 id="应对故障"><a href="#应对故障" class="headerlink" title="应对故障"></a>应对故障</h2><p>关闭第一个节点，这时集群的状态为：关闭了一个节点后的集群。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826814-d635f690.png"></p></div><p>关闭的节点是一个主节点。而集群必须拥有一个主节点来保证正常工作，所以发生的第一件事情就是选举一个新的主节点：<code>node-2</code>。在关闭<code>node-1</code>的同时也失去了主分片 $1$ 和 $2$，并且在缺失主分片的时候索引也不能正常工作。  </p><p>如果此时来检查集群的状况，看到的状态将会为<code>red</code>：不是所有主分片都在正常工作。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639826841-7b553107.png"></p></div><p>幸运的是，在其它节点上存在着这两个主分片的完整副本， 所以新的主节点立即将这些分片在<code>node-2</code>和<code>node-3</code>上对应的副本分片提升为主分片，此时集群的状态将会为<code>yellow</code>。这个提升主分片的过程是瞬间发生的，如同按下一个开关一般。</p><p><strong>为什么集群状态是<code>yellow</code>而不是<code>green</code>呢</strong>？</p><p>虽然拥有所有的三个主分片，但是同时设置了每个主分片需要对应 $2$ 份副本分片，而此时只存在一份副本分片，所以集群不能为<code>green</code>的状态。</p><p>不过不必过于担心：如果同样关闭了<code>node-2</code>，程序依然可以保持在不丢任何数据的情况下运行，因为<code>node-3</code>为每一个分片都保留着一份副本。</p><p>如果重新启动<code>node-1</code>，集群可以将缺失的副本分片再次进行分配，那么集群的状态也将恢复成之前的状态。 如果<code>node-1</code>依然拥有着之前的分片，它将尝试去重用它们，同时仅从主分片复制发生了修改的数据文件。和之前的集群相比，只是<code>master</code>节点切换了。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639827636-176cf0cc.png"></p></div><h1 id="路由计算"><a href="#路由计算" class="headerlink" title="路由计算"></a>路由计算</h1><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639827744-99398bec.png"></p></div><p>当索引一个文档的时候，文档会被存储到一个主分片中。</p><p><code>Elasticsearch</code>如何知道一个文档应该存放到哪个分片中呢？当创建文档时，它如何决定这个文档应当被存储在分片 $1$ 还是分片 $2$ 中呢？</p><p>首先这肯定不会是随机的，否则将来要获取文档时就不知道从何处寻找了。实际上，这个过程是根据下面这个公式决定的：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shard = hash(routing) % number_of_primary_shard</span><br></pre></td></tr></table></figure><p><code>routing</code>是一个可变值，默认是文档的<code>_id</code>，也可以设置成一个自定义的值。<code>routing</code>通过</p><p><code>hash</code>函数生成一个数字，然后这个数字再除以<code>number_of_primary_shards</code>（主分片的数量）后得到余数。这个分布在 $0$ 到<code>number_of_primary_shards-1</code>之间的余数，就是所寻求的文档所在分片的位置。</p><p>这就解释了为什么要在创建索引的时候就确定好主分片的数量并且永远不会改变这个数量：因为如果数量变化了，那么所有之前路由的值都会无效，文档也再也找不到了。</p><p>所有的文档<code>API</code>（<code>get</code>、<code>index</code>、<code>delete</code>、<code>bulk</code>、<code>update</code>以及<code>mget</code>）都接受一个叫做<code>routing</code>的路由参数 ，通过这个参数可以自定义文档到分片的映射。一个自定义的路由参数可以用来确保所有相关的文档——例如所有属于同一个用户的文档——都被存储到同一个分片中。</p><h1 id="分片控制"><a href="#分片控制" class="headerlink" title="分片控制"></a>分片控制</h1><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639827809-f22aabe8.png"></p></div><p>假设有一个集群由三个节点组成。 它包含一个叫<code>emps</code>的索引，有两个主分片，每个主分片有两个副本分片。相同分片的副本不会放在同一节点。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;setting&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;number_of_shards&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;number_of_replicas&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639827837-f1c4fbd2.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639827850-7f74643c.png"></p></div><p>通过<code>Elasticsearch Head</code>插件查看集群情况，集群是一个有三个节点和一个索引的集群。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639827876-5c3c9c7d.png"></p></div><p>可以发送请求到集群中的任一节点。  </p><p>每个节点都有能力处理任意请求。 每个节点都知道集群中任一文档位置，所以可以直接将请求转发到需要的节点上。</p><p>在下面的例子中，将所有的请求发送到<code>node-1</code>，将其称为<strong>协调节点</strong>（<code>coordinating node</code>）。</p><p><strong>当发送请求的时候，为了扩展负载，更好的做法是轮询集群中所有的节点。</strong></p><h3 id="写流程"><a href="#写流程" class="headerlink" title="写流程"></a>写流程</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639827945-e402a7a1.png"></p></div><p>新建、索引和删除请求都是写操作，必须在主分片上面完成之后才能被复制到相关的副本分片。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828012-079984de.png"></p></div><p><strong>新建，索引和删除文档所需要的步骤顺序</strong>：</p><ol><li>客户端向<code>node-1</code>发送新建、索引或者删除请求。</li><li>节点使用文档的<code>_id</code>确定文档属于分片 $0$。请求会被转发到<code>node-3</code>，因为分片 $0$ 的主分片目前被分配在<code>node-3</code>上。</li><li><code>node-3</code>在主分片上面执行请求。如果成功了，它将请求并行转发到<code>node-1</code>和<code>node-2</code>的副本分片上。一旦所有的副本分片都报告成功，<code>node-3</code>将向协调节点报告成功，协调节点向客户端报告成功。</li></ol><p>在客户端收到成功响应时，文档变更已经在主分片和所有副本分片执行完成，变更是安全的。有一些可选的请求参数允许您影响这个过程，可能以数据安全为代价提升性能。</p><p>这些选项很少使用，因为<code>Elasticsearch</code>已经很快，但是为了完整起见，请参考下面表格：</p><table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>consistency</td><td><code>consistency</code>，即一致性。<br />在默认设置下，即使仅仅是在试图执行一个写操作之前，主分片都会要求必须要有规定数量（<code>quorum</code>）（或者换种说法，也即必须要有大多数）的分片副本处于活跃可用状态，才会去执行写操作（其中分片副本可以是主分片或者副本分片）。这是为了避免在发生网络分区故障（<code>networkpartition</code>）的时候进行写操作，进而导致数据不一致。<br />规定数量即：<br /><code>int((primary+number_of_replicas)/2)+1&lt;br /&gt;</code><br />consistency参数的值可以设为：<code>one</code>（只要主分片状态<code>ok</code>就允许执行写操作）,<code>all</code>（必须要主分片和所有副本分片的状态没问题才允许执行写操作）,<br />或<code>quorum</code>。默认值为<code>quorum</code>, 即大多数的分片副本状态没问题就允许执行写操作。<br />注意，规定数量的计算公式中<code>number_of_replicas</code>指的是在索引设置中的设定副本分片数，而不是指当前处理活动状态的副本分片数。如果索引设置中指定了当前索引拥有三个副本分片，那规定数量的计算结果即：<br /><code>int((primary+3 replicas)/2 )+1=3</code><br />如果此时只启动两个节点，那么处于活跃状态的分片副本数量就达不到规定数量，也因此将无法索引和删除任何文档。<br /></td></tr><tr><td>timeout</td><td>如果没有足够的副本分片会发生什么？<br /><code>Elasticsearch</code>会等待，希望更多的分片出现。<br />默认情况下，它最多等待 $1$ 分钟。如果需要，可以使用<code>timeout</code>参数使它更早终止： 100ms：100毫秒，30s是 30秒。<br /></td></tr></tbody></table><p>新索引默认有 $1$ 个副本分片，这意味着为满足规定数量应该需要两个活动的分片副本。但是，这些默认的设置会阻止在单一节点上做任何事情。</p><p>为了避免这个问题，要求只有当<code>number_of_replicas</code>大于 $1$ 的时候，规定数量才会执行。</p><h3 id="读流程"><a href="#读流程" class="headerlink" title="读流程"></a>读流程</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828089-0da8743e.png"></p></div><p>可以从主分片或者从其它任意副本分片检索文档：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828114-0e9e77e7.png"></p></div><p><strong>从主分片或者副本分片检索文档的步骤顺序</strong>：</p><ol><li>客户端向<code>node-1</code>发送获取请求。</li><li>节点使用文档的<code>_id</code>来确定文档属于分片 $0$。分片 $0$ 的副本分片存在于所有的三个节点上。 在这种情况下，它将请求转发到<code>node-2</code>。</li><li><code>node-2</code>将文档返回给<code>node-1</code>，然后将文档返回给客户端。</li></ol><p>在处理读取请求时，协调结点在每次请求的时候都会通过轮询所有的副本分片来达到负载均衡。</p><p>在文档被检索时，已经被索引的文档可能已经存在于主分片上但是还没有复制到副本分片。</p><p>在这种情况下，副本分片可能会报告文档不存在，但是主分片可能成功返回文档。  </p><p>一旦索引请求成功返回给用户，文档在主分片和副本分片都是可用的。</p><h3 id="更新流程"><a href="#更新流程" class="headerlink" title="更新流程"></a>更新流程</h3><p>部分更新一个文档结合了先前说明的读取和写入流程：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828145-fb5d4bc4.png"></p></div><p><strong>部分更新一个文档的步骤如下</strong>：</p><ol><li>客户端向<code>node-1</code>发送更新请求。</li><li>它将请求转发到主分片所在的<code>node-3</code>。</li><li><code>node-3</code>从主分片检索文档，修改<code>_source</code>字段中的<code>JSON</code>，并且尝试重新索引主分片的文档。如果文档已经被另一个进程修改，它会重试步骤 $3$，超过<code>retry_on_conflict</code>次后放弃。</li><li>如果<code>node-3</code>成功地更新文档，它将新版本的文档并行转发到<code>node-1</code>和<code>node-2</code>上的副本分片，重新建立索引。一旦所有副本分片都返回成功，<code>node-3</code>向协调节点也返回成功，协调节点向客户端返回成功。</li></ol><p>当主分片把更改转发到副本分片时，它不会转发更新请求。相反，它转发完整文档的新版本。请记住，这些更改将会异步转发到副本分片，并且不能保证它们以发送它们相同的顺序到达。  </p><p>如果<code>Elasticsearch</code>仅转发更改请求，则可能以错误的顺序应用更改，导致得到损坏的文档。</p><h3 id="多文档操作流程"><a href="#多文档操作流程" class="headerlink" title="多文档操作流程"></a>多文档操作流程</h3><p><code>mget</code>和<code>bulkAPI</code>的模式类似于单文档模式。区别在于协调节点知道每个文档存在于哪个分片中。它将整个多文档请求分解成每个分片的多文档请求，并且将这些请求并行转发到每个参与节点。</p><p>协调节点一旦收到来自每个节点的应答，就将每个节点的响应收集整理成单个响应，返回给客户端。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828183-18eaa11b.png"></p></div><p><strong>用单个<code>mget</code>请求取回多个文档所需的步骤顺序</strong>：</p><ol><li>客户端向<code>node-1</code>发送<code>mget</code>请求。</li><li><code>node-1</code>为每个分片构建多文档获取请求，然后并行转发这些请求到托管在每个所需的主分片或者副本分片的节点上。一旦收到所有答复，<code>node-1</code>构建响应并将其返回给客户端。</li></ol><p>可以对<code>docs</code>数组中每个文档设置<code>routing</code>参数。</p><p><code>bulk API</code>：允许在单个批量请求中执行多个创建、索引、删除和更新请求。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828209-3a6671fa.png"></p></div><p><strong><code>bulk API</code>按如下步骤顺序执行</strong>：</p><ol><li>客户端向<code>node-1</code>发送<code>bulk</code>请求。</li><li><code>node-1</code>为每个节点创建一个批量请求，并将这些请求并行转发到每个包含主分片的节点主机。</li><li>主分片一个接一个按顺序执行每个操作。当每个操作成功时，主分片并行转发新文档（或删除）到副本分片，然后执行下一个操作。 一旦所有的副本分片报告所有操作成功，该节点将向协调节点报告成功，协调节点将这些响应收集整理并返回给客户端。</li></ol><h1 id="分片原理"><a href="#分片原理" class="headerlink" title="分片原理"></a>分片原理</h1><p>分片是<code>Elasticsearch</code>最小的工作单元。但是究竟什么是一个分片，它是如何工作的？</p><p>传统的数据库每个字段存储单个值，但这对全文检索并不够。文本字段中的每个单词需要被搜索，对数据库意味着需要单个字段有索引多值的能力。最好的支持是一个字段多个值需求的数据结构是倒排索引。</p><h2 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h2><p><code>Elasticsearch</code>使用一种称为<strong>倒排索引</strong>的结构，它适用于快速的全文搜索。</p><p>见其名，知其意，有倒排索引，肯定会对应有正向索引。正向索引（<code>forward index</code>），反向索引（<code>inverted index</code>）更熟悉的名字是倒排索引。</p><p>所谓的正向索引，就是搜索引擎会将待搜索的文件都对应一个文件<code>ID</code>，搜索时将这个<code>ID</code>和搜索关键字进行对应，形成<code>K-V</code>对，然后对关键字进行统计计数。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828246-dd8dff5b.png"></p></div><p>但是互联网上收录在搜索引擎中的文档的数目是个天文数字，这样的索引结构根本无法满足实时返回排名结果的要求。</p><p>所以，搜索引擎会将正向索引重新构建为倒排索引，即把文件<code>ID</code>对应到关键词的映射转换为关键词到文件<code>ID</code>的映射，每个关键词都对应着一系列的文件，这些文件中都出现这个关键词。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828269-6224b4a9.png"></p></div><p>一个倒排索引由文档中所有不重复词的列表构成，对于其中每个词，有一个包含它的文档列表。例如，假设我们有两个文档，每个文档的<code>content</code>域包含如下内容：</p><ul><li><code>The quick brown fox jumped over the lazy dog</code></li><li><code>Quick brown foxes leap over lazy dogs in summer</code></li></ul><p>为了创建倒排索引，首先将每个文档的<code>content</code>域拆分成单独的词（称它为词条或<code>tokens</code>）。</p><ul><li>词条：索引中最小存储和查询单元</li><li>词典：字典，词条的集合，<code>B+ Tree</code>，<code>HashMap</code></li></ul><p>创建一个包含所有不重复词条的排序列表，然后列出每个词条出现在哪个文档，结果如下所示：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828302-32e228c7.png"></p></div><p>现在，如果我们想搜索<code>quick brown</code>，只需要查找包含每个词条的文档：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828323-25a39983.png"></p></div><p>两个文档都匹配，但是第一个文档比第二个匹配度更高。如果使用仅计算匹配词条数量的简单相似性算法，那么可以说，对于查询的相关性来讲，第一个文档比第二个文档更佳。</p><p>但是，目前的倒排索引有一些问题：</p><ul><li><code>Quick</code>和<code>quick</code>以独立的词条出现，然而用户可能认为它们是相同的词</li><li><code>fox</code>和<code>foxes</code>非常相似，就像<code>dog</code>和<code>dogs</code>；它们有相同的词根</li><li><code>jumped</code>和<code>leap</code>尽管没有相同的词根，但它们的意思很相近，是同义词</li></ul><p>使用前面的索引搜索<code>+Quick +fox</code>不会得到任何匹配文档（记住，<code>+</code>前缀表明这个词必须存在）。只有同时出现<code>Quick</code>和<code>fox</code>的文档才满足这个查询条件，但是第一个文档包含<code>quick fox</code>，第二个文档包含<code>Quick foxes</code>。</p><p>用户可以合理的期望两个文档与查询匹配。我们可以做的更好。</p><p>如果将词条规范为标准模式，那么可以找到与用户搜索的词条不完全一致，但具有足够相关性的文档。例如：</p><ul><li><code>Quick</code>可以小写化为<code>quick</code><br /></li><li><code>foxes</code>可以词干提取——变为词根的格式——为<code>fox</code>。类似的，<code>dogs</code>可以为提取为<code>dog</code>。<br /></li><li><code>jumped</code>和<code>leap</code>是同义词，可以索引为相同的单词<code>jump</code>。</li></ul><p>现在索引看上去像这样：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828361-94add718.png"></p></div><p>这还远远不够。搜索<code>+Quick +fox</code>仍然会失败，因为在索引中已经没有<code>Quick</code>了。但是，如果对搜索的字符串使用与<code>content</code>域相同的标准化规则，会变成查询<code>+quick +fox</code>，这样两个文档都会匹配！分词和标准化的过程称为<strong>分析</strong>。</p><p>这非常重要。你只能搜索在索引中出现的词条，所以索引文本和查询字符串必须标准化为相同的格式。</p><h2 id="文档搜索"><a href="#文档搜索" class="headerlink" title="文档搜索"></a>文档搜索</h2><p>早期的全文检索会为整个文档集合建立一个很大的倒排索引并将其写入到磁盘。 一旦新的索引就绪，旧的就会被其替换，这样最近的变化便可以被检索到。</p><p>倒排索引被写入磁盘后是不可改变的：它永远不会修改。</p><p>不变性有重要的价值：</p><ul><li>不需要锁。如果你从来不更新索引，你就不需要担心多进程同时修改数据的问题。</li><li>一旦索引被读入内核的文件系统缓存，便会留在哪里，由于其不变性。只要文件系统缓存中还有足够的空间，那么大部分读请求会直接请求内存，而不会命中磁盘。这提供了很大的性能提升。</li><li>其它缓存（像filter缓存），在索引的生命周期内始终有效。它们不需要在每次数据改变时被重建，因为数据不会变化。</li><li>写入单个大的倒排索引允许数据被压缩，减少磁盘<code>I/O</code>和需要被缓存到内存的索引的使用量。</li></ul><p>当然，一个不变的索引也有不好的地方。主要事实是它是不可变的! 不能修改它。</p><p>如果需要让一个新的文档可被搜索，需要重建整个索引。这要么对一个索引所能包含的数据量造成了很大的限制，要么对索引可被更新的频率造成了很大的限制。</p><h3 id="动态更新索引"><a href="#动态更新索引" class="headerlink" title="动态更新索引"></a>动态更新索引</h3><p>如何在保留不变性的前提下实现倒排索引的更新？</p><p>答案是: 用更多的索引。通过增加新的补充索引来反映新近的修改，而不是直接重写整个倒排索引。每一个倒排索引都会被轮流查询到，从最早的开始查询完后再对结果进行合并。</p><p><code>Elasticsearch</code>基于<code>Lucene</code>，这个<code>java</code>库引入了<strong>按段搜索</strong>的概念。每一 段本身都是一个倒排索引，但索引在<code>Lucene</code>中除表示所有段的集合外，还增加了提交点的概念——一个列出了所有已知段的文件。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828408-8c18cc47.png"></p></div><p><strong>按段搜索</strong>会以如下流程执行：</p><ol><li>新文档被收集到内存索引缓存<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828426-82827a27.png"></li><li>不时地，缓存被提交<ol><li>一个新的段——一个追加的倒排索引—被写入磁盘</li><li>一个新的包含新段名字的 提交点 被写入磁盘</li><li>磁盘进行同步——所有在文件系统缓存中等待的写入都刷新到磁盘，以确保它们被写入物理文件</li></ol></li><li>新的段被开启，让它包含的文档可见以被搜索</li><li>内存缓存被清空，等待接收新的文档<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828445-218cda2e.png"></li></ol><p>当一个查询被触发，所有已知的段按顺序被查询。词项统计会对所有段的结果进行聚合，以保证每个词和每个文档的关联都被准确计算。这种方式可以用相对较低的成本将新文档添加到索引。</p><p>段是不可改变的，所以既不能从把文档从旧的段中移除，也不能修改旧的段来进行反映文档的更新。 取而代之的是，每个提交点会包含一个<code>.del</code>文件，文件中会列出这些被删除文档的段信息。</p><p>当一个文档被 “删除” 时，它实际上只是在<code>.del</code>文件中被标记删除。一个被标记删除的文档仍然可以被查询匹配到， 但它会在最终结果被返回前从结果集中移除。</p><p>文档更新也是类似的操作方式：当一个文档被更新时，旧版本文档被标记删除，文档的新版本被索引到一个新的段中。可能两个版本的文档都会被一个查询匹配到，但被删除的那个旧版本文档在结果集返回前就已经被移除。</p><h3 id="近实时搜索"><a href="#近实时搜索" class="headerlink" title="近实时搜索"></a>近实时搜索</h3><p>随着按段（<code>per-segment</code>）搜索的发展，一个新的文档从索引到可被搜索的延迟显著降低了。新文档在几分钟之内即可被检索，但这样还是不够快。磁盘在这里成为了瓶颈。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828488-91244843.png"></p></div><p>提交（<code>Commiting</code>）一个新的段到磁盘需要一个<code>fsync</code>来确保段被物理性地写入磁盘，这样在断电的时候就不会丢失数据。但是<code>fsync</code>操作代价很大; 如果每次索引一个文档都去执行一次的话会造成很大的性能问题。</p><p>需要的是一个更轻量的方式来使一个文档可被搜索，这意味着<code>fsync</code>要从整个过程中被移除。</p><p>在<code>Elasticsearch</code>和磁盘之间是文件系统缓存。像之前描述的一样， 在内存索引缓冲区中的文档会被写入到一个新的段中。</p><p>但是这里新段会被先写入到文件系统缓存—这一步代价会比较低，稍后再被刷新到磁盘—这一步代价比较高。不过只要文件已经在缓存中，就可以像其它文件一样被打开和读取了。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828524-e805fe38.png"></p></div><p><code>Lucene</code>允许新段被写入和打开—使其包含的文档在未进行一次完整提交时便对搜索可见。这种方式比进行一次提交代价要小得多，并且在不影响性能的前提下可以被频繁地执行。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828547-c71664f8.png"></p></div><p>在<code>Elasticsearch</code>中，写入和打开一个新段的轻量的过程叫做<code>refresh</code>。 默认情况下每个分片会每秒自动刷新一次。</p><p>这就是为什么说<code>Elasticsearch</code>是近实时搜索: 文档的变化并不是立即对搜索可见，但会在一秒之内变为可见。</p><p>这些行为可能会对新用户造成困惑：他们索引了一个文档然后尝试搜索它，但却没有搜到。这个问题的解决办法是用<code>refreshAPI</code>执行一次手动刷新：<code>/users/_refresh</code>。</p><p><strong>尽管刷新是比提交轻量很多的操作，它还是会有性能开销。当写测试的时候，手动刷新很有用，但是不要在生产环境下每次索引一个文档都去手动刷新。相反，应用需要意识到<code>Elasticsearch</code>的近实时的性质，并接受它的不足</strong>。</p><p>并不是所有的情况都需要每秒刷新。可能正在使用<code>Elasticsearch</code>索引大量的日志文件，可能想优化索引速度而不是近实时搜索， 可以通过设置<code>refresh_interval</code>， 降低每个索引的刷新频率：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">        <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30s&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><code>refresh_interval</code>可以在既存索引上进行动态更新。在生产环境中，当正在建立一个大的新索引时，可以先关闭自动刷新，待开始使用该索引时，再把它们调回来。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 关闭自动刷新</span><br><span class="line"># PUT /users/_settings</span><br><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="number">-1</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># 每一秒刷新</span><br><span class="line">#PUT /users/_settings</span><br><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1s&quot;</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="持久化变更"><a href="#持久化变更" class="headerlink" title="持久化变更"></a>持久化变更</h3><p>如果没有用<code>fsync</code>把数据从文件系统缓存刷（<code>flush</code>）到硬盘，我们不能保证数据在断电甚至是程序正常退出之后依然存在。为了保证<code>Elasticsearch</code>的可靠性，需要确保数据变化被持久化到磁盘。</p><p>在动态更新索引说一次完整的提交会将段刷到磁盘，并写入一个包含所有段列表的提交点。<code>Elasticsearch</code>在启动或重新打开一个索引的过程中使用这个提交点来判断哪些段隶属于当前分片。</p><p>即使通过每秒刷新（<code>refresh</code>）实现了近实时搜索，仍然需要经常进行完整提交来确保能从失败中恢复。但在两次提交之间发生变化的文档怎么办？也不希望丢失掉这些数据。</p><p><code>Elasticsearch</code>增加了一个<code>translog</code>，或者叫事务日志，在每一次对<code>Elasticsearch</code>进行操作时均进行了日志记录。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828593-7d2a25ad.png"></p></div><p>整个流程如下：</p><ol><li><p>一个文档被索引之后，就会被添加到内存缓冲区，并且追加到了<code>translog</code><br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828617-55a74f47.png"></p></li><li><p>刷新（<code>refresh</code>）使分片每秒被刷新（<code>refresh</code>）一次</p><ul><li>这些在内存缓冲区的文档被写入到一个新的段中，且没有进行 fsync操作</li><li>这个段被打开，使其可被搜索</li><li>内存缓冲区被清空</li></ul><p> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828637-eb1827bb.png"></p></li><li><p>这个进程继续工作，更多的文档被添加到内存缓冲区和追加到事务日志<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828654-59f0262a.png"></p></li><li><p>每隔一段时间——例如<code>translog</code>变得越来越大—索引被刷新（<code>flush</code>）；一个新的<code>translog</code>被创建，并且一个全量提交被执行。</p><ul><li>所有在内存缓冲区的文档都被写入一个新的段</li><li>缓冲区被清空</li><li>一个提交点被写入硬盘</li><li>文件系统缓存通过<code>fsync</code>被刷新（<code>flush</code>）</li><li>老的<code>translog</code>被删除</li></ul></li></ol><p><code>translog</code>提供所有还没有被刷到磁盘的操作的一个持久化纪录。</p><p>当<code>Elasticsearch</code>启动的时候， 它会从磁盘中使用最后一个提交点去恢复已知的段，并且会重放 <code>translog</code>中所有在最后一次提交后发生的变更操作。</p><p><code>translog</code>也被用来提供实时<code>CRUD</code>。当你试着通过<code>ID</code>查询、更新、删除一个文档，它会在尝试从相应的段中检索之前， 首先检查<code>translog</code>任何最近的变更。这意味着它总是能够实时地获取到文档的最新版本。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828684-91022a3d.png"></p></div><p>执行一个提交并且截断<code>translog</code>的行为在<code>Elasticsearch</code>被称作一次<code>flush</code>。</p><p>分片每 $30$ 分钟被自动刷新（<code>flush</code>），或者在<code>translog</code>太大的时候也会刷新。</p><p>很少需要自己手动执行<code>flush</code>操作；通常情况下，自动刷新就足够了。这就是说，在重启节点或关闭索引之前执行<code>flush有</code>益于自己的索引。当<code>Elasticsearch</code>尝试恢复或重新打开一个索引， 它需要重放<code>translog</code>中所有的操作，所以如果日志越短，恢复越快。</p><p><code>translog</code>的目的是保证操作不会丢失，在文件被<code>fsync</code>到磁盘前，被写入的文件在重启之后就会丢失。</p><p>默认<code>translog</code>是每 $5$ 秒被<code>fsync</code>刷新到硬盘， 或者在每次写请求完成之后执行（<code>index</code>，<code>delete</code>，<code>update</code>，<code>bulk</code>）。这个过程在主分片和复制分片都会发生。</p><p>最终，基本上，这意味着在整个请求被<code>fsync</code>到主分片和复制分片的<code>translog</code>之前，客户端不会得到一个<code>200OK</code>响应。</p><p>在每次请求后都执行一个<code>fsync</code>会带来一些性能损失，尽管实践表明这种损失相对较小（特别是 <code>bulk</code>导入，它在一次请求中平摊了大量文档的开销）。</p><p>但是对于一些大容量的偶尔丢失几秒数据问题也并不严重的集群，使用异步的<code>fsync</code>还是比较有益的。比如，写入的数据被缓存到内存中，再每 $5$ 秒执行一次<code>fsync</code>。</p><p>如果决定使用异步<code>translog</code>的话，需要保证在发生<code>crash</code>时，丢失掉<code>sync_interval</code>时间段的数据也无所谓。请在决定前知晓这个特性。</p><p>如果不确定这个行为的后果，最好是使用默认的参数（<code>&quot;index.translog.durability&quot;: &quot;request&quot;</code>）来避免数据丢失。</p><h3 id="段合并"><a href="#段合并" class="headerlink" title="段合并"></a>段合并</h3><p>由于自动刷新流程每秒会创建一个新的段，这样会导致短时间内的段数量暴增。而段数目太多会带来较大的麻烦。 每一个段都会消耗文件句柄、内存和<code>cpu</code>运行周期。更重要的是，每个搜索请求都必须轮流检查每个段；所以段越多，搜索也就越慢。</p><p><code>Elasticsearch</code>通过在后台进行段合并来解决这个问题。小的段被合并到大的段，然后这些大的段再被合并到更大的段。</p><p>段合并的时候会将那些旧的已删除文档从文件系统中清除。被删除的文档（或被更新文档的旧版本）不会被拷贝到新的大段中。</p><p>启动段合并不需要做任何事。进行索引和搜索时会自动进行。</p><ol><li><p>当索引的时候，刷新（<code>refresh</code>）操作会创建新的段并将段打开以供搜索使用</p></li><li><p>合并进程选择一小部分大小相似的段，并且在后台将它们合并到更大的段中。这并不会中断索引和搜索</p></li><li><p>一旦合并结束，老的段被删除</p><ul><li>新的段被刷新（<code>flush</code>）到了磁盘。写入一个包含新段且排除旧的和较小的段的新提交点。</li><li>新的段被打开用来搜索。</li><li>老的段被删除。</li></ul><p> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828727-5f635329.png"></p></li></ol><p>合并大的段需要消耗大量的<code>I/O</code>和<code>CPU</code>资源，如果任其发展会影响搜索性能。<code>Elasticsearch</code>在默认情况下会对合并流程进行资源限制，所以搜索仍然 有足够的资源很好地执行。</p><h1 id="文档分析"><a href="#文档分析" class="headerlink" title="文档分析"></a>文档分析</h1><p>分析包含下面的过程：</p><ul><li>将一块文本分成适合于倒排索引的独立的词条</li><li>将这些词条统一化为标准格式以提高它们的“可搜索性”，或者<code>recall</code></li></ul><p>分析器执行上面的工作。</p><p>分析器实际上是将三个功能封装到了一个包里：</p><ul><li>字符过滤器<br>首先，字符串按顺序通过每个 字符过滤器 。<br>它们的任务是在分词前整理字符串。一个字符过滤器可以用来去掉<code>HTML</code>，或者将<code>&amp;</code>转化成 <code>and</code>。</li><li>分词器<br>其次，字符串被分词器分为单个的词条。<br>一个简单的分词器遇到空格和标点的时候，可能会将文本拆分成词条。</li><li><code>Token</code>过滤器<br>最后，词条按顺序通过每个<code>token</code>过滤器。<br>这个过程可能会改变词条（例如小写化<code>Quick</code>），删除词条（例如<code>a</code>，<code>and</code>，<code>the</code>等无用词），或者增加词条（例如<code>jump</code>和<code>leap</code>这种同义词）。</li></ul><h3 id="内置分析器"><a href="#内置分析器" class="headerlink" title="内置分析器"></a>内置分析器</h3><p><code>Elasticsearch</code>还附带了可以直接使用的预包装的分析器。</p><p>接下来会列出最重要的分析器。为了证明它们的差异，先来看看每个分析器会从下面的字符串得到哪些词条：</p><blockquote><p>Set the shape to semi-transparent by calling set_trans(5)</p></blockquote><ul><li><p>标准分析器<br>标准分析器是<code>Elasticsearch</code>默认使用的分析器。它是分析各种语言文本最常用的选择。它根据<br><code>Unicode</code>联盟定义的单词边界划分文本；删除绝大部分标点；最后，将词条小写。它会产生：</p><blockquote><p>set, the, shape, to, semi, transparent, by, calling, set_trans, 5</p></blockquote></li><li><p>简单分析器<br>简单分析器在任何不是字母的地方分隔文本，将词条小写。它会产生：</p><blockquote><p>set, the, shape, to, semi, transparent, by, calling, set, trans</p></blockquote></li><li><p>空格分析器<br>空格分析器在空格的地方划分文本。它会产生：</p><blockquote><p>Set, the, shape, to, semi-transparent, by, calling, set_trans(5)</p></blockquote></li><li><p>语言分析器<br>特定语言分析器可用于很多语言。它们可以考虑指定语言的特点。<br>例如， 英语分析器附带了一组英语无用词（常用单词，如<code>and</code>或<code>the</code>，它们对相关性没有多少影响），它们会被删除。 由于理解英语语法的规则，这个分词器可以提取英语单词的词干。<br>英语分词器会产生下面的词条：</p><blockquote><p>set, shape, semi, transpar, call, set_tran, 5</p></blockquote><p>注意看，<code>transparent</code>、<code>calling</code>和<code>set_trans</code>已经变为词根格式。</p></li></ul><h3 id="分析器使用场景"><a href="#分析器使用场景" class="headerlink" title="分析器使用场景"></a>分析器使用场景</h3><p>当索引 一个文档，它的全文域被分析成词条以用来创建倒排索引。但是，当在全文域搜索的时候，需要将查询字符串通过相同的分析过程，以保证我们搜索的词条格式与索引中的词条格式一致。</p><p>全文查询，理解每个域是如何定义的，因此它们可以做正确的事：</p><ul><li>当查询一个<strong>全文域</strong>时，会对查询字符串应用相同的分析器，以产生正确的搜索词条列表。</li><li>当查询一个<strong>精确值域</strong>时，不会分析查询字符串，而是搜索指定的精确值。</li></ul><h3 id="测试分析器"><a href="#测试分析器" class="headerlink" title="测试分析器"></a>测试分析器</h3><p>有些时候很难理解分词的过程和实际被存储到索引中的词条，特别是刚接触<code>Elasticsearch</code>。</p><p>为了理解发生了什么，可以使用<code>analyzeAPI</code>来看文本是如何被分析的。</p><p>在消息体里，指定分析器和要分析的文本：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># GET http<span class="punctuation">:</span><span class="comment">//localhost:9200/_analyze</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Text to analyze&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>结果中每个元素代表一个单独的词条：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;tokens&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span><span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;to&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span><span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span><span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;analyze&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span><span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><code>token</code>是实际存储到索引中的词条。<code>position</code>指明词条在原始文本中出现的位置。<code>start_offset</code>和<code>end_offset</code>指明字符在原始字符串中的位置。</p><h3 id="指定分析器"><a href="#指定分析器" class="headerlink" title="指定分析器"></a>指定分析器</h3><p>当<code>Elasticsearch</code>在文档中检测到一个新的字符串域，它会自动设置其为一个全文字符串域，使用 标准分析器对它进行分析。</p><p>但并不希望总是这样。有时想使用一个不同的分析器，适用于数据使用的语言。有时想要一个字符串域就是一个字符串域——不使用分析，直接索引传入的精确值，例如用户<code>ID</code>或者一个内部的状态域或标签。要做到这一点，必须手动指定这些域的映射。</p><h3 id="IK-分词器"><a href="#IK-分词器" class="headerlink" title="IK 分词器"></a>IK 分词器</h3><p>首先通过<code>Postman</code>发送<code>GET</code>请求查询分词效果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># GET http<span class="punctuation">:</span><span class="comment">//localhost:9200/_analyze</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;测试单词&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828810-abdbeef5.png"></p></div><p><code>ES</code>的默认分词器无法识别中文中测试、单词这样的词汇，而是简单的将每个字拆完分为一个词：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;tokens&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;测&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;试&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;单&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;词&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>这样的结果显然不符合使用要求，所以需要下载<code>ES</code>对应版本的中文分词器。</p><p>这里采用<code>IK</code>中文分词器，<a href="https://github.com/medcl/elasticsearch-analysis-ik">下载地址</a>为：<code>https://github.com/medcl/elasticsearch-analysis-ik/</code>。</p><p>将解压后的后的文件夹放入<code>ES</code>根目录下的<code>plugins</code>目录下，重启<code>ES</code>即可使用。</p><p>这次加入新的查询参数·<code>&quot;analyzer&quot;:&quot;ik_max_word&quot;</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># GET http<span class="punctuation">:</span><span class="comment">//localhost:9200/_analyze</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;测试单词&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span><span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul><li><code>ik_max_word</code>：会将文本做最细粒度的拆分</li><li><code>ik_smart</code>：会将文本做最粗粒度的拆分</li></ul><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828846-16e27ee9.png"></p></div><p>　使用中文分词后的结果为：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;tokens&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;测试&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;单词&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><code>ES</code>中也可以进行扩展词汇，首先查询：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># GET http<span class="punctuation">:</span><span class="comment">//localhost:9200/_analyze</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;弗雷尔卓德&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span><span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828874-a0e0219d.png"></p></div><p>仅仅可以得到每个字的分词结果，需要做的就是使分词器识别到弗雷尔卓德也是一个词语：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;tokens&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;弗&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;雷&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;尔&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;卓&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;德&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>首先进入<code>ES</code>根目录中的<code>plugins</code>文件夹下的 ik文件夹，进入<code>config</code>目录，创建<code>custom.dic</code>文件，写入弗雷尔卓德。同时打开<code>IKAnalyzer.cfg.xml</code>文件，将新建的<code>custom.dic</code>配置其中，重启<code>ES</code>服务器。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">properties</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_dict&quot;</span>&gt;</span>custom.dic<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_stopwords&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- &lt;entry key=&quot;remote_ext_dict&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828904-8d0957f2.png"></p></div><h3 id="自定义分析器"><a href="#自定义分析器" class="headerlink" title="自定义分析器"></a>自定义分析器</h3><p>虽然<code>Elasticsearch</code>带有一些现成的分析器，然而在分析器上<code>Elasticsearch</code>真正的强大之处在于，可以通过在一个适合特定数据的设置之中组合字符过滤器、分词器、词汇单元过滤器来创建自定义的分析器。在分析与分析器说过，一个分析器就是在一个包里面组合了三种函数的一个包装器， 三种函数按照顺序被执行。</p><ul><li>字符过滤器<br>字符过滤器用来整理一个尚未被分词的字符串。例如，如果文本是<code>HTML</code>格式的，它会包含像 <code>&lt;p&gt;</code>或者<code>&lt;div&gt;</code>这样的<code>HTML</code>标签，这些标签是不想索引的。<br>可以使用<code>html</code>清除字符过滤器来移除掉所有的<code>HTML</code>标签，并且像把<code>&amp;Aacute;</code>转换为相对应的<code>Unicode</code>字符<code>Á</code>这样，转换<code>HTML</code>实体。一个分析器可能有 $0$ 个或者多个字符过滤器。</li><li>分词器<br>一个分析器必须有一个唯一的分词器。<br>分词器把字符串分解成单个词条或者词汇单元。<br>标准分析器里使用的标准分词器把一个字符串根据单词边界分解成单个词条，并且移除掉大部分的标点符号，然而还有其他不同行为的分词器存在。<br>例如，关键词分词器完整地输出接收到的同样的字符串，并不做任何分词。<br>空格分词器只根据空格分割文本。正则分词器根据匹配正则表达式来分割文本 。</li><li>词单元过滤器<br>经过分词，作为结果的词单元流会按照指定的顺序通过指定的词单元过滤器。<br>词单元过滤器可以修改、添加或者移除词单元。已经提到过<code>lowercase</code>和<code>stop</code>词过滤器，但是在<code>Elasticsearch</code>里面还有很多可供选择的词单元过滤器。词干过滤器把单词遏制为词干。 <code>ascii_folding</code>过滤器移除变音符，把一个像<code>très</code>这样的词转换为<code>tres</code>。<br><code>ngram</code>和<code>edge_ngram</code>词单元过滤器可以产生适合用于部分匹配或者自动补全的词单元。</li></ul><p>接下来，看看如何创建自定义的分析器：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># PUT http<span class="punctuation">:</span><span class="comment">//localhost:9200/my_index</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;analysis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">            <span class="attr">&quot;char_filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;&amp;_to_and&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mapping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;&amp;=&gt; and &quot;</span><span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;my_stopwords&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stop&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;stopwords&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;the&quot;</span><span class="punctuation">,</span> <span class="string">&quot;a&quot;</span> <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                <span class="attr">&quot;my_analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;custom&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;char_filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;html_strip&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&amp;_to_and&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">                    <span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;lowercase&quot;</span><span class="punctuation">,</span> <span class="string">&quot;my_stopwords&quot;</span> <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828936-6c9c2912.png"></p></div><p>索引被创建以后，使用<code>analyzeAPI</code>来测试这个新的分析器：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># GET http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9200/my_index/_analyze</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;The quick &amp; brown fox&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_analyzer&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828957-92753551.png"></p></div><p>下面的缩略结果展示出分析器正在正确地运行：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;tokens&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;quick&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;and&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;brown&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">17</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fox&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h1 id="文档处理"><a href="#文档处理" class="headerlink" title="文档处理"></a>文档处理</h1><h2 id="文档冲突"><a href="#文档冲突" class="headerlink" title="文档冲突"></a>文档冲突</h2><p>当使用<code>indexAPI</code>更新文档 ，可以一次性读取原始文档，做修改，然后重新索引整个文档。</p><p>最近的索引请求将获胜：无论最后哪一个文档被索引，都将被唯一存储在<code>Elasticsearch</code>中。如果其他人同时更改这个文档，他们的更改将丢失。</p><p>很多时候这是没有问题的。也许主数据存储是一个关系型数据库，只是将数据复制到<code>Elasticsearch</code>中并使其可被搜索。也许两个人同时更改相同的文档的几率很小。或者对于业务来说偶尔丢失更改并不是很严重的问题。</p><p>但有时丢失了一个变更就是非常严重的 。试想使用<code>Elasticsearch</code>存储网上商城商品库存的数量，<br>每次卖一个商品的时候，在<code>Elasticsearch</code>中将库存数量减少。有一天，管理层决定做一次促销。突然地，一秒要卖好几个商品。 假设有两个<code>web</code>程序并行运行，每一个都同时处理所有商品的销售：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639828992-3e399600.png"></p></div><p><code>web_1</code>对<code>stock_count</code>所做的更改已经丢失，因为<code>web_2</code>不知道它的<code>stock_count</code>的拷贝已经过期。 结果会认为有超过商品的实际数量的库存，因为卖给顾客的库存商品并不存在，将让用户非常失望。</p><p>变更越频繁，读数据和更新数据的间隙越长，也就越可能丢失变更。</p><p>在数据库领域中，有两种方法通常被用来确保并发更新时变更不会丢失：</p><ul><li>悲观并发控制<br>这种方法被关系型数据库广泛使用，它假定有变更冲突可能发生，因此阻塞访问资源以防止冲突。一个典型的例子是读取一行数据之前先将其锁住，确保只有放置锁的线程能够对这行数据进行修改。</li><li>乐观并发控制<br><code>Elasticsearch</code>中使用的这种方法假定冲突是不可能发生的，并且不会阻塞正在尝试的操作。 然而，如果源数据在读写当中被修改，更新将会失败。应用程序接下来将决定该如何解决冲突。 例如，可以重试更新、使用新的数据、或者将相关情况报告给用户。</li></ul><h2 id="乐观并发控制"><a href="#乐观并发控制" class="headerlink" title="乐观并发控制"></a>乐观并发控制</h2><p><code>Elasticsearch</code>是分布式的。当文档创建、更新或删除时，新版本的文档必须复制到集群中的其他节点。<code>Elasticsearch</code>也是异步和并发的，这意味着这些复制请求被并行发送，并且到达目的地时也许顺序是乱的。<code>Elasticsearch</code>需要一种方法确保文档的旧版本不会覆盖新的版本。</p><p>之前讨论<code>index</code>，<code>GET</code>和<code>delete</code>请求时，指出每个文档都有一个<code>_version</code>（版本）号，当文档被修改时版本号递增。<code>Elasticsearch</code>使用这个<code>version</code>号来确保变更以正确顺序得到执行。如果旧版本的文档在新版本之后到达，它可以被简单的忽略。</p><p>可以利用<code>version</code>号来确保应用中相互冲突的变更不会导致数据丢失。通过指定想要修改文档的 <code>version</code>号来达到这个目的。如果该版本不是当前版本号，请求将会失败。</p><p>老的版本<code>ES</code>使用<code>version</code>，但是新版本不支持了，会报下面的错误，提示用<code>if_seq_no</code>和<code>if_primary_term</code>。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639829029-9c9717aa.png"></p></div><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;root_cause&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;action_request_validation_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Validation Failed: 1: internal versioning can not be used for optimistic concurrency control. Please use `if_seq_no` and `if_primary_term` instead;&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;action_request_validation_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Validation Failed: 1: internal versioning can not be used for optimistic concurrency control. Please use `if_seq_no` and `if_primary_term` instead;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">400</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639829051-47eab3fb.png"></p></div><h2 id="外部系统版本控制"><a href="#外部系统版本控制" class="headerlink" title="外部系统版本控制"></a>外部系统版本控制</h2><p>一个常见的设置是使用其它数据库作为主要的数据存储，使用<code>Elasticsearch</code>做数据检索，这意味着主数据库的所有更改发生时都需要被复制到<code>Elasticsearch</code>，如果多个进程负责这一数据同步，可能遇到类似于之前描述的并发问题。</p><p>如果主数据库已经有了版本号或一个能作为版本号的字段值比如<code>timestamp</code> — 那么就可以在<code>Elasticsearch</code>中通过增加<code>version_type=external</code>到查询字符串的方式重用这些相同的版本号，<br>版本号必须是大于零的整数，且小于 $9.2E+18$——一个<code>Java</code>中<code>long</code>类型的正值。</p><p>外部版本号的处理方式和之前讨论的内部版本号的处理方式有些不同，<code>Elasticsearch</code>不是检查当前<code>_version</code>和请求中指定的版本号是否相同，而是检查当前<code>_version</code>是否小于指定的版本号。如果请求成功，外部的版本号作为文档的新<code>_version</code>进行存储。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639829077-f93c5123.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634468798/1639829088-5b9bd7e3.png"></p></div><p>外部版本号不仅在索引和删除请求是可以指定，而且在创建新文档时也可以指定。</p><h1 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h1><p><code>Kibana</code>是一个免费且开放的用户界面，能够对<code>Elasticsearch</code>数据进行可视化，并在<code>ElasticStack中</code>进行导航。</p><p>可以进行各种操作，从跟踪查询负载，到理解请求如何流经整个应用，都能轻松完成。</p><p><a href="https://artifacts.elastic.co/downloads/kibana/kibana-7.8.0-windows-x86_64.zip">下载地址</a>：<code>https://artifacts.elastic.co/downloads/kibana/kibana-7.8.0-windows-x86_64.zip</code>。</p><ol><li>解压缩下载的<code>zip</code>文件</li><li>修改<code>config/kibana.yml</code>文件 <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认端口server.port: 5601 # ES 服务器的地址</span></span><br><span class="line"><span class="attr">elasticsearch.hosts</span>: <span class="string">[&quot;http://localhost:9200&quot;] </span></span><br><span class="line"><span class="comment"># 索引名</span></span><br><span class="line"><span class="attr">kibana.index</span>: <span class="string">&quot;.kibana&quot;</span></span><br><span class="line"><span class="comment"># 支持中文</span></span><br><span class="line"><span class="attr">i18n.locale</span>: <span class="string">&quot;zh-CN&quot;</span></span><br></pre></td></tr></table></figure></li><li><code>Windows</code>环境下执行<code>bin/kibana.bat</code>文件</li><li>通过浏览器访问：<code>http://localhost:5601</code></li></ol>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ElasticSearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Elasticsearch 环境</title>
      <link href="/2021/10/15/ElasticSearch/03.Elasticsearch%20%E7%8E%AF%E5%A2%83/"/>
      <url>/2021/10/15/ElasticSearch/03.Elasticsearch%20%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<h1 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h1><h2 id="单机-amp-集群"><a href="#单机-amp-集群" class="headerlink" title="单机 &amp; 集群"></a>单机 &amp; 集群</h2><p>单台<code>Elasticsearch</code>服务器提供服务，往往都有最大的负载能力，超过这个阈值，服务器性能就会大大降低甚至不可用，所以生产环境中，一般都是运行在指定服务器集群中。</p><p>除了负载能力，单点服务器也存在其他问题：</p><ul><li>单台机器存储容量有限</li><li>单服务器容易出现单点故障，无法实现高可用</li><li>单服务的并发处理能力有限</li></ul><p>配置服务器集群时，集群中节点数量没有限制，大于等于 $2$ 个节点就可以看做是集群了。一般出于高性能及高可用方面来考虑集群中节点数量都是 $3$ 个以上。</p><h2 id="集群-Cluster"><a href="#集群-Cluster" class="headerlink" title="集群 Cluster"></a>集群 Cluster</h2><p>一个集群就是由一个或多个服务器节点组织在一起，共同持有整个的数据，并一起提供索引和搜索功能。一个<code>Elasticsearch</code>集群有一个唯一的名字标识，这个名字默认就是<code>elasticsearch</code>。这个名字是重要的，因为一个节点只能通过指定某个集群的名字，来加入这个集群。</p><h2 id="节点-Node"><a href="#节点-Node" class="headerlink" title="节点 Node"></a>节点 Node</h2><p>集群中包含很多服务器，一个节点就是其中的一个服务器。作为集群的一部分，它存储数据，参与集群的索引和搜索功能。</p><p>一个节点也是由一个名字来标识的，默认情况下，这个名字是一个随机的漫威漫画角色的名字，这个名字会在启动的时候赋予节点。这个名字对于管理工作来说挺重要的，因为在这个管理过程中，你会去确定网络中的哪些服务器对应于<code>Elasticsearch</code>集群中的哪些节点。</p><p>一个节点可以通过配置集群名称的方式来加入一个指定的集群。默认情况下，每个节点都会被安排加入到一个叫做<code>elasticsearch</code>的集群中，这意味着，如果在网络中启动了若干个节点，并假定它们能够相互发现彼此，它们将会自动地形成并加入到一个叫做<code>elasticsearch</code>的集群中。</p><p>在一个集群里可以拥有任意多个节点。而且，如果当前网络中没有运行任何<code>Elasticsearch</code>节点，这时启动一个节点，会默认创建并加入一个叫做<code>elasticsearch</code>的集群。</p><h1 id="Windows-集群"><a href="#Windows-集群" class="headerlink" title="Windows 集群"></a>Windows 集群</h1><h2 id="部署集群"><a href="#部署集群" class="headerlink" title="部署集群"></a>部署集群</h2><ol><li>创建<code>elasticsearch-cluster</code>文件夹，在内部复制三个<code>elasticsearch</code>服务<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634267897/1639825373-1f90ca67.png"></li><li>修改集群文件目录中每个节点的<code>config/elasticsearch.yml</code>配置文件<ul><li><code>node-1001</code>节点<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#节点 1 的配置信息：</span></span><br><span class="line"><span class="comment">#集群名称，节点之间要保持一致</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">my-elasticsearch</span> </span><br><span class="line"><span class="comment">#节点名称，集群内要唯一 </span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">node-1001</span> </span><br><span class="line"><span class="attr">node.master:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.data:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ip 地址</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="string">localhost</span> </span><br><span class="line"><span class="comment">#http 端口</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">1004</span></span><br><span class="line"><span class="comment">#tcp 监听端口</span></span><br><span class="line"><span class="attr">transport.tcp.port:</span> <span class="number">9304</span></span><br><span class="line"></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span> [<span class="string">&quot;localhost:9304&quot;</span>, <span class="string">&quot;localhost:9302&quot;</span>,<span class="string">&quot;localhost:9303&quot;</span>] </span><br><span class="line"><span class="attr">discovery.zen.fd.ping_timeout:</span> <span class="string">1m</span></span><br><span class="line"><span class="attr">discovery.zen.fd.ping_retries:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#集群内的可以被选为主节点的节点列表 </span></span><br><span class="line"><span class="comment">#cluster.initial_master_nodes: [&quot;node-1&quot;, &quot;node-2&quot;,&quot;node-3&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#跨域配置</span></span><br><span class="line"><span class="comment">#action.destructive_requires_name: true </span></span><br><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span> </span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure></li><li><code>node-1002</code>节点<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#节点 2 的配置信息：</span></span><br><span class="line"><span class="comment">#集群名称，节点之间要保持一致</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">my-elasticsearch</span> </span><br><span class="line"><span class="comment">#节点名称，集群内要唯一 </span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">node-1002</span> </span><br><span class="line"><span class="attr">node.master:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.data:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ip 地址</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="string">localhost</span> </span><br><span class="line"><span class="comment">#http 端口</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">1002</span> </span><br><span class="line"><span class="comment">#tcp 监听端口</span></span><br><span class="line"><span class="attr">transport.tcp.port:</span> <span class="number">9302</span></span><br><span class="line"></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span> [<span class="string">&quot;localhost:9301&quot;</span>] </span><br><span class="line"><span class="attr">discovery.zen.fd.ping_timeout:</span> <span class="string">1m</span> </span><br><span class="line"><span class="attr">discovery.zen.fd.ping_retries:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#集群内的可以被选为主节点的节点列表 </span></span><br><span class="line"><span class="comment">#cluster.initial_master_nodes: [&quot;node-1&quot;, &quot;node-2&quot;,&quot;node-3&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#跨域配置</span></span><br><span class="line"><span class="comment">#action.destructive_requires_name: true </span></span><br><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span> </span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure></li><li><code>node-1003</code>节点<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#节点 3 的配置信息：</span></span><br><span class="line"><span class="comment">#集群名称，节点之间要保持一致</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">my-elasticsearch</span> </span><br><span class="line"><span class="comment">#节点名称，集群内要唯一 </span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">node-1003</span> </span><br><span class="line"><span class="attr">node.master:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.data:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ip 地址</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="string">localhost</span> </span><br><span class="line"><span class="comment">#http 端口</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">1003</span> </span><br><span class="line"><span class="comment">#tcp 监听端口</span></span><br><span class="line"><span class="attr">transport.tcp.port:</span> <span class="number">9303</span></span><br><span class="line"><span class="comment">#候选主节点的地址，在开启服务后可以被选为主节点</span></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span> [<span class="string">&quot;localhost:9301&quot;</span>, <span class="string">&quot;localhost:9302&quot;</span>] </span><br><span class="line"><span class="attr">discovery.zen.fd.ping_timeout:</span> <span class="string">1m</span> </span><br><span class="line"><span class="attr">discovery.zen.fd.ping_retries:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#集群内的可以被选为主节点的节点列表 </span></span><br><span class="line"><span class="comment">#cluster.initial_master_nodes: [&quot;node-1&quot;, &quot;node-2&quot;,&quot;node-3&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#跨域配置</span></span><br><span class="line"><span class="comment">#action.destructive_requires_name: true </span></span><br><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span> </span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure></li></ul></li></ol><h2 id="启动集群"><a href="#启动集群" class="headerlink" title="启动集群"></a>启动集群</h2><ol><li>启动前先删除每个节点中的<code>data</code>目录中所有内容（如果存在）<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634267897/1639825408-958a6c16.png"></li><li>分别双击执行<code>bin/elasticsearch.bat</code>, 启动节点服务器，启动后，会自动加入指定名称的集群<br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634267897/1639825439-880ba266.png"><br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634267897/1639825453-2f8ba373.png"><br> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634267897/1639825464-eed6b7f7.png"></li></ol><h2 id="测试集群"><a href="#测试集群" class="headerlink" title="测试集群"></a>测试集群</h2><h3 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h3><ul><li><code>node-1001</code>节点<br><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634267897/1639825481-302e2ed3.png"></li><li><code>node-1002</code>节点<br><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634267897/1639825504-b33468d1.png"></li><li><code>node-1003</code>节点<br><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634267897/1639825522-6cf12aae.png"></li></ul><p><code>status</code>字段指示着当前集群在总体上是否工作正常，它的三种颜色含义如下：</p><ul><li>green：所有的主分片和副本分片都正常运行</li><li>yellow：所有的主分片都正常运行，但不是所有的副本分片都正常运行</li><li>red：有主分片没能正常运行</li></ul><h3 id="向集群中的-node-1001-节点增加索引"><a href="#向集群中的-node-1001-节点增加索引" class="headerlink" title="向集群中的 node-1001 节点增加索引"></a>向集群中的 node-1001 节点增加索引</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634267897/1639825554-f5a86bc3.png"></p></div><h3 id="向集群中的-node-1002-节点查询索引"><a href="#向集群中的-node-1002-节点查询索引" class="headerlink" title="向集群中的 node-1002 节点查询索引"></a>向集群中的 node-1002 节点查询索引</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634267897/1639825576-cb464ce8.png"></p></div><h1 id="Linux-单机"><a href="#Linux-单机" class="headerlink" title="Linux 单机"></a>Linux 单机</h1><h2 id="软件下载"><a href="#软件下载" class="headerlink" title="软件下载"></a>软件下载</h2><p>软件下载<a href="https://www.elastic.co/cn/downloads">地址</a>。</p><h2 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h2><h3 id="解压软件"><a href="#解压软件" class="headerlink" title="解压软件"></a>解压软件</h3><p>将下载的软件解压缩。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解压缩</span></span><br><span class="line">tar -zxvf elasticsearch-7.8.0-linux-x86_64.tar.gz -C /opt/module </span><br><span class="line"><span class="comment"># 改名</span></span><br><span class="line"><span class="built_in">mv</span> elasticsearch-7.8.0 es</span><br></pre></td></tr></table></figure><h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><p>因为安全问题，<code>Elasticsearch</code>不允许<code>root</code>用户直接运行，所以要创建新用户。</p><p>在<code>root</code>用户中创建新用户。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#新增 es 用户</span></span><br><span class="line">useradd es </span><br><span class="line"><span class="comment">#为 es 用户设置密码</span></span><br><span class="line">passwd es </span><br><span class="line"><span class="comment">#如果错了，可以删除再加</span></span><br><span class="line">userdel -r es </span><br><span class="line"><span class="comment">#文件夹所有者</span></span><br><span class="line"><span class="built_in">chown</span> -R es:es /opt/module/es </span><br></pre></td></tr></table></figure><h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><ol><li>修改<code>/opt/module/es/config/elasticsearch.yml</code>文件 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加入如下配置</span></span><br><span class="line">cluster.name: elasticsearch </span><br><span class="line">node.name: node-1 </span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200 </span><br><span class="line">cluster.initial_master_nodes: [<span class="string">&quot;node-1&quot;</span>]</span><br></pre></td></tr></table></figure></li><li>修改<code>/etc/security/limits.conf</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在文件末尾中增加下面内容</span></span><br><span class="line"><span class="comment"># 每个进程可以打开的文件数的限制</span></span><br><span class="line">es soft nofile 65536 </span><br><span class="line">es hard nofile 65536</span><br></pre></td></tr></table></figure></li><li>修改<code>/etc/security/limits.d/20-nproc.conf</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在文件末尾中增加下面内容</span></span><br><span class="line"><span class="comment"># 每个进程可以打开的文件数的限制</span></span><br><span class="line">es soft nofile 65536 </span><br><span class="line">es hard nofile 65536</span><br><span class="line"><span class="comment"># 操作系统级别对每个用户创建的进程数的限制</span></span><br><span class="line">* hard <span class="built_in">nproc</span> 4096</span><br><span class="line"><span class="comment"># 注：* 带表 Linux 所有用户名称</span></span><br></pre></td></tr></table></figure></li><li>修改<code>/etc/sysctl.conf</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在文件中增加下面内容</span></span><br><span class="line"><span class="comment"># 一个进程可以拥有的 VMA(虚拟内存区域)的数量,默认值为 65536 </span></span><br><span class="line">vm.max_map_count=655360</span><br></pre></td></tr></table></figure></li><li>重新加载 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure></li></ol><h2 id="启动软件"><a href="#启动软件" class="headerlink" title="启动软件"></a>启动软件</h2><p>使用<code>ES</code>用户启动。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/module/es/ </span><br><span class="line"><span class="comment">#启动</span></span><br><span class="line">bin/elasticsearch </span><br><span class="line"><span class="comment">#后台启动</span></span><br><span class="line">bin/elasticsearch -d</span><br></pre></td></tr></table></figure><p>启动时，会动态生成文件，如果文件所属用户不匹配，会发生错误，需要重新进行修改用户和用户组。</p><p>关闭防火墙。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#暂时关闭防火墙</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment">#永久关闭防火墙</span></span><br><span class="line"><span class="comment">#打开防火墙，永久性生效，重启后不会复原</span></span><br><span class="line">systemctl <span class="built_in">enable</span> firewalld.service </span><br><span class="line"><span class="comment">#关闭防火墙，永久性生效，重启后不会复原</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service </span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634267897/1639825650-90d9c128.png"></p></div><h2 id="测试软件"><a href="#测试软件" class="headerlink" title="测试软件"></a>测试软件</h2><p>浏览器中输入地址：<code>http://linux1:9200/</code>。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634267897/1639826107-de61f004.png"></p></div><h1 id="Linux-集群"><a href="#Linux-集群" class="headerlink" title="Linux 集群"></a>Linux 集群</h1><h2 id="软件下载-1"><a href="#软件下载-1" class="headerlink" title="软件下载"></a>软件下载</h2><p>软件下载<a href="https://www.elastic.co/cn/downloads">地址</a>。</p><h2 id="软件安装-1"><a href="#软件安装-1" class="headerlink" title="软件安装"></a>软件安装</h2><h3 id="解压软件-1"><a href="#解压软件-1" class="headerlink" title="解压软件"></a>解压软件</h3><p>将下载的软件解压缩。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解压缩</span></span><br><span class="line">tar -zxvf elasticsearch-7.8.0-linux-x86_64.tar.gz -C /opt/module </span><br><span class="line"><span class="comment"># 改名</span></span><br><span class="line"><span class="built_in">mv</span> elasticsearch-7.8.0 es-cluster</span><br></pre></td></tr></table></figure><p>将软件分发到其他节点：<code>linux2</code>，<code>linux3</code>。</p><h3 id="创建用户-1"><a href="#创建用户-1" class="headerlink" title="创建用户"></a>创建用户</h3><p>因为安全问题，<code>Elasticsearch</code>不允许<code>root</code>用户直接运行，所以要在每个节点中创建新用户，在<code>root</code>用户中创建新用户。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#新增 es 用户</span></span><br><span class="line">useradd es</span><br><span class="line"><span class="comment">#为 es 用户设置密码 </span></span><br><span class="line">passwd es </span><br><span class="line"></span><br><span class="line"><span class="comment">#如果错了，可以删除再加</span></span><br><span class="line">userdel -r es </span><br><span class="line"><span class="comment">#文件夹所有者</span></span><br><span class="line"><span class="built_in">chown</span> -R es:es /opt/module/es-cluster </span><br></pre></td></tr></table></figure><h3 id="修改配置文件-1"><a href="#修改配置文件-1" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><ol><li><p>修改<code>/opt/module/es/config/elasticsearch.yml</code>文件，分发文件。</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加入如下配置</span></span><br><span class="line"><span class="comment">#集群名称</span></span><br><span class="line">cluster.name: cluster-es</span><br><span class="line"><span class="comment">#节点名称，每个节点的名称不能重复</span></span><br><span class="line">node.name: node-1</span><br><span class="line"><span class="comment">#ip 地址，每个节点的地址不能重复</span></span><br><span class="line">network.host: linux1 </span><br><span class="line"><span class="comment">#是不是有资格主节点</span></span><br><span class="line">node.master: <span class="literal">true</span> </span><br><span class="line">node.data: <span class="literal">true</span> </span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="comment">#tcp 监听端口</span></span><br><span class="line">transport.tcp.port: 9300</span><br><span class="line"><span class="comment"># head 插件需要这打开这两个配置</span></span><br><span class="line">http.cors.allow-origin: <span class="string">&quot;*&quot;</span> </span><br><span class="line">http.cors.enabled: <span class="literal">true</span> </span><br><span class="line">http.max_content_length: 200mb</span><br><span class="line"><span class="comment">#es7.x 之后新增的配置，初始化一个新的集群时需要此配置来选举 master</span></span><br><span class="line">cluster.initial_master_nodes: [<span class="string">&quot;node-1&quot;</span>] </span><br><span class="line"><span class="comment">#es7.x 之后新增的配置，节点发现</span></span><br><span class="line">discovery.seed_hosts: [<span class="string">&quot;linux1:9300&quot;</span>,<span class="string">&quot;linux2:9300&quot;</span>,<span class="string">&quot;linux3:9300&quot;</span>] </span><br><span class="line">gateway.recover_after_nodes: 2</span><br><span class="line">network.tcp.keep_alive: <span class="literal">true</span> </span><br><span class="line">network.tcp.no_delay: <span class="literal">true</span> </span><br><span class="line">transport.tcp.compress: <span class="literal">true</span></span><br><span class="line"><span class="comment">#集群内同时启动的数据任务个数，默认是 2 个</span></span><br><span class="line">cluster.routing.allocation.cluster_concurrent_rebalance: 16</span><br><span class="line"><span class="comment">#添加或删除节点及负载均衡时并发恢复的线程个数，默认 4 个</span></span><br><span class="line">cluster.routing.allocation.node_concurrent_recoveries: 16</span><br><span class="line"><span class="comment">#初始化数据恢复时，并发恢复线程的个数，默认 4 个</span></span><br><span class="line">cluster.routing.allocation.node_initial_primaries_recoveries: 16</span><br></pre></td></tr></table></figure><p> <img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634267897/1639826140-abd0b7e8.png"></p></li><li><p>修改<code>/etc/security/limits.conf</code>，分发文件</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在文件末尾中增加下面内容</span></span><br><span class="line">es soft nofile 65536 </span><br><span class="line">es hard nofile 65536</span><br></pre></td></tr></table></figure></li><li><p>修改<code>/etc/security/limits.d/20-nproc.conf</code>，分发文件</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在文件末尾中增加下面内容</span></span><br><span class="line">es soft nofile 65536 </span><br><span class="line">es hard nofile 65536</span><br><span class="line">* hard <span class="built_in">nproc</span> 4096</span><br><span class="line"><span class="comment"># 注：* 带表 Linux 所有用户名称</span></span><br></pre></td></tr></table></figure></li><li><p>修改<code>/etc/sysctl.conf</code></p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在文件中增加下面内容</span></span><br><span class="line">vm.max_map_count=655360</span><br></pre></td></tr></table></figure></li><li><p>重新加载</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure></li></ol><h2 id="启动软件-1"><a href="#启动软件-1" class="headerlink" title="启动软件"></a>启动软件</h2><p>分别在不同节点上启动<code>ES</code>软件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/module/es-cluster </span><br><span class="line"><span class="comment">#启动</span></span><br><span class="line">bin/elasticsearch </span><br><span class="line"><span class="comment">#后台启动</span></span><br><span class="line">bin/elasticsearch -d</span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634267897/1639826184-a003720f.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634267897/1639826197-ae300178.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634267897/1639826210-906c6d51.png"></p></div><h2 id="测试集群-1"><a href="#测试集群-1" class="headerlink" title="测试集群"></a>测试集群</h2><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634267897/1639826235-346a4697.png"></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ElasticSearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ElasticSearch 基本操作</title>
      <link href="/2021/10/12/ElasticSearch/02.ElasticSearch%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/"/>
      <url>/2021/10/12/ElasticSearch/02.ElasticSearch%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<h1 id="RESTful"><a href="#RESTful" class="headerlink" title="RESTful"></a>RESTful</h1><p><code>REST</code>指的是一组架构约束条件和原则。满足这些约束条件和原则的应用程序或设计就是<code>RESTful</code>。</p><p><code>Web</code>应用程序最重要的<code>REST</code>原则是，客户端和服务器之间的交互在请求之间是无状态的。从客户端到服务器的每个请求都必须包含理解请求所必需的信息。如果服务器在请求之间的任何时间点重启，客户端不会得到通知。此外，无状态请求可以由任何可用服务器回答，这十分适合云计算之类的环境。客户端可以缓存数据以改进性能。</p><p>在服务器端，应用程序状态和功能可以分为各种资源。资源是一个有趣的概念实体，它向客户端公开。资源的例子有：应用程序对象、数据库记录、算法等等。每个资源都使用<code>URI(UniversalResourceIdentifier)</code>得到一个唯一的地址。所有资源都共享统一的接口，以便在客户端和服务器之间传输状态。使用的是标准的<code>HTTP</code>方法，比如<code>GET</code>、<code>PUT</code>、<code>POST</code>和<code>DELETE</code>。</p><p>在<code>REST</code>样式的<code>Web</code>服务中，每个资源都有一个地址。资源本身都是方法调用的目标，方法列表对所有资源都是一样的。这些方法都是标准方法，包括<code>GET</code>、<code>POST</code>、<code>PUT</code>、<code>DELETE</code>，还可能包括<br><code>HEAD</code>和<code>OPTIONS</code>。简单的理解就是，如果想要访问互联网上的资源，就必须向资源所在的服务器发出请求，请求体中必须包含资源的网络路径，以及对资源进行的操作（增删改查）。</p><h1 id="客户端安装"><a href="#客户端安装" class="headerlink" title="客户端安装"></a>客户端安装</h1><p>如果直接通过浏览器向<code>Elasticsearch</code>服务器发请求，那么需要在发送的请求中包含<code>HTTP</code>标准的方法，而<code>HTTP</code>的大部分特性且仅支持<code>GET</code>和<code>POST</code>方法。所以为了能方便地进行客户端的访问，可以使用<code>Postman</code>软件</p><p><code>Postman</code>是一款强大的网页调试工具，提供功能强大的<code>WebAPI</code>和<code>HTTP</code>请求调试。软件功能强大，界面简洁明晰、操作方便快捷，设计得很人性化。<code>Postman</code>中文版能够发送任何类型的<code>HTTP</code>请求（<code>GET</code>、<code>HEAD</code>、<code>POST</code>、<code>PUT</code>…），不仅能够表单提交，且可以附带任意类型请求体。</p><p><code>Postman</code><a href="%5Bhttps://www.getpostman.com%5D(https://www.getpostman.com/)">官网</a>、<a href="%5Bhttps://www.getpostman.com/apps%5D(https://www.getpostman.com/apps)">下载</a>。</p><h1 id="数据格式"><a href="#数据格式" class="headerlink" title="数据格式"></a>数据格式</h1><p><code>Elasticsearch</code>是面向文档型数据库，一条数据在这里就是一个文档。为了方便理解，将<code>Elasticsearch</code>里存储文档数据和关系型数据库<code>MySQL</code>存储数据的概念进行一个类比：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639815947-9eab7813.png"></p></div><p><code>ES</code>里的<code>Index</code>可以看做一个库，而<code>Type</code>相当于表，<code>Documents</code>则相当于表的行。这里<code>Types</code>的概念已经被逐渐弱化，<code>Elasticsearch 6.X</code>中，一个<code>Index</code>下已经只能包含一个<code>Type</code>，<code>Elasticsearch 7.X</code>中，<code>Type</code>的概念已经被删除了。</p><p>用<code>JSON</code>作为文档序列化的格式，比如一条用户信息：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;John&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sex&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Male&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">25</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;birthDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1990/05/01&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;about&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;I love to go rock climbing&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;interests&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;sports&quot;</span><span class="punctuation">,</span> <span class="string">&quot;music&quot;</span> <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h1 id="HTTP操作"><a href="#HTTP操作" class="headerlink" title="HTTP操作"></a>HTTP操作</h1><h2 id="索引操作"><a href="#索引操作" class="headerlink" title="索引操作"></a>索引操作</h2><h3 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h3><p>对比关系型数据库，创建索引就等同于创建数据库。</p><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>PUT</code><a href="http://127.0.0.1:9200/shopping">请求</a>：<code>http://127.0.0.1:9200/shopping</code>，请求后，服务器返回响应。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639815987-9fc5f790.png"></p></div><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="string">&quot;acknowledged&quot;</span>【响应结果】<span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> # <span class="keyword">true</span> 操作成功</span><br><span class="line">    <span class="string">&quot;shards_acknowledged&quot;</span>【分片结果】<span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> # 分片操作成功</span><br><span class="line">    <span class="string">&quot;index&quot;</span>【索引名称】<span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"># 注意：创建索引库的分片数默认 <span class="number">1</span> 片，在 <span class="number">7.0</span><span class="number">.0</span> 之前的 Elasticsearch 版本中，默认 <span class="number">5</span> 片</span><br></pre></td></tr></table></figure><p>如果重复添加索引，会返回错误信息：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639816017-c668e278.png"></p></div><h3 id="查看所有索引"><a href="#查看所有索引" class="headerlink" title="查看所有索引"></a>查看所有索引</h3><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code><a href="http://127.0.0.1:9200/_cat/indices?v">请求</a>：<code>http://127.0.0.1:9200/_cat/indices?v</code>。</p><p>这里请求路径中的<code>_cat</code>表示查看的意思，<code>indices</code>表示索引，所以整体含义就是查看当前<code>ES</code>服务器中的所有索引，就好像<code>MySQL</code>中的<code>showtables</code>的感觉。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639816049-1995eade.png"></p></div><table><thead><tr><th>表头</th><th>含义</th></tr></thead><tbody><tr><td>health</td><td>当前服务器健康状态：  <strong>green</strong> (集群完整) <strong>yellow</strong> (单点正常、集群不完整)red(单点不正常)</td></tr><tr><td>status</td><td>索引打开、关闭状态</td></tr><tr><td>index</td><td>索引名</td></tr><tr><td>uuid</td><td>索引统一编号</td></tr><tr><td>pri</td><td>主分片数量</td></tr><tr><td>rep</td><td>副本数量</td></tr><tr><td>docs.count</td><td>可用文档数量</td></tr><tr><td>docs.deleted</td><td>文档删除状态（逻辑删除）</td></tr><tr><td>store.size</td><td>主分片和副分片整体占空间大小</td></tr><tr><td>pri.store.size</td><td>主分片占空间大小</td></tr></tbody></table><h3 id="查看单个索引"><a href="#查看单个索引" class="headerlink" title="查看单个索引"></a>查看单个索引</h3><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code><a href="http://127.0.0.1:9200/shopping">请求</a>：<code>http://127.0.0.1:9200/shopping</code>。</p><p>查看索引向<code>ES</code>服务器发送的请求路径和创建索引是一致的。但是<code>HTTP</code>方法不一致。这里可以体会一下<code>RESTful</code>的意义。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639816187-9c9fb695.png"></p></div><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="string">&quot;shopping&quot;</span>【索引名】<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="string">&quot;aliases&quot;</span>【别名】<span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;mappings&quot;</span>【映射】<span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="string">&quot;settings&quot;</span>【设置】<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="string">&quot;index&quot;</span>【设置 - 索引】<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="string">&quot;creation_date&quot;</span>【设置 - 索引 - 创建时间】<span class="punctuation">:</span> <span class="string">&quot;1614265373911&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                        <span class="string">&quot;number_of_shards&quot;</span>【设置 - 索引 - 主分片数量】<span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                        <span class="string">&quot;number_of_replicas&quot;</span>【设置 - 索引 - 副分片数量】<span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                        <span class="string">&quot;uuid&quot;</span>【设置 - 索引 - 唯一标识】<span class="punctuation">:</span> <span class="string">&quot;eI5wemRERTumxGCc1bAk2A&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                        <span class="string">&quot;version&quot;</span>【设置 - 索引 - 版本】<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7080099&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="string">&quot;provided_name&quot;</span>【设置 - 索引 - 名称】<span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h3><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>DELETE</code><a href="http://127.0.0.1:9200/shopping">请求</a>：<code>http://127.0.0.1:9200/shopping</code>。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639816219-cc029963.png"></p></div><p>重新访问索引时，服务器返回响应：<strong>索引不存在</strong>。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639816238-f71009ed.png"></p></div><h2 id="文档操作"><a href="#文档操作" class="headerlink" title="文档操作"></a>文档操作</h2><p>索引已经创建好了，接下来来创建文档，并添加数据。这里的文档可以类比为关系型数据库中的表数据，添加的数据格式为<code>JSON</code>格式。</p><h3 id="创建文档"><a href="#创建文档" class="headerlink" title="创建文档"></a>创建文档</h3><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>POST</code><a href="http://127.0.0.1:9200/shopping**/_doc">请求</a>：<code>http://127.0.0.1:9200/shopping/phone</code>，请求体内容为：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="string">&quot;小米手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span><span class="string">&quot;小米&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span><span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="number">3999.00</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639816268-a17dad45.png"></p></div><p>此处发送请求的方式必须为<code>POST</code>，不能是<code>PUT</code>，否则会发生错误。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="string">&quot;_index&quot;</span>【索引】<span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="string">&quot;_type&quot;</span>【类型-文档】<span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;_id&quot;</span>【唯一标识】<span class="punctuation">:</span> <span class="string">&quot;Xhsa2ncBlvF_7lxyCE9G&quot;</span><span class="punctuation">,</span> #可以类比为 MySQL 中的主键，随机生成</span><br><span class="line">    <span class="string">&quot;_version&quot;</span>【版本】<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;result&quot;</span>【结果】<span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span> #这里的 create 表示创建成功</span><br><span class="line">    <span class="string">&quot;_shards&quot;</span>【分片】<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="string">&quot;total&quot;</span>【分片 - 总数】<span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="string">&quot;successful&quot;</span>【分片 - 成功】<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="string">&quot;failed&quot;</span>【分片 - 失败】<span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_seq_no&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_primary_term&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>上面的数据创建后，由于没有指定数据唯一性标识（<code>ID</code>），默认情况下，<code>ES</code>服务器会随机生成一个。如果想要自定义唯一性标识，需要在创建时指定：<code>http://127.0.0.1:9200/shopping/phone/1</code>。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639816300-7c581792.png"></p></div><p>此处需要注意：如果增加数据时明确数据主键，那么请求方式也可以为<code>PUT</code>。</p><h3 id="查看文档"><a href="#查看文档" class="headerlink" title="查看文档"></a>查看文档</h3><p>查看文档时，需要指明文档的唯一性标识，类似于<code>MySQL</code>中数据的主键查询。</p><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code><a href="http://127.0.0.1:9200/shopping/_doc/1">请求</a> ：<code>http://127.0.0.1:9200/shopping/phone/1</code>。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639816409-8f6faef2.png"></p></div><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="string">&quot;_index&quot;</span>【索引】<span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="string">&quot;_type&quot;</span>【文档类型】<span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_version&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_seq_no&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_primary_term&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;found&quot;</span>【查询结果】<span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> # <span class="keyword">true</span> 表示查找到，<span class="keyword">false</span> 表示未查找到</span><br><span class="line">    <span class="string">&quot;_source&quot;</span>【文档源信息】<span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/hw.jpg&quot;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">4999.00</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="修改文档"><a href="#修改文档" class="headerlink" title="修改文档"></a>修改文档</h3><p>和新增文档一样，输入相同的<code>URL</code>地址请求，如果请求体变化，会将原有的数据内容覆盖。</p><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>POST</code><a href="http://127.0.0.1:9200/shopping/_doc/1">请求</a>：<code>http://127.0.0.1:9200/shopping/phone/1</code>。</p><p>请求体内容为：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="string">&quot;华为手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span><span class="string">&quot;华为&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span><span class="string">&quot;http://www.gulixueyuan.com/hw.jpg&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="number">4999.00</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639816439-7936a7b3.png"></p></div><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;_version&quot;</span>【版本】<span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;result&quot;</span>【结果】<span class="punctuation">:</span> <span class="string">&quot;updated&quot;</span><span class="punctuation">,</span> # updated 表示数据被更新</span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_seq_no&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_primary_term&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="修改字段"><a href="#修改字段" class="headerlink" title="修改字段"></a>修改字段</h3><p>修改数据时，也可以只修改某一给条数据的局部信息。</p><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>POST</code><a href="http://127.0.0.1:9200/shopping/_update/1">请求</a>：<code>http://127.0.0.1:9200/shopping/phone/1/_update</code>。</p><p>请求体内容为：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">        <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="number">3000.00</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639816469-f54d8b80.png"></p></div><p>根据唯一性标识，查询文档数据，文档数据已经更新：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639816493-8b6e4663.png"></p></div><h3 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h3><p>删除一个文档不会立即从磁盘上移除，它只是被标记成已删除（逻辑删除）。</p><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>DELETE</code><a href="http://127.0.0.1:9200/shopping/_doc/1">请求</a>：<code>http://127.0.0.1:9200/shopping/phone/1</code>。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639816515-8cc81881.png"></p></div><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;_version&quot;</span>【版本】<span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> #对数据的操作，都会更新版本</span><br><span class="line">    <span class="string">&quot;result&quot;</span>【结果】<span class="punctuation">:</span> <span class="string">&quot;deleted&quot;</span><span class="punctuation">,</span> # deleted 表示数据被标记为删除</span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_seq_no&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_primary_term&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>删除后再查询当前文档信息（<code>GET</code>方式<a href="http://127.0.0.1:9200/shopping/phone/1/">请求</a>：<code>http://127.0.0.1:9200/shopping/phone/1/</code>）：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639816542-4d0caa73.png"></p></div><p>如果删除一个并不存在的文档：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639816569-b7a05692.png"></p></div><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_version&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;result&quot;</span>【结果】<span class="punctuation">:</span> <span class="string">&quot;not_found&quot;</span><span class="punctuation">,</span> # not_found 表示未查找到</span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_seq_no&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_primary_term&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="条件删除文档"><a href="#条件删除文档" class="headerlink" title="条件删除文档"></a>条件删除文档</h3><p>一般删除数据都是根据文档的唯一性标识进行删除，实际操作时，也可以根据条件对多条数据进行删除。</p><p>首先分别增加多条数据：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="string">&quot;小米手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span><span class="string">&quot;小米&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span><span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="number">4000.00</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="string">&quot;华为手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span><span class="string">&quot;华为&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span><span class="string">&quot;http://www.gulixueyuan.com/hw.jpg&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="number">4000.00</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639816599-750f17b0.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639816615-7c9b3a10.png"></p></div><p>向<code>ES</code>服务器发<code>POST</code><a href="http://127.0.0.1:9200/shopping/_delete_by_query">请求</a>：<code>http://127.0.0.1:9200/shopping/_delete_by_query</code>。</p><p>请求体内容为：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> </span><br><span class="line">            <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="number">4000.00</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639816651-9866e373.png"></p></div><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="string">&quot;took&quot;</span>【耗时】<span class="punctuation">:</span> <span class="number">175</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="string">&quot;timed_out&quot;</span>【是否超时】<span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="string">&quot;total&quot;</span>【总数】<span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;deleted&quot;</span>【删除数量】<span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;batches&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version_conflicts&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;noops&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;retries&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;bulk&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;search&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;throttled_millis&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;requests_per_second&quot;</span><span class="punctuation">:</span> <span class="number">-1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;throttled_until_millis&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;failures&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="映射操作"><a href="#映射操作" class="headerlink" title="映射操作"></a>映射操作</h2><p>有了索引库，等于有了数据库中的<code>database</code>。</p><p>接下来就需要建索引库（<code>index</code>）中的映射了，类似于数据库（<code>database</code>）中的表结构（<code>table</code>）。创建数据库表需要设置字段名称，类型，长度，约束等；索引库也一样，需要知道这个类型下有哪些字段，每个字段有哪些约束信息，这就叫做映射（<code>mapping</code>）。</p><h3 id="创建映射"><a href="#创建映射" class="headerlink" title="创建映射"></a><strong>创建映射</strong></h3><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>PUT</code>请求：<code>http://127.0.0.1:9200/student/_mapping</code>。</p><p>请求体内容为：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817020-8f8f3826.png"></p></div><p>映射数据说明：</p><ul><li>字段名：任意填写，下面指定许多属性，例如：<code>title</code>、<code>subtitle</code>、<code>images</code>、<code>price</code></li><li><code>type</code>：类型，<code>Elasticsearch</code>中支持的数据类型非常丰富，说几个关键的：<ul><li><code>String</code>类型，又分两种：<ul><li><code>text</code>：可分词</li><li><code>keyword</code>：不可分词，数据会作为完整字段进行匹配</li></ul></li><li><code>Numerical</code>：数值类型，分两类<ul><li>基本数据类型：<code>long</code>、<code>integer</code>、<code>short</code>、<code>byte</code>、<code>double</code>、<code>float</code>、<code>half_float</code></li><li>浮点数的高精度类型：<code>scaled_float</code></li></ul></li><li><code>Date</code>：日期类型</li><li><code>Array</code>：数组类型</li><li><code>Object</code>：对象</li></ul></li><li><code>index</code>：是否索引，默认为<code>true</code>，也就是说你不进行任何配置，所有字段都会被索引。<ul><li><code>true</code>：字段会被索引，则可以用来进行搜索</li><li><code>false</code>：字段不会被索引，不能用来搜索</li></ul></li><li><code>store</code>：是否将数据进行独立存储，默认为<code>false</code><br>原始的文本会存储在<code>_source</code>里面，默认情况下其他提取出来的字段都不是独立存储的，是从<code>_source</code>里面提取出来的。当然你也可以独立的存储某个字段，只要设置<code>&quot;store&quot;: true</code>即可，获取独立存储的字段要比从<code>_source</code>中解析快得多，但是也会占用更多的空间，所以要根据实际业务需求来设置。</li><li><code>analyzer</code>：分词器，这里的<code>ik_max_word</code>即使用<code>ik</code>分词器，后面会有专门的章节学习</li></ul><h3 id="查看映射"><a href="#查看映射" class="headerlink" title="查看映射"></a>查看映射</h3><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code><a href="http://127.0.0.1:9200/student/_mapping">请求</a>：<code>http://127.0.0.1:9200/student/_mapping</code>。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817054-58371915.png"></p></div><h3 id="索引映射关联"><a href="#索引映射关联" class="headerlink" title="索引映射关联"></a>索引映射关联</h3><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>PUT</code><a href="http://127.0.0.1:9200/student1">请求</a>：<code>http://127.0.0.1:9200/student1</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817081-bc3f7434.png"></p></div><h2 id="高级查询"><a href="#高级查询" class="headerlink" title="高级查询"></a>高级查询</h2><p><code>Elasticsearch</code>提供了基于<code>JSON</code>提供完整的查询<code>DSL</code>来定义查询。</p><p>定义数据：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># POST /student/_doc/<span class="number">1001</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;zhangsan&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span><span class="string">&quot;zhangsan&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span><span class="string">&quot;男&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">30</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"># POST /student/_doc/<span class="number">1002</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;lisi&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span><span class="string">&quot;lisi&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span><span class="string">&quot;男&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">20</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"># POST /student/_doc/<span class="number">1003</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;wangwu&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span><span class="string">&quot;wangwu&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span><span class="string">&quot;女&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">40</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"># POST /student/_doc/<span class="number">1004</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;zhangsan1&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span><span class="string">&quot;zhangsan1&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span><span class="string">&quot;女&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">50</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"># POST /student/_doc/<span class="number">1005</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;zhangsan2&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span><span class="string">&quot;zhangsan2&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span><span class="string">&quot;女&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">30</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="查询所有文档"><a href="#查询所有文档" class="headerlink" title="查询所有文档"></a>查询所有文档</h3><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code><a href="http://127.0.0.1:9200/student/_search">请求</a>：<code>http://127.0.0.1:9200/student/_search</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"># <span class="string">&quot;query&quot;</span>：这里的 query 代表一个查询对象，里面可以有不同的查询属性</span><br><span class="line"># <span class="string">&quot;match_all&quot;</span>：查询类型，例如：match_all(代表查询所有)，match，term，range 等等</span><br><span class="line"># <span class="punctuation">&#123;</span>查询条件<span class="punctuation">&#125;</span>：查询条件会根据类型的不同，写法也有差异</span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817118-f32bd4a4.png"></p></div><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;took【查询花费时间，单位毫秒】&quot;</span> <span class="punctuation">:</span> <span class="number">1116</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;timed_out【是否超时】&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;_shards【分片信息】&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;total【总数】&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;successful【成功】&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;skipped【忽略】&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;failed【失败】&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits【搜索命中结果】&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total【搜索条件匹配的文档总数】&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> </span><br><span class="line">            <span class="attr">&quot;value【总命中计数的值】&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;relation【计数规则】&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span> # eq 表示计数准确， gte 表示计数不准确</span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max_score【匹配度分值】&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;hits【命中结果集合】&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                ...</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="匹配查询"><a href="#匹配查询" class="headerlink" title="匹配查询"></a>匹配查询</h3><p><code>match</code>匹配类型查询，会把查询条件进行分词，然后进行查询，多个词条之间是<code>or</code>的关系。</p><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code><a href="http://127.0.0.1:9200/student/_search">请求</a>：<code>http://127.0.0.1:9200/student/_search</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817144-2a6dfcad.png"></p></div><h3 id="字段匹配查询"><a href="#字段匹配查询" class="headerlink" title="字段匹配查询"></a>字段匹配查询</h3><p><code>multi_match</code>与<code>match</code>类似，不同的是它可以在多个字段中查询。</p><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code><a href="http://127.0.0.1:9200/student/_search">请求</a>：<code>http://127.0.0.1:9200/student/_search</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">        <span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhangsan&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">,</span> <span class="string">&quot;nickname&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817177-917646d7.png"></p></div><h3 id="关键字精确查询"><a href="#关键字精确查询" class="headerlink" title="关键字精确查询"></a>关键字精确查询</h3><p><code>term</code>查询，精确的关键词匹配查询，不对查询条件进行分词。</p><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code>请求：<code>http://127.0.0.1:9200/student/_search</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span>  </span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817199-c4a166ff.png"></p></div><h3 id="多关键字精确查询"><a href="#多关键字精确查询" class="headerlink" title="多关键字精确查询"></a>多关键字精确查询</h3><p><code>terms</code>查询和<code>term</code>查询一样，但它允许你指定多值进行匹配。如果这个字段包含了指定值中的任何一个值，那么这个文档满足条件，类似于<code>mysql</code>的<code>in</code>。</p><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code>请求：<code>http://127.0.0.1:9200/student/_search</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;zhangsan&quot;</span><span class="punctuation">,</span><span class="string">&quot;lisi&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817238-1130232e.png"></p></div><h3 id="指定查询字段"><a href="#指定查询字段" class="headerlink" title="指定查询字段"></a>指定查询字段</h3><p>默认情况下，<code>Elasticsearch</code>在搜索的结果中，会把文档中保存在<code>_source</code>的所有字段都返回。如果只想获取其中的部分字段，可以添加<code>_source</code>的过滤。</p><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code>请求：<code>http://127.0.0.1:9200/student/_search</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">,</span><span class="string">&quot;nickname&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;zhangsan&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817267-8c6d037c.png"></p></div><h3 id="过滤字段"><a href="#过滤字段" class="headerlink" title="过滤字段"></a>过滤字段</h3><p>也可以通过：</p><ul><li><code>includes</code>：来指定想要显示的字段</li><li><code>excludes</code>：来指定不想要显示的字段</li></ul><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code>请求：<code>http://127.0.0.1:9200/student/_search</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;includes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">,</span><span class="string">&quot;nickname&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;zhangsan&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817295-b7aa1ef6.png"></p></div><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;excludes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">,</span><span class="string">&quot;nickname&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;zhangsan&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817317-bb3a4978.png"></p></div><h3 id="组合查询"><a href="#组合查询" class="headerlink" title="组合查询"></a>组合查询</h3><p><code>bool</code>把各种其它查询通过<code>must</code>（必须 ）、<code>must_not</code>（必须不）、<code>should</code>（应该）的方式进行组合。</p><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code>请求：<code>http://127.0.0.1:9200/student/_search</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;40&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;should&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span> <span class="string">&quot;男&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817346-bac20974.png"></p></div><h3 id="范围查询"><a href="#范围查询" class="headerlink" title="范围查询"></a>范围查询</h3><p><code>range</code>查询找出那些落在指定区间内的数字或者时间。<code>range</code>查询允许以下字符：</p><table><thead><tr><th>操作符</th><th>说明</th></tr></thead><tbody><tr><td>gt</td><td>大于&gt;</td></tr><tr><td>gte</td><td>大于等于&gt;=</td></tr><tr><td>lt</td><td>小于&lt;</td></tr><tr><td>lte</td><td>小于等于&lt;=</td></tr></tbody></table><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code>请求：<code>http://127.0.0.1:9200/student/_search</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span> <span class="number">35</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817378-43eb3028.png"></p></div><h3 id="模糊查询"><a href="#模糊查询" class="headerlink" title="模糊查询"></a>模糊查询</h3><p>返回包含与搜索字词相似的字词的文档。</p><p>编辑距离是将一个术语转换为另一个术语所需的一个字符更改的次数。这些更改可以包括：</p><ul><li>更改字符（<code>box→ fox</code>）</li><li>删除字符（<code>black→ lack</code>）</li><li>插入字符（<code>sic→ sick</code>）</li><li>转置两个相邻字符（<code>act→ cat</code>）</li></ul><p>为了找到相似的术语，<code>fuzzy</code>查询会在指定的编辑距离内创建一组搜索词的所有可能的变体或扩展。然后查询返回每个扩展的完全匹配。</p><p>通过<code>fuzziness</code>修改编辑距离。一般使用默认值<code>AUTO</code>，根据术语的长度生成编辑距离。</p><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code>请求：<code>http://127.0.0.1:9200/student/_search</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;fuzzy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817412-f71b86ea.png"></p></div><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;fuzzy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhangsan&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                <span class="attr">&quot;fuzziness&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817432-f28bff45.png"></p></div><h3 id="单字段排序"><a href="#单字段排序" class="headerlink" title="单字段排序"></a>单字段排序</h3><p><code>sort</code>可以按照不同的字段进行排序，并且通过<code>order</code>指定排序的方式。<code>desc</code>降序，<code>asc</code>升序。</p><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code>请求：<code>http://127.0.0.1:9200/student/_search</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span><span class="string">&quot;desc&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817464-cfc8a924.png"></p></div><h3 id="多字段排序"><a href="#多字段排序" class="headerlink" title="多字段排序"></a>多字段排序</h3><p>假定想要结合使用<code>age</code>和<code> _score</code>进行查询，并且匹配的结果首先按照年龄排序，然后按照相关性得分排序。</p><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code>请求：<code>http://127.0.0.1:9200/student/_search</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817492-cef617f1.png"></p></div><h3 id="高亮查询"><a href="#高亮查询" class="headerlink" title="高亮查询"></a>高亮查询</h3><p>在进行关键字搜索时，搜索出的内容中的关键字会显示不同的颜色，称之为高亮。</p><p><code>Elasticsearch</code>可以对查询内容中的关键字部分，进行标签和样式(高亮)的设置。在使用<code>match</code>查询的同时，加上一个<code>highlight</code>属性：</p><ul><li><code>pre_tags</code>：前置标签</li><li><code>post_tags</code>：后置标签</li><li><code>fields</code>：需要高亮的字段</li><li><code>title</code>：这里声明<code>title</code>字段需要高亮，后面可以为这个字段设置特有配置，也可以空</li></ul><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code>请求：<code>http://127.0.0.1:9200/student/_search</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;pre_tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;font color=&#x27;red&#x27;&gt;&quot;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;post_tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;/font&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817523-abf10525.png"></p></div><h3 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h3><ul><li><code>from</code>：当前页的起始索引，默认从 $0$ 开始。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from =(pageNum - 1) * size</span><br></pre></td></tr></table></figure></li><li><code>size</code>：每页显示多少条</li></ul><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code>请求：<code>http://127.0.0.1:9200/student/_search</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817549-a54c4162.png"></p></div><h3 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h3><p>聚合允许使用者对<code>ES</code>文档进行统计分析，类似与关系型数据库中的<code>groupby</code>，当然还有很多其他的聚合，例如取最大值、平均值等等。</p><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code>请求：<code>http://127.0.0.1:9200/student/_search</code>。</p><ul><li><p>对某个字段取最大值<code>max</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;max_age&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> </span><br><span class="line">            <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;age&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817572-da0156c2.png"></p></li><li><p>对某个字段取最小值<code>min</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;min_age&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> </span><br><span class="line">            <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;age&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817591-3724b82b.png"></p></li><li><p>对某个字段求和<code>sum</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;sum_age&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> </span><br><span class="line">            <span class="attr">&quot;sum&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;age&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817611-75a59fb9.png"></p></li><li><p>对某个字段取平均值<code>avg</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;avg_age&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> </span><br><span class="line">            <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;age&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817630-01228e1b.png"></p></li><li><p>对某个字段的值进行去重之后再取总数</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> </span><br><span class="line">        <span class="attr">&quot;distinct_age&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;cardinality&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;age&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817649-f676cd1c.png"></p></li><li><p><code>State</code>聚合<br><code>stats</code>聚合，对某个字段一次性返回<code>count</code>，<code>max</code>，<code>min</code>，<code>avg</code>和<code>sum</code>五个指标</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;stats_age&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> </span><br><span class="line">            <span class="attr">&quot;stats&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;age&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817737-81b97c4c.png"></p></li></ul><h3 id="桶聚合查询"><a href="#桶聚合查询" class="headerlink" title="桶聚合查询"></a>桶聚合查询</h3><p>桶聚和相当于<code>sql</code>中的<code>groupby</code>语句</p><p>在<code>Postman</code>中，向<code>ES</code>服务器发<code>GET</code>请求：<code>http://127.0.0.1:9200/student/_search</code>。</p><ul><li><p><code>terms</code>聚合，分组统计</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> </span><br><span class="line">        <span class="attr">&quot;age_groupby&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;age&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817806-18094163.png"></p></li><li><p><code>terms</code>分组下再进行聚合</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> </span><br><span class="line">        <span class="attr">&quot;age_groupby&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;age&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;sum_age&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;sum&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;age&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1634003472/1639817828-7f9c4845.png"></p></li></ul><h1 id="JavaAPI-操作"><a href="#JavaAPI-操作" class="headerlink" title="JavaAPI 操作"></a>JavaAPI 操作</h1><p><code>Elasticsearch</code>软件是由<code>Java</code>语言开发的，所以也可以通过<code>JavaAPI</code>的方式对<code>Elasticsearch</code></p><p>服务进行访问。</p><h2 id="创建-Maven-项目"><a href="#创建-Maven-项目" class="headerlink" title="创建 Maven 项目"></a>创建 Maven 项目</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- elasticsearch 的客户端 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- elasticsearch 依赖 2.x 的 log4j --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- junit 单元测试 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="客户端对象"><a href="#客户端对象" class="headerlink" title="客户端对象"></a>客户端对象</h2><p>创建<code>ElasticsearchClient</code>类，代码中创建<code>Elasticsearch</code>客户端对象。</p><p>因为早期版本的客户端对象已经不再推荐使用，且在未来版本中会被删除，所以这里我们采用高级 REST 客户端对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.nio.reactor.IOReactorException;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticsearchClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        <span class="comment">// 创建客户端对象</span></span><br><span class="line">        <span class="type">RestHighLevelClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(</span><br><span class="line">                <span class="comment">// 9200 端口为 Elasticsearch 的 Web 通信端口，localhost 为启动 ES 服务的主机名执行代码</span></span><br><span class="line">                RestClient.builder(<span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>))</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭客户端连接</span></span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="索引操作-1"><a href="#索引操作-1" class="headerlink" title="索引操作"></a>索引操作</h2><p><code>ES</code>服务器正常启动后，可以通过<code>JavaAPI</code>客户端对象对<code>ES</code>索引进行操作。</p><h3 id="创建索引-1"><a href="#创建索引-1" class="headerlink" title="创建索引"></a>创建索引</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.indices.CreateIndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.indices.CreateIndexResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.indices.GetIndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.indices.GetIndexResponse;</span><br><span class="line"><span class="keyword">import</span> org.junit.AfterClass;</span><br><span class="line"><span class="keyword">import</span> org.junit.BeforeClass;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticsearchIndex</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeClass</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">beforeClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建客户端对象</span></span><br><span class="line">        client = <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(</span><br><span class="line">                <span class="comment">// 9200 端口为 Elasticsearch 的 Web 通信端口，localhost 为启动 ES 服务的主机名执行代码</span></span><br><span class="line">                RestClient.builder(<span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterClass</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">afterClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 创建索引 - 请求对象</span></span><br><span class="line">        <span class="type">CreateIndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CreateIndexRequest</span>(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="comment">// 发送请求，获取响应</span></span><br><span class="line">        <span class="type">CreateIndexResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.indices().create(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">acknowledged</span> <span class="operator">=</span> response.isAcknowledged();</span><br><span class="line">        <span class="comment">// 响应状态</span></span><br><span class="line">        System.out.println(<span class="string">&quot;操作状态 = &quot;</span> + acknowledged);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="查看索引"><a href="#查看索引" class="headerlink" title="查看索引"></a>查看索引</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 查询索引 - 请求对象</span></span><br><span class="line">    <span class="type">GetIndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetIndexRequest</span>(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">    <span class="comment">// 发送请求，获取响应</span></span><br><span class="line">    <span class="type">GetIndexResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.indices().get(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(<span class="string">&quot;aliases:&quot;</span>+response.getAliases());</span><br><span class="line">    System.out.println(<span class="string">&quot;mappings:&quot;</span>+response.getMappings());</span><br><span class="line">    System.out.println(<span class="string">&quot;settings:&quot;</span>+response.getSettings());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="删除索引-1"><a href="#删除索引-1" class="headerlink" title="删除索引"></a>删除索引</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 删除索引 - 请求对象</span></span><br><span class="line">    <span class="type">DeleteIndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeleteIndexRequest</span>(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">    <span class="comment">// 发送请求，获取响应</span></span><br><span class="line">    <span class="type">AcknowledgedResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.indices().delete(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 操作结果</span></span><br><span class="line">    System.out.println(<span class="string">&quot;操作结果 ： &quot;</span> + response.isAcknowledged());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="文档操作-1"><a href="#文档操作-1" class="headerlink" title="文档操作"></a>文档操作</h2><h3 id="新增文档"><a href="#新增文档" class="headerlink" title="新增文档"></a>新增文档</h3><ol><li>创建数据模型 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSex</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSex</span><span class="params">(String sex)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>创建数据，添加到文档 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentType;</span><br><span class="line"><span class="keyword">import</span> org.junit.AfterClass;</span><br><span class="line"><span class="keyword">import</span> org.junit.BeforeClass;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticsearchDoc</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeClass</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">beforeClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建客户端对象</span></span><br><span class="line">        client = <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(</span><br><span class="line">                <span class="comment">// 9200 端口为 Elasticsearch 的 Web 通信端口，localhost 为启动 ES 服务的主机名执行代码</span></span><br><span class="line">                RestClient.builder(<span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterClass</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">afterClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 新增文档 - 请求对象</span></span><br><span class="line">        <span class="type">IndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>();</span><br><span class="line">        <span class="comment">// 设置索引及唯一性标识</span></span><br><span class="line">        request.index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1001&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建数据对象</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setName(<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">        user.setAge(<span class="number">30</span>);</span><br><span class="line">        user.setSex(<span class="string">&quot;男&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">productJson</span> <span class="operator">=</span> objectMapper.writeValueAsString(user);</span><br><span class="line">        <span class="comment">// 添加文档数据，数据格式为 JSON 格式</span></span><br><span class="line">        request.source(productJson, XContentType.JSON);</span><br><span class="line">        <span class="comment">// 客户端发送请求，获取响应对象</span></span><br><span class="line">        <span class="type">IndexResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.index(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">// 打印结果信息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;_index:&quot;</span> + response.getIndex());</span><br><span class="line">        System.out.println(<span class="string">&quot;_id:&quot;</span> + response.getId());</span><br><span class="line">        System.out.println(<span class="string">&quot;_result:&quot;</span> + response.getResult());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="修改文档-1"><a href="#修改文档-1" class="headerlink" title="修改文档"></a>修改文档</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updataDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 修改文档 - 请求对象</span></span><br><span class="line">    <span class="type">UpdateRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateRequest</span>();</span><br><span class="line">    <span class="comment">// 配置修改参数</span></span><br><span class="line">    request.index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1001&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置请求体，对数据进行修改</span></span><br><span class="line">    request.doc(XContentType.JSON, <span class="string">&quot;sex&quot;</span>, <span class="string">&quot;女&quot;</span>);</span><br><span class="line">    <span class="comment">// 客户端发送请求，获取响应对象</span></span><br><span class="line">    <span class="type">UpdateResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.update(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(<span class="string">&quot;_index:&quot;</span> + response.getIndex());</span><br><span class="line">    System.out.println(<span class="string">&quot;_id:&quot;</span> + response.getId());</span><br><span class="line">    System.out.println(<span class="string">&quot;_result:&quot;</span> + response.getResult());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 1.创建请求对象</span></span><br><span class="line">    <span class="type">GetRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1001&quot;</span>);</span><br><span class="line">    <span class="comment">// 2.客户端发送请求，获取响应对象</span></span><br><span class="line">    <span class="type">GetResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.get(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 3.打印结果信息</span></span><br><span class="line">    System.out.println(<span class="string">&quot;_index:&quot;</span> + response.getIndex());</span><br><span class="line">    System.out.println(<span class="string">&quot;_type:&quot;</span> + response.getType());</span><br><span class="line">    System.out.println(<span class="string">&quot;_id:&quot;</span> + response.getId());</span><br><span class="line">    System.out.println(<span class="string">&quot;source:&quot;</span> + response.getSourceAsString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="删除文档-1"><a href="#删除文档-1" class="headerlink" title="删除文档"></a>删除文档</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 创建请求对象</span></span><br><span class="line">    <span class="type">DeleteRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeleteRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1001&quot;</span>);</span><br><span class="line">    <span class="comment">// 客户端发送请求，获取响应对象</span></span><br><span class="line">    <span class="type">DeleteResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.delete(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 打印信息</span></span><br><span class="line">    System.out.println(response.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="批量操作"><a href="#批量操作" class="headerlink" title="批量操作"></a>批量操作</h3><ul><li>批量新增<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchInsertIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 创建批量新增请求对象</span></span><br><span class="line">    <span class="type">BulkRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line">    request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1001&quot;</span>)</span><br><span class="line">            .source(XContentType.JSON, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>));</span><br><span class="line">    request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1002&quot;</span>)</span><br><span class="line">            .source(XContentType.JSON, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;lisi&quot;</span>));</span><br><span class="line">    request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1003&quot;</span>)</span><br><span class="line">            .source(XContentType.JSON, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;wangwu&quot;</span>));</span><br><span class="line">    <span class="comment">// 客户端发送请求，获取响应对象</span></span><br><span class="line">    <span class="type">BulkResponse</span> <span class="variable">responses</span> <span class="operator">=</span> client.bulk(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 打印结果信息</span></span><br><span class="line">    <span class="comment">// 耗费时间</span></span><br><span class="line">    System.out.println(<span class="string">&quot;took:&quot;</span> + responses.getTook());</span><br><span class="line">    System.out.println(<span class="string">&quot;items:&quot;</span> + responses.getItems());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>批量删除<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchDeleteDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 创建批量删除请求对象</span></span><br><span class="line">    <span class="type">BulkRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line">    request.add(<span class="keyword">new</span> <span class="title class_">DeleteRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1001&quot;</span>));</span><br><span class="line">    request.add(<span class="keyword">new</span> <span class="title class_">DeleteRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1002&quot;</span>));</span><br><span class="line">    request.add(<span class="keyword">new</span> <span class="title class_">DeleteRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1003&quot;</span>));</span><br><span class="line">    <span class="comment">// 客户端发送请求，获取响应对象</span></span><br><span class="line">    <span class="type">BulkResponse</span> <span class="variable">responses</span> <span class="operator">=</span> client.bulk(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 打印结果信息</span></span><br><span class="line">    <span class="comment">//耗费时间</span></span><br><span class="line">    System.out.println(<span class="string">&quot;took:&quot;</span> + responses.getTook());</span><br><span class="line">    System.out.println(<span class="string">&quot;items:&quot;</span> + responses.getItems());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="高级查询-1"><a href="#高级查询-1" class="headerlink" title="高级查询"></a>高级查询</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.bulk.BulkRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.bulk.BulkResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentType;</span><br><span class="line"><span class="keyword">import</span> org.junit.AfterClass;</span><br><span class="line"><span class="keyword">import</span> org.junit.BeforeClass;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticsearchQuery</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeClass</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">beforeClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建客户端对象</span></span><br><span class="line">        client = <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(</span><br><span class="line">                <span class="comment">// 9200 端口为 Elasticsearch 的 Web 通信端口，localhost 为启动 ES 服务的主机名执行代码</span></span><br><span class="line">                RestClient.builder(<span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterClass</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">afterClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchInsertDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 创建批量新增请求对象</span></span><br><span class="line">        <span class="type">BulkRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line">        request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1001&quot;</span>)</span><br><span class="line">                .source(XContentType.JSON, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;age&quot;</span>,<span class="number">30</span>,<span class="string">&quot;sex&quot;</span>,<span class="string">&quot;男&quot;</span>));</span><br><span class="line">        request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1002&quot;</span>)</span><br><span class="line">                .source(XContentType.JSON, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;lisi&quot;</span>, <span class="string">&quot;age&quot;</span>,<span class="number">30</span>,<span class="string">&quot;sex&quot;</span>,<span class="string">&quot;女&quot;</span>));</span><br><span class="line">        request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1003&quot;</span>)</span><br><span class="line">                .source(XContentType.JSON, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;wangwu&quot;</span>, <span class="string">&quot;age&quot;</span>,<span class="number">40</span>,<span class="string">&quot;sex&quot;</span>,<span class="string">&quot;男&quot;</span>));</span><br><span class="line">        request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1004&quot;</span>)</span><br><span class="line">                .source(XContentType.JSON, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;wangwu1&quot;</span>, <span class="string">&quot;age&quot;</span>,<span class="number">40</span>,<span class="string">&quot;sex&quot;</span>,<span class="string">&quot;女&quot;</span>));</span><br><span class="line">        request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1005&quot;</span>)</span><br><span class="line">                .source(XContentType.JSON, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;wangwu2&quot;</span>, <span class="string">&quot;age&quot;</span>,<span class="number">50</span>,<span class="string">&quot;sex&quot;</span>,<span class="string">&quot;男&quot;</span>));</span><br><span class="line">        request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1006&quot;</span>)</span><br><span class="line">                .source(XContentType.JSON, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;wangwu3&quot;</span>, <span class="string">&quot;age&quot;</span>,<span class="number">50</span>,<span class="string">&quot;sex&quot;</span>,<span class="string">&quot;男&quot;</span>));</span><br><span class="line">        request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1007&quot;</span>)</span><br><span class="line">                .source(XContentType.JSON, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;wangwu11&quot;</span>, <span class="string">&quot;age&quot;</span>,<span class="number">60</span>,<span class="string">&quot;sex&quot;</span>,<span class="string">&quot;男&quot;</span>));</span><br><span class="line">        request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1008&quot;</span>)</span><br><span class="line">                .source(XContentType.JSON, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;wangwu555&quot;</span>, <span class="string">&quot;age&quot;</span>,<span class="number">60</span>,<span class="string">&quot;sex&quot;</span>,<span class="string">&quot;男&quot;</span>));</span><br><span class="line">        request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1009&quot;</span>)</span><br><span class="line">                .source(XContentType.JSON, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;wangwu66666&quot;</span>, <span class="string">&quot;age&quot;</span>,<span class="number">60</span>,<span class="string">&quot;sex&quot;</span>,<span class="string">&quot;男&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 客户端发送请求，获取响应对象</span></span><br><span class="line">        <span class="type">BulkResponse</span> <span class="variable">responses</span> <span class="operator">=</span> client.bulk(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">// 打印结果信息</span></span><br><span class="line">        <span class="comment">// 耗费时间</span></span><br><span class="line">        System.out.println(<span class="string">&quot;took:&quot;</span> + responses.getTook());</span><br><span class="line">        System.out.println(<span class="string">&quot;items:&quot;</span> + responses.getItems());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="请求体查询"><a href="#请求体查询" class="headerlink" title="请求体查询"></a>请求体查询</h3><h4 id="查询所有索引数据"><a href="#查询所有索引数据" class="headerlink" title="查询所有索引数据"></a>查询所有索引数据</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryAllIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>();</span><br><span class="line">    request.indices(<span class="string">&quot;student&quot;</span>);</span><br><span class="line">    <span class="comment">// 构建查询的请求体</span></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">    <span class="comment">// 查询所有数据sourceBuilder.query(QueryBuilders.matchAllQuery()); request.source(sourceBuilder);</span></span><br><span class="line"></span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 查询匹配</span></span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">    System.out.println(<span class="string">&quot;took:&quot;</span> + response.getTook());</span><br><span class="line">    System.out.println(<span class="string">&quot;timeout:&quot;</span> + response.isTimedOut());</span><br><span class="line">    System.out.println(<span class="string">&quot;total:&quot;</span> + hits.getTotalHits());</span><br><span class="line">    System.out.println(<span class="string">&quot;MaxScore:&quot;</span> + hits.getMaxScore());</span><br><span class="line">    System.out.println(<span class="string">&quot;hits========&gt;&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="comment">// 输出每条查询的结果信息</span></span><br><span class="line">        System.out.println(hit.getSourceAsString());</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;&lt;&lt;========&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="term-查询"><a href="#term-查询" class="headerlink" title="term 查询"></a>term 查询</h4><p>查询条件为关键字。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryTerm</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>();</span><br><span class="line">    request.indices(<span class="string">&quot;student&quot;</span>);</span><br><span class="line">    <span class="comment">// 构建查询的请求体</span></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">    <span class="comment">// 查询 age=30 的</span></span><br><span class="line">    sourceBuilder.query(QueryBuilders.termQuery(<span class="string">&quot;age&quot;</span>, <span class="string">&quot;30&quot;</span>));</span><br><span class="line">    request.source(sourceBuilder);</span><br><span class="line"></span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 查询匹配</span></span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">    System.out.println(<span class="string">&quot;took:&quot;</span> + response.getTook());</span><br><span class="line">    System.out.println(<span class="string">&quot;timeout:&quot;</span> + response.isTimedOut());</span><br><span class="line">    System.out.println(<span class="string">&quot;total:&quot;</span> + hits.getTotalHits());</span><br><span class="line">    System.out.println(<span class="string">&quot;MaxScore:&quot;</span> + hits.getMaxScore());</span><br><span class="line">    System.out.println(<span class="string">&quot;hits========&gt;&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="comment">// 输出每条查询的结果信息</span></span><br><span class="line">        System.out.println(hit.getSourceAsString());</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;&lt;&lt;========&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="分页查询-1"><a href="#分页查询-1" class="headerlink" title="分页查询"></a>分页查询</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryPage</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(); request.indices(<span class="string">&quot;student&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建查询的请求体</span></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分页查询</span></span><br><span class="line">    <span class="comment">// 当前页其实索引（第一条数据的顺序号），from</span></span><br><span class="line">    sourceBuilder.from(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 每页显示多少条 size</span></span><br><span class="line">    sourceBuilder.size(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    request.source(sourceBuilder);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 查询匹配</span></span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">    System.out.println(<span class="string">&quot;took:&quot;</span> + response.getTook());</span><br><span class="line">    System.out.println(<span class="string">&quot;timeout:&quot;</span> + response.isTimedOut());</span><br><span class="line">    System.out.println(<span class="string">&quot;total:&quot;</span> + hits.getTotalHits());</span><br><span class="line">    System.out.println(<span class="string">&quot;MaxScore:&quot;</span> + hits.getMaxScore());</span><br><span class="line">    System.out.println(<span class="string">&quot;hits========&gt;&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="comment">// 输出每条查询的结果信息</span></span><br><span class="line">        System.out.println(hit.getSourceAsString());</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;&lt;&lt;========&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="数据排序"><a href="#数据排序" class="headerlink" title="数据排序"></a>数据排序</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">querySort</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(); request.indices(<span class="string">&quot;student&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建查询的请求体</span></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 排序</span></span><br><span class="line">    sourceBuilder.sort(<span class="string">&quot;age&quot;</span>, SortOrder.ASC);</span><br><span class="line"></span><br><span class="line">    request.source(sourceBuilder);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 查询匹配</span></span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">    System.out.println(<span class="string">&quot;took:&quot;</span> + response.getTook());</span><br><span class="line">    System.out.println(<span class="string">&quot;timeout:&quot;</span> + response.isTimedOut());</span><br><span class="line">    System.out.println(<span class="string">&quot;total:&quot;</span> + hits.getTotalHits());</span><br><span class="line">    System.out.println(<span class="string">&quot;MaxScore:&quot;</span> + hits.getMaxScore());</span><br><span class="line">    System.out.println(<span class="string">&quot;hits========&gt;&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="comment">// 输出每条查询的结果信息</span></span><br><span class="line">        System.out.println(hit.getSourceAsString());</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;&lt;&lt;========&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="过滤字段-1"><a href="#过滤字段-1" class="headerlink" title="过滤字段"></a>过滤字段</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryFetch</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>();</span><br><span class="line">    request.indices(<span class="string">&quot;student&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建查询的请求体</span></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询字段过滤</span></span><br><span class="line">    String[] excludes = &#123;&#125;;</span><br><span class="line">    String[] includes = &#123;<span class="string">&quot;name&quot;</span>, <span class="string">&quot;age&quot;</span>&#125;;</span><br><span class="line">    sourceBuilder.fetchSource(includes, excludes);</span><br><span class="line"></span><br><span class="line">    request.source(sourceBuilder);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 查询匹配</span></span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">    System.out.println(<span class="string">&quot;took:&quot;</span> + response.getTook());</span><br><span class="line">    System.out.println(<span class="string">&quot;timeout:&quot;</span> + response.isTimedOut());</span><br><span class="line">    System.out.println(<span class="string">&quot;total:&quot;</span> + hits.getTotalHits());</span><br><span class="line">    System.out.println(<span class="string">&quot;MaxScore:&quot;</span> + hits.getMaxScore());</span><br><span class="line">    System.out.println(<span class="string">&quot;hits========&gt;&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="comment">// 输出每条查询的结果信息</span></span><br><span class="line">        System.out.println(hit.getSourceAsString());</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;&lt;&lt;========&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Bool-查询"><a href="#Bool-查询" class="headerlink" title="Bool 查询"></a>Bool 查询</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryBool</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>();</span><br><span class="line">    request.indices(<span class="string">&quot;student&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建查询的请求体</span></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">    <span class="comment">// 必须包含</span></span><br><span class="line">    boolQueryBuilder.must(QueryBuilders.matchQuery(<span class="string">&quot;age&quot;</span>, <span class="string">&quot;30&quot;</span>));</span><br><span class="line">    <span class="comment">// 一定不含</span></span><br><span class="line">    boolQueryBuilder.mustNot(QueryBuilders.matchQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>));</span><br><span class="line">    <span class="comment">// 可能包含</span></span><br><span class="line">    boolQueryBuilder.should(QueryBuilders.matchQuery(<span class="string">&quot;sex&quot;</span>, <span class="string">&quot;男&quot;</span>));</span><br><span class="line"></span><br><span class="line">    sourceBuilder.query(boolQueryBuilder); request.source(sourceBuilder);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 查询匹配</span></span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">    System.out.println(<span class="string">&quot;took:&quot;</span> + response.getTook());</span><br><span class="line">    System.out.println(<span class="string">&quot;timeout:&quot;</span> + response.isTimedOut());</span><br><span class="line">    System.out.println(<span class="string">&quot;total:&quot;</span> + hits.getTotalHits());</span><br><span class="line">    System.out.println(<span class="string">&quot;MaxScore:&quot;</span> + hits.getMaxScore());</span><br><span class="line">    System.out.println(<span class="string">&quot;hits========&gt;&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="comment">// 输出每条查询的结果信息</span></span><br><span class="line">        System.out.println(hit.getSourceAsString());</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;&lt;&lt;========&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="范围查询-1"><a href="#范围查询-1" class="headerlink" title="范围查询"></a>范围查询</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryRange</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>();</span><br><span class="line">    request.indices(<span class="string">&quot;student&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建查询的请求体</span></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">RangeQueryBuilder</span> <span class="variable">rangeQuery</span> <span class="operator">=</span> QueryBuilders.rangeQuery(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">    <span class="comment">// 大于等于</span></span><br><span class="line">    rangeQuery.gte(<span class="string">&quot;30&quot;</span>);</span><br><span class="line">    <span class="comment">// 小于等于</span></span><br><span class="line">    rangeQuery.lte(<span class="string">&quot;40&quot;</span>);</span><br><span class="line"></span><br><span class="line">    sourceBuilder.query(rangeQuery); request.source(sourceBuilder);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 查询匹配</span></span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">    System.out.println(<span class="string">&quot;took:&quot;</span> + response.getTook());</span><br><span class="line">    System.out.println(<span class="string">&quot;timeout:&quot;</span> + response.isTimedOut());</span><br><span class="line">    System.out.println(<span class="string">&quot;total:&quot;</span> + hits.getTotalHits());</span><br><span class="line">    System.out.println(<span class="string">&quot;MaxScore:&quot;</span> + hits.getMaxScore());</span><br><span class="line">    System.out.println(<span class="string">&quot;hits========&gt;&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="comment">// 输出每条查询的结果信息</span></span><br><span class="line">        System.out.println(hit.getSourceAsString());</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;&lt;&lt;========&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="模糊查询-1"><a href="#模糊查询-1" class="headerlink" title="模糊查询"></a>模糊查询</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryFuzziness</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(); </span><br><span class="line">    request.indices(<span class="string">&quot;student&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建查询的请求体</span></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line"></span><br><span class="line">    sourceBuilder.query(QueryBuilders.fuzzyQuery(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;zhangsan&quot;</span>).fuzziness(Fuzziness.ONE));</span><br><span class="line">    request.source(sourceBuilder);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 查询匹配</span></span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits(); </span><br><span class="line">    System.out.println(<span class="string">&quot;took:&quot;</span> + response.getTook()); </span><br><span class="line">    System.out.println(<span class="string">&quot;timeout:&quot;</span> + response.isTimedOut()); </span><br><span class="line">    System.out.println(<span class="string">&quot;total:&quot;</span> + hits.getTotalHits()); </span><br><span class="line">    System.out.println(<span class="string">&quot;MaxScore:&quot;</span> + hits.getMaxScore()); </span><br><span class="line">    System.out.println(<span class="string">&quot;hits========&gt;&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="comment">// 输出每条查询的结果信息</span></span><br><span class="line">        System.out.println(hit.getSourceAsString());</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;&lt;&lt;========&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="高亮查询-1"><a href="#高亮查询-1" class="headerlink" title="高亮查询"></a>高亮查询</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryHighLight</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 高亮查询</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>().indices(<span class="string">&quot;student&quot;</span>);</span><br><span class="line">    <span class="comment">// 2.创建查询请求体构建器</span></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">    <span class="comment">// 构建查询方式：高亮查询</span></span><br><span class="line">    <span class="type">TermsQueryBuilder</span> <span class="variable">termsQueryBuilder</span> <span class="operator">=</span> QueryBuilders.termsQuery(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置查询方式</span></span><br><span class="line">    sourceBuilder.query(termsQueryBuilder);</span><br><span class="line">    <span class="comment">// 构建高亮字段</span></span><br><span class="line">    <span class="type">HighlightBuilder</span> <span class="variable">highlightBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>();</span><br><span class="line">    <span class="comment">// 设置标签前缀</span></span><br><span class="line">    highlightBuilder.preTags(<span class="string">&quot;&lt;font color=&#x27;red&#x27;&gt;&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置标签后缀</span></span><br><span class="line">    highlightBuilder.postTags(<span class="string">&quot;&lt;/font&gt;&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置高亮字段</span></span><br><span class="line">    highlightBuilder.field(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置高亮构建对象</span></span><br><span class="line">    sourceBuilder.highlighter(highlightBuilder);</span><br><span class="line">    <span class="comment">// 设置请求体</span></span><br><span class="line">    request.source(sourceBuilder);</span><br><span class="line">    <span class="comment">// 3.客户端发送请求，获取响应对象</span></span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 4.打印响应结果</span></span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">    System.out.println(<span class="string">&quot;took::&quot;</span>+response.getTook());</span><br><span class="line">    System.out.println(<span class="string">&quot;time_out::&quot;</span>+response.isTimedOut());</span><br><span class="line">    System.out.println(<span class="string">&quot;total::&quot;</span>+hits.getTotalHits());</span><br><span class="line">    System.out.println(<span class="string">&quot;max_score::&quot;</span>+hits.getMaxScore());</span><br><span class="line">    System.out.println(<span class="string">&quot;hits::::&gt;&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">        System.out.println(sourceAsString);</span><br><span class="line">        <span class="comment">// 打印高亮结果</span></span><br><span class="line">        Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span><br><span class="line">        System.out.println(highlightFields);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;&lt;&lt;::::&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="聚合查询-1"><a href="#聚合查询-1" class="headerlink" title="聚合查询"></a>聚合查询</h3><h4 id="最大年龄"><a href="#最大年龄" class="headerlink" title="最大年龄"></a>最大年龄</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryMaxAge</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 高亮查询</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>().indices(<span class="string">&quot;student&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>(); </span><br><span class="line">    <span class="comment">// 设置查询请求体构建器的名称和作用域</span></span><br><span class="line">    sourceBuilder.aggregation(AggregationBuilders.max(<span class="string">&quot;maxAge&quot;</span>).field(<span class="string">&quot;age&quot;</span>));</span><br><span class="line">    <span class="comment">// 设置请求体</span></span><br><span class="line">    request.source(sourceBuilder);</span><br><span class="line">    <span class="comment">// 3.客户端发送请求，获取响应对象</span></span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.打印响应结果</span></span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits(); </span><br><span class="line">    System.out.println(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="分组统计"><a href="#分组统计" class="headerlink" title="分组统计"></a>分组统计</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryGroup</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 高亮查询</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>().indices(<span class="string">&quot;student&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">    <span class="comment">// 设置查询请求体构建器的名称和作用域</span></span><br><span class="line">    sourceBuilder.aggregation(AggregationBuilders.terms(<span class="string">&quot;ageGroupBy&quot;</span>).field(<span class="string">&quot;age&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置请求体</span></span><br><span class="line">    request.source(sourceBuilder);</span><br><span class="line">    <span class="comment">// 3.客户端发送请求，获取响应对象</span></span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.打印响应结果</span></span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">    System.out.println(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ElasticSearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ElasticSearch 概述</title>
      <link href="/2021/10/11/ElasticSearch/01.ElasticSearch%E6%A6%82%E8%BF%B0/"/>
      <url>/2021/10/11/ElasticSearch/01.ElasticSearch%E6%A6%82%E8%BF%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="ElasticSearch-是什么"><a href="#ElasticSearch-是什么" class="headerlink" title="ElasticSearch 是什么"></a>ElasticSearch 是什么</h1><p><code>ElasticSearch</code>是一个分布式、<code>RESTful</code>风格的搜索和数据分析引擎，能够解决不断涌现出的各种用例。作为<code>ElasticStack</code>的核心，它存储数据，帮助发现意料之中以及意料之外的情况。</p><p><code>The ElasticStack</code>包括<code>Elasticsearch</code>、<code>Kibana</code>、<code>Beats</code>和<code>Logstash</code>（也称为<code>ELKStack</code>）。能够安全可靠地获取任何来源、任何格式的数据，然后实时地对数据进行搜索、分析和可视化。</p><p><code>ElaticSearch</code>简称为<code>ES</code>，是一个<strong>开源的高扩展的分布式全文搜索引擎，</strong> 是整个<code>Elastic Stack</code>技术栈的核心。它可以近乎实时的存储、检索数据；本身扩展性很好，可以扩展到上百台服务器，处理<code>PB</code>级别的数据。</p><h1 id="全文搜索引擎"><a href="#全文搜索引擎" class="headerlink" title="全文搜索引擎"></a>全文搜索引擎</h1><p><code>Google</code>、百度类的网站搜索，它们都是根据网页中的关键字生成索引，在搜索的时候输入关键字，它们会将该关键字即索引匹配到的所有网页返回；还有常见的项目中应用日志的搜索等等。对于这些非结构化的数据文本，关系型数据库搜索不是能很好的支持。</p><p>一般传统数据库，全文检索都实现的很鸡肋，因为一般也没人用数据库存文本字段。进行全文检索需要扫描整个表，如果数据量大的话即使对<code>SQL</code>的语法优化，也收效甚微。建立了索引，但是维护起来也很麻烦，<code>insert</code>和<code>update</code>操作都会重新构建索引。</p><p>基于以上原因可以分析得出，在一些生产环境中，使用常规的搜索方式，性能是非常差的：</p><ul><li>搜索的数据对象是大量的非结构化的文本数据</li><li>文件记录量达到数十万或数百万个甚至更多</li><li>支持大量基于交互式文本的查询</li><li>需求非常灵活的全文搜索查询</li><li>对高度相关的搜索结果的有特殊需求，但是没有可用的关系数据库可以满足</li><li>对不同记录类型、非文本数据操作或安全事务处理的需求相对较少的情况</li></ul><p>为了解决结构化数据搜索和非结构化数据搜索性能问题，就需要专业，健壮，强大的全文搜索引擎。</p><p>这里说到的全文搜索引擎指的是目前广泛应用的主流搜索引擎。它的工作原理是计算机索引程序通过扫描文章中的每一个词，对每一个词建立一个索引，指明该词在文章中出现的次数和位置，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户的检索方式。这个过程类似于通过字典中的检索字表查字的过程。</p><h1 id="ElasticSearch-And-Solr"><a href="#ElasticSearch-And-Solr" class="headerlink" title="ElasticSearch And Solr"></a>ElasticSearch And Solr</h1><p><code>Lucene</code>是<code>Apache</code>软件基金会<code>Jakarta</code>项目组的一个子项目，提供了一个简单却强大的应用程式接口，能够做全文索引和搜寻。在<code>Java</code>开发环境里<code>Lucene</code>是一个成熟的免费开源工具。就其本身而言，<code>Lucene</code>是当前以及最近几年最受欢迎的免费<code>Java</code>信息检索程序库。但<code>Lucene</code>只是一个提供全文搜索功能类库的核心工具包，而真正使用它还需要一个完善的服务框架搭建起来进行应用。</p><p>目前市面上流行的搜索引擎软件，主流的就两款：<code>ElasticSearch</code>和<code>Solr</code>，这两款都是基于 <code>Lucene</code>搭建的，可以独立部署启动的搜索引擎服务软件。由于内核相同，所以两者除了服务器安装、部署、管理、集群以外，对于数据的修改、添加、保存、查询等等操作都十分类似。</p><p>在使用过程中，一般都会将<code>ElasticSearch</code>和<code>Solr</code>这两个软件对比，然后进行选型。这两个搜索引擎都是流行的，先进的的开源搜索引擎。它们都是围绕核心底层搜索库<code>Lucene</code>构建的，但它们又是不同的。像所有东西一样，每个都有其优点和缺点：</p><table><thead><tr><th>特征</th><th>Solr/SolrCloud</th><th>ElasticSearch</th></tr></thead><tbody><tr><td>社区和开发者</td><td>Apache软件基金和社区支持</td><td>单一商业实体及其员工</td></tr><tr><td>节点发现</td><td>Apache Zookeeper，在大量项目中成熟且经过实战测试</td><td>Zen内置于ElasticSearch本身，需要专用的主节点才能进行分裂脑保护</td></tr><tr><td>碎片放置</td><td>本质上是静态，需要手动工作来迁移分片，从Solr7开始，Autoscaling API允许一些动态操作</td><td>动态，可以根据群集状态按需移动分片</td></tr><tr><td>高数缓存</td><td>全局，每个段更改无效</td><td>每段，更适合动态更改数据</td></tr><tr><td>分析引擎性能</td><td>非常适合精确计算的静态数据</td><td>结果的准确性取决于数据放置</td></tr><tr><td>全文搜索功能</td><td>基于Lucene的语言分析、多建议、拼写检查、丰富的高亮显示支持</td><td>基于Lucene的语言分析、单一建议API实现、高亮显示重新计算</td></tr><tr><td>DevOps支持</td><td>尚未完全，但即将到来</td><td>非常好的API</td></tr><tr><td>非平面数据处理</td><td>嵌套文档和父-子支持</td><td>嵌套和对象类型的自然支持允许几乎无限的嵌套和父-子支持</td></tr><tr><td>查询DSL</td><td>JSON（有限）、XML（有限）或URL参数</td><td>JSON</td></tr><tr><td>索引/收集领导控制</td><td>领导者安置控制和领导者重新平衡甚至可以节点上的负载</td><td>不可能</td></tr><tr><td>机器学习</td><td>内置-在流聚合之上，专注于逻辑回归和学习排名贡献模块</td><td>商业功能，专注于异常和异常值以及时间序列数据</td></tr></tbody></table><h1 id="ElasticSearch-Or-Solr"><a href="#ElasticSearch-Or-Solr" class="headerlink" title="ElasticSearch Or Solr"></a>ElasticSearch Or Solr</h1><p><code>ElasticSearch</code>和<code>Solr</code>都是开源搜索引擎，那么在使用时该如何选择呢？</p><ul><li><code>Google</code>搜索趋势结果表明，与<code>Solr</code>相比，<code>ElasticSearch</code>具有很大的吸引力，但这并不意味着<code>Apache Solr</code>已经死亡。虽然有些人可能不这么认为，但<code>Solr</code>仍然是最受欢迎的搜索引擎之一，拥有强大的社区和开源支持。</li><li>与<code>Solr</code>相比，<code>ElasticSearch</code>易于安装且非常轻巧。此外，可以在几分钟内安装并运行<code>ElasticSearch</code>。但是，如果<code>ElasticSearch</code>管理不当，这种易于部署和使用可能会成为一个问题。基于<code>JSON</code>的配置很简单，但如果要为文件中的每个配置指定注释，那么它不适合您。总的来说，如果你的应用使用的是<code>JSON</code>，那么<code>ElasticSearch</code>是一个更好的选择。否则，请使用 <code>Solr</code>，因为它的<code>schema.xml</code>和<code>solrconfig.xml</code>都有很好的文档记录。</li><li><code>Solr</code>拥有更大，更成熟的用户，开发者和贡献者社区。<code>ES</code>虽拥有的规模较小但活跃的用户社区以及不断增长的贡献者社区。<code>Solr</code>贡献者和提交者来自许多不同的组织，而<code>ElasticSearch</code> 提交者来自单个公司。</li><li><code>Solr</code>更成熟，但<code>ES</code>增长迅速，更稳定。</li><li><code>Solr</code>是一个非常有据可查的产品，具有清晰的示例和<code>API</code>用例场景。<code>ElasticSearch</code>的文档组织良好，但它缺乏好的示例和清晰的配置说明。</li></ul><p>那么，到底是<code>Solr</code>还是<code>ElasticSearch</code>？</p><p>有时很难找到明确的答案。无论您选择<code>Solr</code>还是<code>ElasticSearch</code>，首先需要了解正确的用例和未来需求。总结他们的每个属性。</p><ul><li>由于易于使用，<code>ElasticSearch</code>在新开发者中更受欢迎。一个下载和一个命令就可以启动一切</li><li>如果除了搜索文本之外还需要它来处理分析查询，<code>ElasticSearch</code>是更好的选择</li><li>如果需要分布式索引，则需要选择<code>ElasticSearch</code>。对于需要良好可伸缩性和以及性能分布式环境，<code>ElasticSearch</code>是更好的选择</li><li><code>ElasticSearch</code>在开源日志管理用例中占据主导地位，许多组织在<code>ElasticSearch</code>中索引它们的日志以使其可搜索</li><li>如果你喜欢监控和指标，那么请使用<code>ElasticSearch</code>，因为相对于<code>Solr</code>，<code>ElasticSearch</code>暴露了更多的关键指标</li></ul><h1 id="ElasticSearch应用案例"><a href="#ElasticSearch应用案例" class="headerlink" title="ElasticSearch应用案例"></a>ElasticSearch应用案例</h1><ul><li><strong>GitHub</strong>：$2013$ 年初，抛弃了<code>Solr</code>，采取<code>ElasticSearch</code>来做<code>PB</code>级的搜索。<code>GitHub</code>使用<code>ElasticSearch</code>搜索 $20$ TB 的数据，包括 $13$ 亿文件和 $1300$ 亿行代码。</li><li><strong>维基百科</strong>：启动以<code>ElasticSearch</code>为基础的核心搜索架构</li><li><strong>SoundCloud</strong>：<code>SoundCloud</code>使用<code>Elasticsearch</code>为 $1.8$ 亿用户提供即时而精准的音乐搜索服务。</li><li><strong>百度</strong>：目前广泛使用<code>Elasticsearch</code>作为文本数据分析，采集百度所有服务器上的各类指标数据及用户自定义数据，通过对各种数据进行多维分析展示，辅助定位分析实例异常或业务层面异常。目前覆盖百度内部 $20$ 多个业务线（包括云分析、网盟、预测、文库、直达号、钱包、风控等），单集群最大 $100$ 台机器，$200$ 个<code>ES</code>节点，每天导入 $30$ TB+数据。</li><li><strong>新浪</strong>：使用<code>Elasticsearch</code>分析处理 $32$ 亿条实时日志</li><li><strong>阿里</strong>：使用<code>Elasticsearch</code>构建日志采集和分析体系</li><li><strong>Stack</strong> <strong>Overflow</strong> ：解决<code>Bug</code>问题的网站，全英文，编程人员交流的网站</li></ul><h1 id="Elasticsearch安装"><a href="#Elasticsearch安装" class="headerlink" title="Elasticsearch安装"></a>Elasticsearch安装</h1><p><code>Elasticsearch</code>的<a href="%5Bhttps://www.elastic.co/cn/%5D(https://www.elastic.co/cn/)">官方地址</a>，<a href="%5Bhttps://www.elastic.co/cn/downloads/past-releases#elasticsearch%5D(https://www.elastic.co/cn/downloads/past-releases#elasticsearch)">下载地址</a></p><p><code>Windows</code>版的<code>Elasticsearch</code>的安装很简单，解压即安装完毕，解压后的<code>Elasticsearch</code><br>的目录结构如下：</p><table><thead><tr><th>目录</th><th>含义</th></tr></thead><tbody><tr><td>bin</td><td>可执行脚本目录</td></tr><tr><td>config</td><td>配置目录</td></tr><tr><td>jdk</td><td>内置JDK目录</td></tr><tr><td>lib</td><td>类库</td></tr><tr><td>logs</td><td>日志目录</td></tr><tr><td>modules</td><td>模块目录</td></tr><tr><td>plugins</td><td>插件目录</td></tr></tbody></table><p>解压后，进入<code>bin</code>文件目录，点击<code>elasticsearch.bat</code>文件启动ES服务。</p><p><strong>注意：</strong>$9300$ 端口为<code>Elasticsearch</code>集群间组件的通信端口，$9200$ 端口为浏览器访问的<code>http</code></p><p>协议<code>RESTful</code>端口。</p><p>打开浏览器（推荐使用谷歌浏览器），输入<a href="http://localhost:9200/">地址</a>：<code>http://localhost:9200</code>，测试结果。</p><h3 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h3><ul><li><code>Elasticsearch</code>是使用<code>java</code>开发的，且 $7.8$ 版本的<code>ES</code>需要<code>JDK</code>版本 $1.8$ 以上，默认安装包带有<code>jdk</code>环境，如果系统配置<code>JAVA_HOME</code>，那么使用系统默认的<code>JDK</code>，如果没有配置使用自带的<code>JDK</code>，一般建议使用系统配置的<code>JDK</code>。</li><li>双击启动窗口闪退，通过路径访问追踪错误，如果是“空间不足”，请修改<code>config/jvm.options</code>配置文件<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 设置 JVM 初始内存为 1G。此值可以设置与-Xmx 相同，以避免每次垃圾回收完成后 JVM 重新分配内存</span><br><span class="line"># Xms represents the initial size of total heap space # 设置 JVM 最大可用内存为 1G</span><br><span class="line"># Xmx represents the maximum size of total heap space</span><br><span class="line"></span><br><span class="line">-Xms1g</span><br><span class="line">-Xmx1g</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ElasticSearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GitLab服务器</title>
      <link href="/2021/04/28/Git/06.GitLab%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
      <url>/2021/04/28/Git/06.GitLab%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="官网"><a href="#官网" class="headerlink" title="官网"></a>官网</h1><ul><li><a href="https://about.gitlab.com/">首页</a></li><li><a href="https://about.gitlab.com/installation/">安装说明</a></li></ul><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y curl policycoreutils-python openssh-server cronie</span><br><span class="line">sudo lokkit -s http -s ssh</span><br><span class="line">sudo yum install postfix</span><br><span class="line">sudo service postfix start</span><br><span class="line">sudo chkconfig postfix on</span><br><span class="line">curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.rpm.sh | sudo bash</span><br><span class="line">sudo EXTERNAL_URL=<span class="string">&quot;http://gitlab.example.com&quot;</span> yum -y install gitlab-ee</span><br></pre></td></tr></table></figure><p>　　<code>yum</code>安装<code>gitlab-ee</code>（或<code>ce</code>）时，需要联网下载安装文件，非常耗时，所以应提前把所需<code>RPM</code>包下载并安装好，<a href="https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/7/gitlab-ce-10.8.2-ce.0.el7.x86_64.rpm">下载地址</a>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo rpm -ivh /opt/gitlab-ce-10.8.2-ce.0.el7.x86_64.rpm</span><br><span class="line">sudo yum install -y curl policycoreutils-python openssh-server cronie</span><br><span class="line">sudo lokkit -s http -s ssh</span><br><span class="line">sudo yum install postfix</span><br><span class="line">sudo service postfix start</span><br><span class="line">sudo chkconfig postfix on</span><br><span class="line">curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash</span><br><span class="line">sudo EXTERNAL_URL=<span class="string">&quot;http://gitlab.example.com&quot;</span> yum -y install gitlab-ce</span><br></pre></td></tr></table></figure><p>　　步骤完成后重启。</p><h1 id="GitLab-服务操作"><a href="#GitLab-服务操作" class="headerlink" title="GitLab 服务操作"></a>GitLab 服务操作</h1><ul><li>初始化配置<code>GitLab</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure></li><li>启动<code>GitLab</code>服务<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl start</span><br></pre></td></tr></table></figure></li><li>停止<code>GitLab</code>服务<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl stop</span><br></pre></td></tr></table></figure></li></ul><h1 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h1><p>访问<code>Linux</code>服务器<code>IP</code>地址即可，如果想访问<code>EXTERNAL_URL</code>指定的域名还需要配置域名服务器或本地<code>hosts</code> 文件。</p><p>初次登录时需要为<code>GitLab</code>的<code>root</code>用户设置密码：</p><div align="center">  <p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619601545/1639558817-412aea69.png"></p></div><p>应该会需要停止防火墙服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service firewalld stop</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git工作流</title>
      <link href="/2021/04/28/Git/05.Git%E5%B7%A5%E4%BD%9C%E6%B5%81/"/>
      <url>/2021/04/28/Git/05.Git%E5%B7%A5%E4%BD%9C%E6%B5%81/</url>
      
        <content type="html"><![CDATA[<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>在项目开发过程中使用<code>Git</code>的方式。</p><h1 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h1><h2 id="集中式工作流"><a href="#集中式工作流" class="headerlink" title="集中式工作流"></a>集中式工作流</h2><p>像<code>SVN</code>一样，集中式工作流以中央仓库作为项目所有修改的单点实体。所有修改都提交到<code>Master</code>这个分支上。</p><p>这种方式与<code>SVN</code>的主要区别就是开发人员有本地库。<code>Git</code>很多特性并没有用到。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619590959/1639558390-b72865e1.png"></p></div><h2 id="GitFlow-工作流"><a href="#GitFlow-工作流" class="headerlink" title="GitFlow 工作流"></a>GitFlow 工作流</h2><p><code>Gitflow</code>工作流通过为功能开发、发布准备和维护设立了独立的分支，让发布迭代过程更流畅。严格的分支模型也为大型项目提供了一些非常必要的结构。</p><div align="center">  <p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619590959/1639558431-f7b6600c.png"></p></div><h1 id="Forking-工作流"><a href="#Forking-工作流" class="headerlink" title="Forking 工作流"></a>Forking 工作流</h1><p><code>Forking</code>工作流是在<code>GitFlow</code>基础上，充分利用了<code>Git</code>的<code>Fork</code>和<code>pull request</code>的功能以达到代码审核的目的。 更适合安全可靠地管理大团队的开发者， 而且能接受不信任贡献者的提交。</p><div align="center">  <p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619590959/1639558453-4cbe2bfa.png"></p></div><h1 id="GitFlow-工作流详解"><a href="#GitFlow-工作流详解" class="headerlink" title="GitFlow 工作流详解"></a>GitFlow 工作流详解</h1><h2 id="分支种类"><a href="#分支种类" class="headerlink" title="分支种类"></a>分支种类</h2><ul><li>主干分支<code>master</code><ul><li>主要负责管理正在运行的生产环境代码。 永远保持与正在运行的生产环境完全一致</li></ul></li><li>开发分支<code>develop</code><ul><li>主要负责管理正在开发过程中的代码，一般情况下应该是最新的代码</li></ul></li><li><code>bug</code>修理分支<code>hotfix</code><ul><li>主要负责管理生产环境下出现的紧急修复的代码</li><li>从主干分支分出，修理完毕并测试上线后，并回主干分支；并回后，视情况可以删除该分支</li></ul></li><li>准生产分支（预发布分支）<code>release</code><ul><li>较大的版本上线前， 会从开发分支中分出准生产分支， 进行最后阶段的集成测试</li><li>该版本上线后，会合并到主干分支。生产环境运行一段阶段较稳定后可以视情况删除</li></ul></li><li>功能分支<code>feature</code><ul><li>为了不影响较短周期的开发工作， 一般把中长期开发模块， 会从开发分支中独立出来</li><li>开发完成后会合并到开发分支</li></ul></li></ul><h2 id="GitFlow-工作流举例"><a href="#GitFlow-工作流举例" class="headerlink" title="GitFlow 工作流举例"></a>GitFlow 工作流举例</h2><div align="center">  <p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619590959/1639558487-8d9fd995.png"></p></div><h2 id="分支实战"><a href="#分支实战" class="headerlink" title="分支实战"></a>分支实战</h2><div align="center">  <p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619590959/1639558505-1736076b.png"></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GitHub</title>
      <link href="/2021/04/28/Git/04.GitHub/"/>
      <url>/2021/04/28/Git/04.GitHub/</url>
      
        <content type="html"><![CDATA[<h1 id="账号信息"><a href="#账号信息" class="headerlink" title="账号信息"></a>账号信息</h1><p><a href="https://github.com/"><code>GitHub</code>首页</a>就是注册页面。</p><h1 id="创建远程库"><a href="#创建远程库" class="headerlink" title="创建远程库"></a>创建远程库</h1><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639557218-5af0e8b3.png"></p></div><h1 id="创建远程库地址别名"><a href="#创建远程库地址别名" class="headerlink" title="创建远程库地址别名"></a>创建远程库地址别名</h1><ul><li>查看当前所有远程地址别名<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote -v</span><br></pre></td></tr></table></figure></li><li>创建远程库地址别名<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add [别名] [远程地址]</span><br></pre></td></tr></table></figure></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/huashan]$ gitt remote add origin https://github.com/atguigu2018ybuq/huashan.git</span><br><span class="line">[root@centos /home/huashan (master)]$ git remote -v</span><br><span class="line">origin https://github.com/atguigu2018ybuq/huashan.git (fetch)</span><br><span class="line">origin https://github.com/atguigu2018ybuq/huashan.git (push)</span><br></pre></td></tr></table></figure><h1 id="推送"><a href="#推送" class="headerlink" title="推送"></a>推送</h1><p>开发修改完把本地库的文件推送到远程仓库，前提是提交到了本地库才可以推送。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push [别名] [分支名]</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/huashan (master)]$ git push origin master</span><br></pre></td></tr></table></figure><h1 id="克隆"><a href="#克隆" class="headerlink" title="克隆"></a>克隆</h1><p>完整的把远程库克隆到本地，克隆下来后不要在主分支里面做开发。<code>clone</code>进行一次，从无到有的过程，更新用<code>pull</code>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> [远程地址]</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/huashan]$ git <span class="built_in">clone</span> https://github.com/atguigu2018ybuq/huashan.git</span><br></pre></td></tr></table></figure><p>效果：</p><ul><li>完整的把远程库下载到本地</li><li>创建<code>origin</code>远程地址别名</li><li>初始化本地库</li></ul><h1 id="团队成员邀请"><a href="#团队成员邀请" class="headerlink" title="团队成员邀请"></a>团队成员邀请</h1><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639557651-9a390d49.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639557663-a076fc64.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639557676-32257b87.png"></p></div><p>“岳不群”把邀请链接发送给“令狐冲”，令狐冲”登录自己的<code>GitHub</code>账号，访问邀请链接。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639557711-64b05b32.png"></p></div><h1 id="拉取"><a href="#拉取" class="headerlink" title="拉取"></a>拉取</h1><p><code>pull=fetch+merge</code></p><ul><li><code>fetch</code>只是抓取远程库，不会修改本地，想要查看可以<code>git checkout origin/master</code></li><li>将<code>fetch</code>和<code>merge</code>分开来做，可以更方便，先将远程库抓取，查看之后再合并，合并使用<code>git merge origin/master</code></li><li>直接使用<code>pull</code>可能会在其中的<code>merge</code>操作发生冲突</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git fetch [远程库地址别名] [远程分支名]</span><br><span class="line">git merge [远程库地址别名/远程分支名]</span><br><span class="line">git pull [远程库地址别名] [远程分支名]</span><br></pre></td></tr></table></figure><h1 id="解决冲突"><a href="#解决冲突" class="headerlink" title="解决冲突"></a>解决冲突</h1><p><code>A</code>和<code>B</code>原本都是同样的文件，<code>A</code>修改后推送到<code>GitHub</code>上，<code>B</code>再修改后推送就不允许了。</p><ul><li>要点<ul><li>如果不是基于<code>GitHub</code>远程库的最新版所做的修改，不能推送，必须先拉取</li><li>拉取下来后如果进入冲突状态，则按照“分支冲突解决”操作解决即可</li><li>解决冲突后的提交是不能带文件名的</li></ul></li><li>类比<ul><li>债权人：老王</li><li>债务人：小刘</li><li>老王说：10 天后归还。小刘接受，双方达成一致</li><li>老王媳妇说：5 天后归还。小刘不能接受。老王媳妇需要找老王确认后再执行</li></ul></li></ul><h1 id="跨团队协作"><a href="#跨团队协作" class="headerlink" title="跨团队协作"></a>跨团队协作</h1><ul><li><p>Fork</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639557754-87fca229.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639557765-5461c3c0.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639557780-1e770727.png"></p></div></li><li><p>本地修改，然后推送到远程</p></li><li><p><code>Pull Request</code></p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639557862-447a0f29.png"></p></div><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639557916-ebe49a0b.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639557886-18db53f1.png"></p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639557932-f58d4579.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639557946-b390062f.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639557962-38ab0f68.png"></p></div></li><li><p>对话</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639557977-2b0b667b.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639557986-cce3aaa4.png"></p></div></li><li><p>审核代码</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639557999-1259ec27.png"></p></div></li><li><p>合并代码</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639558016-53f4e673.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639558024-8fbb202c.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619577686/1639558033-b1ca4f8c.png"></p></div></li><li><p>将远程库修改拉取到本地</p></li></ul><h1 id="SSH-登录"><a href="#SSH-登录" class="headerlink" title="SSH 登录"></a>SSH 登录</h1><p>缺点：每台电脑只能登陆一个账号。</p><ul><li>进入当前用户的家目录<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br></pre></td></tr></table></figure></li><li>删除<code>.ssh</code>目录<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rvf .ssh</span><br></pre></td></tr></table></figure></li><li>运行命令生成<code>.ssh</code>密钥目录<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意：这里 -C 参数是大写的 C</span></span><br><span class="line">ssh-keygen -t rsa -C atguigu2018ybuq@aliyun.com</span><br></pre></td></tr></table></figure></li><li>进入<code>.ssh</code>目录查看文件列表<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> .ssh</span><br><span class="line"> <span class="built_in">ls</span> -lF</span><br></pre></td></tr></table></figure></li><li>查看<code>id_rsa.pub</code>文件内容<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> id_rsa.pub</span><br></pre></td></tr></table></figure></li><li>复制<code>id_rsa.pub</code>文件内容， 登录<code>GitHub</code>，点击用户头像→<code>Settings</code>→<code>SSH and GPG keys</code></li><li><code>New SSH Key</code></li><li>输入复制的密钥信息</li><li>回到<code>Git bash</code>创建远程地址别名<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin_ssh git@github.com:atguigu2018ybuq/huashan.git</span><br></pre></td></tr></table></figure></li><li>推送文件进行测试</li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git基本原理</title>
      <link href="/2021/04/27/Git/03.Git%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/"/>
      <url>/2021/04/27/Git/03.Git%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h1 id="哈希"><a href="#哈希" class="headerlink" title="哈希"></a>哈希</h1><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619531566/1639490272-1d560d57.png"></p></div><p>哈希是一个系列的加密算法， 各个不同的哈希算法虽然加密强度不同， 但是有以下几个共同点：</p><ol><li>不管输入数据的数据量有多大， 输入同一个哈希算法， 得到的加密结果长度固定</li><li>哈希算法确定，输入数据确定，输出数据能够保证不变</li><li>哈希算法确定，输入数据有变化，输出数据一定有变化，而且通常变化很大</li><li>哈希算法不可逆</li></ol><p><code>Git</code>底层采用的是<code>SHA-1</code>算法。</p><p>哈希算法可以被用来验证文件。原理如下图所示：</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619531566/1639490341-897d5c2a.png"></p></div><p><code>Git</code>就是靠这种机制来从根本上保证数据完整性的。</p><h1 id="Git-保存版本的机制"><a href="#Git-保存版本的机制" class="headerlink" title="Git 保存版本的机制"></a>Git 保存版本的机制</h1><h2 id="集中式版本控制工具的文件管理机制"><a href="#集中式版本控制工具的文件管理机制" class="headerlink" title="集中式版本控制工具的文件管理机制"></a>集中式版本控制工具的文件管理机制</h2><p>以文件变更列表的方式存储信息。 这类系统将它们保存的信息看作是一组基本文件和每个文件随时间逐步累积的差异。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619531566/1639490364-7adebb8f.png"></p></div><h2 id="Git-的文件管理机制"><a href="#Git-的文件管理机制" class="headerlink" title="Git 的文件管理机制"></a>Git 的文件管理机制</h2><p><code>Git</code>把数据看作是小型文件系统的一组快照。每次提交更新时<code>Git</code>都会对当前的全部文件制作一个快照并保存这个快照的索引。为了高效，如果文件没有修改，<code>Git</code>不再重新存储该文件，而是只保留一个链接指向之前存储的文件。所以<code>Git</code>的工作方式可以称之为快照流。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619531566/1639490395-56476f26.png"></p></div><h2 id="Git-文件管理机制细节"><a href="#Git-文件管理机制细节" class="headerlink" title="Git 文件管理机制细节"></a>Git 文件管理机制细节</h2><ul><li>Git 的“提交对象”<br><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619531566/1639490419-85847034.png"></li><li>提交对象及其父对象形成的链条<br><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619531566/1639490437-9e8efdf9.png"></li></ul><h1 id="Git-分支管理机制"><a href="#Git-分支管理机制" class="headerlink" title="Git 分支管理机制"></a>Git 分支管理机制</h1><h2 id="分支的创建"><a href="#分支的创建" class="headerlink" title="分支的创建"></a>分支的创建</h2><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619531566/1639490458-8c349184.png"></p></div>　## 分支的切换<div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619531566/1639490479-cb2a878d.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619531566/1639490492-39e44130.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619531566/1639490618-b22f8098.png"></p><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619531566/1639490628-a44465ab.png"></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git操作</title>
      <link href="/2021/04/23/Git/02.Git%E6%93%8D%E4%BD%9C/"/>
      <url>/2021/04/23/Git/02.Git%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<h1 id="本地库初始化"><a href="#本地库初始化" class="headerlink" title="本地库初始化"></a>本地库初始化</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br></pre></td></tr></table></figure><p>注意：<code>.git</code>目录中存放的是本地库相关的子目录和文件，不要删除，也不要胡乱修改。</p><h1 id="设置签名"><a href="#设置签名" class="headerlink" title="设置签名"></a>设置签名</h1><ul><li><p>形式</p><ul><li>用户名：<code>tom</code></li><li><code>Email</code>地址：<code>goodMorning@atguigu.com</code></li></ul></li><li><p>作用：区分不同开发人员的身份</p></li><li><p>辨析：这里设置的签名和登录远程库（代码托管中心）的账号、密码没有任何关系。</p></li><li><p>命令</p><ul><li><p>项目级别/仓库级别：仅在当前本地库范围内有效</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config user.name tom_pro</span><br><span class="line">git config user.email goodMorning_pro@atguigu.com</span><br></pre></td></tr></table></figure><p>信息保存位置：<code>./.git/config</code>文件</p></li><li><p>系统用户级别：登录当前操作系统的用户范围</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name tom_glb</span><br><span class="line">git config --global goodMorning_pro@atguigu.com</span><br></pre></td></tr></table></figure><p>信息保存位置：<code>~/.gitconfig</code>文件</p></li></ul></li><li><p>级别优先级</p><ul><li>就近原则： 项目级别优先于系统用户级别， 二者都有时采用项目级别的签名</li><li>如果只有系统用户级别的签名，就以系统用户级别的签名为准</li><li>不允许二者都没有</li></ul></li></ul><h1 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h1><h2 id="状态查看"><a href="#状态查看" class="headerlink" title="状态查看"></a>状态查看</h2><p>查看工作区、暂存区状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br></pre></td></tr></table></figure><h2 id="添加"><a href="#添加" class="headerlink" title="添加"></a>添加</h2><p>将工作区的“新建/修改”添加到暂存区</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add [file name]</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (master)]$ vi test.txt</span><br><span class="line">[root@centos /home/gittest (master)]$ git add test.txt</span><br></pre></td></tr></table></figure><h2 id="提交"><a href="#提交" class="headerlink" title="提交"></a>提交</h2><p>将暂存区的内容提交到本地库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit -m <span class="string">&quot;commit message&quot;</span> [file name]</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (master)]$ git commit -m <span class="string">&quot;first commit&quot;</span> test.txt</span><br></pre></td></tr></table></figure><h2 id="查看历史记录"><a href="#查看历史记录" class="headerlink" title="查看历史记录"></a>查看历史记录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (master)]$ git <span class="built_in">log</span></span><br><span class="line">commit f60cd6c (HEAD -&gt; master)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --pretty=oneline</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --oneline</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HEAD@&#123;移动到当前版本需要多少步&#125;</span></span><br><span class="line">git reflog</span><br></pre></td></tr></table></figure><p>多屏显示控制方式：</p><ul><li>空格向下翻页</li><li><code>b</code>向上翻页</li><li><code>q</code>退出</li></ul><h2 id="前进后退"><a href="#前进后退" class="headerlink" title="前进后退"></a>前进后退</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (master)]$ git reflog</span><br><span class="line">ee9b643 (HEAD -&gt; master) HEAD@&#123;0&#125;: commit: <span class="built_in">test</span> add h</span><br><span class="line">bea03f7 HEAD@&#123;1&#125;: commit: <span class="built_in">test</span> add g</span><br><span class="line">2237de4 HEAD@&#123;2&#125;: commit: <span class="built_in">test</span> add f</span><br><span class="line">4e8b43b HEAD@&#123;3&#125;: commit: <span class="built_in">test</span> add e</span><br><span class="line">c9fe281 HEAD@&#123;4&#125;: commit: <span class="built_in">test</span> add d</span><br><span class="line">9c4147d HEAD@&#123;5&#125;: commit: <span class="built_in">test</span> thrid commit </span><br><span class="line">31eebcc HEAD@&#123;6&#125;: commit: <span class="built_in">test</span> second commit </span><br><span class="line">f60cd6c HEAD@&#123;7&#125;: commit: <span class="built_in">test</span> first commit</span><br></pre></td></tr></table></figure><ul><li><p>基于索引值操作[<strong>推荐</strong>]</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard [局部索引值]</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (master)]$ git reset --hard 9c4147d</span><br><span class="line">HEAD is now at 9c4147d <span class="built_in">test</span> thrid commit</span><br><span class="line">[root@centos /home/gittest (master)]$ git reflog</span><br><span class="line">9c4147d (HEAD -&gt; master) HEAD@&#123;0&#125;: reset: moving to 9c4147d </span><br><span class="line">ee9b643 HEAD@&#123;1&#125;: commit: <span class="built_in">test</span> add h</span><br><span class="line">bea03f7 HEAD@&#123;2&#125;: commit: <span class="built_in">test</span> add g</span><br><span class="line">2237de4 HEAD@&#123;3&#125;: commit: <span class="built_in">test</span> add f</span><br><span class="line">4e8b43b HEAD@&#123;4&#125;: commit: <span class="built_in">test</span> add e</span><br><span class="line">c9fe281 HEAD@&#123;5&#125;: commit: <span class="built_in">test</span> add d</span><br><span class="line">9c4147d (HEAD -&gt; master) HEAD@&#123;6&#125;: commit (initial): <span class="built_in">test</span> thrid commit </span><br><span class="line">31eebcc HEAD@&#123;7&#125;: commit: <span class="built_in">test</span> second commit </span><br><span class="line">f60cd6c HEAD@&#123;8&#125;: commit: <span class="built_in">test</span> first commit</span><br></pre></td></tr></table></figure></li><li><p>使用<code>^</code>符号：只能后退</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard HEAD^</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (master)]$ git reset --hard HEAD^</span><br><span class="line">HEAD is now at 31eebcc <span class="built_in">test</span> second commit</span><br><span class="line">[root@centos /home/gittest (master)]$ git reflog</span><br><span class="line">31eebcc (HEAD -&gt; master) HEAD@&#123;0&#125;: reset: moving to HEAD^</span><br><span class="line">9c4147d HEAD@&#123;1&#125;: reset: moving to 9c4147d</span><br><span class="line">ee9b643 HEAD@&#123;2&#125;: commit: <span class="built_in">test</span> add h</span><br><span class="line">bea03f7 HEAD@&#123;3&#125;: commit: <span class="built_in">test</span> add g</span><br><span class="line">2237de4 HEAD@&#123;4&#125;: commit: <span class="built_in">test</span> add f</span><br><span class="line">4e8b43b HEAD@&#123;5&#125;: commit: <span class="built_in">test</span> add e</span><br><span class="line">c9fe281 HEAD@&#123;6&#125;: commit: <span class="built_in">test</span> add d</span><br><span class="line">9c4147d HEAD@&#123;7&#125;: commit: <span class="built_in">test</span> thrid commit </span><br><span class="line">31eebcc (HEAD -&gt; master) HEAD@&#123;8&#125;: commit (initial): <span class="built_in">test</span> second commit </span><br><span class="line">f60cd6c HEAD@&#123;9&#125;: commit: <span class="built_in">test</span> first commit</span><br></pre></td></tr></table></figure><p>注：一个<code>^</code>表示后退一步，<code>n</code>个表示后退<code>n</code>步</p></li><li><p>使用<code>~</code>符号：只能后退</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard HEAD~n</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (master)]$ git reset --hard HEAD~1</span><br><span class="line">HEAD is now at f60cd6c <span class="built_in">test</span> first commit</span><br><span class="line">[root@centos /home/gittest (master)]$ git reflog</span><br><span class="line">f60cd6c (HEAD -&gt; master) HEAD@&#123;0&#125;: reset: moving to HEAD~1</span><br><span class="line">31eebcc HEAD@&#123;1&#125;: reset: moving to HEAD^ </span><br><span class="line">9c4147d HEAD@&#123;2&#125;: reset: moving to 9c4147d</span><br><span class="line">ee9b643 HEAD@&#123;3&#125;: commit: <span class="built_in">test</span> add h</span><br><span class="line">bea03f7 HEAD@&#123;4&#125;: commit: <span class="built_in">test</span> add g</span><br><span class="line">2237de4 HEAD@&#123;5&#125;: commit: <span class="built_in">test</span> add f</span><br><span class="line">4e8b43b HEAD@&#123;6&#125;: commit: <span class="built_in">test</span> add e</span><br><span class="line">c9fe281 HEAD@&#123;7&#125;: commit: <span class="built_in">test</span> add d</span><br><span class="line">9c4147d HEAD@&#123;8&#125;: commit: <span class="built_in">test</span> thrid commit </span><br><span class="line">31eebcc HEAD@&#123;9&#125;: commit: <span class="built_in">test</span> second commit </span><br><span class="line">f60cd6c (HEAD -&gt; master) HEAD@&#123;10&#125;: commit (initial): <span class="built_in">test</span> first commit</span><br></pre></td></tr></table></figure><p>注：表示后退<code>n</code>步</p></li></ul><h3 id="reset-命令的三个参数对比"><a href="#reset-命令的三个参数对比" class="headerlink" title="reset 命令的三个参数对比"></a>reset 命令的三个参数对比</h3><ul><li><p><code>--soft</code>参数</p><ul><li>仅仅在本地库移动<code>HEAD</code>指针</li></ul><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619145994/1639488543-28b46baa.png"></p></li><li><p><code>--mixed</code>参数</p><ul><li>在本地库移动<code>HEAD</code>指针</li><li>重置暂存区</li></ul><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619145994/1639488566-0edd428e.png"></p></li><li><p><code>--hard</code>参数</p><ul><li>在本地库移动<code>HEAD</code>指针</li><li>重置暂存区</li><li>重置工作区</li></ul></li></ul><h2 id="删除文件并找回"><a href="#删除文件并找回" class="headerlink" title="删除文件并找回"></a>删除文件并找回</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (master)]$ vi delete.txt</span><br><span class="line">[root@centos /home/gittest (master)]$ git add delete.txt</span><br><span class="line">[root@centos /home/gittest (master)]$ git commit -m <span class="string">&quot;create delete.txt&quot;</span> delete.txt</span><br><span class="line">[root@centos /home/gittest (master)]$ <span class="built_in">rm</span> delete.txt</span><br><span class="line">[root@centos /home/gittest (master)]$ git add delete.txt</span><br></pre></td></tr></table></figure><ul><li><p>前提：删除前，文件存在时的状态提交到了本地库。</p></li><li><p>操作：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard [指针位置]</span><br></pre></td></tr></table></figure><ul><li>删除操作已经提交到本地库：指针位置指向历史记录<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (master)]$ <span class="built_in">rm</span> delete.txt</span><br><span class="line">[root@centos /home/gittest (master)]$ git add delete.txt</span><br><span class="line">[root@centos /home/gittest (master)]$ git commit -m <span class="string">&quot;delete delete.txt&quot;</span> delete.txt</span><br><span class="line">[root@centos /home/gittest (master)]$ git reflog</span><br><span class="line">03b0563 (HEAD -&gt; master) HEAD@&#123;0&#125;: commit: delete delete.txt</span><br><span class="line">2d75244 HEAD@&#123;1&#125;: commit: create delete.txt</span><br><span class="line">f60cd6c HEAD@&#123;2&#125;: reset: moving to HEAD~1</span><br><span class="line">31eebcc HEAD@&#123;3&#125;: reset: moving to HEAD^ </span><br><span class="line">9c4147d HEAD@&#123;4&#125;: reset: moving to 9c4147d</span><br><span class="line">ee9b643 HEAD@&#123;5&#125;: commit: <span class="built_in">test</span> add h</span><br><span class="line">bea03f7 HEAD@&#123;6&#125;: commit: <span class="built_in">test</span> add g</span><br><span class="line">2237de4 HEAD@&#123;7&#125;: commit: <span class="built_in">test</span> add f</span><br><span class="line">4e8b43b HEAD@&#123;8&#125;: commit: <span class="built_in">test</span> add e</span><br><span class="line">c9fe281 HEAD@&#123;9&#125;: commit: <span class="built_in">test</span> add d</span><br><span class="line">9c4147d HEAD@&#123;10&#125;: commit: <span class="built_in">test</span> thrid commit </span><br><span class="line">31eebcc HEAD@&#123;11&#125;: commit: <span class="built_in">test</span> second commit </span><br><span class="line">f60cd6c HEAD@&#123;12&#125;: commit (initial): <span class="built_in">test</span> first commit</span><br><span class="line">[root@centos /home/gittest (master)]$ git reset --hard 2d75244</span><br><span class="line">[root@centos /home/gittest (master)]$ ll</span><br></pre></td></tr></table></figure></li><li>删除操作尚未提交到本地库：指针位置使用<code>HEAD</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (master)]$ ll</span><br><span class="line">total 2</span><br><span class="line">delete.txt</span><br><span class="line">test.txt</span><br><span class="line">[root@centos /home/gittest (master)]$ <span class="built_in">rm</span> delete.txt</span><br><span class="line">[root@centos /home/gittest (master)]$ git add delete.txt</span><br><span class="line">[root@centos /home/gittest (master)]$ ll</span><br><span class="line">total 1</span><br><span class="line">test.txt</span><br><span class="line">[root@centos /home/gittest (master)]$ git reset --hard HEAD</span><br><span class="line">[root@centos /home/gittest (master)]$ ll</span><br><span class="line">total 2</span><br><span class="line">delete.txt</span><br><span class="line">test.txt</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="比较文件差异"><a href="#比较文件差异" class="headerlink" title="比较文件差异"></a>比较文件差异</h2><ul><li><p>将工作区中的文件和暂存区进行比较</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff [文件名]</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (master)]$ vi test.txt</span><br><span class="line">[root@centos /home/gittest (master)]$ git diff test.txt</span><br></pre></td></tr></table></figure></li><li><p>将工作区中的文件和本地库历史记录比较</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff [本地库中历史版本] [文件名]</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (master)]$ git diff HEAD^ test.txt</span><br><span class="line">diff --git a/test.txt b/test.txt</span><br></pre></td></tr></table></figure></li><li><p>不带文件名比较多个文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (master)]$ git diff</span><br></pre></td></tr></table></figure></li></ul><h2 id="分支管理"><a href="#分支管理" class="headerlink" title="分支管理"></a>分支管理</h2><h3 id="什么是分支"><a href="#什么是分支" class="headerlink" title="什么是分支"></a>什么是分支</h3><p>在版本控制过程中，使用多条线同时推进多个任务。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1619145994/1639488882-3b2b4f4b.png"></p></div><h3 id="分支的好处"><a href="#分支的好处" class="headerlink" title="分支的好处"></a>分支的好处</h3><ul><li>同时并行推进多个功能开发，提高开发效率</li><li>各个分支在开发过程中，如果某一个分支开发失败，不会对其他分支有任 何影响。失败的分支删除重新开始即可。</li></ul><h3 id="分支操作"><a href="#分支操作" class="headerlink" title="分支操作"></a>分支操作</h3><ul><li><p>创建分支</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch [分支名]</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (master)]$ git branch hot_fix</span><br></pre></td></tr></table></figure></li><li><p>查看分支</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -v</span><br></pre></td></tr></table></figure></li><li><p>切换分支</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout [分支名]</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (master)]$ git checkout hot_fix</span><br></pre></td></tr></table></figure></li><li><p>合并分支</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (hot_fix)]$ vi aaa.txt</span><br><span class="line">[root@centos /home/gittest (hot_fix)]$ git add aaa.txt</span><br><span class="line">[root@centos /home/gittest (hot_fix)]$ git commit -m <span class="string">&quot;hot_fix&quot;</span> aaa.txt</span><br></pre></td></tr></table></figure><ol><li><p>切换到接受修改的分支（被合并，增加新内容）上</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout [被合并分支名]</span><br></pre></td></tr></table></figure> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (hot_fix)]$ git checkout master</span><br><span class="line">[root@centos /home/gittest (master)]$ vi aaa.txt</span><br><span class="line">[root@centos /home/gittest (master)]$ git add aaa.txt</span><br><span class="line">[root@centos /home/gittest (master)]$ git commit -m <span class="string">&quot;master&quot;</span> aaa.txt</span><br></pre></td></tr></table></figure></li><li><p>第二步：执行<code>merge</code>命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge [有新内容分支名]</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (master)]$ git merge hot_fix</span><br></pre></td></tr></table></figure></li></ol></li><li><p>解决冲突</p><ul><li>冲突的表现<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (hot_fix)]$  git merge master</span><br><span class="line">Auto-merging aaa.txt</span><br><span class="line">CONFLICT (ontent): Merge conflict <span class="keyword">in</span> aaa.txt</span><br><span class="line">Automatic merge failed; fix conflicts and <span class="keyword">then</span> commit the</span><br></pre></td></tr></table></figure></li><li>冲突的解决<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 当前分支内容</span></span><br><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt; <span class="string">HEAD</span></span><br><span class="line"><span class="string">hot_fix</span></span><br><span class="line"><span class="string">=======</span></span><br><span class="line"><span class="string"># 另一分支内容</span></span><br><span class="line"><span class="string">master</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;&gt;&gt;&gt;&gt; master</span></span><br></pre></td></tr></table></figure><ol><li>编辑文件，删除特殊符号 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hot_fix</span><br><span class="line"></span><br><span class="line">master</span><br></pre></td></tr></table></figure></li><li>把文件修改到满意的程度，保存退出 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hot_fix master</span><br></pre></td></tr></table></figure></li><li><code>git add [文件名]</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (hot_fix|MERGING)]$ git add aaa.txt</span><br></pre></td></tr></table></figure></li><li><code>git commit -m &quot;日志信息&quot;</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos /home/gittest (hot_fix|MERGING)]$ git commit -m <span class="string">&quot;hot and master&quot;</span></span><br></pre></td></tr></table></figure></li><li>此时<code>commit</code>一定不能带具体文件名</li></ol></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>简介</title>
      <link href="/2021/04/19/Git/01.%E7%AE%80%E4%BB%8B/"/>
      <url>/2021/04/19/Git/01.%E7%AE%80%E4%BB%8B/</url>
      
        <content type="html"><![CDATA[<h1 id="版本控制工具应该具备的功能"><a href="#版本控制工具应该具备的功能" class="headerlink" title="版本控制工具应该具备的功能"></a>版本控制工具应该具备的功能</h1><ul><li>协同修改<ul><li>多人并行不悖的修改服务器端的同一个文件</li></ul></li><li>数据备份<ul><li>不仅保存目录和文件的当前状态，还能够保存每一个提交过的历史状态</li></ul></li><li>版本管理<ul><li>在保存每一个版本的文件信息的时候要做到不保存重复数据，以节约存储空间，提高运行效率。这方面<code>SVN</code>采用的是增量式管理的方式，而<code>Git</code>采取了文件系统快照的方式</li></ul></li><li>权限控制<ul><li>对团队中参与开发的人员进行权限控制</li><li>对团队外开发者贡献的代码进行审核——<code>Git</code>独有</li></ul></li><li>历史记录<ul><li>查看修改人、修改时间、修改内容、日志信息</li><li>将本地文件恢复到某一个历史状态</li></ul></li><li>分支管理<ul><li>允许开发团队在工作过程中多条生产线同时推进任务，进一步提高效率</li></ul></li></ul><h1 id="版本控制简介"><a href="#版本控制简介" class="headerlink" title="版本控制简介"></a>版本控制简介</h1><h2 id="版本控制"><a href="#版本控制" class="headerlink" title="版本控制"></a>版本控制</h2><p>　　工程设计领域中使用版本控制管理工程蓝图的设计过程。在<code>IT</code>开发过程中也可以使用版本控制思想管理代码的版本迭代。</p><h2 id="版本控制工具"><a href="#版本控制工具" class="headerlink" title="版本控制工具"></a>版本控制工具</h2><ul><li>集中式版本控制工具：<code>CVS</code>、<code>SVN</code>、<code>VSS</code>…</li><li>分布式版本控制工具：<code>Git</code>、<code>Mercurial</code>、<code>Bazaar</code>、<code>Darcs</code>…</li></ul><h1 id="Git-简介"><a href="#Git-简介" class="headerlink" title="Git 简介"></a>Git 简介</h1><p><code>Git</code>是分布式版本控制系统，它没有中央服务器，每个人的电脑就是一个完整的版本库，这样，工作的时候就不需要联网了，因为版本都是在自己的电脑上。既然每个人的电脑都有一个完整的版本库，那多个人如何协作呢？比如说自己在电脑上改了文件A，其他人也在电脑上改了文件A，这时，你们两之间只需把各自的修改推送给对方，就可以互相看到对方的修改了。</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1618811193/1639487875-eee8781a.png"></p></div><p>仓库（版本库）：相当于一个专门用来存放代码的目录。这个目录里面的所有文件都可以<code>Git</code>管理，每个文件的增删改查都能被<code>Git</code>跟踪到</p><h2 id="Git-简史"><a href="#Git-简史" class="headerlink" title="Git 简史"></a>Git 简史</h2><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1618811193/1639487926-eab22d66.png"></p></div><h2 id="Git-官网"><a href="#Git-官网" class="headerlink" title="Git 官网"></a>Git 官网</h2><p><a href="https://git-scm.com/">官网地址</a></p><h2 id="Git-优势"><a href="#Git-优势" class="headerlink" title="Git 优势"></a>Git 优势</h2><ul><li>大部分操作在本地完成，不需要联网</li><li>完整性保证</li><li>尽可能添加数据而不是删除或修改数据</li><li>分支操作非常快捷流畅</li><li>与<code>Linux</code>命令全面兼容</li></ul><h2 id="Git-安装"><a href="#Git-安装" class="headerlink" title="Git 安装"></a>Git 安装</h2><ul><li>安装到非中文没有空格的目录下</li><li>建议用<code>VIM</code>编辑器</li><li>完全不修改<code>path</code>变量，仅在<code>Git Bash</code>中使用<code>Git</code>：<code>Use Git from Git Bash only</code></li><li><code>Use the OpenSSL library</code></li><li>行末换行符转换方式，使用默认值：<code>Checkout Windows-style, commit Unix-style line endings</code></li><li>执行<code>Git</code>命令的默认终端，使用默认值：<code>Use MinTTY</code></li></ul><h2 id="Git-结构"><a href="#Git-结构" class="headerlink" title="Git 结构"></a>Git 结构</h2><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1618811193/1639488000-3148bac9.png"></p></div><h2 id="Git-和代码托管中心"><a href="#Git-和代码托管中心" class="headerlink" title="Git 和代码托管中心"></a>Git 和代码托管中心</h2><p>代码托管中心的任务：维护远程库</p><ul><li>局域网环境下<ul><li>GitLab 服务器</li></ul></li><li>外网环境下<ul><li>GitHub</li><li>码云</li></ul></li></ul><h2 id="本地库和远程库"><a href="#本地库和远程库" class="headerlink" title="本地库和远程库"></a>本地库和远程库</h2><h3 id="团队内部协作"><a href="#团队内部协作" class="headerlink" title="团队内部协作"></a>团队内部协作</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1618811193/1639488043-341e9b6d.png"></p></div><h3 id="跨团队协作"><a href="#跨团队协作" class="headerlink" title="跨团队协作"></a>跨团队协作</h3><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1618811193/1639488062-0a05b2c2.png"></p></div><h2 id="Git-工作流程"><a href="#Git-工作流程" class="headerlink" title="Git 工作流程"></a>Git 工作流程</h2><p>1．从远程仓库中克隆<code>Git</code>资源作为本地仓库<br>2．从本地仓库中<code>checkout</code>代码然后进行代码修改<br>3．在提交前先将代码提交到暂存区<br>4．提交修改。提交到本地仓库。本地仓库中保存修改的各个历史版本<br>5．在修改完成后，需要和团队成员共享代码时，可以将代码<code>push</code>到远程仓库</p><div align="center"><p><img src="https://cdn.jsdelivr.net/gh/atideas/assets/1618811193/1639488132-1cfd971e.png"></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
